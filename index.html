<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zynapse - Secure Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="zynaps.png">
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <img src="zynaps.png" alt="Zynapse Logo" class="loading-logo">
            <div class="spinner-large"></div>
            <p>Initializing Zynapse...</p>
        </div>
    </div>

    <!-- Authentication Container -->
    <div class="auth-page">
        <!-- Welcome Screen -->
        <div class="auth-container" id="welcomeScreen">
            <div class="welcome-screen">
                <img src="zynaps.png" alt="Zynapse Logo" class="logo-large">
                <h1>Zynapse</h1>
                <p class="tagline">Secure, private messaging with end-to-end encryption</p>
                <p class="tagline">Connect instantly with friends and colleagues</p>
                <p class="powered-by">powered by <strong>buffer zone</strong></p>
                
                <div class="welcome-actions">
                    <button class="btn-primary full-width" onclick="showSignupForm()">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                    <button class="btn-secondary full-width" onclick="showLoginForm()">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
                
                <div class="welcome-footer">
                    By continuing, you agree to our <a href="#" class="link">Terms</a> and <a href="#" class="link">Privacy Policy</a>
                </div>
            </div>
        </div>

        <!-- Signup Form -->
        <div class="auth-container auth-form-container" id="signupForm" style="display: none;">
            <div class="auth-form">
                <div class="auth-header">
                    <button class="back-btn" onclick="showWelcomeScreen()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" alt="Zynapse Logo" class="logo-small">
                    <h2>Create Account</h2>
                    <p>Join Zynapse for secure messaging</p>
                </div>

                <form id="signupFormElement" onsubmit="registerUser(event)">
                    <div class="auth-form-content">
                        <div class="input-group">
                            <i class="fas fa-user"></i>
                            <input type="text" id="signupName" placeholder="Full Name" required>
                        </div>

                        <div class="input-group">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="signupPhone" placeholder="Phone Number" required>
                        </div>

                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="signupEmail" placeholder="Email Address" required>
                        </div>

                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="signupPassword" placeholder="Password (min. 8 characters)" minlength="8" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePassword('signupPassword', this)"></i>
                        </div>

                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePassword('signupConfirmPassword', this)"></i>
                        </div>

                        <!-- Profile Upload -->
                        <div class="profile-upload-section">
                            <label class="upload-label">Profile Picture</label>
                            <div class="profile-upload-container">
                                <div class="upload-preview" onclick="triggerProfileUpload()">
                                    <div class="preview-placeholder" id="profilePreviewPlaceholder">
                                        <i class="fas fa-user-circle"></i>
                                        <span>Tap to upload</span>
                                        <p>JPG, PNG up to 5MB</p>
                                    </div>
                                    <img id="profilePreviewImage" style="display: none;" alt="Profile Preview">
                                </div>
                                <div class="upload-buttons">
                                    <button type="button" class="btn-upload" onclick="triggerProfileUpload()">
                                        <i class="fas fa-upload"></i> Choose Image
                                    </button>
                                    <button type="button" class="btn-remove" onclick="removeProfileImage()" style="display: none;" id="removeProfileBtn">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="profileUpload" accept="image/*" style="display: none;" onchange="previewProfileImage(event)">
                            <p class="upload-hint">Optional. Upload a profile picture for your account.</p>
                        </div>

                        <div class="terms-agreement">
                            <label class="checkbox-container">
                                <input type="checkbox" id="agreeTerms" required>
                                <span class="checkmark"></span>
                                I agree to the <a href="#" class="link">Terms of Service</a> and <a href="#" class="link">Privacy Policy</a>
                            </label>
                        </div>

                        <button type="submit" class="btn-primary full-width" id="signupSubmitBtn">
                            <span>Create Account</span>
                            <div class="spinner" id="signupSpinner" style="display: none;"></div>
                        </button>

                        <div class="auth-divider">
                            <span>or</span>
                        </div>

                        <button type="button" class="btn-google" onclick="signInWithGoogle()">
                            <i class="fab fa-google"></i>
                            <span>Continue with Google</span>
                        </button>

                        <div class="auth-switch">
                            Already have an account? <a href="#" class="link" onclick="showLoginForm()">Sign In</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Login Form -->
        <div class="auth-container auth-form-container" id="loginForm" style="display: none;">
            <div class="auth-form">
                <div class="auth-header">
                    <button class="back-btn" onclick="showWelcomeScreen()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" alt="Zynapse Logo" class="logo-small">
                    <h2>Welcome Back</h2>
                    <p>Sign in to your Zynapse account</p>
                </div>

                <form id="loginFormElement" onsubmit="loginUser(event)">
                    <div class="auth-form-content">
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="loginEmail" placeholder="Email Address" required>
                        </div>

                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="loginPassword" placeholder="Password" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePassword('loginPassword', this)"></i>
                        </div>

                        <div class="form-options">
                            <label class="checkbox-container">
                                <input type="checkbox" id="rememberMe">
                                <span class="checkmark"></span>
                                Remember me
                            </label>
                            <a href="#" class="link" onclick="showForgotPassword()">Forgot Password?</a>
                        </div>

                        <button type="submit" class="btn-primary full-width" id="loginSubmitBtn">
                            <span>Sign In</span>
                            <div class="spinner" id="loginSpinner" style="display: none;"></div>
                        </button>

                        <div class="auth-divider">
                            <span>or</span>
                        </div>

                        <button type="button" class="btn-google" onclick="signInWithGoogle()">
                            <i class="fab fa-google"></i>
                            <span>Continue with Google</span>
                        </button>

                        <div class="auth-switch">
                            New to Zynapse? <a href="#" class="link" onclick="showSignupForm()">Create Account</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Firebase and Cloudinary Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cloudinary-core/2.12.5/cloudinary-core-shrinkwrap.min.js"></script>
    
    <!-- App Script -->
    <script src="app.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
            authDomain: "zynapse-68181.firebaseapp.com",
            databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
            projectId: "zynapse-68181",
            storageBucket: "zynapse-68181.firebasestorage.app",
            messagingSenderId: "841353050519",
            appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
            measurementId: "G-4764XLL6WS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: 'dd3lcymrk',
            apiKey: '489857926297197',
            uploadPreset: 'h3eyhc2o',
            folder: 'zynapse/profiles'
        };

        let userProfileImage = null;

        // Show welcome screen
        function showWelcomeScreen() {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
        }

        // Show signup form
        function showSignupForm() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
        }

        // Show login form
        function showLoginForm() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        // Toggle password visibility
        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Trigger profile upload
        function triggerProfileUpload() {
            document.getElementById('profileUpload').click();
        }

        // Preview profile image
        function previewProfileImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('profilePreviewImage');
                    const placeholder = document.getElementById('profilePreviewPlaceholder');
                    const removeBtn = document.getElementById('removeProfileBtn');
                    
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                    removeBtn.style.display = 'block';
                    
                    userProfileImage = file;
                }
                reader.readAsDataURL(file);
            }
        }

        // Remove profile image
        function removeProfileImage() {
            const preview = document.getElementById('profilePreviewImage');
            const placeholder = document.getElementById('profilePreviewPlaceholder');
            const removeBtn = document.getElementById('removeProfileBtn');
            const fileInput = document.getElementById('profileUpload');
            
            preview.src = '';
            preview.style.display = 'none';
            placeholder.style.display = 'block';
            removeBtn.style.display = 'none';
            fileInput.value = '';
            userProfileImage = null;
        }

        // Show forgot password
        function showForgotPassword() {
            const email = prompt('Enter your email to reset password:');
            if (email) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        showToast('Password reset email sent! Check your inbox.', 'success');
                    })
                    .catch(error => {
                        showToast(error.message, 'error');
                    });
            }
        }

        // Generate ZYN user ID
        function generateUserID() {
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `ZYN-${randomNum}`;
        }

        // Upload image to Cloudinary
        async function uploadToCloudinary(file, type = 'image') {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);
                formData.append('folder', type === 'profile' ? 'zynapse/profiles' : 'zynapse/uploads');
                
                fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.secure_url) {
                        resolve(data.secure_url);
                    } else {
                        reject(new Error('Upload failed'));
                    }
                })
                .catch(error => reject(error));
            });
        }

        // Register user
        async function registerUser(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match!', 'error');
                return;
            }
            
            if (password.length < 8) {
                showToast('Password must be at least 8 characters', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('signupSubmitBtn');
            const spinner = document.getElementById('signupSpinner');
            submitBtn.disabled = true;
            spinner.style.display = 'block';
            submitBtn.querySelector('span').style.display = 'none';
            
            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Generate ZYN ID
                const zynID = generateUserID();
                
                // Upload profile image if exists
                let profileUrl = '';
                if (userProfileImage) {
                    try {
                        profileUrl = await uploadToCloudinary(userProfileImage, 'profile');
                    } catch (error) {
                        console.error('Profile upload failed:', error);
                    }
                }
                
                // Create user data object
                const userData = {
                    name: name,
                    phone: phone,
                    email: email,
                    zynID: zynID,
                    profileUrl: profileUrl,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'online',
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Save user data to Firebase
                await database.ref('users/' + user.uid).set(userData);
                
                // Also create a reference by ZYN ID
                await database.ref('zynIDs/' + zynID).set({
                    uid: user.uid,
                    name: name
                });
                
                showToast('Account created successfully! Logging you in...', 'success');
                
                // Auto login and redirect
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1500);
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast(error.message, 'error');
                submitBtn.disabled = false;
                spinner.style.display = 'none';
                submitBtn.querySelector('span').style.display = 'inline';
            }
        }

        // Login user
        async function loginUser(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const submitBtn = document.getElementById('loginSubmitBtn');
            const spinner = document.getElementById('loginSpinner');
            submitBtn.disabled = true;
            spinner.style.display = 'block';
            submitBtn.querySelector('span').style.display = 'none';
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                
                // Update user status
                const user = auth.currentUser;
                if (user) {
                    await database.ref('users/' + user.uid).update({
                        status: 'online',
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                showToast('Login successful! Redirecting...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                showToast(error.message, 'error');
                submitBtn.disabled = false;
                spinner.style.display = 'none';
                submitBtn.querySelector('span').style.display = 'inline';
            }
        }

        // Google Sign In
        async function signInWithGoogle() {
            // Note: For production, implement proper Google OAuth
            showToast('Google sign-in coming soon. Please use email signup.', 'info');
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in, redirect to home
                window.location.href = 'home.html';
            }
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1000);
        });
    </script>
</body>
</html>
