<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zynapse - Sign Up</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <div class="zynapse-logo">
                <img src="zynaps.png" alt="Zynapse Logo">
            </div>
            
            <h1>Zynapse</h1>
            <p class="tagline">Secure, private messaging for Zambia. Connect instantly with friends and family.</p>
            <p class="powered-by">Powered by Buffer Zone</p>
            
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Login</button>
                <button class="auth-tab" id="signupTab">Sign Up</button>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Login to Zynapse
                </button>
            </form>
            
            <!-- Sign Up Form -->
            <form id="signupForm" class="auth-form" style="display: none;">
                <div class="profile-upload">
                    <div class="profile-preview" id="profilePreview">
                        <div class="upload-placeholder">
                            <i class="fas fa-user-plus"></i>
                            <span>Upload Photo</span>
                        </div>
                    </div>
                    <input type="file" id="profilePicture" accept="image/*" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="phoneNumber">Phone Number</label>
                    <input type="tel" id="phoneNumber" class="form-control" placeholder="+260 XXX XXX XXX" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Create a password" required>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm your password" required>
                </div>
                
                <button type="submit" class="btn">
                    <i class="fas fa-user-plus"></i> Create Zynapse Account
                </button>
            </form>
            
            <div class="auth-footer" style="margin-top: 20px; font-size: 12px; color: var(--ios-gray-400);">
                By registering, you agree to our Terms of Service and Privacy Policy
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title" id="notifTitle">Notification</div>
            <div class="notification-message" id="notifMessage">Message</div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="app.js"></script>
    <script>
        // Tab switching
        const loginTab = document.getElementById('loginTab');
        const signupTab = document.getElementById('signupTab');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const profilePreview = document.getElementById('profilePreview');
        const profilePictureInput = document.getElementById('profilePicture');
        let profilePictureFile = null;

        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
        });

        signupTab.addEventListener('click', () => {
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            signupForm.style.display = 'block';
            loginForm.style.display = 'none';
        });

        // Profile picture upload
        profilePreview.addEventListener('click', () => {
            profilePictureInput.click();
        });

        profilePictureInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                profilePictureFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    profilePreview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
                };
                reader.readAsDataURL(file);
            }
        });

        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                showNotification('Logging in...', 'Please wait while we authenticate you');
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Get user data from database
                const userRef = database.ref(`users/${user.uid}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                if (userData) {
                    // Store user data in localStorage
                    localStorage.setItem('zynapse_user', JSON.stringify({
                        uid: user.uid,
                        ...userData
                    }));
                    
                    showNotification('Success!', 'Welcome back to Zynapse');
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login Failed', error.message, 'error');
            }
        });

        // Signup form submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (password !== confirmPassword) {
                showNotification('Error', 'Passwords do not match', 'error');
                return;
            }
            
            if (!profilePictureFile) {
                showNotification('Error', 'Please upload a profile picture', 'error');
                return;
            }
            
            try {
                showNotification('Creating account...', 'Please wait');
                
                // Create user with email/password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Generate user ID
                const userId = generateUserID();
                
                // Upload profile picture
                showNotification('Uploading profile picture...', 'Please wait');
                const imagekitResponse = await uploadProfilePicture(profilePictureFile, user.uid);
                
                // Create user data object
                const userData = {
                    name: fullName,
                    email: email,
                    phone: phoneNumber,
                    userId: userId,
                    profilePicture: imagekitResponse.url,
                    profilePictureId: imagekitResponse.fileId,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: {
                        online: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    },
                    contacts: [],
                    chatRequests: [],
                    groups: []
                };
                
                // Save user data to database
                await database.ref(`users/${user.uid}`).set(userData);
                
                // Save user ID mapping for quick lookup
                await database.ref(`userIds/${userId}`).set({
                    uid: user.uid,
                    name: fullName
                });
                
                // Store user data in localStorage
                localStorage.setItem('zynapse_user', JSON.stringify({
                    uid: user.uid,
                    ...userData
                }));
                
                showNotification('Success!', `Your Zynapse ID: ${userId}`, 'success');
                
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 2000);
                
            } catch (error) {
                console.error('Signup error:', error);
                showNotification('Signup Failed', error.message, 'error');
            }
        });

        // Notification system
        const notification = document.getElementById('notification');
        const notifTitle = document.getElementById('notifTitle');
        const notifMessage = document.getElementById('notifMessage');
        const notificationSound = new Audio('notification.mp3');

        function showNotification(title, message, type = 'info') {
            notifTitle.textContent = title;
            notifMessage.textContent = message;
            
            // Set color based on type
            const leftBorderColor = {
                'success': 'var(--ios-green)',
                'error': 'var(--ios-red)',
                'info': 'var(--ios-blue)'
            }[type] || 'var(--ios-blue)';
            
            notification.style.borderLeftColor = leftBorderColor;
            
            // Play sound for important notifications
            if (type !== 'info') {
                notificationSound.play().catch(e => console.log('Audio play failed:', e));
            }
            
            notification.classList.add('show');
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user && window.location.pathname.includes('index.html')) {
                // User is already logged in, redirect to home
                database.ref(`users/${user.uid}`).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        localStorage.setItem('zynapse_user', JSON.stringify({
                            uid: user.uid,
                            ...snapshot.val()
                        }));
                        window.location.href = 'home.html';
                    }
                });
            }
        });
    </script>
</body>
</html>
