<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zynapse - Welcome</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/cloudinary-core@2.11.4/cloudinary-core-shrinkwrap.min.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <img src="zynaps.png" alt="Zynapse Logo" class="loading-logo">
            <div class="spinner-large"></div>
            <p>Loading Zynapse...</p>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div class="auth-page" id="welcomeScreen" style="display: none;">
        <div class="auth-container">
            <div class="welcome-screen">
                <img src="zynaps.png" alt="Zynapse Logo" class="logo-large">
                <h1>Zynapse</h1>
                <p class="tagline">Connect instantly with secure, private messaging</p>
                <p class="powered-by">Powered by Buffer Zone</p>
                
                <div class="welcome-actions">
                    <button class="btn-primary full-width" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                    <button class="btn-secondary full-width" id="signupBtn">
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                </div>
                
                <div class="welcome-footer">
                    By continuing, you agree to our <a href="#" class="link">Terms</a> and <a href="#" class="link">Privacy Policy</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Form -->
    <div class="auth-page" id="loginForm" style="display: none;">
        <div class="auth-container">
            <div class="auth-form">
                <div class="auth-header">
                    <button class="back-btn" id="backToWelcomeFromLogin">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" alt="Zynapse Logo" class="logo-small">
                    <h2>Welcome Back</h2>
                    <p>Sign in to your Zynapse account</p>
                </div>
                
                <div class="auth-form-content">
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="loginEmail" placeholder="Email Address" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <i class="fas fa-eye toggle-password" id="toggleLoginPassword"></i>
                    </div>
                    
                    <div class="form-options">
                        <label class="checkbox-container">
                            <input type="checkbox" id="rememberMe">
                            <span class="checkmark"></span>
                            Remember me
                        </label>
                        <a href="#" class="link" id="forgotPassword">Forgot Password?</a>
                    </div>
                    
                    <button class="btn-primary full-width" id="loginSubmitBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                    
                    <div class="auth-switch">
                        Don't have an account? <a href="#" class="link" id="switchToSignup">Sign Up</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signup Form -->
    <div class="auth-page" id="signupForm" style="display: none;">
        <div class="auth-container">
            <div class="auth-form">
                <div class="auth-header">
                    <button class="back-btn" id="backToWelcomeFromSignup">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" alt="Zynapse Logo" class="logo-small">
                    <h2>Create Account</h2>
                    <p>Join Zynapse today</p>
                </div>
                
                <div class="auth-form-content">
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="signupName" placeholder="Full Name" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="signupPhone" placeholder="Phone Number" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="signupEmail" placeholder="Email Address" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="signupPassword" placeholder="Password" required>
                        <i class="fas fa-eye toggle-password" id="toggleSignupPassword"></i>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required>
                        <i class="fas fa-eye toggle-password" id="toggleConfirmPassword"></i>
                    </div>
                    
                    <!-- Profile Upload Section -->
                    <div class="profile-upload-section">
                        <label class="upload-label">Profile Picture</label>
                        <div class="profile-upload-container">
                            <div class="upload-preview" id="profilePreview">
                                <div class="preview-placeholder">
                                    <i class="fas fa-user-circle"></i>
                                    <span>No image selected</span>
                                    <p>Click to upload</p>
                                </div>
                            </div>
                            <div class="upload-buttons">
                                <button class="btn-upload" id="uploadProfileBtn">
                                    <i class="fas fa-upload"></i>
                                    Choose Image
                                </button>
                                <button class="btn-remove" id="removeProfileBtn" style="display: none;">
                                    <i class="fas fa-trash"></i>
                                    Remove
                                </button>
                            </div>
                        </div>
                        <input type="file" id="profileImage" accept="image/*" style="display: none;">
                        <p class="upload-hint">Recommended: Square image, max 2MB</p>
                    </div>
                    
                    <div class="terms-agreement checkbox-container">
                        <input type="checkbox" id="agreeTerms" required>
                        <span class="checkmark"></span>
                        I agree to the <a href="#" class="link">Terms of Service</a> and <a href="#" class="link">Privacy Policy</a>
                    </div>
                    
                    <button class="btn-primary full-width" id="signupSubmitBtn">
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                    
                    <div class="auth-switch">
                        Already have an account? <a href="#" class="link" id="switchToLogin">Sign In</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
            authDomain: "zynapse-68181.firebaseapp.com",
            databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
            projectId: "zynapse-68181",
            storageBucket: "zynapse-68181.firebasestorage.app",
            messagingSenderId: "841353050519",
            appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
            measurementId: "G-4764XLL6WS"
        };

        // Cloudinary Configuration
        const CLOUDINARY_CONFIG = {
            cloudName: 'dd3lcymrk',
            apiKey: '489857926297197',
            uploadPreset: 'h3eyhc2o',
            folder: 'zynapse/profiles'
        };

        // Global Variables
        let currentUser = null;
        let profileImageFile = null;
        let profileImageUrl = null;
        let isLoading = false;

        // Firebase Initialization
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        
        // Navigation Buttons
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const backToWelcomeFromLogin = document.getElementById('backToWelcomeFromWelcomeFromLogin');
        const backToWelcomeFromSignup = document.getElementById('backToWelcomeFromSignup');
        const switchToSignup = document.getElementById('switchToSignup');
        const switchToLogin = document.getElementById('switchToLogin');
        const forgotPassword = document.getElementById('forgotPassword');
        
        // Login Form Elements
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const toggleLoginPassword = document.getElementById('toggleLoginPassword');
        const rememberMe = document.getElementById('rememberMe');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        
        // Signup Form Elements
        const signupName = document.getElementById('signupName');
        const signupPhone = document.getElementById('signupPhone');
        const signupEmail = document.getElementById('signupEmail');
        const signupPassword = document.getElementById('signupPassword');
        const signupConfirmPassword = document.getElementById('signupConfirmPassword');
        const toggleSignupPassword = document.getElementById('toggleSignupPassword');
        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        const agreeTerms = document.getElementById('agreeTerms');
        const signupSubmitBtn = document.getElementById('signupSubmitBtn');
        
        // Profile Upload Elements
        const profilePreview = document.getElementById('profilePreview');
        const uploadProfileBtn = document.getElementById('uploadProfileBtn');
        const removeProfileBtn = document.getElementById('removeProfileBtn');
        const profileImage = document.getElementById('profileImage');

        // Initialize Application
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            // Check if user is already logged in
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is logged in, redirect to home
                    await fetchUserData(user.uid);
                    window.location.href = 'home.html';
                } else {
                    // Show welcome screen after loading
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                            welcomeScreen.style.display = 'flex';
                        }, 300);
                    }, 1000);
                }
            });

            // Setup event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Navigation
            loginBtn.addEventListener('click', () => showScreen(loginForm));
            signupBtn.addEventListener('click', () => showScreen(signupForm));
            
            if (backToWelcomeFromLogin) {
                backToWelcomeFromLogin.addEventListener('click', () => showScreen(welcomeScreen));
            }
            
            if (backToWelcomeFromSignup) {
                backToWelcomeFromSignup.addEventListener('click', () => showScreen(welcomeScreen));
            }
            
            switchToSignup.addEventListener('click', (e) => {
                e.preventDefault();
                showScreen(signupForm);
            });
            
            switchToLogin.addEventListener('click', (e) => {
                e.preventDefault();
                showScreen(loginForm);
            });
            
            forgotPassword.addEventListener('click', (e) => {
                e.preventDefault();
                showForgotPasswordModal();
            });

            // Toggle password visibility
            toggleLoginPassword.addEventListener('click', () => togglePasswordVisibility(loginPassword, toggleLoginPassword));
            toggleSignupPassword.addEventListener('click', () => togglePasswordVisibility(signupPassword, toggleSignupPassword));
            toggleConfirmPassword.addEventListener('click', () => togglePasswordVisibility(signupConfirmPassword, toggleConfirmPassword));

            // Profile image upload
            uploadProfileBtn.addEventListener('click', () => profileImage.click());
            profileImage.addEventListener('change', handleProfileImageUpload);
            removeProfileBtn.addEventListener('click', removeProfileImage);
            profilePreview.addEventListener('click', () => profileImage.click());

            // Form submissions
            loginSubmitBtn.addEventListener('click', handleLogin);
            signupSubmitBtn.addEventListener('click', handleSignup);
            
            // Enter key support
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            signupConfirmPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSignup();
            });
        }

        function showScreen(screen) {
            // Hide all screens
            welcomeScreen.style.display = 'none';
            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            
            // Show selected screen
            screen.style.display = 'flex';
        }

        function togglePasswordVisibility(passwordField, toggleIcon) {
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            toggleIcon.classList.toggle('fa-eye');
            toggleIcon.classList.toggle('fa-eye-slash');
        }

        async function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            if (!file.type.match('image.*')) {
                showToast('Please select an image file', 'error');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                showToast('Image size must be less than 2MB', 'error');
                return;
            }

            // Preview image
            const reader = new FileReader();
            reader.onload = (e) => {
                profilePreview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
                removeProfileBtn.style.display = 'flex';
                profileImageFile = file;
            };
            reader.readAsDataURL(file);
        }

        function removeProfileImage() {
            profilePreview.innerHTML = `
                <div class="preview-placeholder">
                    <i class="fas fa-user-circle"></i>
                    <span>No image selected</span>
                    <p>Click to upload</p>
                </div>`;
            removeProfileBtn.style.display = 'none';
            profileImageFile = null;
            profileImage.value = '';
        }

        async function uploadToCloudinary(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                formData.append('folder', CLOUDINARY_CONFIG.folder);
                formData.append('cloud_name', CLOUDINARY_CONFIG.cloudName);

                fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.secure_url) {
                        resolve(data.secure_url);
                    } else {
                        reject(new Error('Upload failed'));
                    }
                })
                .catch(error => reject(error));
            });
        }

        function generateUserId() {
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `ZYN-${randomNum}`;
        }

        async function handleLogin() {
            if (isLoading) return;
            
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();

            // Validation
            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            isLoading = true;
            loginSubmitBtn.innerHTML = '<div class="spinner"></div> Signing In...';
            loginSubmitBtn.disabled = true;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Update last active
                await database.ref(`users/${user.uid}`).update({
                    lastActive: Date.now(),
                    isOnline: true
                });

                showToast('Successfully signed in!', 'success');
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1000);

            } catch (error) {
                let message = 'Login failed';
                switch (error.code) {
                    case 'auth/user-not-found':
                        message = 'No account found with this email';
                        break;
                    case 'auth/wrong-password':
                        message = 'Incorrect password';
                        break;
                    case 'auth/invalid-email':
                        message = 'Invalid email address';
                        break;
                }
                showToast(message, 'error');
            } finally {
                isLoading = false;
                loginSubmitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                loginSubmitBtn.disabled = false;
            }
        }

        async function handleSignup() {
            if (isLoading) return;
            
            // Get form values
            const name = signupName.value.trim();
            const phone = signupPhone.value.trim();
            const email = signupEmail.value.trim();
            const password = signupPassword.value;
            const confirmPassword = signupConfirmPassword.value;

            // Validation
            if (!name || !phone || !email || !password || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            if (!agreeTerms.checked) {
                showToast('You must agree to the terms and conditions', 'error');
                return;
            }

            isLoading = true;
            signupSubmitBtn.innerHTML = '<div class="spinner"></div> Creating Account...';
            signupSubmitBtn.disabled = true;

            try {
                // Upload profile image if selected
                let profileUrl = null;
                if (profileImageFile) {
                    try {
                        profileUrl = await uploadToCloudinary(profileImageFile);
                    } catch (error) {
                        console.error('Profile upload failed:', error);
                        // Continue without profile image
                    }
                }

                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Generate user ID
                const userId = generateUserId();

                // Prepare user data
                const userData = {
                    uid: user.uid,
                    userId: userId,
                    name: name,
                    phone: phone,
                    email: email,
                    profileUrl: profileUrl,
                    createdAt: Date.now(),
                    lastActive: Date.now(),
                    isOnline: true,
                    status: 'Available',
                    contacts: {},
                    chatRequests: {},
                    chats: {},
                    groups: {}
                };

                // Save to database
                await database.ref(`users/${user.uid}`).set(userData);
                await database.ref(`userIds/${userId}`).set(user.uid);

                showToast('Account created successfully!', 'success');
                
                // Redirect to home
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1500);

            } catch (error) {
                let message = 'Registration failed';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        message = 'Email already registered';
                        break;
                    case 'auth/invalid-email':
                        message = 'Invalid email address';
                        break;
                    case 'auth/weak-password':
                        message = 'Password is too weak';
                        break;
                }
                showToast(message, 'error');
            } finally {
                isLoading = false;
                signupSubmitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                signupSubmitBtn.disabled = false;
            }
        }

        async function fetchUserData(uid) {
            try {
                const snapshot = await database.ref(`users/${uid}`).once('value');
                currentUser = snapshot.val();
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-info-circle';
            switch (type) {
                case 'success': icon = 'fa-check-circle'; break;
                case 'error': icon = 'fa-exclamation-circle'; break;
                case 'warning': icon = 'fa-exclamation-triangle'; break;
            }
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showForgotPasswordModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Reset Password</h3>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="resetEmail" placeholder="Enter your email address">
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary" id="cancelReset">Cancel</button>
                            <button class="btn-primary" id="sendResetLink">Send Reset Link</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners for modal
            modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
            modal.querySelector('#cancelReset').addEventListener('click', () => modal.remove());
            modal.querySelector('#sendResetLink').addEventListener('click', async () => {
                const email = modal.querySelector('#resetEmail').value.trim();
                if (!email) {
                    showToast('Please enter your email', 'error');
                    return;
                }
                
                try {
                    await auth.sendPasswordResetEmail(email);
                    showToast('Password reset link sent to your email', 'success');
                    modal.remove();
                } catch (error) {
                    showToast('Failed to send reset link', 'error');
                }
            });
        }
    </script>
</body>
</html>
