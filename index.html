<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Zynapse - Connect Seamlessly</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="zynaps.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    
    <!-- Cloudinary -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <img src="zynaps.png" alt="Zynapse Logo" class="loading-logo">
            <div class="spinner-large"></div>
            <p>Loading Zynapse...</p>
        </div>
    </div>

    <!-- Authentication Page -->
    <div id="authPage" class="auth-page" style="display: none;">
        <div class="auth-container">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="welcome-screen">
                <img src="zynaps.png" alt="Zynapse Logo" class="logo-large">
                <h1>Zynapse</h1>
                <p class="tagline">Connect instantly with seamless messaging</p>
                <p class="tagline">Private, secure, and lightning-fast communication</p>
                <p class="powered-by">Powered by Buffer Zone</p>
                
                <div class="welcome-actions">
                    <button id="loginBtn" class="btn-primary full-width">
                        <i class="fas fa-sign-in-alt"></i> Login to Zynapse
                    </button>
                    <button id="signupBtn" class="btn-secondary full-width">
                        <i class="fas fa-user-plus"></i> Create New Account
                    </button>
                </div>
                
                <div class="welcome-footer">
                    By continuing, you agree to our <a href="#" class="link">Terms</a> and <a href="#" class="link">Privacy Policy</a>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form" style="display: none;">
                <div class="auth-header">
                    <button id="backFromLogin" class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" alt="Zynapse Logo" class="logo-small">
                    <h2>Welcome Back</h2>
                    <p>Login to your Zynapse account</p>
                </div>
                
                <form id="loginFormElement" class="auth-form-content">
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="loginEmail" placeholder="Email address" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('loginPassword')"></i>
                    </div>
                    
                    <div class="form-options">
                        <label class="checkbox-container">
                            <input type="checkbox" id="rememberMe">
                            <span class="checkmark"></span>
                            Remember me
                        </label>
                        <a href="#" id="forgotPassword" class="link">Forgot password?</a>
                    </div>
                    
                    <button type="submit" class="btn-primary full-width" id="loginSubmitBtn">
                        <span>Login to Zynapse</span>
                        <div id="loginSpinner" class="spinner" style="display: none;"></div>
                    </button>
                    
                    <div class="auth-divider">
                        <span>Or continue with</span>
                    </div>
                    
                    <button type="button" class="btn-google">
                        <i class="fab fa-google"></i> Google
                    </button>
                    
                    <div class="auth-switch">
                        Don't have an account? <a href="#" id="switchToSignup" class="link">Sign up</a>
                    </div>
                </form>
            </div>

            <!-- Sign Up Form -->
            <div id="signupForm" class="auth-form" style="display: none;">
                <div class="auth-header">
                    <button id="backFromSignup" class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" alt="Zynapse Logo" class="logo-small">
                    <h2>Create Account</h2>
                    <p>Join Zynapse today</p>
                </div>
                
                <form id="signupFormElement" class="auth-form-content">
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="signupName" placeholder="Full name" required minlength="2" maxlength="50">
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="signupPhone" placeholder="Phone number" required pattern="[0-9]{10,15}">
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="signupEmail" placeholder="Email address" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="signupPassword" placeholder="Password" required minlength="6">
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('signupPassword')"></i>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="signupConfirmPassword" placeholder="Confirm password" required minlength="6">
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('signupConfirmPassword')"></i>
                    </div>
                    
                    <!-- Profile Upload Section -->
                    <div class="profile-upload-section">
                        <label class="upload-label">Profile Picture</label>
                        <div class="profile-upload-container">
                            <div class="upload-preview" id="profilePreview">
                                <div class="preview-placeholder" id="profilePlaceholder">
                                    <i class="fas fa-user-circle"></i>
                                    <span>No image selected</span>
                                    <p>Click to upload</p>
                                </div>
                                <img id="profileImage" style="display: none;">
                            </div>
                            <div class="upload-buttons">
                                <button type="button" class="btn-upload" onclick="openCloudinaryUploader()">
                                    <i class="fas fa-upload"></i> Upload Photo
                                </button>
                                <button type="button" class="btn-remove" onclick="removeProfilePicture()" style="display: none;" id="removeProfileBtn">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                        <p class="upload-hint">Upload a profile picture (Max 5MB, JPG, PNG)</p>
                        <input type="hidden" id="profileImageUrl">
                    </div>
                    
                    <div class="terms-agreement">
                        <label class="checkbox-container">
                            <input type="checkbox" id="acceptTerms" required>
                            <span class="checkmark"></span>
                            I agree to the <a href="#" class="link">Terms of Service</a> and <a href="#" class="link">Privacy Policy</a>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn-primary full-width" id="signupSubmitBtn">
                        <span>Create Account</span>
                        <div id="signupSpinner" class="spinner" style="display: none;"></div>
                    </button>
                    
                    <div class="auth-switch">
                        Already have an account? <a href="#" id="switchToLogin" class="link">Login</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // ===== CONFIGURATION =====
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
            authDomain: "zynapse-68181.firebaseapp.com",
            databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
            projectId: "zynapse-68181",
            storageBucket: "zynapse-68181.firebasestorage.app",
            messagingSenderId: "841353050519",
            appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
            measurementId: "G-4764XLL6WS"
        };

        const CLOUDINARY_ACCOUNT = {
            cloudName: 'dd3lcymrk',
            apiKey: '489857926297197',
            uploadPreset: 'h3eyhc2o',
            folder: 'zynapse/profiles'
        };

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let cloudinaryWidget = null;
        let profileImageUrl = '';

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            try {
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                }
                
                // Check authentication state
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        // User is signed in, redirect to home
                        window.location.href = 'home.html';
                    } else {
                        // User is signed out, show auth page
                        setTimeout(() => {
                            document.getElementById('loadingScreen').classList.add('hidden');
                            setTimeout(() => {
                                document.getElementById('loadingScreen').style.display = 'none';
                                document.getElementById('authPage').style.display = 'flex';
                            }, 500);
                        }, 1000);
                    }
                });
            } catch (error) {
                showToast('Failed to initialize app', 'error');
                console.error('Initialization error:', error);
            }
        }

        function setupEventListeners() {
            // Welcome screen buttons
            document.getElementById('loginBtn').addEventListener('click', () => showLoginForm());
            document.getElementById('signupBtn').addEventListener('click', () => showSignupForm());
            
            // Back buttons
            document.getElementById('backFromLogin').addEventListener('click', () => showWelcomeScreen());
            document.getElementById('backFromSignup').addEventListener('click', () => showWelcomeScreen());
            
            // Form switches
            document.getElementById('switchToSignup').addEventListener('click', (e) => {
                e.preventDefault();
                showSignupForm();
            });
            document.getElementById('switchToLogin').addEventListener('click', (e) => {
                e.preventDefault();
                showLoginForm();
            });
            
            // Form submissions
            document.getElementById('loginFormElement').addEventListener('submit', handleLogin);
            document.getElementById('signupFormElement').addEventListener('submit', handleSignup);
            
            // Forgot password
            document.getElementById('forgotPassword').addEventListener('click', (e) => {
                e.preventDefault();
                handleForgotPassword();
            });
        }

        function showWelcomeScreen() {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
        }

        function showLoginForm() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginEmail').focus();
        }

        function showSignupForm() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('signupName').focus();
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.parentElement.querySelector('.toggle-password');
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // ===== CLOUDINARY UPLOAD =====
        function openCloudinaryUploader() {
            if (!cloudinaryWidget) {
                cloudinaryWidget = cloudinary.createUploadWidget(
                    {
                        cloudName: CLOUDINARY_ACCOUNT.cloudName,
                        uploadPreset: CLOUDINARY_ACCOUNT.uploadPreset,
                        folder: CLOUDINARY_ACCOUNT.folder,
                        maxFiles: 1,
                        maxFileSize: 5242880, // 5MB
                        resourceType: 'image',
                        cropping: true,
                        croppingAspectRatio: 1,
                        croppingDefaultSelectionRatio: 0.9,
                        showAdvancedOptions: false,
                        multiple: false,
                        defaultSource: 'local',
                        styles: {
                            palette: {
                                window: "#FFFFFF",
                                windowBorder: "#90A0B3",
                                tabIcon: "#007AFF",
                                menuIcons: "#5A616A",
                                textDark: "#000000",
                                textLight: "#FFFFFF",
                                link: "#007AFF",
                                action: "#FF620C",
                                inactiveTabIcon: "#0E2F5A",
                                error: "#F44235",
                                inProgress: "#007AFF",
                                complete: "#20B832",
                                sourceBg: "#E4EBF1"
                            }
                        }
                    },
                    (error, result) => {
                        if (!error && result && result.event === "success") {
                            handleProfileUpload(result.info);
                        }
                    }
                );
            }
            cloudinaryWidget.open();
        }

        function handleProfileUpload(result) {
            profileImageUrl = result.secure_url;
            document.getElementById('profileImageUrl').value = profileImageUrl;
            
            // Update preview
            const preview = document.getElementById('profilePreview');
            const placeholder = document.getElementById('profilePlaceholder');
            const image = document.getElementById('profileImage');
            const removeBtn = document.getElementById('removeProfileBtn');
            
            image.src = profileImageUrl;
            image.style.display = 'block';
            placeholder.style.display = 'none';
            removeBtn.style.display = 'block';
            
            preview.style.borderColor = '#34c759';
            preview.style.background = 'transparent';
            
            showToast('Profile picture uploaded successfully', 'success');
        }

        function removeProfilePicture() {
            profileImageUrl = '';
            document.getElementById('profileImageUrl').value = '';
            
            const preview = document.getElementById('profilePreview');
            const placeholder = document.getElementById('profilePlaceholder');
            const image = document.getElementById('profileImage');
            const removeBtn = document.getElementById('removeProfileBtn');
            
            image.style.display = 'none';
            placeholder.style.display = 'flex';
            removeBtn.style.display = 'none';
            
            preview.style.borderColor = '#d9d9d9';
            preview.style.background = '#f2f2f2';
        }

        // ===== AUTHENTICATION FUNCTIONS =====
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const submitBtn = document.getElementById('loginSubmitBtn');
            const spinner = document.getElementById('loginSpinner');
            const btnText = submitBtn.querySelector('span');
            
            // Validation
            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            try {
                // Show loading state
                btnText.textContent = 'Logging in...';
                spinner.style.display = 'block';
                submitBtn.disabled = true;
                
                // Sign in with Firebase
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                showToast('Login successful! Redirecting...', 'success');
                
                // Update last login timestamp
                await firebase.database().ref('users/' + currentUser.uid).update({
                    lastLogin: Date.now()
                });
                
                // Redirect to home page
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many attempts. Please try again later';
                        break;
                }
                
                showToast(errorMessage, 'error');
            } finally {
                // Reset button state
                btnText.textContent = 'Login to Zynapse';
                spinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            
            const name = document.getElementById('signupName').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const acceptTerms = document.getElementById('acceptTerms').checked;
            const submitBtn = document.getElementById('signupSubmitBtn');
            const spinner = document.getElementById('signupSpinner');
            const btnText = submitBtn.querySelector('span');
            
            // Validation
            if (!name || !phone || !email || !password || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (!acceptTerms) {
                showToast('Please accept the terms and conditions', 'error');
                return;
            }
            
            // Phone validation
            const phoneRegex = /^[0-9]{10,15}$/;
            if (!phoneRegex.test(phone)) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            try {
                // Show loading state
                btnText.textContent = 'Creating account...';
                spinner.style.display = 'block';
                submitBtn.disabled = true;
                
                // Generate user ID
                const userId = 'ZYN-' + Math.floor(1000 + Math.random() * 9000);
                
                // Create user in Firebase Auth
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Prepare user data
                const userData = {
                    name: name,
                    phone: phone,
                    email: email,
                    userId: userId,
                    profileImage: profileImageUrl || 'https://res.cloudinary.com/dd3lcymrk/image/upload/v1678888888/zynapse/default-avatar.png',
                    createdAt: Date.now(),
                    lastLogin: Date.now(),
                    status: 'online',
                    contacts: {},
                    chatRequests: {},
                    zynes: {},
                    groups: {}
                };
                
                // Save user data to Firebase Database
                await firebase.database().ref('users/' + currentUser.uid).set(userData);
                
                // Send email verification
                await currentUser.sendEmailVerification();
                
                showToast(`Account created successfully! Your User ID is ${userId}`, 'success');
                
                // Auto-login and redirect
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 2000);
                
            } catch (error) {
                console.error('Signup error:', error);
                let errorMessage = 'Registration failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email already registered';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'Registration is currently disabled';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your connection';
                        break;
                }
                
                showToast(errorMessage, 'error');
            } finally {
                // Reset button state
                btnText.textContent = 'Create Account';
                spinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function handleForgotPassword() {
            const email = prompt('Please enter your email address to reset password:');
            
            if (!email) return;
            
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                showToast('Password reset email sent. Please check your inbox.', 'success');
            } catch (error) {
                console.error('Password reset error:', error);
                showToast('Failed to send reset email. Please try again.', 'error');
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'error') icon = 'fas fa-exclamation-circle';
            if (type === 'warning') icon = 'fas fa-exclamation-triangle';
            
            toast.innerHTML = `
                <i class="${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease forwards';
                setTimeout(() => {
                    if (toast.parentNode === container) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showToast('An error occurred. Please refresh the page.', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showToast('An unexpected error occurred.', 'error');
        });
    </script>
</body>
</html>
