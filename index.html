<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zynapse - Secure Messaging</title>
    <link rel="icon" type="image/x-icon" href="zynaps.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/@cloudinary/url-gen@1.10.0/dist/cloudinary-url-gen.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        /* ===== CSS RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --white: #ffffff;
            --black: #000000;
            --gray-50: #f9f9f9;
            --gray-100: #f2f2f2;
            --gray-200: #e9e9e9;
            --gray-300: #d9d9d9;
            --gray-400: #b0b0b0;
            --gray-500: #8e8e93;
            --gray-600: #6d6d72;
            --gray-700: #3a3a3c;
            --blue: #007aff;
            --blue-light: #5ac8fa;
            --blue-dark: #0056cc;
            --green: #34c759;
            --green-light: #4cd964;
            --red: #ff3b30;
            --red-light: #ff5757;
            --red-dark: #d70015;
            --orange: #ff9500;
            --purple: #af52de;
            --yellow: #ffcc00;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.12);
            --border-radius-small: 10px;
            --border-radius-medium: 16px;
            --border-radius-large: 20px;
            --border-radius-circle: 50%;
            --font-sf-pro: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.4s ease;
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: var(--font-sf-pro);
            background: var(--white);
            color: var(--black);
            line-height: 1.4;
            overflow-x: hidden;
            height: 100vh;
            height: -webkit-fill-available;
        }

        html {
            height: -webkit-fill-available;
        }

        /* ===== LOADING SCREEN ===== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity var(--transition-slow);
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
            padding: 20px;
        }

        .loading-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 30px;
            border-radius: var(--border-radius-large);
            object-fit: cover;
            animation: pulse 2s infinite;
        }

        .spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 122, 255, 0.1);
            border-top-color: var(--blue);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        .loading-content p {
            color: var(--gray-600);
            font-size: 16px;
            font-weight: 500;
        }

        /* ===== AUTHENTICATION PAGES ===== */
        .auth-page {
            background: var(--white);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        .auth-container {
            width: 100%;
            max-width: 400px;
            animation: fadeIn 0.5s ease;
        }

        .welcome-screen {
            text-align: center;
            animation: slideUp 0.6s ease;
        }

        .logo-large {
            width: 120px;
            height: 120px;
            margin: 0 auto 24px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-medium);
            object-fit: cover;
            transition: transform var(--transition-normal);
        }

        .logo-large:hover {
            transform: scale(1.05);
        }

        .welcome-screen h1 {
            font-size: 42px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .tagline {
            font-size: 17px;
            color: var(--gray-600);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .powered-by {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 40px;
            font-weight: 500;
        }

        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 30px;
        }

        .welcome-footer {
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            font-size: 14px;
            color: var(--gray-500);
        }

        .welcome-footer .link {
            color: var(--blue);
            text-decoration: none;
            font-weight: 500;
        }

        .welcome-footer .link:hover {
            text-decoration: underline;
        }

        /* Auth Forms */
        .auth-form {
            background: var(--white);
            border-radius: var(--border-radius-large);
            padding: 36px;
            box-shadow: var(--shadow-heavy);
            animation: slideUp 0.4s ease;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
            position: relative;
        }

        .back-btn {
            position: absolute;
            left: 0;
            top: 0;
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius-circle);
            transition: all var(--transition-normal);
        }

        .back-btn:hover {
            background: var(--gray-100);
            color: var(--black);
        }

        .logo-small {
            width: 64px;
            height: 64px;
            border-radius: var(--border-radius-medium);
            margin-bottom: 20px;
            object-fit: cover;
        }

        .auth-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 8px;
        }

        .auth-header p {
            font-size: 16px;
            color: var(--gray-600);
        }

        .auth-form-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            position: relative;
        }

        .input-group i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
            font-size: 18px;
            z-index: 1;
        }

        .input-group input {
            width: 100%;
            padding: 18px 20px 18px 48px;
            font-size: 17px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius-medium);
            background: var(--white);
            color: var(--black);
            transition: all var(--transition-normal);
            font-family: var(--font-sf-pro);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .input-group input::placeholder {
            color: var(--gray-400);
        }

        .input-group input:invalid:not(:focus):not(:placeholder-shown) {
            border-color: var(--red);
        }

        .toggle-password {
            left: auto !important;
            right: 16px;
            cursor: pointer;
            transition: color var(--transition-normal);
        }

        .toggle-password:hover {
            color: var(--blue);
        }

        /* Form Options */
        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 15px;
            color: var(--gray-600);
            user-select: none;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .checkmark {
            position: relative;
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 10px;
            background: var(--white);
            border: 2px solid var(--gray-300);
            border-radius: 6px;
            transition: all var(--transition-normal);
        }

        .checkbox-container input:checked ~ .checkmark {
            background: var(--blue);
            border-color: var(--blue);
        }

        .checkbox-container input:checked ~ .checkmark::after {
            content: "âœ“";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--white);
            font-size: 14px;
            font-weight: bold;
        }

        /* Profile Upload Section */
        .profile-upload-section {
            margin: 20px 0;
        }

        .upload-label {
            display: block;
            margin-bottom: 12px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .profile-upload-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
        }

        .upload-preview {
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius-circle);
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px dashed var(--gray-300);
            transition: all var(--transition-normal);
            position: relative;
        }

        .upload-preview:hover {
            border-color: var(--blue);
            background: rgba(0, 122, 255, 0.02);
        }

        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 10px;
        }

        .preview-placeholder i {
            font-size: 32px;
            color: var(--gray-400);
            margin-bottom: 8px;
        }

        .preview-placeholder span,
        .preview-placeholder p {
            font-size: 13px;
            color: var(--gray-500);
            line-height: 1.3;
        }

        .upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .btn-upload {
            background: var(--white);
            color: var(--blue);
            border: 2px solid var(--blue);
            padding: 12px 20px;
            border-radius: var(--border-radius-medium);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-upload:hover:not(:disabled) {
            background: var(--blue);
            color: var(--white);
        }

        .btn-upload:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-remove {
            background: var(--white);
            color: var(--red);
            border: 2px solid var(--red);
            padding: 10px 20px;
            border-radius: var(--border-radius-medium);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-remove:hover:not(:disabled) {
            background: var(--red);
            color: var(--white);
        }

        .upload-hint {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 5px;
        }

        /* Terms Agreement */
        .terms-agreement {
            margin: 10px 0;
        }

        .terms-agreement .link {
            color: var(--blue);
            text-decoration: none;
        }

        .terms-agreement .link:hover {
            text-decoration: underline;
        }

        /* Divider */
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--gray-400);
        }

        .auth-divider::before,
        .auth-divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background: var(--gray-200);
        }

        .auth-divider span {
            padding: 0 15px;
            font-size: 14px;
        }

        /* Google Button */
        .btn-google {
            background: var(--white);
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
            padding: 16px 20px;
            border-radius: var(--border-radius-medium);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
        }

        .btn-google:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-google i {
            color: #DB4437;
        }

        /* Auth Switch Links */
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
            font-size: 15px;
            color: var(--gray-600);
        }

        .auth-switch .link {
            color: var(--blue);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-switch .link:hover {
            text-decoration: underline;
        }

        /* Full Width Button */
        .full-width {
            width: 100%;
        }

        /* ===== BUTTONS ===== */
        .btn-primary {
            background: var(--blue);
            color: var(--white);
            border: none;
            padding: 18px 32px;
            border-radius: var(--border-radius-medium);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: -0.3px;
            position: relative;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--blue-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--blue);
            border: 2px solid var(--blue);
            padding: 16px 32px;
            border-radius: var(--border-radius-medium);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--blue);
            color: var(--white);
        }

        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-danger {
            background: var(--red);
            color: var(--white);
            border: none;
            padding: 16px 32px;
            border-radius: var(--border-radius-medium);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--red-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-danger:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Media Buttons */
        .btn-media {
            background: var(--gray-100);
            color: var(--gray-600);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: var(--border-radius-circle);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all var(--transition-normal);
        }

        .btn-media:hover {
            background: var(--gray-200);
            color: var(--blue);
        }

        /* Link Styling */
        .link {
            color: var(--blue);
            text-decoration: none;
            transition: color var(--transition-normal);
        }

        .link:hover {
            text-decoration: underline;
        }

        /* Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== APP HOME PAGE ===== */
        .app-home {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            background: var(--white);
            position: relative;
        }

        .app-header {
            background: var(--white);
            padding: calc(12px + var(--safe-area-inset-top)) 20px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 0;
            z-index: 100;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-small);
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-info h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .user-id-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-id {
            font-size: 14px;
            color: var(--gray-600);
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            letter-spacing: 0.5px;
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--border-radius-small);
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .copy-btn:hover {
            color: var(--blue);
            background: var(--gray-100);
        }

        /* Status Indicator */
        .status-indicator {
            position: relative;
            cursor: pointer;
            padding: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: var(--border-radius-circle);
            background: var(--green);
            border: 2px solid var(--white);
            box-shadow: 0 0 0 2px var(--green);
        }

        .status-indicator.online .status-dot {
            background: var(--green);
            box-shadow: 0 0 0 2px var(--green);
        }

        .status-indicator.offline .status-dot {
            background: var(--gray-400);
            box-shadow: 0 0 0 2px var(--gray-400);
        }

        .status-indicator.away .status-dot {
            background: var(--orange);
            box-shadow: 0 0 0 2px var(--orange);
        }

        .profile-pic-small {
            width: 36px;
            height: 36px;
            border-radius: var(--border-radius-circle);
            object-fit: cover;
            border: 2px solid var(--gray-200);
            transition: border-color var(--transition-normal);
        }

        .profile-pic-small:hover {
            border-color: var(--blue);
        }

        .profile-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--border-radius-medium);
            transition: background var(--transition-normal);
        }

        .profile-btn:hover {
            background: var(--gray-100);
        }

        /* Navigation */
        .app-nav {
            display: flex;
            justify-content: space-around;
            padding: 12px 20px;
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 64px;
            z-index: 99;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            color: var(--gray-500);
            padding: 8px 16px;
            border-radius: var(--border-radius-medium);
            transition: all var(--transition-normal);
            position: relative;
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: color var(--transition-normal);
        }

        .nav-item.active {
            color: var(--blue);
        }

        .nav-item.active span {
            color: var(--blue);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--blue);
            border-radius: var(--border-radius-circle);
        }

        .nav-item:hover:not(.active) {
            color: var(--gray-700);
            background: var(--gray-100);
        }

        .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--red);
            color: var(--white);
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            animation: badgePulse 2s infinite;
        }

        @keyframes badgePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Main Content */
        .app-main {
            flex: 1;
            overflow-y: auto;
            background: var(--white);
            padding: 20px;
            position: relative;
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        .home-content {
            text-align: center;
            padding: 20px;
        }

        .welcome-message h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 12px;
        }

        .welcome-message p {
            font-size: 18px;
            color: var(--gray-600);
            margin-bottom: 40px;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 40px;
        }

        .quick-action-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-medium);
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .quick-action-card:hover {
            transform: translateY(-2px);
            border-color: var(--blue);
            box-shadow: var(--shadow-medium);
        }

        .quick-action-card i {
            font-size: 32px;
            color: var(--blue);
            margin-bottom: 12px;
        }

        .quick-action-card h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 4px;
        }

        .quick-action-card p {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* Recent Chats Section */
        .recent-chats-section {
            background: var(--white);
            border-radius: var(--border-radius-medium);
            padding: 20px;
            border: 1px solid var(--gray-200);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--black);
        }

        .view-all {
            color: var(--blue);
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            transition: color var(--transition-normal);
        }

        .view-all:hover {
            color: var(--blue-dark);
            text-decoration: underline;
        }

        .recent-chats-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Page Headers */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .page-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--black);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .tabs {
            display: flex;
            background: var(--gray-100);
            border-radius: var(--border-radius-medium);
            padding: 4px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-small);
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .tab-btn.active {
            background: var(--white);
            color: var(--blue);
            box-shadow: var(--shadow-light);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--gray-100);
            border-radius: var(--border-radius-medium);
            padding: 10px 16px;
            width: 250px;
        }

        .search-box i {
            color: var(--gray-500);
            margin-right: 10px;
        }

        .search-box input {
            flex: 1;
            background: none;
            border: none;
            font-size: 16px;
            color: var(--black);
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--gray-400);
        }

        /* ===== CHAT PAGE ===== */
        .chat-page {
            display: none;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            background: var(--white);
            position: relative;
        }

        .chat-header {
            background: var(--white);
            padding: calc(12px + var(--safe-area-inset-top)) 20px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 0;
            z-index: 100;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .chat-back-btn {
            background: none;
            border: none;
            color: var(--blue);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius-circle);
            transition: background var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            margin-right: 12px;
        }

        .chat-back-btn:hover {
            background: var(--gray-100);
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .chat-user-details {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .chat-user-details h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .chat-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: var(--border-radius-circle);
        }

        .chat-status .status-dot.online {
            background: var(--green);
        }

        .chat-status .status-dot.offline {
            background: var(--gray-400);
        }

        .chat-status .status-dot.typing {
            background: var(--blue);
            animation: typingPulse 1.5s infinite;
        }

        @keyframes typingPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--gray-600);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius-circle);
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .icon-btn:hover {
            background: var(--gray-100);
            color: var(--black);
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--white);
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
            scroll-behavior: smooth;
        }

        /* Custom Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }

        /* Empty Chat */
        .empty-chat {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-500);
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .empty-chat i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-chat h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--gray-600);
        }

        .empty-chat p {
            font-size: 16px;
            max-width: 300px;
            margin: 0 auto;
        }

        /* Message Date */
        .message-date {
            text-align: center;
            color: var(--gray-500);
            font-size: 13px;
            font-weight: 600;
            margin: 20px 0;
            padding: 8px 16px;
            background: var(--gray-100);
            border-radius: var(--border-radius-large);
            align-self: center;
            letter-spacing: 0.3px;
        }

        /* Message Bubbles - Apple Messages Style */
        .message {
            display: flex;
            margin-bottom: 4px;
            animation: messageSlide 0.3s ease;
            position: relative;
        }

        .message.sent {
            justify-content: flex-end;
            margin-left: auto;
            max-width: 80%;
        }

        .message.received {
            justify-content: flex-start;
            margin-right: auto;
            max-width: 80%;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: var(--border-radius-large);
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
            box-shadow: var(--shadow-light);
            max-width: 100%;
            position: relative;
            display: inline-block;
        }

        /* Sent Messages - Blue bubbles aligned right */
        .message.sent .message-bubble {
            background: var(--blue);
            color: var(--white);
            border-bottom-right-radius: var(--border-radius-small);
            margin-left: auto;
            border-top-right-radius: var(--border-radius-small);
            border-top-left-radius: var(--border-radius-large);
        }

        /* Received Messages - Gray bubbles aligned left */
        .message.received .message-bubble {
            background: #f1f1f1;
            color: var(--black);
            border-bottom-left-radius: var(--border-radius-small);
            margin-right: auto;
            border-top-left-radius: var(--border-radius-small);
            border-top-right-radius: var(--border-radius-large);
        }

        /* Tail effect for message bubbles */
        .message.sent .message-bubble::after {
            content: '';
            position: absolute;
            right: -8px;
            bottom: 0;
            width: 20px;
            height: 20px;
            background: inherit;
            clip-path: polygon(100% 0, 0 0, 100% 100%);
            border-radius: 0 0 0 8px;
        }

        .message.received .message-bubble::before {
            content: '';
            position: absolute;
            left: -8px;
            bottom: 0;
            width: 20px;
            height: 20px;
            background: inherit;
            clip-path: polygon(0 0, 100% 0, 0 100%);
            border-radius: 0 0 8px 0;
        }

        .message-bubble p {
            font-size: 17px;
            margin-bottom: 4px;
            line-height: 1.4;
            letter-spacing: -0.3px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            display: block;
            text-align: right;
            margin-top: 6px;
            font-weight: 500;
            letter-spacing: 0.2px;
        }

        .message.sent .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .message.received .message-time {
            color: var(--gray-600);
        }

        .message-status {
            font-size: 11px;
            margin-left: 4px;
        }

        /* Media Messages */
        .media-message {
            max-width: 250px;
        }

        .chat-media {
            width: 100%;
            border-radius: var(--border-radius-medium);
            margin-bottom: 8px;
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: transform var(--transition-normal);
        }

        .chat-media:hover {
            transform: scale(1.02);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            margin-bottom: 8px;
            padding-left: 16px;
            animation: fadeIn 0.3s ease;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-bubble {
            background: #f1f1f1;
            border-radius: var(--border-radius-large);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom-left-radius: var(--border-radius-small);
            border-top-left-radius: var(--border-radius-small);
            border-top-right-radius: var(--border-radius-large);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gray-500);
            border-radius: var(--border-radius-circle);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .typing-text {
            font-size: 13px;
            color: var(--gray-600);
            font-weight: 500;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Message Input Area */
        .message-input-area {
            background: var(--white);
            padding: 12px 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            bottom: 0;
            z-index: 100;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            padding-bottom: calc(12px + var(--safe-area-inset-bottom));
        }

        .message-input-container {
            flex: 1;
            background: var(--gray-100);
            border-radius: var(--border-radius-large);
            padding: 0 16px;
            display: flex;
            align-items: center;
            transition: all var(--transition-normal);
            border: 1px solid transparent;
        }

        .message-input-container:focus-within {
            background: var(--white);
            border-color: var(--blue-light);
            box-shadow: 0 0 0 2px rgba(90, 200, 250, 0.1);
        }

        .message-input-container input {
            flex: 1;
            background: none;
            border: none;
            padding: 14px 0;
            font-size: 17px;
            color: var(--black);
            font-family: var(--font-sf-pro);
        }

        .message-input-container input:focus {
            outline: none;
        }

        .message-input-container input::placeholder {
            color: var(--gray-500);
        }

        .send-btn {
            background: var(--blue);
            color: var(--white);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-circle);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
            margin-left: 8px;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--blue-dark);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Attachment Options */
        .attachment-options {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background: var(--white);
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-heavy);
            padding: 12px;
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            z-index: 1000;
            border: 1px solid var(--gray-200);
            animation: slideUp 0.3s ease;
        }

        .attachment-options.show {
            display: grid;
        }

        .attachment-btn {
            background: none;
            border: none;
            padding: 12px 8px;
            border-radius: var(--border-radius-medium);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--black);
            font-size: 13px;
            min-width: 80px;
        }

        .attachment-btn:hover {
            background: var(--gray-100);
            color: var(--blue);
            transform: translateY(-2px);
        }

        .attachment-btn i {
            font-size: 20px;
        }

        /* ===== FLOATING BUTTON ===== */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--blue);
            color: var(--white);
            border: none;
            width: 60px;
            height: 60px;
            border-radius: var(--border-radius-circle);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: var(--shadow-heavy);
            transition: all var(--transition-normal);
            z-index: 1000;
            animation: pulse 2s infinite;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-heavy), 0 0 30px rgba(0, 122, 255, 0.4);
        }

        .floating-btn:active {
            transform: scale(0.95);
        }

        .floating-btn i {
            font-size: 20px;
        }

        .floating-btn span {
            font-size: 10px;
            font-weight: 600;
        }

        @keyframes pulse {
            0% { box-shadow: var(--shadow-heavy); }
            50% { box-shadow: var(--shadow-heavy), 0 0 20px rgba(0, 122, 255, 0.3); }
            100% { box-shadow: var(--shadow-heavy); }
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius-large);
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-heavy);
            animation: modalSlideUp 0.4s ease;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--white);
            border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
            z-index: 1;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--black);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-circle);
            transition: all var(--transition-normal);
        }

        .close-modal:hover {
            background: var(--gray-100);
            color: var(--black);
        }

        .modal-body {
            padding: 24px;
        }

        .search-result {
            margin: 20px 0;
            padding: 20px;
            background: var(--gray-50);
            border-radius: var(--border-radius-medium);
            display: none;
        }

        .search-result.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .search-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--gray-500);
        }

        .search-placeholder i {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .search-placeholder p {
            font-size: 15px;
        }

        .user-found {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border-radius: var(--border-radius-medium);
            border: 1px solid var(--gray-200);
            animation: slideUp 0.3s ease;
        }

        .user-found .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius-circle);
            object-fit: cover;
        }

        .user-found h4 {
            font-size: 17px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 4px;
        }

        .user-found p {
            font-size: 14px;
            color: var(--gray-600);
        }

        .already-contact {
            color: var(--green) !important;
            font-weight: 500;
            margin-top: 4px;
        }

        .error {
            color: var(--red) !important;
            text-align: center;
            padding: 10px;
        }

        /* Character Counter */
        .character-counter {
            text-align: right;
            font-size: 14px;
            color: var(--gray-500);
            margin-top: 8px;
        }

        /* Media Preview */
        .media-preview {
            margin: 16px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 100px;
        }

        .media-preview-content {
            width: 100%;
            text-align: center;
        }

        .preview-item {
            width: 100px;
            height: 100px;
            border-radius: var(--border-radius-small);
            overflow: hidden;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--white);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: var(--border-radius-circle);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-normal);
        }

        .remove-preview:hover {
            background: var(--red);
            transform: scale(1.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .media-buttons {
            display: flex;
            gap: 10px;
        }

        /* ===== LISTS CONTAINERS ===== */
        .requests-container,
        .contacts-container,
        .groups-container,
        .zynes-container,
        .chats-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Request Card */
        .request-card,
        .contact-card,
        .group-card,
        .zyne-card,
        .chat-card {
            background: var(--white);
            border-radius: var(--border-radius-medium);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid var(--gray-200);
            transition: all var(--transition-normal);
            cursor: pointer;
            animation: fadeIn 0.3s ease;
        }

        .request-card:hover,
        .contact-card:hover,
        .group-card:hover,
        .zyne-card:hover,
        .chat-card:hover {
            border-color: var(--blue);
            box-shadow: var(--shadow-light);
            transform: translateY(-1px);
        }

        .request-card .profile-pic,
        .contact-card .profile-pic,
        .group-card .profile-pic,
        .zyne-card .profile-pic,
        .chat-card .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius-circle);
            object-fit: cover;
        }

        .group-card .profile-pic {
            border-radius: var(--border-radius-medium);
        }

        .request-info,
        .contact-info,
        .group-info,
        .zyne-info,
        .chat-info {
            flex: 1;
        }

        .request-info h4,
        .contact-info h4,
        .group-info h4,
        .zyne-info h4,
        .chat-info h4 {
            font-size: 17px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 4px;
        }

        .request-info p,
        .contact-info p,
        .group-info p,
        .zyne-info p,
        .chat-info p {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 2px;
        }

        .request-info .time,
        .contact-info .time,
        .group-info .time,
        .zyne-info .time,
        .chat-info .time {
            font-size: 13px;
            color: var(--gray-500);
        }

        .contact-info .status {
            font-size: 13px;
            font-weight: 500;
        }

        .contact-info .status.online {
            color: var(--green);
        }

        .contact-info .status.offline {
            color: var(--gray-500);
        }

        .request-actions,
        .contact-actions,
        .group-actions,
        .zyne-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: var(--border-radius-medium);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .accept-btn {
            background: var(--green);
            color: var(--white);
        }

        .accept-btn:hover {
            background: #2db34a;
            transform: translateY(-1px);
        }

        .reject-btn {
            background: var(--red);
            color: var(--white);
        }

        .reject-btn:hover {
            background: #e53935;
            transform: translateY(-1px);
        }

        .chat-btn {
            background: var(--blue);
            color: var(--white);
        }

        .chat-btn:hover {
            background: var(--blue-dark);
            transform: translateY(-1px);
        }

        /* ===== DROPDOWNS ===== */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--white);
            min-width: 220px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            border: 1px solid var(--gray-200);
            animation: dropdownFade 0.2s ease;
            margin-top: 8px;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .dropdown-profile-pic {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-circle);
            object-fit: cover;
        }

        .dropdown-profile-info {
            display: flex;
            flex-direction: column;
        }

        .dropdown-profile-info strong {
            font-size: 15px;
            color: var(--black);
            margin-bottom: 2px;
        }

        .dropdown-profile-info span {
            font-size: 13px;
            color: var(--gray-600);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 8px 0;
        }

        .dropdown-content a,
        .dropdown-content button {
            color: var(--black);
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            transition: all var(--transition-normal);
            border-bottom: 1px solid var(--gray-100);
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-family: var(--font-sf-pro);
        }

        .dropdown-content a:last-child,
        .dropdown-content button:last-child {
            border-bottom: none;
        }

        .dropdown-content a:hover,
        .dropdown-content button:hover {
            background: var(--gray-100);
            color: var(--blue);
        }

        .logout-link {
            color: var(--red) !important;
        }

        .logout-link:hover {
            color: var(--white) !important;
            background: var(--red) !important;
        }

        /* ===== ZYNES (STATUS) PAGE ===== */
        .zynes-page {
            padding: 20px;
        }

        .zyne-card {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .zyne-content {
            flex: 1;
        }

        .zyne-media {
            width: 100%;
            max-width: 300px;
            border-radius: var(--border-radius-medium);
            margin-top: 10px;
            cursor: pointer;
        }

        .zyne-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .zyne-time {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 8px;
        }

        /* Create Zyne Button */
        .create-zyne-btn {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: var(--blue);
            color: var(--white);
            border: none;
            width: 56px;
            height: 56px;
            border-radius: var(--border-radius-circle);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-heavy);
            z-index: 999;
        }

        /* ===== GROUPS PAGE ===== */
        .groups-page {
            padding: 20px;
        }

        .create-group-btn {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: var(--blue);
            color: var(--white);
            border: none;
            width: 56px;
            height: 56px;
            border-radius: var(--border-radius-circle);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-heavy);
            z-index: 999;
        }

        /* Members Container */
        .members-container {
            margin: 20px 0;
            background: var(--gray-50);
            border-radius: var(--border-radius-medium);
            padding: 20px;
        }

        .members-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .members-header h4 {
            font-size: 17px;
            font-weight: 600;
            color: var(--black);
        }

        .members-count {
            font-size: 14px;
            color: var(--gray-600);
        }

        .members-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 60px;
        }

        .empty-members {
            width: 100%;
            text-align: center;
            padding: 20px;
            color: var(--gray-500);
        }

        .empty-members i {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .empty-members p {
            font-size: 15px;
        }

        .member-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-large);
            padding: 8px 12px;
            font-size: 14px;
            color: var(--gray-700);
            animation: slideUp 0.3s ease;
        }

        .remove-member {
            background: none;
            border: none;
            color: var(--gray-500);
            cursor: pointer;
            padding: 2px;
            border-radius: var(--border-radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            transition: all var(--transition-normal);
        }

        .remove-member:hover {
            color: var(--red);
            background: var(--gray-100);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: var(--black);
            color: var(--white);
            padding: 16px 20px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-heavy);
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
            max-width: 100%;
        }

        .toast::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            animation: toastProgress 3s linear forwards;
        }

        .toast.success {
            background: var(--green);
        }

        .toast.error {
            background: var(--red);
        }

        .toast.warning {
            background: var(--orange);
        }

        .toast.info {
            background: var(--blue);
        }

        .toast i {
            font-size: 20px;
        }

        .toast span {
            flex: 1;
            font-size: 15px;
            line-height: 1.4;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--gray-600);
        }

        .empty-state p {
            font-size: 16px;
            max-width: 300px;
            margin: 0 auto;
            line-height: 1.4;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .auth-form {
                padding: 24px;
            }
            
            .app-nav span {
                display: none;
            }
            
            .app-nav {
                justify-content: space-between;
                padding: 12px 16px;
            }
            
            .nav-item {
                padding: 12px;
            }
            
            .nav-item.active::after {
                bottom: -8px;
            }
            
            .message-bubble {
                max-width: 85%;
            }
            
            .floating-btn span {
                display: none;
            }
            
            .floating-btn {
                width: 56px;
                height: 56px;
                bottom: 20px;
                right: 20px;
            }
            
            .quick-actions {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .search-box {
                width: 200px;
            }
            
            .attachment-options {
                grid-template-columns: repeat(2, 1fr);
                left: 10px;
                right: 10px;
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                max-height: 85vh;
            }
            
            .toast-container {
                left: 20px;
                right: 20px;
                max-width: none;
            }
            
            .toast {
                max-width: 100%;
            }
            
            .create-zyne-btn,
            .create-group-btn {
                bottom: 90px;
                right: 20px;
            }
        }

        @media (max-width: 480px) {
            .welcome-screen h1 {
                font-size: 36px;
            }
            
            .auth-header h2 {
                font-size: 24px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .page-header h2 {
                font-size: 24px;
            }
            
            .header-actions {
                width: 100%;
            }
            
            .search-box {
                width: 100%;
            }
            
            .chat-messages {
                padding: 16px;
            }
            
            .message-input-area {
                padding: 12px 16px;
            }
            
            .chat-header {
                padding: 12px 16px;
            }
            
            .modal-content {
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-header {
                padding: 20px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .profile-upload-container {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .upload-buttons {
                width: 100%;
            }
            
            .message.sent,
            .message.received {
                max-width: 90%;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10;
            border-radius: inherit;
        }

        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .nav-item:hover:not(.active) {
                background: transparent;
            }
            
            .copy-btn:hover,
            .icon-btn:hover,
            .profile-btn:hover {
                background: transparent;
            }
            
            .btn-primary:hover:not(:disabled),
            .btn-secondary:hover:not(:disabled),
            .btn-danger:hover:not(:disabled) {
                transform: none;
            }
            
            .floating-btn:hover {
                transform: none;
            }
            
            .request-card:hover,
            .contact-card:hover,
            .group-card:hover {
                transform: none;
            }
            
            .attachment-btn:hover {
                transform: none;
            }
            
            .chat-media:hover {
                transform: none;
            }
            
            .action-btn:hover {
                transform: none;
            }
            
            .remove-preview:hover {
                transform: none;
            }
            
            input,
            textarea,
            select,
            button {
                font-size: 16px !important;
            }
        }

        /* Print Styles */
        @media print {
            .floating-btn,
            .message-input-area,
            .app-nav,
            .profile-btn,
            .copy-btn,
            .back-btn,
            .icon-btn,
            .close-modal,
            .toast-container,
            .attachment-options,
            .create-zyne-btn,
            .create-group-btn {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .app-main {
                padding: 0 !important;
            }
            
            .chat-messages {
                height: auto !important;
                overflow: visible !important;
            }
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --blue: #0040ff;
                --green: #008000;
                --red: #c00000;
                --gray-500: #000000;
            }
            
            .input-group input {
                border-width: 3px;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .app-home,
            .chat-page {
                height: -webkit-fill-available;
            }
            
            .chat-messages {
                -webkit-overflow-scrolling: touch;
            }
            
            input,
            textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <img src="zynaps.png" alt="Zynapse Logo" class="loading-logo">
            <div class="spinner-large"></div>
            <p>Loading Zynapse...</p>
        </div>
    </div>

    <!-- Authentication Pages -->
    <div class="auth-page" id="authPage">
        <div class="auth-container">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <img src="zynaps.png" alt="Zynapse Logo" class="logo-large">
                <h1>Zynapse</h1>
                <p class="tagline">Secure, private messaging for Zambia</p>
                <p class="powered-by">Powered by Buffer Zone</p>
                
                <div class="welcome-actions">
                    <button class="btn-primary full-width" onclick="showAuthForm('signup')">
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                    <button class="btn-secondary full-width" onclick="showAuthForm('login')">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                </div>
                
                <div class="welcome-footer">
                    By continuing, you agree to our 
                    <a href="#" class="link" onclick="showTerms()">Terms of Service</a> and 
                    <a href="#" class="link" onclick="showPrivacy()">Privacy Policy</a>
                </div>
            </div>

            <!-- Sign Up Form -->
            <div class="auth-form" id="signupForm" style="display: none;">
                <div class="auth-header">
                    <button class="back-btn" onclick="showWelcomeScreen()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" alt="Zynapse Logo" class="logo-small">
                    <h2>Create Account</h2>
                    <p>Join Zynapse today</p>
                </div>

                <form class="auth-form-content" id="signupFormElement" onsubmit="handleSignUp(event)">
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="signupName" placeholder="Full Name" required>
                    </div>

                    <div class="input-group">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="signupPhone" placeholder="Phone Number (+260)" required pattern="^\+260[0-9]{9}$">
                    </div>

                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="signupEmail" placeholder="Email Address" required>
                    </div>

                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="signupPassword" placeholder="Password" required minlength="6">
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('signupPassword', this)"></i>
                    </div>

                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('signupConfirmPassword', this)"></i>
                    </div>

                    <div class="profile-upload-section">
                        <label class="upload-label">Profile Picture</label>
                        <div class="profile-upload-container">
                            <div class="upload-preview" id="profilePreview">
                                <div class="preview-placeholder">
                                    <i class="fas fa-user-circle"></i>
                                    <span>No image selected</span>
                                    <p>JPG, PNG, GIF up to 5MB</p>
                                </div>
                            </div>
                            <div class="upload-buttons">
                                <button type="button" class="btn-upload" onclick="openCloudinaryUpload()">
                                    <i class="fas fa-upload"></i>
                                    Upload Photo
                                </button>
                                <button type="button" class="btn-remove" onclick="removeProfilePicture()" style="display: none;">
                                    <i class="fas fa-trash"></i>
                                    Remove
                                </button>
                            </div>
                        </div>
                        <p class="upload-hint">Your profile picture will be visible to your contacts</p>
                    </div>

                    <div class="terms-agreement">
                        <label class="checkbox-container">
                            <input type="checkbox" id="termsAgreement" required>
                            <span class="checkmark"></span>
                            I agree to the <a href="#" class="link" onclick="showTerms()">Terms of Service</a> and 
                            <a href="#" class="link" onclick="showPrivacy()">Privacy Policy</a>
                        </label>
                    </div>

                    <button type="submit" class="btn-primary full-width" id="signupSubmit">
                        <span>Create Account</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>

                    <div class="auth-divider">
                        <span>Or</span>
                    </div>

                    <button type="button" class="btn-google" onclick="signInWithGoogle()">
                        <i class="fab fa-google"></i>
                        Continue with Google
                    </button>

                    <div class="auth-switch">
                        Already have an account? 
                        <a href="#" class="link" onclick="showAuthForm('login')">Sign In</a>
                    </div>
                </form>
            </div>

            <!-- Login Form -->
            <div class="auth-form" id="loginForm" style="display: none;">
                <div class="auth-header">
                    <button class="back-btn" onclick="showWelcomeScreen()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" alt="Zynapse Logo" class="logo-small">
                    <h2>Welcome Back</h2>
                    <p>Sign in to your account</p>
                </div>

                <form class="auth-form-content" id="loginFormElement" onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="loginEmail" placeholder="Email Address" required>
                    </div>

                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('loginPassword', this)"></i>
                    </div>

                    <div class="form-options">
                        <label class="checkbox-container">
                            <input type="checkbox" id="rememberMe">
                            <span class="checkmark"></span>
                            Remember me
                        </label>
                        <a href="#" class="link" onclick="showForgotPassword()">Forgot Password?</a>
                    </div>

                    <button type="submit" class="btn-primary full-width" id="loginSubmit">
                        <span>Sign In</span>
                        <div class="spinner" style="display: none;"></div>
                    </button>

                    <div class="auth-divider">
                        <span>Or</span>
                    </div>

                    <button type="button" class="btn-google" onclick="signInWithGoogle()">
                        <i class="fab fa-google"></i>
                        Continue with Google
                    </button>

                    <div class="auth-switch">
                        Don't have an account? 
                        <a href="#" class="link" onclick="showAuthForm('signup')">Create Account</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- App Home Page -->
    <div class="app-home" id="appHome">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <img src="zynaps.png" alt="Zynapse Logo" class="header-logo">
                <div class="user-info">
                    <h2 id="userNameDisplay">Loading...</h2>
                    <div class="user-id-container">
                        <span class="user-id" id="userIdDisplay">ZYN-0000</span>
                        <button class="copy-btn" onclick="copyUserId()" title="Copy User ID">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="status-indicator online" id="statusIndicator" onclick="toggleStatus()">
                    <div class="status-dot"></div>
                </div>
                
                <button class="profile-btn" onclick="toggleProfileDropdown()">
                    <img src="" alt="Profile" class="profile-pic-small" id="userProfilePic">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </header>

        <!-- Profile Dropdown -->
        <div class="dropdown">
            <div class="dropdown-content" id="profileDropdown">
                <div class="dropdown-profile">
                    <img src="" alt="Profile" class="dropdown-profile-pic" id="dropdownProfilePic">
                    <div class="dropdown-profile-info">
                        <strong id="dropdownUserName">Loading...</strong>
                        <span id="dropdownUserId">ZYN-0000</span>
                    </div>
                </div>
                
                <div class="dropdown-divider"></div>
                
                <a href="#" onclick="showEditProfile()">
                    <i class="fas fa-user-edit"></i>
                    Edit Profile
                </a>
                
                <a href="#" onclick="showSettings()">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
                
                <a href="#" onclick="showPrivacySettings()">
                    <i class="fas fa-shield-alt"></i>
                    Privacy
                </a>
                
                <a href="#" onclick="showNotificationsSettings()">
                    <i class="fas fa-bell"></i>
                    Notifications
                </a>
                
                <div class="dropdown-divider"></div>
                
                <a href="#" class="logout-link" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Log Out
                </a>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="app-nav">
            <a href="#" class="nav-item active" data-page="home" onclick="switchPage('home')">
                <i class="fas fa-home"></i>
                <span>HOME</span>
            </a>
            
            <a href="#" class="nav-item" data-page="zynes" onclick="switchPage('zynes')">
                <i class="fas fa-circle"></i>
                <span>ZYNES</span>
                <span class="badge" id="zynesBadge" style="display: none;">0</span>
            </a>
            
            <a href="#" class="nav-item" data-page="groups" onclick="switchPage('groups')">
                <i class="fas fa-users"></i>
                <span>GROUPS</span>
                <span class="badge" id="groupsBadge" style="display: none;">0</span>
            </a>
            
            <a href="#" class="nav-item" data-page="requests" onclick="switchPage('requests')">
                <i class="fas fa-user-plus"></i>
                <span>REQUESTS</span>
                <span class="badge" id="requestsBadge" style="display: none;">0</span>
            </a>
            
            <a href="#" class="nav-item" data-page="contacts" onclick="switchPage('contacts')">
                <i class="fas fa-address-book"></i>
                <span>CONTACTS</span>
            </a>
        </nav>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Home Page -->
            <div class="page active" id="homePage">
                <div class="home-content">
                    <div class="welcome-message">
                        <h1>Welcome to Zynapse</h1>
                        <p>Secure messaging for Zambia</p>
                    </div>
                    
                    <div class="quick-actions">
                        <div class="quick-action-card" onclick="openStartChatModal()">
                            <i class="fas fa-comment-medical"></i>
                            <h3>New Chat</h3>
                            <p>Start a new conversation</p>
                        </div>
                        
                        <div class="quick-action-card" onclick="switchPage('groups')">
                            <i class="fas fa-users"></i>
                            <h3>Create Group</h3>
                            <p>Start a group chat</p>
                        </div>
                        
                        <div class="quick-action-card" onclick="switchPage('zynes')">
                            <i class="fas fa-circle"></i>
                            <h3>Post Zyne</h3>
                            <p>Share your status</p>
                        </div>
                        
                        <div class="quick-action-card" onclick="showSettings()">
                            <i class="fas fa-cog"></i>
                            <h3>Settings</h3>
                            <p>Customize your app</p>
                        </div>
                    </div>
                    
                    <div class="recent-chats-section">
                        <div class="section-header">
                            <h3>Recent Chats</h3>
                            <a href="#" class="view-all" onclick="switchPage('chats')">View All</a>
                        </div>
                        
                        <div class="recent-chats-list" id="recentChatsList">
                            <!-- Recent chats will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zynes Page -->
            <div class="page" id="zynesPage">
                <div class="page-header">
                    <h2>Zynes</h2>
                    <div class="header-actions">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search Zynes..." id="searchZynes">
                        </div>
                    </div>
                </div>
                
                <div class="zynes-container" id="zynesContainer">
                    <!-- Zynes will be loaded here -->
                </div>
                
                <button class="create-zyne-btn" onclick="openCreateZyneModal()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <!-- Groups Page -->
            <div class="page" id="groupsPage">
                <div class="page-header">
                    <h2>Groups</h2>
                    <div class="header-actions">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search groups..." id="searchGroups">
                        </div>
                    </div>
                </div>
                
                <div class="groups-container" id="groupsContainer">
                    <!-- Groups will be loaded here -->
                </div>
                
                <button class="create-group-btn" onclick="openCreateGroupModal()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <!-- Chat Requests Page -->
            <div class="page" id="requestsPage">
                <div class="page-header">
                    <h2>Chat Requests</h2>
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchRequestsTab('incoming')">Incoming</button>
                        <button class="tab-btn" onclick="switchRequestsTab('sent')">Sent</button>
                    </div>
                </div>
                
                <div class="requests-container" id="incomingRequests">
                    <!-- Incoming requests will be loaded here -->
                </div>
                
                <div class="requests-container" id="sentRequests" style="display: none;">
                    <!-- Sent requests will be loaded here -->
                </div>
            </div>

            <!-- Contacts Page -->
            <div class="page" id="contactsPage">
                <div class="page-header">
                    <h2>Contacts</h2>
                    <div class="header-actions">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search contacts..." id="searchContacts" oninput="searchContacts()">
                        </div>
                        <button class="icon-btn" onclick="openAddContactModal()">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="contacts-container" id="contactsContainer">
                    <!-- Contacts will be loaded here -->
                </div>
            </div>
        </main>

        <!-- Floating Start Chat Button -->
        <button class="floating-btn" onclick="openStartChatModal()">
            <i class="fas fa-comment"></i>
            <span>Chat</span>
        </button>
    </div>

    <!-- Chat Page -->
    <div class="chat-page" id="chatPage">
        <!-- Chat Header -->
        <header class="chat-header">
            <button class="chat-back-btn" onclick="goBackToHome()">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="chat-user-info" onclick="showChatProfile()">
                <img src="" alt="Profile" class="profile-pic-small" id="chatUserPic">
                <div class="chat-user-details">
                    <h3 id="chatUserName">Loading...</h3>
                    <div class="chat-status">
                        <div class="status-dot" id="chatUserStatus"></div>
                        <span id="chatUserStatusText">Loading...</span>
                    </div>
                </div>
            </div>
            
            <div class="chat-header-actions">
                <button class="icon-btn" onclick="toggleChatDropdown()">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </header>

        <!-- Chat Dropdown -->
        <div class="dropdown">
            <div class="dropdown-content" id="chatDropdown">
                <button onclick="addNickname()">
                    <i class="fas fa-tag"></i>
                    Add Nickname
                </button>
                
                <button onclick="toggleFavorite()">
                    <i class="fas fa-star"></i>
                    <span id="favoriteText">Add to Favorites</span>
                </button>
                
                <button onclick="showChatInfo()">
                    <i class="fas fa-info-circle"></i>
                    Chat Info
                </button>
                
                <div class="dropdown-divider"></div>
                
                <button onclick="toggleBlockUser()">
                    <i class="fas fa-ban"></i>
                    <span id="blockText">Block User</span>
                </button>
                
                <button onclick="openReportModal()">
                    <i class="fas fa-flag"></i>
                    Report User
                </button>
                
                <div class="dropdown-divider"></div>
                
                <button onclick="clearChatHistory()" class="logout-link">
                    <i class="fas fa-trash"></i>
                    Clear Chat
                </button>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be loaded here -->
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-bubble">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span class="typing-text">typing...</span>
            </div>
        </div>

        <!-- Message Input Area -->
        <div class="message-input-area">
            <button class="icon-btn" onclick="toggleAttachmentOptions()">
                <i class="fas fa-plus"></i>
            </button>
            
            <div class="message-input-container">
                <input type="text" placeholder="iMessage" id="messageInput" 
                       oninput="handleTyping()" 
                       onkeypress="handleMessageKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <button class="icon-btn" onclick="toggleEmojiPicker()">
                <i class="far fa-smile"></i>
            </button>
        </div>

        <!-- Attachment Options -->
        <div class="attachment-options" id="attachmentOptions">
            <button class="attachment-btn" onclick="attachPhoto()">
                <i class="fas fa-image"></i>
                <span>Photo</span>
            </button>
            
            <button class="attachment-btn" onclick="attachVideo()">
                <i class="fas fa-video"></i>
                <span>Video</span>
            </button>
            
            <button class="attachment-btn" onclick="attachFile()">
                <i class="fas fa-file"></i>
                <span>File</span>
            </button>
            
            <button class="attachment-btn" onclick="attachLocation()">
                <i class="fas fa-map-marker-alt"></i>
                <span>Location</span>
            </button>
            
            <button class="attachment-btn" onclick="attachContact()">
                <i class="fas fa-user"></i>
                <span>Contact</span>
            </button>
            
            <button class="attachment-btn" onclick="attachAudio()">
                <i class="fas fa-microphone"></i>
                <span>Audio</span>
            </button>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- Start Chat Modal -->
    <div class="modal-overlay" id="startChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Chat</h3>
                <button class="close-modal" onclick="closeStartChatModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchUserId" placeholder="Enter User ID (ZYN-XXXX)" 
                           oninput="searchUserById()">
                </div>
                
                <div class="search-result" id="userSearchResult">
                    <div class="search-placeholder" id="searchPlaceholder">
                        <i class="fas fa-search"></i>
                        <p>Enter a User ID to search</p>
                    </div>
                    
                    <div class="user-found" id="userFound" style="display: none;">
                        <img src="" alt="Profile" class="profile-pic" id="foundUserPic">
                        <div class="user-info">
                            <h4 id="foundUserName">John Doe</h4>
                            <p id="foundUserId">ZYN-1234</p>
                            <p id="foundUserStatus" class="already-contact"></p>
                        </div>
                    </div>
                    
                    <div class="error" id="searchError" style="display: none;"></div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeStartChatModal()">
                        Cancel
                    </button>
                    <button class="btn-primary" id="sendRequestBtn" onclick="sendChatRequest()" disabled>
                        Send Chat Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal-overlay" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Group</h3>
                <button class="close-modal" onclick="closeCreateGroupModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <i class="fas fa-users"></i>
                    <input type="text" id="groupName" placeholder="Group Name" required>
                </div>
                
                <div class="profile-upload-section">
                    <label class="upload-label">Group Photo (Optional)</label>
                    <div class="profile-upload-container">
                        <div class="upload-preview" id="groupPhotoPreview">
                            <div class="preview-placeholder">
                                <i class="fas fa-users"></i>
                                <span>No image selected</span>
                                <p>JPG, PNG, GIF up to 5MB</p>
                            </div>
                        </div>
                        <div class="upload-buttons">
                            <button type="button" class="btn-upload" onclick="openCloudinaryUpload('group')">
                                <i class="fas fa-upload"></i>
                                Upload Photo
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="members-container">
                    <div class="members-header">
                        <h4>Add Members</h4>
                        <span class="members-count" id="membersCount">0 members</span>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchMemberId" placeholder="Search by User ID" 
                               oninput="searchMemberById()">
                    </div>
                    
                    <div class="members-list" id="membersList">
                        <div class="empty-members">
                            <i class="fas fa-user-plus"></i>
                            <p>Add members using their User ID</p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeCreateGroupModal()">
                        Cancel
                    </button>
                    <button class="btn-primary" onclick="createGroup()" id="createGroupBtn">
                        Create Group
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Zyne Modal -->
    <div class="modal-overlay" id="createZyneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Zyne</h3>
                <button class="close-modal" onclick="closeCreateZyneModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <i class="fas fa-pen"></i>
                    <textarea id="zyneText" placeholder="What's on your mind?" rows="4"></textarea>
                    <div class="character-counter">
                        <span id="zyneCharCount">0/500</span>
                    </div>
                </div>
                
                <div class="media-preview" id="zyneMediaPreview">
                    <div class="media-preview-content">
                        <div class="empty-members">
                            <i class="fas fa-image"></i>
                            <p>Add photo or video (optional)</p>
                        </div>
                    </div>
                </div>
                
                <div class="media-buttons">
                    <button class="btn-media" onclick="attachZynePhoto()">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="btn-media" onclick="attachZyneVideo()">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="btn-media" onclick="removeZyneMedia()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeCreateZyneModal()">
                        Cancel
                    </button>
                    <button class="btn-primary" onclick="createZyne()" id="createZyneBtn">
                        Post Zyne
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div class="modal-overlay" id="addContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Contact</h3>
                <button class="close-modal" onclick="closeAddContactModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="input-group">
                    <i class="fas fa-search"></i>
                    <input type="text" id="addContactUserId" placeholder="Enter User ID (ZYN-XXXX)" 
                           oninput="searchContactById()">
                </div>
                
                <div class="search-result" id="contactSearchResult">
                    <div class="search-placeholder" id="contactSearchPlaceholder">
                        <i class="fas fa-search"></i>
                        <p>Enter a User ID to search</p>
                    </div>
                    
                    <div class="user-found" id="contactFound" style="display: none;">
                        <img src="" alt="Profile" class="profile-pic" id="foundContactPic">
                        <div class="user-info">
                            <h4 id="foundContactName">John Doe</h4>
                            <p id="foundContactId">ZYN-1234</p>
                            <p id="foundContactStatus" class="already-contact"></p>
                        </div>
                    </div>
                    
                    <div class="error" id="contactSearchError" style="display: none;"></div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeAddContactModal()">
                        Cancel
                    </button>
                    <button class="btn-primary" id="addContactBtn" onclick="addContact()" disabled>
                        Add Contact
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report User</h3>
                <button class="close-modal" onclick="closeReportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="confirmation-message">
                    <div class="warning-icon">
                        <i class="fas fa-flag"></i>
                    </div>
                    <h4>Report Inappropriate Behavior</h4>
                    <p>Please select the reason for reporting this user. Your report will be reviewed by our moderation team.</p>
                </div>
                
                <form class="report-form" id="reportForm" onsubmit="submitReport(event)">
                    <div class="input-group">
                        <label>Reason for Reporting</label>
                        <select id="reportReason" required>
                            <option value="">Select a reason</option>
                            <option value="spam">Spam or misleading content</option>
                            <option value="harassment">Harassment or bullying</option>
                            <option value="inappropriate">Inappropriate content</option>
                            <option value="impersonation">Impersonation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Additional Details (Optional)</label>
                        <textarea id="reportDetails" placeholder="Please provide any additional information..." rows="4"></textarea>
                        <div class="character-counter">
                            <span id="reportCharCount">0/1000</span>
                        </div>
                    </div>
                    
                    <div class="form-hint">
                        <i class="fas fa-info-circle"></i>
                        Your report is anonymous. The reported user won't know who reported them.
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" onclick="closeReportModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn-danger" id="submitReportBtn">
                            Submit Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-modal" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="settings-section">
                    <h4>Account</h4>
                    <div class="settings-list">
                        <button class="settings-item" onclick="showEditProfile()">
                            <i class="fas fa-user-edit"></i>
                            <span>Edit Profile</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <button class="settings-item" onclick="showPrivacySettings()">
                            <i class="fas fa-shield-alt"></i>
                            <span>Privacy & Security</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <button class="settings-item" onclick="showNotificationsSettings()">
                            <i class="fas fa-bell"></i>
                            <span>Notifications</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4>Chat Settings</h4>
                    <div class="settings-list">
                        <button class="settings-item" onclick="showChatSettings()">
                            <i class="fas fa-comment"></i>
                            <span>Chat Preferences</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <button class="settings-item" onclick="showMediaSettings()">
                            <i class="fas fa-image"></i>
                            <span>Media & Storage</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4>About</h4>
                    <div class="settings-list">
                        <button class="settings-item" onclick="showAbout()">
                            <i class="fas fa-info-circle"></i>
                            <span>About Zynapse</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <button class="settings-item" onclick="showHelp()">
                            <i class="fas fa-question-circle"></i>
                            <span>Help & Support</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn-danger full-width" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Log Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hidden file inputs -->
    <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
    <input type="file" id="videoUpload" accept="video/*" style="display: none;" onchange="handleVideoUpload(event)">
    <input type="file" id="fileUpload" accept="*" style="display: none;" onchange="handleFileUpload(event)">
    <input type="file" id="zynePhotoUpload" accept="image/*" style="display: none;" onchange="handleZynePhotoUpload(event)">
    <input type="file" id="zyneVideoUpload" accept="video/*" style="display: none;" onchange="handleZyneVideoUpload(event)">

    <!-- Audio element for notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="notification.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
            authDomain: "zynapse-68181.firebaseapp.com",
            databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
            projectId: "zynapse-68181",
            storageBucket: "zynapse-68181.firebasestorage.app",
            messagingSenderId: "841353050519",
            appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
            measurementId: "G-4764XLL6WS"
        };

        // ===== CLOUDINARY ACCOUNT DETAILS =====
        const CLOUDINARY_ACCOUNT = {
            cloudName: 'dd3lcymrk',
            apiKey: '489857926297197',
            apiSecret: 'RHDQG1YP6jqvn4UADq3nJWHIeHQ',
            uploadPreset: 'h3eyhc2o',
            folder: 'zynapse/users',
            environmentVariable: 'CLOUDINARY_URL=cloudinary://489857926297197:RHDQG1YP6jqvn4UADq3nJWHIeHQ@dd3lcymrk',
            accountType: 'cloudinary'
        };

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let currentChatId = null;
        let currentChatType = null; // 'individual' or 'group'
        let currentChatUser = null;
        let userData = null;
        let typingTimeout = null;
        let isTyping = false;
        let cloudinaryWidget = null;
        let pendingUploadType = null; // 'profile', 'group', 'message', 'zyne'
        let pendingMedia = {
            type: null,
            url: null,
            publicId: null
        };
        let zyneMedia = null;
        let groupMembers = [];
        let notificationsEnabled = true;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Initialize Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }

            // Check if user is already logged in
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    loadUserData();
                } else {
                    // User is signed out
                    showAuthPage();
                }
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 500);
            });

            // Initialize Cloudinary widget
            initializeCloudinary();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for service worker support for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
            
            // Prevent pull-to-refresh on mobile
            document.body.addEventListener('touchmove', function(e) {
                if (e.touches.length > 1) e.preventDefault();
            }, { passive: false });
        }

        function setupEventListeners() {
            // Character counters
            document.getElementById('zyneText')?.addEventListener('input', updateZyneCharCount);
            document.getElementById('reportDetails')?.addEventListener('input', updateReportCharCount);
            
            // Search functionality
            document.getElementById('searchContacts')?.addEventListener('input', searchContacts);
            document.getElementById('searchGroups')?.addEventListener('input', searchGroups);
            document.getElementById('searchZynes')?.addEventListener('input', searchZynes);
            
            // Modal close on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // Prevent form submission on enter in textareas
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                    }
                });
            });
        }

        // ===== AUTHENTICATION FUNCTIONS =====
        function showWelcomeScreen() {
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
        }

        function showAuthForm(formType) {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('signupForm').style.display = formType === 'signup' ? 'block' : 'none';
            document.getElementById('loginForm').style.display = formType === 'login' ? 'block' : 'none';
        }

        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        async function handleSignUp(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const profilePic = pendingMedia.url || 'https://via.placeholder.com/150';
            
            // Validation
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (!phone.match(/^\+260[0-9]{9}$/)) {
                showToast('Please enter a valid Zambian phone number (+260XXXXXXXXX)', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('signupSubmit');
            const spinner = submitBtn.querySelector('.spinner');
            const buttonText = submitBtn.querySelector('span');
            
            // Show loading state
            buttonText.textContent = 'Creating Account...';
            spinner.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                // Create user in Firebase Auth
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Generate user ID
                const userId = generateUserId();
                
                // Prepare user data
                const userData = {
                    uid: user.uid,
                    userId: userId,
                    name: name,
                    email: email,
                    phone: phone,
                    profilePic: profilePic,
                    createdAt: Date.now(),
                    lastSeen: Date.now(),
                    status: 'online',
                    contacts: {},
                    blockedUsers: {},
                    favorites: {},
                    settings: {
                        notifications: true,
                        privacy: {
                            showStatus: true,
                            showLastSeen: true,
                            showProfilePic: true
                        }
                    }
                };
                
                // Save user data to Firebase
                await firebase.database().ref('users/' + userId).set(userData);
                await firebase.database().ref('userEmails/' + user.uid).set(userId);
                
                // Update current user
                currentUser = user;
                loadUserData();
                
                showToast('Account created successfully!', 'success');
                
            } catch (error) {
                console.error('Sign up error:', error);
                let errorMessage = 'Failed to create account. ';
                
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'Email already in use.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'Password is too weak.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showToast(errorMessage, 'error');
            } finally {
                // Reset button state
                buttonText.textContent = 'Create Account';
                spinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        function generateUserId() {
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `ZYN-${randomNum}`;
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const submitBtn = document.getElementById('loginSubmit');
            const spinner = submitBtn.querySelector('.spinner');
            const buttonText = submitBtn.querySelector('span');
            
            // Show loading state
            buttonText.textContent = 'Signing In...';
            spinner.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                await firebase.auth().signInWithEmailAndPassword(email, password);
                showToast('Signed in successfully!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Failed to sign in. ';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage += 'Invalid email or password.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += 'Too many failed attempts. Please try again later.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showToast(errorMessage, 'error');
            } finally {
                // Reset button state
                buttonText.textContent = 'Sign In';
                spinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function signInWithGoogle() {
            // Note: Google sign-in requires additional setup in Firebase Console
            showToast('Google sign-in requires additional configuration', 'warning');
            // Implementation would require enabling Google provider in Firebase Console
            // and adding the necessary OAuth credentials
        }

        function showForgotPassword() {
            const email = prompt('Please enter your email address:');
            if (email) {
                firebase.auth().sendPasswordResetEmail(email)
                    .then(() => {
                        showToast('Password reset email sent!', 'success');
                    })
                    .catch(error => {
                        showToast('Error sending reset email: ' + error.message, 'error');
                    });
            }
        }

        // ===== USER DATA MANAGEMENT =====
        async function loadUserData() {
            try {
                // Get user ID from userEmails reference
                const userIdRef = await firebase.database().ref('userEmails/' + currentUser.uid).once('value');
                const userId = userIdRef.val();
                
                if (!userId) {
                    showToast('User data not found. Please contact support.', 'error');
                    await firebase.auth().signOut();
                    return;
                }
                
                // Load user data
                const userRef = firebase.database().ref('users/' + userId);
                userRef.on('value', (snapshot) => {
                    userData = snapshot.val();
                    if (userData) {
                        updateUIWithUserData();
                        showAppHome();
                        startListeningForUpdates(userId);
                    }
                });
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading user data', 'error');
            }
        }

        function updateUIWithUserData() {
            // Update header
            document.getElementById('userNameDisplay').textContent = userData.name;
            document.getElementById('userIdDisplay').textContent = userData.userId;
            document.getElementById('dropdownUserName').textContent = userData.name;
            document.getElementById('dropdownUserId').textContent = userData.userId;
            
            // Update profile pictures
            const profilePics = document.querySelectorAll('#userProfilePic, #dropdownProfilePic');
            profilePics.forEach(img => {
                img.src = userData.profilePic || 'https://via.placeholder.com/150';
                img.onerror = function() {
                    this.src = 'https://via.placeholder.com/150';
                };
            });
            
            // Update status
            updateStatusIndicator(userData.status);
            
            // Load initial data
            loadContacts();
            loadChatRequests();
            loadRecentChats();
            loadGroups();
            loadZynes();
        }

        function updateStatusIndicator(status) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator ${status}`;
            
            // Update status in database if changed
            if (userData.status !== status) {
                userData.status = status;
                firebase.database().ref('users/' + userData.userId + '/status').set(status);
                firebase.database().ref('users/' + userData.userId + '/lastSeen').set(Date.now());
            }
        }

        function toggleStatus() {
            const currentStatus = userData.status;
            let newStatus;
            
            switch(currentStatus) {
                case 'online':
                    newStatus = 'away';
                    break;
                case 'away':
                    newStatus = 'offline';
                    break;
                default:
                    newStatus = 'online';
            }
            
            updateStatusIndicator(newStatus);
            showToast(`Status changed to ${newStatus}`, 'info');
        }

        // ===== APP NAVIGATION =====
        function showAuthPage() {
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('appHome').style.display = 'none';
            document.getElementById('chatPage').style.display = 'none';
            resetAuthForms();
        }

        function showAppHome() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('appHome').style.display = 'flex';
            document.getElementById('chatPage').style.display = 'none';
        }

        function showChatPage() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('appHome').style.display = 'none';
            document.getElementById('chatPage').style.display = 'flex';
        }

        function goBackToHome() {
            // Leave chat
            if (currentChatId) {
                stopListeningToChat(currentChatId);
                currentChatId = null;
                currentChatUser = null;
            }
            
            showAppHome();
            scrollToTop();
        }

        function switchPage(page) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            // Show selected page
            document.querySelectorAll('.page').forEach(pageElement => {
                pageElement.classList.remove('active');
            });
            document.getElementById(page + 'Page').classList.add('active');
            
            // Load page data if needed
            switch(page) {
                case 'contacts':
                    loadContacts();
                    break;
                case 'requests':
                    loadChatRequests();
                    break;
                case 'groups':
                    loadGroups();
                    break;
                case 'zynes':
                    loadZynes();
                    break;
            }
            
            scrollToTop();
        }

        function switchRequestsTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (tab === 'incoming') {
                document.getElementById('incomingRequests').style.display = 'flex';
                document.getElementById('sentRequests').style.display = 'none';
            } else {
                document.getElementById('incomingRequests').style.display = 'none';
                document.getElementById('sentRequests').style.display = 'flex';
                loadSentRequests();
            }
        }

        function scrollToTop() {
            document.querySelector('.app-main').scrollTop = 0;
        }

        // ===== CLOUDINARY FUNCTIONS =====
        function initializeCloudinary() {
            // Cloudinary widget configuration
            const options = {
                cloudName: CLOUDINARY_ACCOUNT.cloudName,
                uploadPreset: CLOUDINARY_ACCOUNT.uploadPreset,
                folder: CLOUDINARY_ACCOUNT.folder,
                sources: ['local', 'url', 'camera'],
                multiple: false,
                maxFileSize: 50000000, // 50MB
                resourceType: 'auto',
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'mp4', 'mov', 'avi', 'pdf', 'doc', 'docx'],
                showAdvancedOptions: false,
                cropping: true,
                croppingAspectRatio: 1,
                croppingDefaultSelectionRatio: 0.9,
                showPoweredBy: false,
                styles: {
                    palette: {
                        window: "#FFFFFF",
                        sourceBg: "#F5F5F5",
                        windowBorder: "#007AFF",
                        tabIcon: "#007AFF",
                        inactiveTabIcon: "#8E8E93",
                        menuIcons: "#007AFF",
                        link: "#007AFF",
                        action: "#007AFF",
                        inProgress: "#007AFF",
                        complete: "#34C759",
                        error: "#FF3B30",
                        textDark: "#000000",
                        textLight: "#FFFFFF"
                    }
                }
            };

            // Create widget
            cloudinaryWidget = cloudinary.createUploadWidget(options, (error, result) => {
                if (!error && result && result.event === "success") {
                    handleCloudinaryUpload(result.info);
                } else if (error) {
                    console.error('Cloudinary upload error:', error);
                    showToast('Upload failed: ' + error.message, 'error');
                }
            });
        }

        function openCloudinaryUpload(type = 'profile') {
            pendingUploadType = type;
            cloudinaryWidget.open();
        }

        function handleCloudinaryUpload(result) {
            const mediaUrl = result.secure_url;
            const publicId = result.public_id;
            
            switch(pendingUploadType) {
                case 'profile':
                    updateProfilePicture(mediaUrl);
                    break;
                case 'group':
                    updateGroupPhotoPreview(mediaUrl);
                    break;
                case 'zyne':
                    zyneMedia = {
                        url: mediaUrl,
                        type: result.resource_type,
                        publicId: publicId
                    };
                    updateZyneMediaPreview();
                    break;
                case 'message':
                    pendingMedia = {
                        type: result.resource_type,
                        url: mediaUrl,
                        publicId: publicId
                    };
                    // Auto-send the media message
                    sendMediaMessage();
                    break;
            }
            
            pendingUploadType = null;
            showToast('Upload completed successfully!', 'success');
        }

        function updateProfilePicture(url) {
            // Update preview
            const preview = document.getElementById('profilePreview');
            preview.innerHTML = `<img src="${url}" alt="Profile Preview">`;
            
            // Show remove button
            document.querySelector('.btn-remove').style.display = 'flex';
            
            // Store for signup
            pendingMedia.url = url;
        }

        function removeProfilePicture() {
            const preview = document.getElementById('profilePreview');
            preview.innerHTML = `
                <div class="preview-placeholder">
                    <i class="fas fa-user-circle"></i>
                    <span>No image selected</span>
                    <p>JPG, PNG, GIF up to 5MB</p>
                </div>
            `;
            
            document.querySelector('.btn-remove').style.display = 'none';
            pendingMedia.url = null;
        }

        // ===== CHAT FUNCTIONS =====
        function openStartChatModal() {
            document.getElementById('startChatModal').classList.add('active');
            resetSearchResult();
        }

        function closeStartChatModal() {
            document.getElementById('startChatModal').classList.remove('active');
        }

        async function searchUserById() {
            const userId = document.getElementById('searchUserId').value.trim().toUpperCase();
            const searchResult = document.getElementById('userSearchResult');
            const placeholder = document.getElementById('searchPlaceholder');
            const userFound = document.getElementById('userFound');
            const errorDiv = document.getElementById('searchError');
            const sendBtn = document.getElementById('sendRequestBtn');
            
            // Reset
            placeholder.style.display = 'block';
            userFound.style.display = 'none';
            errorDiv.style.display = 'none';
            sendBtn.disabled = true;
            
            if (!userId || !userId.match(/^ZYN-\d{4}$/)) {
                return;
            }
            
            // Don't search for self
            if (userId === userData.userId) {
                errorDiv.textContent = 'You cannot send a chat request to yourself.';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Check if user exists
                const userRef = await firebase.database().ref('users/' + userId).once('value');
                const foundUser = userRef.val();
                
                if (!foundUser) {
                    errorDiv.textContent = 'User not found. Please check the User ID.';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Check if already a contact
                let isContact = false;
                if (userData.contacts && userData.contacts[userId]) {
                    isContact = true;
                }
                
                // Update UI with found user
                document.getElementById('foundUserName').textContent = foundUser.name;
                document.getElementById('foundUserId').textContent = foundUser.userId;
                document.getElementById('foundUserPic').src = foundUser.profilePic || 'https://via.placeholder.com/150';
                document.getElementById('foundUserStatus').textContent = isContact ? 'Already in your contacts' : '';
                
                placeholder.style.display = 'none';
                userFound.style.display = 'flex';
                
                // Enable send button if not already a contact
                sendBtn.disabled = isContact;
                
            } catch (error) {
                console.error('Search error:', error);
                errorDiv.textContent = 'Error searching for user.';
                errorDiv.style.display = 'block';
            }
        }

        function resetSearchResult() {
            document.getElementById('searchUserId').value = '';
            document.getElementById('searchPlaceholder').style.display = 'block';
            document.getElementById('userFound').style.display = 'none';
            document.getElementById('searchError').style.display = 'none';
            document.getElementById('sendRequestBtn').disabled = true;
        }

        async function sendChatRequest() {
            const recipientId = document.getElementById('foundUserId').textContent;
            
            if (!recipientId) return;
            
            try {
                const requestId = `${userData.userId}_${recipientId}_${Date.now()}`;
                
                const requestData = {
                    id: requestId,
                    fromUserId: userData.userId,
                    fromUserName: userData.name,
                    fromUserPic: userData.profilePic || 'https://via.placeholder.com/150',
                    toUserId: recipientId,
                    status: 'pending', // pending, accepted, rejected
                    timestamp: Date.now(),
                    message: `${userData.name} wants to chat with you`
                };
                
                // Save to both users
                await firebase.database().ref('chatRequests/' + requestId).set(requestData);
                
                // Add to sender's sent requests
                await firebase.database().ref(`users/${userData.userId}/sentRequests/${requestId}`).set(true);
                
                // Add to recipient's incoming requests
                await firebase.database().ref(`users/${recipientId}/incomingRequests/${requestId}`).set(true);
                
                // Send notification
                sendNotification(recipientId, 'new_request', requestData);
                
                showToast('Chat request sent successfully!', 'success');
                closeStartChatModal();
                
            } catch (error) {
                console.error('Error sending chat request:', error);
                showToast('Failed to send chat request', 'error');
            }
        }

        async function loadChatRequests() {
            try {
                // Load incoming requests
                const incomingRequests = document.getElementById('incomingRequests');
                incomingRequests.innerHTML = '';
                
                if (userData.incomingRequests) {
                    const requestIds = Object.keys(userData.incomingRequests);
                    
                    for (const requestId of requestIds) {
                        const requestRef = await firebase.database().ref('chatRequests/' + requestId).once('value');
                        const request = requestRef.val();
                        
                        if (request && request.status === 'pending') {
                            const requestCard = createRequestCard(request, 'incoming');
                            incomingRequests.appendChild(requestCard);
                        }
                    }
                }
                
                // Update badge count
                updateBadge('requests', Object.keys(userData.incomingRequests || {}).length);
                
            } catch (error) {
                console.error('Error loading chat requests:', error);
            }
        }

        async function loadSentRequests() {
            try {
                const sentRequestsDiv = document.getElementById('sentRequests');
                sentRequestsDiv.innerHTML = '';
                
                if (userData.sentRequests) {
                    const requestIds = Object.keys(userData.sentRequests);
                    
                    for (const requestId of requestIds) {
                        const requestRef = await firebase.database().ref('chatRequests/' + requestId).once('value');
                        const request = requestRef.val();
                        
                        if (request) {
                            const requestCard = createRequestCard(request, 'sent');
                            sentRequestsDiv.appendChild(requestCard);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error loading sent requests:', error);
            }
        }

        function createRequestCard(request, type) {
            const card = document.createElement('div');
            card.className = 'request-card';
            card.innerHTML = `
                <img src="${request.fromUserPic || 'https://via.placeholder.com/150'}" alt="Profile" class="profile-pic">
                <div class="request-info">
                    <h4>${request.fromUserName}</h4>
                    <p>${request.fromUserId}</p>
                    <p class="time">${formatTime(request.timestamp)}</p>
                </div>
                <div class="request-actions">
                    ${type === 'incoming' ? `
                        <button class="action-btn accept-btn" onclick="handleRequest('${request.id}', 'accept')">
                            <i class="fas fa-check"></i>
                            Accept
                        </button>
                        <button class="action-btn reject-btn" onclick="handleRequest('${request.id}', 'reject')">
                            <i class="fas fa-times"></i>
                            Reject
                        </button>
                    ` : `
                        <span class="status">${request.status}</span>
                    `}
                </div>
            `;
            
            if (type === 'incoming') {
                card.onclick = function(e) {
                    if (!e.target.closest('.request-actions')) {
                        showUserProfile(request.fromUserId);
                    }
                };
            }
            
            return card;
        }

        async function handleRequest(requestId, action) {
            try {
                // Update request status
                await firebase.database().ref('chatRequests/' + requestId + '/status').set(action);
                await firebase.database().ref('chatRequests/' + requestId + '/processedAt').set(Date.now());
                
                const requestRef = await firebase.database().ref('chatRequests/' + requestId).once('value');
                const request = requestRef.val();
                
                if (action === 'accept') {
                    // Add each other to contacts
                    await firebase.database().ref(`users/${userData.userId}/contacts/${request.fromUserId}`).set({
                        addedAt: Date.now(),
                        nickname: '',
                        isFavorite: false
                    });
                    
                    await firebase.database().ref(`users/${request.fromUserId}/contacts/${userData.userId}`).set({
                        addedAt: Date.now(),
                        nickname: '',
                        isFavorite: false
                    });
                    
                    // Create chat between users
                    const chatId = [userData.userId, request.fromUserId].sort().join('_');
                    await firebase.database().ref('chats/' + chatId).set({
                        type: 'individual',
                        participants: {
                            [userData.userId]: true,
                            [request.fromUserId]: true
                        },
                        createdAt: Date.now(),
                        lastMessage: null,
                        lastMessageTime: null
                    });
                    
                    // Send notification to requester
                    sendNotification(request.fromUserId, 'request_accepted', {
                        byUserId: userData.userId,
                        byUserName: userData.name
                    });
                    
                    showToast('Request accepted! Contact added.', 'success');
                    
                    // Open chat with the user
                    openChat(request.fromUserId, 'individual');
                    
                } else {
                    // Send rejection notification
                    sendNotification(request.fromUserId, 'request_rejected', {
                        byUserId: userData.userId,
                        byUserName: userData.name
                    });
                    
                    showToast('Request rejected', 'info');
                }
                
                // Remove from requests lists
                await firebase.database().ref(`users/${userData.userId}/incomingRequests/${requestId}`).remove();
                await firebase.database().ref(`users/${request.fromUserId}/sentRequests/${requestId}`).remove();
                
                // Reload requests
                loadChatRequests();
                
            } catch (error) {
                console.error('Error handling request:', error);
                showToast('Error processing request', 'error');
            }
        }

        // ===== CONTACTS FUNCTIONS =====
        async function loadContacts() {
            try {
                const contactsContainer = document.getElementById('contactsContainer');
                contactsContainer.innerHTML = '';
                
                if (!userData.contacts || Object.keys(userData.contacts).length === 0) {
                    contactsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-address-book"></i>
                            <h3>No Contacts Yet</h3>
                            <p>Add contacts by accepting chat requests or searching for users.</p>
                            <button class="btn-primary" onclick="openAddContactModal()" style="margin-top: 20px;">
                                Add Contact
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const contactIds = Object.keys(userData.contacts);
                
                for (const contactId of contactIds) {
                    const contactRef = await firebase.database().ref('users/' + contactId).once('value');
                    const contact = contactRef.val();
                    
                    if (contact) {
                        const contactCard = createContactCard(contact);
                        contactsContainer.appendChild(contactCard);
                    }
                }
                
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        function createContactCard(contact) {
            const card = document.createElement('div');
            card.className = 'contact-card';
            card.innerHTML = `
                <img src="${contact.profilePic || 'https://via.placeholder.com/150'}" alt="Profile" class="profile-pic">
                <div class="contact-info">
                    <h4>${contact.name}</h4>
                    <p>${contact.userId}</p>
                    <p class="status ${contact.status || 'offline'}">${contact.status || 'offline'}</p>
                </div>
                <div class="contact-actions">
                    <button class="action-btn chat-btn" onclick="openChat('${contact.userId}', 'individual')">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                    <button class="icon-btn" onclick="showContactOptions('${contact.userId}', event)">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            `;
            
            card.onclick = function(e) {
                if (!e.target.closest('.contact-actions')) {
                    showUserProfile(contact.userId);
                }
            };
            
            return card;
        }

        function searchContacts() {
            const searchTerm = document.getElementById('searchContacts').value.toLowerCase();
            const contactCards = document.querySelectorAll('.contact-card');
            
            contactCards.forEach(card => {
                const name = card.querySelector('h4').textContent.toLowerCase();
                const userId = card.querySelector('p').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || userId.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function openAddContactModal() {
            document.getElementById('addContactModal').classList.add('active');
            resetContactSearch();
        }

        function closeAddContactModal() {
            document.getElementById('addContactModal').classList.remove('active');
        }

        function resetContactSearch() {
            document.getElementById('addContactUserId').value = '';
            document.getElementById('contactSearchPlaceholder').style.display = 'block';
            document.getElementById('contactFound').style.display = 'none';
            document.getElementById('contactSearchError').style.display = 'none';
            document.getElementById('addContactBtn').disabled = true;
        }

        async function searchContactById() {
            const userId = document.getElementById('addContactUserId').value.trim().toUpperCase();
            const searchResult = document.getElementById('contactSearchResult');
            const placeholder = document.getElementById('contactSearchPlaceholder');
            const contactFound = document.getElementById('contactFound');
            const errorDiv = document.getElementById('contactSearchError');
            const addBtn = document.getElementById('addContactBtn');
            
            // Reset
            placeholder.style.display = 'block';
            contactFound.style.display = 'none';
            errorDiv.style.display = 'none';
            addBtn.disabled = true;
            
            if (!userId || !userId.match(/^ZYN-\d{4}$/)) {
                return;
            }
            
            // Don't search for self
            if (userId === userData.userId) {
                errorDiv.textContent = 'You cannot add yourself as a contact.';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                // Check if user exists
                const userRef = await firebase.database().ref('users/' + userId).once('value');
                const foundUser = userRef.val();
                
                if (!foundUser) {
                    errorDiv.textContent = 'User not found. Please check the User ID.';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Check if already a contact
                let isContact = false;
                if (userData.contacts && userData.contacts[userId]) {
                    isContact = true;
                }
                
                // Update UI with found user
                document.getElementById('foundContactName').textContent = foundUser.name;
                document.getElementById('foundContactId').textContent = foundUser.userId;
                document.getElementById('foundContactPic').src = foundUser.profilePic || 'https://via.placeholder.com/150';
                document.getElementById('foundContactStatus').textContent = isContact ? 'Already in your contacts' : '';
                
                placeholder.style.display = 'none';
                contactFound.style.display = 'flex';
                
                // Enable add button if not already a contact
                addBtn.disabled = isContact;
                
            } catch (error) {
                console.error('Search error:', error);
                errorDiv.textContent = 'Error searching for user.';
                errorDiv.style.display = 'block';
            }
        }

        async function addContact() {
            const contactId = document.getElementById('foundContactId').textContent;
            
            if (!contactId) return;
            
            try {
                // Add to contacts
                await firebase.database().ref(`users/${userData.userId}/contacts/${contactId}`).set({
                    addedAt: Date.now(),
                    nickname: '',
                    isFavorite: false
                });
                
                // Send chat request automatically
                const requestId = `${userData.userId}_${contactId}_${Date.now()}`;
                
                const requestData = {
                    id: requestId,
                    fromUserId: userData.userId,
                    fromUserName: userData.name,
                    fromUserPic: userData.profilePic || 'https://via.placeholder.com/150',
                    toUserId: contactId,
                    status: 'pending',
                    timestamp: Date.now(),
                    message: `${userData.name} added you as a contact`
                };
                
                await firebase.database().ref('chatRequests/' + requestId).set(requestData);
                await firebase.database().ref(`users/${userData.userId}/sentRequests/${requestId}`).set(true);
                await firebase.database().ref(`users/${contactId}/incomingRequests/${requestId}`).set(true);
                
                // Send notification
                sendNotification(contactId, 'new_request', requestData);
                
                showToast('Contact added successfully! Chat request sent.', 'success');
                closeAddContactModal();
                loadContacts();
                
            } catch (error) {
                console.error('Error adding contact:', error);
                showToast('Failed to add contact', 'error');
            }
        }

        function showContactOptions(userId, event) {
            event.stopPropagation();
            // Implement contact options menu
            const options = [
                { text: 'View Profile', icon: 'fa-user', action: () => showUserProfile(userId) },
                { text: 'Remove Contact', icon: 'fa-trash', action: () => removeContact(userId) },
                { text: 'Block User', icon: 'fa-ban', action: () => blockUser(userId) }
            ];
            
            showContextMenu(options, event);
        }

        async function removeContact(userId) {
            if (confirm('Are you sure you want to remove this contact?')) {
                try {
                    await firebase.database().ref(`users/${userData.userId}/contacts/${userId}`).remove();
                    showToast('Contact removed', 'success');
                    loadContacts();
                } catch (error) {
                    console.error('Error removing contact:', error);
                    showToast('Failed to remove contact', 'error');
                }
            }
        }

        // ===== CHAT MESSAGING FUNCTIONS =====
        async function openChat(otherUserId, type = 'individual') {
            try {
                currentChatType = type;
                
                if (type === 'individual') {
                    currentChatUser = otherUserId;
                    
                    // Get user info
                    const userRef = await firebase.database().ref('users/' + otherUserId).once('value');
                    const user = userRef.val();
                    
                    if (!user) {
                        showToast('User not found', 'error');
                        return;
                    }
                    
                    // Update chat header
                    document.getElementById('chatUserName').textContent = user.name;
                    document.getElementById('chatUserPic').src = user.profilePic || 'https://via.placeholder.com/150';
                    updateChatUserStatus(user.status);
                    
                    // Get or create chat ID
                    currentChatId = [userData.userId, otherUserId].sort().join('_');
                    
                    // Check if chat exists
                    const chatRef = await firebase.database().ref('chats/' + currentChatId).once('value');
                    
                    if (!chatRef.exists()) {
                        // Create new chat
                        await firebase.database().ref('chats/' + currentChatId).set({
                            type: 'individual',
                            participants: {
                                [userData.userId]: true,
                                [otherUserId]: true
                            },
                            createdAt: Date.now(),
                            lastMessage: null,
                            lastMessageTime: null
                        });
                    }
                    
                } else {
                    // Group chat
                    currentChatId = otherUserId;
                    const groupRef = await firebase.database().ref('groups/' + otherUserId).once('value');
                    const group = groupRef.val();
                    
                    if (group) {
                        document.getElementById('chatUserName').textContent = group.name;
                        document.getElementById('chatUserPic').src = group.photo || 'https://via.placeholder.com/150';
                        document.getElementById('chatUserStatusText').textContent = `${group.memberCount || 0} members`;
                    }
                }
                
                // Show chat page
                showChatPage();
                
                // Load messages
                loadChatMessages();
                
                // Start listening for new messages
                startListeningToChat(currentChatId);
                
                // Mark as read
                markChatAsRead(currentChatId);
                
            } catch (error) {
                console.error('Error opening chat:', error);
                showToast('Error opening chat', 'error');
            }
        }

        function updateChatUserStatus(status) {
            const statusDot = document.getElementById('chatUserStatus');
            const statusText = document.getElementById('chatUserStatusText');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = status;
        }

        async function loadChatMessages() {
            try {
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.innerHTML = '';
                
                // Show loading
                messagesDiv.innerHTML = `
                    <div class="empty-chat">
                        <div class="spinner-large"></div>
                        <p>Loading messages...</p>
                    </div>
                `;
                
                // Get messages
                const messagesRef = firebase.database().ref('messages/' + currentChatId).orderByChild('timestamp').limitToLast(50);
                const snapshot = await messagesRef.once('value');
                
                if (!snapshot.exists()) {
                    messagesDiv.innerHTML = `
                        <div class="empty-chat">
                            <i class="fas fa-comment-slash"></i>
                            <h3>No Messages Yet</h3>
                            <p>Start the conversation by sending a message!</p>
                        </div>
                    `;
                    return;
                }
                
                messagesDiv.innerHTML = '';
                
                const messages = [];
                snapshot.forEach(childSnapshot => {
                    messages.push(childSnapshot.val());
                });
                
                // Group messages by date
                let currentDate = null;
                
                messages.forEach(message => {
                    const messageDate = new Date(message.timestamp).toDateString();
                    
                    // Add date separator if new date
                    if (messageDate !== currentDate) {
                        currentDate = messageDate;
                        const dateDiv = document.createElement('div');
                        dateDiv.className = 'message-date';
                        dateDiv.textContent = formatDate(message.timestamp);
                        messagesDiv.appendChild(dateDiv);
                    }
                    
                    // Create message element
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.senderId === userData.userId ? 'sent' : 'received'}`;
                    
                    let messageContent = '';
                    
                    if (message.type === 'text') {
                        messageContent = `
                            <div class="message-bubble">
                                <p>${escapeHtml(message.content)}</p>
                                <span class="message-time">${formatTime(message.timestamp)}</span>
                            </div>
                        `;
                    } else if (message.type === 'image') {
                        messageContent = `
                            <div class="message-bubble media-message">
                                <img src="${message.content}" alt="Image" class="chat-media" onclick="openMediaViewer('${message.content}')">
                                <span class="message-time">${formatTime(message.timestamp)}</span>
                            </div>
                        `;
                    } else if (message.type === 'video') {
                        messageContent = `
                            <div class="message-bubble media-message">
                                <video controls class="chat-media" onclick="openMediaViewer('${message.content}')">
                                    <source src="${message.content}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <span class="message-time">${formatTime(message.timestamp)}</span>
                            </div>
                        `;
                    } else if (message.type === 'file') {
                        messageContent = `
                            <div class="message-bubble">
                                <p><i class="fas fa-file"></i> ${message.fileName || 'File'}</p>
                                <a href="${message.content}" target="_blank" style="color: inherit; text-decoration: underline;">Download</a>
                                <span class="message-time">${formatTime(message.timestamp)}</span>
                            </div>
                        `;
                    }
                    
                    messageDiv.innerHTML = messageContent;
                    messagesDiv.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                setTimeout(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 100);
                
            } catch (error) {
                console.error('Error loading messages:', error);
                showToast('Error loading messages', 'error');
            }
        }

        function startListeningToChat(chatId) {
            // Listen for new messages
            firebase.database().ref('messages/' + chatId).limitToLast(1).on('child_added', (snapshot) => {
                const message = snapshot.val();
                
                // Don't add if it's our own message (already added)
                if (message.senderId === userData.userId) return;
                
                addMessageToChat(message);
                
                // Play notification sound
                if (notificationsEnabled) {
                    playNotificationSound();
                }
                
                // Mark as read
                markChatAsRead(chatId);
            });
            
            // Listen for typing indicators
            if (currentChatType === 'individual') {
                firebase.database().ref('typing/' + chatId + '/' + currentChatUser).on('value', (snapshot) => {
                    const typing = snapshot.val();
                    if (typing && typing.isTyping) {
                        document.getElementById('typingIndicator').classList.add('active');
                    } else {
                        document.getElementById('typingIndicator').classList.remove('active');
                    }
                });
            }
        }

        function stopListeningToChat(chatId) {
            firebase.database().ref('messages/' + chatId).off();
            
            if (currentChatType === 'individual' && currentChatUser) {
                firebase.database().ref('typing/' + chatId + '/' + currentChatUser).off();
            }
        }

        function addMessageToChat(message) {
            const messagesDiv = document.getElementById('chatMessages');
            
            // Remove empty state if present
            const emptyState = messagesDiv.querySelector('.empty-chat');
            if (emptyState) {
                emptyState.remove();
            }
            
            // Check if we need a date separator
            const lastMessage = messagesDiv.lastElementChild;
            let addDateSeparator = false;
            
            if (lastMessage && lastMessage.className === 'message-date') {
                // Last element was a date separator, check the message before that
                const prevMessage = lastMessage.previousElementSibling;
                if (prevMessage) {
                    const lastMessageTime = prevMessage.querySelector('.message-time')?.textContent;
                    if (lastMessageTime) {
                        const lastDate = new Date(parseTime(lastMessageTime));
                        const newDate = new Date(message.timestamp);
                        if (lastDate.toDateString() !== newDate.toDateString()) {
                            addDateSeparator = true;
                        }
                    }
                }
            } else if (lastMessage) {
                const lastMessageTime = lastMessage.querySelector('.message-time')?.textContent;
                if (lastMessageTime) {
                    const lastDate = new Date(parseTime(lastMessageTime));
                    const newDate = new Date(message.timestamp);
                    if (lastDate.toDateString() !== newDate.toDateString()) {
                        addDateSeparator = true;
                    }
                }
            }
            
            // Add date separator if needed
            if (addDateSeparator) {
                const dateDiv = document.createElement('div');
                dateDiv.className = 'message-date';
                dateDiv.textContent = formatDate(message.timestamp);
                messagesDiv.appendChild(dateDiv);
            }
            
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === userData.userId ? 'sent' : 'received'}`;
            
            let messageContent = '';
            
            if (message.type === 'text') {
                messageContent = `
                    <div class="message-bubble">
                        <p>${escapeHtml(message.content)}</p>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                `;
            } else if (message.type === 'image') {
                messageContent = `
                    <div class="message-bubble media-message">
                        <img src="${message.content}" alt="Image" class="chat-media" onclick="openMediaViewer('${message.content}')">
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                `;
            } else if (message.type === 'video') {
                messageContent = `
                    <div class="message-bubble media-message">
                        <video controls class="chat-media" onclick="openMediaViewer('${message.content}')">
                            <source src="${message.content}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                `;
            } else if (message.type === 'file') {
                messageContent = `
                    <div class="message-bubble">
                        <p><i class="fas fa-file"></i> ${message.fileName || 'File'}</p>
                        <a href="${message.content}" target="_blank" style="color: inherit; text-decoration: underline;">Download</a>
                        <span class="message-time">${formatTime(message.timestamp)}</span>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = messageContent;
            messagesDiv.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, 100);
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentChatId) return;
            
            try {
                const messageId = `${currentChatId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const messageData = {
                    id: messageId,
                    chatId: currentChatId,
                    senderId: userData.userId,
                    senderName: userData.name,
                    type: 'text',
                    content: message,
                    timestamp: Date.now(),
                    status: 'sent'
                };
                
                // Save message
                await firebase.database().ref('messages/' + currentChatId + '/' + messageId).set(messageData);
                
                // Update chat last message
                await firebase.database().ref('chats/' + currentChatId).update({
                    lastMessage: message,
                    lastMessageTime: Date.now(),
                    lastMessageSender: userData.userId
                });
                
                // Clear input
                input.value = '';
                
                // Send notification to other participants
                sendMessageNotification(messageData);
                
                // Stop typing indicator
                stopTyping();
                
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Failed to send message', 'error');
            }
        }

        async function sendMediaMessage() {
            if (!pendingMedia.url || !currentChatId) return;
            
            try {
                const messageId = `${currentChatId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const messageData = {
                    id: messageId,
                    chatId: currentChatId,
                    senderId: userData.userId,
                    senderName: userData.name,
                    type: pendingMedia.type === 'image' ? 'image' : pendingMedia.type === 'video' ? 'video' : 'file',
                    content: pendingMedia.url,
                    timestamp: Date.now(),
                    status: 'sent'
                };
                
                // Save message
                await firebase.database().ref('messages/' + currentChatId + '/' + messageId).set(messageData);
                
                // Update chat last message
                const messagePreview = pendingMedia.type === 'image' ? 'ðŸ“· Photo' : pendingMedia.type === 'video' ? 'ðŸŽ¥ Video' : 'ðŸ“Ž File';
                await firebase.database().ref('chats/' + currentChatId).update({
                    lastMessage: messagePreview,
                    lastMessageTime: Date.now(),
                    lastMessageSender: userData.userId
                });
                
                // Clear pending media
                pendingMedia = { type: null, url: null, publicId: null };
                
                // Send notification
                sendMessageNotification(messageData);
                
            } catch (error) {
                console.error('Error sending media message:', error);
                showToast('Failed to send media', 'error');
            }
        }

        function handleTyping() {
            if (!currentChatId || !currentChatUser) return;
            
            if (!isTyping) {
                isTyping = true;
                // Send typing start
                firebase.database().ref('typing/' + currentChatId + '/' + userData.userId).set({
                    isTyping: true,
                    timestamp: Date.now()
                });
            }
            
            // Clear previous timeout
            clearTimeout(typingTimeout);
            
            // Set timeout to stop typing after 3 seconds of inactivity
            typingTimeout = setTimeout(() => {
                stopTyping();
            }, 3000);
        }

        function stopTyping() {
            if (isTyping && currentChatId && currentChatUser) {
                isTyping = false;
                firebase.database().ref('typing/' + currentChatId + '/' + userData.userId).update({
                    isTyping: false,
                    timestamp: Date.now()
                });
            }
            
            clearTimeout(typingTimeout);
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function toggleAttachmentOptions() {
            const options = document.getElementById('attachmentOptions');
            options.classList.toggle('show');
        }

        function attachPhoto() {
            document.getElementById('photoUpload').click();
            toggleAttachmentOptions();
        }

        function attachVideo() {
            document.getElementById('videoUpload').click();
            toggleAttachmentOptions();
        }

        function attachFile() {
            document.getElementById('fileUpload').click();
            toggleAttachmentOptions();
        }

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 50000000) { // 50MB
                showToast('File size exceeds 50MB limit', 'error');
                return;
            }
            
            pendingUploadType = 'message';
            cloudinaryWidget.open();
        }

        async function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 50000000) { // 50MB
                showToast('File size exceeds 50MB limit', 'error');
                return;
            }
            
            pendingUploadType = 'message';
            cloudinaryWidget.open();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 50000000) { // 50MB
                showToast('File size exceeds 50MB limit', 'error');
                return;
            }
            
            // For files, we'll use Cloudinary
            pendingUploadType = 'message';
            cloudinaryWidget.open();
        }

        function attachLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    const messageId = `${currentChatId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    const messageData = {
                        id: messageId,
                        chatId: currentChatId,
                        senderId: userData.userId,
                        senderName: userData.name,
                        type: 'location',
                        content: `https://maps.google.com/?q=${lat},${lng}`,
                        location: { lat, lng },
                        timestamp: Date.now(),
                        status: 'sent'
                    };
                    
                    await firebase.database().ref('messages/' + currentChatId + '/' + messageId).set(messageData);
                    
                    showToast('Location sent', 'success');
                    
                }, (error) => {
                    showToast('Failed to get location: ' + error.message, 'error');
                });
            } else {
                showToast('Geolocation not supported', 'error');
            }
            
            toggleAttachmentOptions();
        }

        function attachContact() {
            // Implement contact sharing
            showToast('Contact sharing coming soon', 'info');
            toggleAttachmentOptions();
        }

        function attachAudio() {
            // Implement audio recording/upload
            showToast('Audio messages coming soon', 'info');
            toggleAttachmentOptions();
        }

        // ===== GROUPS FUNCTIONS =====
        function openCreateGroupModal() {
            document.getElementById('createGroupModal').classList.add('active');
            groupMembers = [];
            updateGroupMembersList();
        }

        function closeCreateGroupModal() {
            document.getElementById('createGroupModal').classList.remove('active');
        }

        function updateGroupPhotoPreview(url) {
            const preview = document.getElementById('groupPhotoPreview');
            preview.innerHTML = `<img src="${url}" alt="Group Photo Preview">`;
        }

        async function searchMemberById() {
            const userId = document.getElementById('searchMemberId').value.trim().toUpperCase();
            
            if (!userId || !userId.match(/^ZYN-\d{4}$/)) return;
            
            // Don't add self
            if (userId === userData.userId) {
                showToast('You are automatically added as admin', 'info');
                return;
            }
            
            // Check if already added
            if (groupMembers.includes(userId)) {
                showToast('User already added to group', 'info');
                return;
            }
            
            try {
                // Check if user exists
                const userRef = await firebase.database().ref('users/' + userId).once('value');
                const foundUser = userRef.val();
                
                if (!foundUser) {
                    showToast('User not found', 'error');
                    return;
                }
                
                // Add to members
                groupMembers.push(userId);
                updateGroupMembersList();
                
                // Clear search
                document.getElementById('searchMemberId').value = '';
                
            } catch (error) {
                console.error('Error searching for member:', error);
                showToast('Error searching for user', 'error');
            }
        }

        function updateGroupMembersList() {
            const membersList = document.getElementById('membersList');
            const membersCount = document.getElementById('membersCount');
            
            // Include self as admin
            const allMembers = [userData.userId, ...groupMembers];
            
            membersCount.textContent = `${allMembers.length} members`;
            
            if (allMembers.length === 1) { // Only self
                membersList.innerHTML = `
                    <div class="empty-members">
                        <i class="fas fa-user-plus"></i>
                        <p>Add members using their User ID</p>
                    </div>
                `;
                return;
            }
            
            membersList.innerHTML = '';
            
            // Add self as admin
            const selfTag = document.createElement('div');
            selfTag.className = 'member-tag';
            selfTag.innerHTML = `
                <span>${userData.name} (You) - Admin</span>
            `;
            membersList.appendChild(selfTag);
            
            // Add other members
            groupMembers.forEach(async (memberId, index) => {
                try {
                    const userRef = await firebase.database().ref('users/' + memberId).once('value');
                    const user = userRef.val();
                    
                    if (user) {
                        const memberTag = document.createElement('div');
                        memberTag.className = 'member-tag';
                        memberTag.innerHTML = `
                            <span>${user.name}</span>
                            <button class="remove-member" onclick="removeGroupMember(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        membersList.appendChild(memberTag);
                    }
                } catch (error) {
                    console.error('Error loading member info:', error);
                }
            });
        }

        function removeGroupMember(index) {
            groupMembers.splice(index, 1);
            updateGroupMembersList();
        }

        async function createGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            
            if (!groupName) {
                showToast('Please enter a group name', 'error');
                return;
            }
            
            if (groupMembers.length === 0) {
                showToast('Please add at least one member', 'error');
                return;
            }
            
            try {
                const groupId = `GROUP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Get group photo
                const groupPhoto = document.querySelector('#groupPhotoPreview img')?.src || null;
                
                // Include self as admin
                const allMembers = [userData.userId, ...groupMembers];
                
                const groupData = {
                    id: groupId,
                    name: groupName,
                    photo: groupPhoto,
                    createdBy: userData.userId,
                    createdAt: Date.now(),
                    members: {},
                    admins: {
                        [userData.userId]: true
                    },
                    memberCount: allMembers.length
                };
                
                // Add members to group
                allMembers.forEach(memberId => {
                    groupData.members[memberId] = {
                        joinedAt: Date.now(),
                        role: memberId === userData.userId ? 'admin' : 'member'
                    };
                });
                
                // Save group
                await firebase.database().ref('groups/' + groupId).set(groupData);
                
                // Add group to each member's groups list
                for (const memberId of allMembers) {
                    await firebase.database().ref(`users/${memberId}/groups/${groupId}`).set({
                        addedAt: Date.now(),
                        notification: true
                    });
                    
                    // Send notification
                    if (memberId !== userData.userId) {
                        sendNotification(memberId, 'added_to_group', {
                            groupId: groupId,
                            groupName: groupName,
                            addedBy: userData.userId,
                            addedByName: userData.name
                        });
                    }
                }
                
                // Create chat for group
                await firebase.database().ref('chats/' + groupId).set({
                    type: 'group',
                    groupId: groupId,
                    participants: groupData.members,
                    createdAt: Date.now(),
                    lastMessage: null,
                    lastMessageTime: null
                });
                
                showToast('Group created successfully!', 'success');
                closeCreateGroupModal();
                loadGroups();
                
                // Open group chat
                openChat(groupId, 'group');
                
            } catch (error) {
                console.error('Error creating group:', error);
                showToast('Failed to create group', 'error');
            }
        }

        async function loadGroups() {
            try {
                const groupsContainer = document.getElementById('groupsContainer');
                groupsContainer.innerHTML = '';
                
                if (!userData.groups || Object.keys(userData.groups).length === 0) {
                    groupsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Groups Yet</h3>
                            <p>Create a group to chat with multiple people.</p>
                        </div>
                    `;
                    return;
                }
                
                const groupIds = Object.keys(userData.groups);
                
                for (const groupId of groupIds) {
                    const groupRef = await firebase.database().ref('groups/' + groupId).once('value');
                    const group = groupRef.val();
                    
                    if (group) {
                        const groupCard = createGroupCard(group);
                        groupsContainer.appendChild(groupCard);
                    }
                }
                
                // Update badge
                updateBadge('groups', groupIds.length);
                
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        function createGroupCard(group) {
            const card = document.createElement('div');
            card.className = 'group-card';
            card.onclick = () => openChat(group.id, 'group');
            
            card.innerHTML = `
                <img src="${group.photo || 'https://via.placeholder.com/150'}" alt="Group" class="profile-pic">
                <div class="group-info">
                    <h4>${group.name}</h4>
                    <p>${group.memberCount || 0} members</p>
                    <p class="time">Created ${formatTime(group.createdAt)}</p>
                </div>
                <div class="group-actions">
                    <button class="icon-btn" onclick="showGroupOptions('${group.id}', event)">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            `;
            
            return card;
        }

        function searchGroups() {
            const searchTerm = document.getElementById('searchGroups').value.toLowerCase();
            const groupCards = document.querySelectorAll('.group-card');
            
            groupCards.forEach(card => {
                const name = card.querySelector('h4').textContent.toLowerCase();
                
                if (name.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // ===== ZYNES FUNCTIONS =====
        function openCreateZyneModal() {
            document.getElementById('createZyneModal').classList.add('active');
            zyneMedia = null;
            updateZyneMediaPreview();
        }

        function closeCreateZyneModal() {
            document.getElementById('createZyneModal').classList.remove('active');
        }

        function updateZyneCharCount() {
            const text = document.getElementById('zyneText').value;
            const charCount = document.getElementById('zyneCharCount');
            charCount.textContent = `${text.length}/500`;
            
            if (text.length > 500) {
                charCount.style.color = 'var(--red)';
            } else {
                charCount.style.color = 'var(--gray-500)';
            }
        }

        function attachZynePhoto() {
            document.getElementById('zynePhotoUpload').click();
        }

        function attachZyneVideo() {
            document.getElementById('zyneVideoUpload').click();
        }

        async function handleZynePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 50000000) {
                showToast('File size exceeds 50MB limit', 'error');
                return;
            }
            
            pendingUploadType = 'zyne';
            cloudinaryWidget.open();
        }

        async function handleZyneVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 50000000) {
                showToast('File size exceeds 50MB limit', 'error');
                return;
            }
            
            pendingUploadType = 'zyne';
            cloudinaryWidget.open();
        }

        function updateZyneMediaPreview() {
            const preview = document.getElementById('zyneMediaPreview');
            
            if (!zyneMedia) {
                preview.innerHTML = `
                    <div class="media-preview-content">
                        <div class="empty-members">
                            <i class="fas fa-image"></i>
                            <p>Add photo or video (optional)</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (zyneMedia.type === 'image') {
                preview.innerHTML = `
                    <div class="preview-item">
                        <img src="${zyneMedia.url}" alt="Zyne Preview">
                        <button class="remove-preview" onclick="removeZyneMedia()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            } else if (zyneMedia.type === 'video') {
                preview.innerHTML = `
                    <div class="preview-item">
                        <video src="${zyneMedia.url}" controls></video>
                        <button class="remove-preview" onclick="removeZyneMedia()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
        }

        function removeZyneMedia() {
            zyneMedia = null;
            updateZyneMediaPreview();
        }

        async function createZyne() {
            const text = document.getElementById('zyneText').value.trim();
            
            if (!text && !zyneMedia) {
                showToast('Please add text or media to your Zyne', 'error');
                return;
            }
            
            if (text.length > 500) {
                showToast('Text exceeds 500 character limit', 'error');
                return;
            }
            
            try {
                const zyneId = `ZYNE_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const zyneData = {
                    id: zyneId,
                    userId: userData.userId,
                    userName: userData.name,
                    userPic: userData.profilePic || 'https://via.placeholder.com/150',
                    text: text,
                    media: zyneMedia,
                    timestamp: Date.now(),
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000), // 24 hours
                    views: {},
                    viewCount: 0
                };
                
                // Save Zyne
                await firebase.database().ref('zynes/' + zyneId).set(zyneData);
                await firebase.database().ref(`users/${userData.userId}/zynes/${zyneId}`).set(true);
                
                // Notify contacts
                if (userData.contacts) {
                    const contactIds = Object.keys(userData.contacts);
                    for (const contactId of contactIds) {
                        sendNotification(contactId, 'new_zyne', {
                            zyneId: zyneId,
                            userName: userData.name,
                            userId: userData.userId
                        });
                    }
                }
                
                showToast('Zyne posted successfully!', 'success');
                closeCreateZyneModal();
                loadZynes();
                
            } catch (error) {
                console.error('Error creating Zyne:', error);
                showToast('Failed to post Zyne', 'error');
            }
        }

        async function loadZynes() {
            try {
                const zynesContainer = document.getElementById('zynesContainer');
                zynesContainer.innerHTML = '';
                
                // Load Zynes from contacts
                if (!userData.contacts || Object.keys(userData.contacts).length === 0) {
                    zynesContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-circle"></i>
                            <h3>No Zynes Available</h3>
                            <p>Add contacts to see their Zynes.</p>
                        </div>
                    `;
                    return;
                }
                
                const contactIds = Object.keys(userData.contacts);
                let allZynes = [];
                
                // Get Zynes from each contact
                for (const contactId of contactIds) {
                    const userRef = await firebase.database().ref('users/' + contactId + '/zynes').once('value');
                    const zyneIds = userRef.val();
                    
                    if (zyneIds) {
                        const zyneIdList = Object.keys(zyneIds);
                        
                        for (const zyneId of zyneIdList) {
                            const zyneRef = await firebase.database().ref('zynes/' + zyneId).once('value');
                            const zyne = zyneRef.val();
                            
                            if (zyne && zyne.expiresAt > Date.now()) {
                                allZynes.push(zyne);
                            }
                        }
                    }
                }
                
                // Sort by timestamp (newest first)
                allZynes.sort((a, b) => b.timestamp - a.timestamp);
                
                if (allZynes.length === 0) {
                    zynesContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-circle"></i>
                            <h3>No Zynes Available</h3>
                            <p>Your contacts haven't posted any Zynes yet.</p>
                        </div>
                    `;
                    return;
                }
                
                // Display Zynes
                for (const zyne of allZynes) {
                    const zyneCard = createZyneCard(zyne);
                    zynesContainer.appendChild(zyneCard);
                }
                
                // Update badge
                updateBadge('zynes', allZynes.length);
                
            } catch (error) {
                console.error('Error loading Zynes:', error);
            }
        }

        function createZyneCard(zyne) {
            const card = document.createElement('div');
            card.className = 'zyne-card';
            
            let mediaContent = '';
            if (zyne.media) {
                if (zyne.media.type === 'image') {
                    mediaContent = `<img src="${zyne.media.url}" alt="Zyne Media" class="zyne-media" onclick="openMediaViewer('${zyne.media.url}')">`;
                } else if (zyne.media.type === 'video') {
                    mediaContent = `<video controls class="zyne-media" onclick="openMediaViewer('${zyne.media.url}')">
                        <source src="${zyne.media.url}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>`;
                }
            }
            
            card.innerHTML = `
                <img src="${zyne.userPic || 'https://via.placeholder.com/150'}" alt="Profile" class="profile-pic">
                <div class="zyne-content">
                    <h4>${zyne.userName}</h4>
                    ${zyne.text ? `<p>${escapeHtml(zyne.text)}</p>` : ''}
                    ${mediaContent}
                    <div class="zyne-time">
                        ${formatTime(zyne.timestamp)} â€¢ Expires in ${formatExpiryTime(zyne.expiresAt)}
                    </div>
                </div>
                <div class="zyne-actions">
                    <button class="icon-btn" onclick="viewZyne('${zyne.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${zyne.userId === userData.userId ? `
                        <button class="icon-btn" onclick="deleteZyne('${zyne.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        function searchZynes() {
            const searchTerm = document.getElementById('searchZynes').value.toLowerCase();
            const zyneCards = document.querySelectorAll('.zyne-card');
            
            zyneCards.forEach(card => {
                const name = card.querySelector('h4').textContent.toLowerCase();
                const text = card.querySelector('p')?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || text.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function viewZyne(zyneId) {
            try {
                // Mark as viewed
                await firebase.database().ref(`zynes/${zyneId}/views/${userData.userId}`).set(Date.now());
                
                // Update view count
                const zyneRef = await firebase.database().ref(`zynes/${zyneId}`).once('value');
                const zyne = zyneRef.val();
                
                if (zyne) {
                    const viewCount = Object.keys(zyne.views || {}).length;
                    await firebase.database().ref(`zynes/${zyneId}/viewCount`).set(viewCount);
                }
                
            } catch (error) {
                console.error('Error viewing Zyne:', error);
            }
        }

        async function deleteZyne(zyneId) {
            if (confirm('Are you sure you want to delete this Zyne?')) {
                try {
                    await firebase.database().ref('zynes/' + zyneId).remove();
                    await firebase.database().ref(`users/${userData.userId}/zynes/${zyneId}`).remove();
                    
                    showToast('Zyne deleted', 'success');
                    loadZynes();
                    
                } catch (error) {
                    console.error('Error deleting Zyne:', error);
                    showToast('Failed to delete Zyne', 'error');
                }
            }
        }

        // ===== RECENT CHATS =====
        async function loadRecentChats() {
            try {
                const recentChatsList = document.getElementById('recentChatsList');
                recentChatsList.innerHTML = '';
                
                // Get user's chats
                const chatsRef = firebase.database().ref('chats').orderByChild('lastMessageTime').limitToLast(10);
                const snapshot = await chatsRef.once('value');
                
                if (!snapshot.exists()) {
                    recentChatsList.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <i class="fas fa-comment"></i>
                            <p>No recent chats</p>
                        </div>
                    `;
                    return;
                }
                
                const chats = [];
                snapshot.forEach(childSnapshot => {
                    const chat = childSnapshot.val();
                    chat.id = childSnapshot.key;
                    
                    // Check if user is a participant
                    if (chat.participants && chat.participants[userData.userId]) {
                        chats.push(chat);
                    }
                });
                
                // Sort by last message time (newest first)
                chats.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                
                // Show only 5 most recent
                const recentChats = chats.slice(0, 5);
                
                for (const chat of recentChats) {
                    const chatCard = await createRecentChatCard(chat);
                    if (chatCard) {
                        recentChatsList.appendChild(chatCard);
                    }
                }
                
            } catch (error) {
                console.error('Error loading recent chats:', error);
            }
        }

        async function createRecentChatCard(chat) {
            try {
                const card = document.createElement('div');
                card.className = 'chat-card';
                
                let chatName = '';
                let chatPic = '';
                let lastMessage = chat.lastMessage || 'No messages yet';
                
                if (chat.type === 'individual') {
                    // Find other participant
                    const participantIds = Object.keys(chat.participants || {});
                    const otherUserId = participantIds.find(id => id !== userData.userId);
                    
                    if (!otherUserId) return null;
                    
                    const userRef = await firebase.database().ref('users/' + otherUserId).once('value');
                    const user = userRef.val();
                    
                    if (!user) return null;
                    
                    chatName = user.name;
                    chatPic = user.profilePic || 'https://via.placeholder.com/150';
                    
                } else if (chat.type === 'group') {
                    const groupRef = await firebase.database().ref('groups/' + chat.id).once('value');
                    const group = groupRef.val();
                    
                    if (!group) return null;
                    
                    chatName = group.name;
                    chatPic = group.photo || 'https://via.placeholder.com/150';
                }
                
                card.innerHTML = `
                    <img src="${chatPic}" alt="Chat" class="profile-pic">
                    <div class="chat-info">
                        <h4>${chatName}</h4>
                        <p>${lastMessage.length > 30 ? lastMessage.substring(0, 30) + '...' : lastMessage}</p>
                        <p class="time">${chat.lastMessageTime ? formatTime(chat.lastMessageTime) : ''}</p>
                    </div>
                `;
                
                card.onclick = () => openChat(chat.id, chat.type);
                
                return card;
                
            } catch (error) {
                console.error('Error creating chat card:', error);
                return null;
            }
        }

        // ===== NOTIFICATION FUNCTIONS =====
        function sendNotification(userId, type, data) {
            try {
                const notificationId = `${userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const notificationData = {
                    id: notificationId,
                    userId: userId,
                    type: type,
                    data: data,
                    timestamp: Date.now(),
                    read: false
                };
                
                firebase.database().ref('notifications/' + notificationId).set(notificationData);
                
            } catch (error) {
                console.error('Error sending notification:', error);
            }
        }

        function sendMessageNotification(message) {
            try {
                // Get chat participants
                const chatRef = firebase.database().ref('chats/' + message.chatId);
                chatRef.once('value').then(snapshot => {
                    const chat = snapshot.val();
                    
                    if (chat && chat.participants) {
                        const participantIds = Object.keys(chat.participants);
                        
                        participantIds.forEach(participantId => {
                            // Don't send notification to sender
                            if (participantId !== userData.userId) {
                                sendNotification(participantId, 'new_message', {
                                    chatId: message.chatId,
                                    messageId: message.id,
                                    senderId: message.senderId,
                                    senderName: message.senderName,
                                    message: message.type === 'text' ? message.content : 
                                            message.type === 'image' ? 'ðŸ“· Photo' :
                                            message.type === 'video' ? 'ðŸŽ¥ Video' :
                                            message.type === 'file' ? 'ðŸ“Ž File' : 'New message',
                                    timestamp: message.timestamp
                                });
                            }
                        });
                    }
                });
                
            } catch (error) {
                console.error('Error sending message notification:', error);
            }
        }

        function playNotificationSound() {
            try {
                const audio = document.getElementById('notificationSound');
                audio.currentTime = 0;
                audio.play().catch(e => console.log('Audio play failed:', e));
            } catch (error) {
                console.error('Error playing notification sound:', error);
            }
        }

        // ===== PROFILE & SETTINGS FUNCTIONS =====
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.add('active');
            toggleProfileDropdown();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function showEditProfile() {
            // Implement edit profile modal
            showToast('Edit profile coming soon', 'info');
            toggleProfileDropdown();
        }

        function showPrivacySettings() {
            // Implement privacy settings modal
            showToast('Privacy settings coming soon', 'info');
        }

        function showNotificationsSettings() {
            // Implement notifications settings modal
            showToast('Notifications settings coming soon', 'info');
        }

        async function handleLogout() {
            try {
                // Update status to offline
                if (userData) {
                    await firebase.database().ref('users/' + userData.userId + '/status').set('offline');
                    await firebase.database().ref('users/' + userData.userId + '/lastSeen').set(Date.now());
                }
                
                // Sign out from Firebase
                await firebase.auth().signOut();
                
                // Reset state
                currentUser = null;
                userData = null;
                currentChatId = null;
                currentChatUser = null;
                
                showToast('Signed out successfully', 'success');
                
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Error signing out', 'error');
            }
        }

        function copyUserId() {
            const userId = document.getElementById('userIdDisplay').textContent;
            
            navigator.clipboard.writeText(userId).then(() => {
                showToast('User ID copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy User ID', 'error');
            });
        }

        // ===== CHAT OPTIONS FUNCTIONS =====
        function toggleChatDropdown() {
            const dropdown = document.getElementById('chatDropdown');
            dropdown.classList.toggle('show');
        }

        function addNickname() {
            const nickname = prompt('Enter nickname for this contact:');
            if (nickname && currentChatUser) {
                // Save nickname
                firebase.database().ref(`users/${userData.userId}/contacts/${currentChatUser}/nickname`).set(nickname);
                showToast('Nickname added', 'success');
            }
            toggleChatDropdown();
        }

        function toggleFavorite() {
            if (!currentChatUser) return;
            
            const isFavorite = userData.contacts?.[currentChatUser]?.isFavorite || false;
            
            firebase.database().ref(`users/${userData.userId}/contacts/${currentChatUser}/isFavorite`).set(!isFavorite);
            
            showToast(isFavorite ? 'Removed from favorites' : 'Added to favorites', 'success');
            toggleChatDropdown();
        }

        function showChatInfo() {
            // Implement chat info modal
            showToast('Chat info coming soon', 'info');
            toggleChatDropdown();
        }

        function toggleBlockUser() {
            if (!currentChatUser) return;
            
            const isBlocked = userData.blockedUsers?.[currentChatUser] || false;
            
            if (isBlocked) {
                // Unblock
                firebase.database().ref(`users/${userData.userId}/blockedUsers/${currentChatUser}`).remove();
                showToast('User unblocked', 'success');
            } else {
                // Block
                if (confirm('Are you sure you want to block this user? They will no longer be able to send you messages.')) {
                    firebase.database().ref(`users/${userData.userId}/blockedUsers/${currentChatUser}`).set(true);
                    showToast('User blocked', 'success');
                }
            }
            
            toggleChatDropdown();
        }

        function openReportModal() {
            document.getElementById('reportModal').classList.add('active');
            toggleChatDropdown();
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }

        function updateReportCharCount() {
            const text = document.getElementById('reportDetails').value;
            const charCount = document.getElementById('reportCharCount');
            charCount.textContent = `${text.length}/1000`;
            
            if (text.length > 1000) {
                charCount.style.color = 'var(--red)';
            } else {
                charCount.style.color = 'var(--gray-500)';
            }
        }

        async function submitReport(event) {
            event.preventDefault();
            
            const reason = document.getElementById('reportReason').value;
            const details = document.getElementById('reportDetails').value.trim();
            
            if (!reason) {
                showToast('Please select a reason for reporting', 'error');
                return;
            }
            
            try {
                const reportId = `REPORT_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                const reportData = {
                    id: reportId,
                    reporterId: userData.userId,
                    reportedUserId: currentChatUser,
                    reason: reason,
                    details: details,
                    timestamp: Date.now(),
                    status: 'pending'
                };
                
                await firebase.database().ref('reports/' + reportId).set(reportData);
                
                showToast('Report submitted successfully. Our team will review it.', 'success');
                closeReportModal();
                
            } catch (error) {
                console.error('Error submitting report:', error);
                showToast('Failed to submit report', 'error');
            }
        }

        function clearChatHistory() {
            if (confirm('Are you sure you want to clear all messages in this chat? This action cannot be undone.')) {
                if (currentChatId) {
                    firebase.database().ref('messages/' + currentChatId).remove();
                    showToast('Chat cleared', 'success');
                }
            }
            toggleChatDropdown();
        }

        // ===== UTILITY FUNCTIONS =====
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            }
        }

        function formatExpiryTime(expiryTimestamp) {
            const diffMs = expiryTimestamp - Date.now();
            const diffHours = Math.floor(diffMs / 3600000);
            const diffMins = Math.floor((diffMs % 3600000) / 60000);
            
            if (diffHours > 0) {
                return `${diffHours}h ${diffMins}m`;
            } else {
                return `${diffMins}m`;
            }
        }

        function parseTime(timeString) {
            // Parse time strings like "2h ago", "30m ago", etc.
            const now = Date.now();
            
            if (timeString === 'Just now') return now;
            
            const match = timeString.match(/(\d+)([mhd]) ago/);
            if (!match) return now;
            
            const value = parseInt(match[1]);
            const unit = match[2];
            
            let offset = 0;
            switch(unit) {
                case 'm': offset = value * 60000; break;
                case 'h': offset = value * 3600000; break;
                case 'd': offset = value * 86400000; break;
            }
            
            return now - offset;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = `toast_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.id = toastId;
            
            let icon = 'fa-info-circle';
            switch(type) {
                case 'success': icon = 'fa-check-circle'; break;
                case 'error': icon = 'fa-exclamation-circle'; break;
                case 'warning': icon = 'fa-exclamation-triangle'; break;
            }
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                const toastToRemove = document.getElementById(toastId);
                if (toastToRemove) {
                    toastToRemove.remove();
                }
            }, 3000);
        }

        function updateBadge(type, count) {
            const badge = document.getElementById(type + 'Badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function startListeningForUpdates(userId) {
            // Listen for incoming chat requests
            firebase.database().ref('users/' + userId + '/incomingRequests').on('value', (snapshot) => {
                const requests = snapshot.val() || {};
                const count = Object.keys(requests).length;
                updateBadge('requests', count);
            });
            
            // Listen for new messages (update recent chats)
            firebase.database().ref('chats').on('child_changed', (snapshot) => {
                const chat = snapshot.val();
                if (chat.participants && chat.participants[userData.userId]) {
                    loadRecentChats();
                }
            });
        }

        function showContextMenu(options, event) {
            // Remove any existing context menu
            const existingMenu = document.getElementById('contextMenu');
            if (existingMenu) existingMenu.remove();
            
            // Create menu
            const menu = document.createElement('div');
            menu.id = 'contextMenu';
            menu.className = 'dropdown-content';
            menu.style.position = 'fixed';
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            menu.style.display = 'block';
            
            // Add options
            options.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `
                    <i class="fas ${option.icon}"></i>
                    <span>${option.text}</span>
                `;
                button.onclick = () => {
                    option.action();
                    menu.remove();
                };
                menu.appendChild(button);
            });
            
            document.body.appendChild(menu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 100);
        }

        function openMediaViewer(url) {
            // Create modal for media viewer
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.style.zIndex = '3000';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%; background: transparent; box-shadow: none;">
                    <div class="modal-header" style="background: rgba(0,0,0,0.5); color: white; border: none; position: absolute; top: 0; width: 100%;">
                        <button class="close-modal" onclick="this.closest('.modal-overlay').remove()" style="color: white;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                        ${url.match(/\.(mp4|mov|avi|webm)$/i) ? 
                            `<video controls autoplay style="max-width: 100%; max-height: 100%;">
                                <source src="${url}" type="video/mp4">
                            </video>` :
                            `<img src="${url}" alt="Media" style="max-width: 100%; max-height: 100%; object-fit: contain;">`
                        }
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function markChatAsRead(chatId) {
            if (chatId && userData) {
                firebase.database().ref(`users/${userData.userId}/unreadMessages/${chatId}`).remove();
            }
        }

        function resetAuthForms() {
            // Reset signup form
            document.getElementById('signupFormElement')?.reset();
            removeProfilePicture();
            
            // Reset login form
            document.getElementById('loginFormElement')?.reset();
        }

        function showUserProfile(userId) {
            // Implement user profile view
            showToast('User profile view coming soon', 'info');
        }

        function showChatProfile() {
            if (currentChatUser) {
                showUserProfile(currentChatUser);
            }
        }

        function showAbout() {
            alert(`Zynapse v1.0.0\n\nA secure messaging app for Zambia\nPowered by Buffer Zone\n\nContact: support@zynapse.com`);
        }

        function showHelp() {
            alert(`Zynapse Help\n\n1. To start a chat, click the floating chat button or search for users by their User ID (ZYN-XXXX).\n2. Accept chat requests to add contacts.\n3. Post Zynes (status updates) that disappear after 24 hours.\n4. Create groups for multiple people chats.\n5. Your User ID is displayed at the top - share it with others to connect.\n\nNeed more help? Contact support@zynapse.com`);
        }

        function showTerms() {
            alert(`Zynapse Terms of Service\n\n1. You must be at least 13 years old to use Zynapse.\n2. You are responsible for maintaining the security of your account.\n3. Do not use Zynapse for illegal activities.\n4. We reserve the right to suspend accounts violating our terms.\n5. By using Zynapse, you agree to these terms.`);
        }

        function showPrivacy() {
            alert(`Zynapse Privacy Policy\n\n1. We collect necessary information to provide our services.\n2. Your messages are encrypted and private.\n3. We do not sell your personal information.\n4. You can delete your account and data at any time.\n5. Contact us for data removal requests.`);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            // Profile dropdown
            const profileDropdown = document.getElementById('profileDropdown');
            const profileBtn = document.querySelector('.profile-btn');
            if (profileDropdown && profileBtn && !profileBtn.contains(event.target) && !profileDropdown.contains(event.target)) {
                profileDropdown.classList.remove('show');
            }
            
            // Chat dropdown
            const chatDropdown = document.getElementById('chatDropdown');
            const chatMenuBtn = document.querySelector('.chat-header-actions .icon-btn');
            if (chatDropdown && chatMenuBtn && !chatMenuBtn.contains(event.target) && !chatDropdown.contains(event.target)) {
                chatDropdown.classList.remove('show');
            }
            
            // Attachment options
            const attachmentOptions = document.getElementById('attachmentOptions');
            const attachmentBtn = document.querySelector('.message-input-area .icon-btn:first-child');
            if (attachmentOptions && attachmentBtn && !attachmentBtn.contains(event.target) && !attachmentOptions.contains(event.target)) {
                attachmentOptions.classList.remove('show');
            }
        });

        // Handle iOS keyboard issues
        window.addEventListener('resize', function() {
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                document.activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        // Prevent iOS zoom on input focus
        document.addEventListener('touchstart', function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                event.target.style.fontSize = '16px';
            }
        }, { passive: true });

        // Initialize
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 1000);
        });

        // Add beforeunload handler to update status
        window.addEventListener('beforeunload', function() {
            if (userData) {
                firebase.database().ref('users/' + userData.userId + '/status').set('offline');
                firebase.database().ref('users/' + userData.userId + '/lastSeen').set(Date.now());
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (userData) {
                if (document.hidden) {
                    firebase.database().ref('users/' + userData.userId + '/status').set('away');
                } else {
                    firebase.database().ref('users/' + userData.userId + '/status').set('online');
                }
            }
        });

        // Add install prompt for PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            const installBtn = document.createElement('button');
            installBtn.className = 'floating-btn';
            installBtn.style.left = '30px';
            installBtn.style.right = 'auto';
            installBtn.innerHTML = '<i class="fas fa-download"></i><span>Install</span>';
            installBtn.onclick = installApp;
            document.body.appendChild(installBtn);
            
            setTimeout(() => {
                installBtn.remove();
            }, 10000);
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    showToast('App installed successfully!', 'success');
                }
                deferredPrompt = null;
            }
        }

        // Force light mode
        document.documentElement.style.colorScheme = 'light';
        document.documentElement.style.setProperty('--white', '#ffffff');
        document.documentElement.style.setProperty('--black', '#000000');

        // Final initialization
        setTimeout(() => {
            if (document.getElementById('loadingScreen') && !document.getElementById('loadingScreen').classList.contains('hidden')) {
                document.getElementById('loadingScreen').classList.add('hidden');
            }
        }, 2000);

    </script>
</body>
</html>
