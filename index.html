<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zynapse - Connect Instantly</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="zynaps.png">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <img src="zynaps.png" class="loading-logo" alt="Zynapse Logo">
            <div class="spinner-large"></div>
            <p>Loading Zynapse...</p>
        </div>
    </div>

    <!-- Authentication Page -->
    <div class="auth-page" id="authPage" style="display: none;">
        <div class="auth-container">
            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <img src="zynaps.png" class="logo-large" alt="Zynapse Logo">
                <h1>Zynapse</h1>
                <p class="tagline">Connect instantly with secure, real-time messaging powered by end-to-end encryption.</p>
                <p class="powered-by">Powered by Buffer Zone</p>
                <div class="welcome-actions">
                    <button class="btn-primary full-width" id="signupBtn">
                        <i class="fas fa-user-plus"></i> Create New Account
                    </button>
                    <button class="btn-secondary full-width" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
                <p class="welcome-footer">
                    By proceeding, you agree to our <a href="#" class="link">Terms</a> and <a href="#" class="link">Privacy Policy</a>.
                </p>
            </div>

            <!-- Authentication Forms -->
            <div class="auth-form" id="authForm" style="display: none;">
                <div class="auth-header">
                    <button class="back-btn" id="backBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <img src="zynaps.png" class="logo-small" alt="Zynapse Logo">
                    <h2 id="authTitle">Sign Up</h2>
                    <p id="authSubtitle">Join Zynapse today</p>
                </div>
                
                <div class="auth-form-content">
                    <!-- Signup Form -->
                    <form id="signupForm" style="display: none;">
                        <div class="input-group">
                            <i class="fas fa-user"></i>
                            <input type="text" id="name" placeholder="Full Name" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="phone" placeholder="Phone Number" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="email" placeholder="Email Address" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="password" placeholder="Password" required minlength="6">
                            <i class="fas fa-eye toggle-password" id="togglePassword"></i>
                        </div>
                        
                        <!-- Profile Upload -->
                        <div class="profile-upload-section">
                            <label class="upload-label">Profile Picture</label>
                            <div class="profile-upload-container">
                                <div class="upload-preview" id="uploadPreview">
                                    <div class="preview-placeholder">
                                        <i class="fas fa-user-circle"></i>
                                        <span>No image selected</span>
                                        <p>Max 5MB</p>
                                    </div>
                                </div>
                                <div class="upload-buttons">
                                    <button type="button" class="btn-upload" id="uploadBtn">
                                        <i class="fas fa-upload"></i> Choose Image
                                    </button>
                                    <button type="button" class="btn-remove" id="removeBtn" style="display: none;">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                            <p class="upload-hint">Supported formats: JPG, PNG, GIF, WebP. Max size: 5MB.</p>
                        </div>
                        
                        <div class="terms-agreement">
                            <label class="checkbox-container">
                                <input type="checkbox" id="terms" required>
                                <span class="checkmark"></span>
                                I agree to the <a href="#" class="link">Terms of Service</a> and <a href="#" class="link">Privacy Policy</a>
                            </label>
                        </div>
                        
                        <button type="submit" class="btn-primary full-width" id="registerBtn">
                            <span id="registerText">Create Account</span>
                            <div class="spinner" id="registerSpinner" style="display: none;"></div>
                        </button>
                    </form>
                    
                    <!-- Login Form -->
                    <form id="loginForm" style="display: none;">
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="loginEmail" placeholder="Email Address" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="loginPassword" placeholder="Password" required>
                            <i class="fas fa-eye toggle-password" id="toggleLoginPassword"></i>
                        </div>
                        <div class="form-options">
                            <label class="checkbox-container">
                                <input type="checkbox" id="rememberMe">
                                <span class="checkmark"></span>
                                Remember me
                            </label>
                            <a href="#" class="link" id="forgotPassword">Forgot Password?</a>
                        </div>
                        <button type="submit" class="btn-primary full-width" id="loginSubmitBtn">
                            <span id="loginText">Sign In</span>
                            <div class="spinner" id="loginSpinner" style="display: none;"></div>
                        </button>
                    </form>
                    
                    <div class="auth-divider">
                        <span>Or continue with</span>
                    </div>
                    
                    <button class="btn-google" id="googleSignIn">
                        <i class="fab fa-google"></i> Google
                    </button>
                    
                    <div class="auth-switch">
                        <span id="switchText">Already have an account?</span>
                        <a href="#" class="link" id="switchLink">Sign In</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept="image/*" style="display: none;">
    
    <script src="app.js"></script>
    <script>
        // Authentication Module
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const loadingScreen = document.getElementById('loadingScreen');
            const authPage = document.getElementById('authPage');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const authForm = document.getElementById('authForm');
            const signupForm = document.getElementById('signupForm');
            const loginForm = document.getElementById('loginForm');
            const signupBtn = document.getElementById('signupBtn');
            const loginBtn = document.getElementById('loginBtn');
            const backBtn = document.getElementById('backBtn');
            const authTitle = document.getElementById('authTitle');
            const authSubtitle = document.getElementById('authSubtitle');
            const switchLink = document.getElementById('switchLink');
            const switchText = document.getElementById('switchText');
            const togglePassword = document.getElementById('togglePassword');
            const toggleLoginPassword = document.getElementById('toggleLoginPassword');
            const registerBtn = document.getElementById('registerBtn');
            const loginSubmitBtn = document.getElementById('loginSubmitBtn');
            const registerSpinner = document.getElementById('registerSpinner');
            const loginSpinner = document.getElementById('loginSpinner');
            const registerText = document.getElementById('registerText');
            const loginText = document.getElementById('loginText');
            const uploadBtn = document.getElementById('uploadBtn');
            const removeBtn = document.getElementById('removeBtn');
            const fileInput = document.getElementById('fileInput');
            const uploadPreview = document.getElementById('uploadPreview');
            
            let profileImage = null;
            let isLoginMode = false;
            
            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
                authDomain: "zynapse-68181.firebaseapp.com",
                databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
                projectId: "zynapse-68181",
                storageBucket: "zynapse-68181.firebasestorage.app",
                messagingSenderId: "841353050519",
                appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
                measurementId: "G-4764XLL6WS"
            };
            
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();
            
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    authPage.style.display = 'flex';
                    
                    if (user) {
                        // User is logged in, redirect to home
                        window.location.href = 'home.html';
                    }
                }, 1500);
            });
            
            // Show Signup Form
            signupBtn.addEventListener('click', () => {
                showAuthForm('signup');
            });
            
            // Show Login Form
            loginBtn.addEventListener('click', () => {
                showAuthForm('login');
            });
            
            // Back to Welcome Screen
            backBtn.addEventListener('click', () => {
                authForm.style.display = 'none';
                welcomeScreen.style.display = 'block';
                resetForms();
            });
            
            // Toggle Password Visibility
            togglePassword?.addEventListener('click', () => {
                const passwordInput = document.getElementById('password');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                togglePassword.classList.toggle('fa-eye');
                togglePassword.classList.toggle('fa-eye-slash');
            });
            
            toggleLoginPassword?.addEventListener('click', () => {
                const passwordInput = document.getElementById('loginPassword');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                toggleLoginPassword.classList.toggle('fa-eye');
                toggleLoginPassword.classList.toggle('fa-eye-slash');
            });
            
            // Toggle between Signup and Login
            switchLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLoginMode = !isLoginMode;
                showAuthForm(isLoginMode ? 'login' : 'signup');
            });
            
            // Profile Image Upload
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        showToast('Image size must be less than 5MB', 'error');
                        return;
                    }
                    
                    profileImage = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadPreview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
                        removeBtn.style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            removeBtn.addEventListener('click', () => {
                profileImage = null;
                uploadPreview.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-user-circle"></i>
                        <span>No image selected</span>
                        <p>Max 5MB</p>
                    </div>
                `;
                removeBtn.style.display = 'none';
                fileInput.value = '';
            });
            
            // Signup Form Submission
            document.getElementById('signupForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const terms = document.getElementById('terms').checked;
                
                if (!terms) {
                    showToast('Please accept the Terms of Service', 'error');
                    return;
                }
                
                if (!name || !phone || !email || !password) {
                    showToast('Please fill in all fields', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showToast('Password must be at least 6 characters', 'error');
                    return;
                }
                
                // Generate User ID
                const userId = 'ZYN-' + Math.floor(1000 + Math.random() * 9000);
                
                registerBtn.disabled = true;
                registerText.style.display = 'none';
                registerSpinner.style.display = 'block';
                
                try {
                    // Create user with email and password
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Upload profile image to Cloudinary
                    let profileUrl = 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png';
                    
                    if (profileImage) {
                        profileUrl = await uploadToCloudinary(profileImage);
                    }
                    
                    // Save user data to Firebase
                    const userData = {
                        name: name,
                        phone: phone,
                        email: email,
                        userId: userId,
                        profileUrl: profileUrl,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP,
                        status: 'Hey there! I am using Zynapse',
                        contacts: {},
                        chatRequests: {},
                        zynes: {},
                        groups: {}
                    };
                    
                    await database.ref('users/' + user.uid).set(userData);
                    await database.ref('userIds/' + userId).set(user.uid);
                    
                    showToast('Account created successfully!', 'success');
                    
                    // Auto-login
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 1500);
                    
                } catch (error) {
                    console.error('Signup error:', error);
                    let errorMessage = 'Failed to create account. ';
                    
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage += 'Email already registered.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage += 'Invalid email address.';
                            break;
                        case 'auth/weak-password':
                            errorMessage += 'Password is too weak.';
                            break;
                        default:
                            errorMessage += 'Please try again.';
                    }
                    
                    showToast(errorMessage, 'error');
                } finally {
                    registerBtn.disabled = false;
                    registerText.style.display = 'block';
                    registerSpinner.style.display = 'none';
                }
            });
            
            // Login Form Submission
            document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                if (!email || !password) {
                    showToast('Please fill in all fields', 'error');
                    return;
                }
                
                loginSubmitBtn.disabled = true;
                loginText.style.display = 'none';
                loginSpinner.style.display = 'block';
                
                try {
                    // Set persistence based on remember me
                    const persistence = rememberMe ? 
                        firebase.auth.Auth.Persistence.LOCAL : 
                        firebase.auth.Auth.Persistence.SESSION;
                    
                    await auth.setPersistence(persistence);
                    
                    // Sign in user
                    await auth.signInWithEmailAndPassword(email, password);
                    
                    showToast('Login successful!', 'success');
                    
                    // Update last seen
                    const user = auth.currentUser;
                    if (user) {
                        await database.ref('users/' + user.uid + '/lastSeen').set(firebase.database.ServerValue.TIMESTAMP);
                    }
                    
                    // Redirect to home
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 1000);
                    
                } catch (error) {
                    console.error('Login error:', error);
                    let errorMessage = 'Login failed. ';
                    
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage += 'No account found with this email.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage += 'Incorrect password.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage += 'Invalid email address.';
                            break;
                        default:
                            errorMessage += 'Please try again.';
                    }
                    
                    showToast(errorMessage, 'error');
                } finally {
                    loginSubmitBtn.disabled = false;
                    loginText.style.display = 'block';
                    loginSpinner.style.display = 'none';
                }
            });
            
            // Google Sign In
            document.getElementById('googleSignIn')?.addEventListener('click', () => {
                showToast('Google sign in coming soon', 'info');
            });
            
            // Forgot Password
            document.getElementById('forgotPassword')?.addEventListener('click', (e) => {
                e.preventDefault();
                showToast('Password reset feature coming soon', 'info');
            });
            
            // Helper Functions
            function showAuthForm(mode) {
                welcomeScreen.style.display = 'none';
                authForm.style.display = 'block';
                
                if (mode === 'signup') {
                    isLoginMode = false;
                    authTitle.textContent = 'Sign Up';
                    authSubtitle.textContent = 'Create your Zynapse account';
                    signupForm.style.display = 'block';
                    loginForm.style.display = 'none';
                    switchText.textContent = 'Already have an account?';
                    switchLink.textContent = 'Sign In';
                } else {
                    isLoginMode = true;
                    authTitle.textContent = 'Sign In';
                    authSubtitle.textContent = 'Welcome back to Zynapse';
                    signupForm.style.display = 'none';
                    loginForm.style.display = 'block';
                    switchText.textContent = "Don't have an account?";
                    switchLink.textContent = 'Sign Up';
                }
            }
            
            function resetForms() {
                document.getElementById('signupForm')?.reset();
                document.getElementById('loginForm')?.reset();
                profileImage = null;
                uploadPreview.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-user-circle"></i>
                        <span>No image selected</span>
                        <p>Max 5MB</p>
                    </div>
                `;
                removeBtn.style.display = 'none';
                fileInput.value = '';
            }
            
            // Cloudinary Upload Function
            async function uploadToCloudinary(file) {
                const cloudName = 'dd3lcymrk';
                const uploadPreset = 'h3eyhc2o';
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);
                formData.append('folder', 'zynapse/profiles');
                
                try {
                    const response = await fetch(
                        `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
                        {
                            method: 'POST',
                            body: formData
                        }
                    );
                    
                    const data = await response.json();
                    return data.secure_url;
                } catch (error) {
                    console.error('Cloudinary upload error:', error);
                    return 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png';
                }
            }
            
            // Toast Notification Function
            function showToast(message, type = 'info') {
                const toastContainer = document.querySelector('.toast-container') || createToastContainer();
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                let icon = 'fa-info-circle';
                if (type === 'success') icon = 'fa-check-circle';
                if (type === 'error') icon = 'fa-exclamation-circle';
                if (type === 'warning') icon = 'fa-exclamation-triangle';
                
                toast.innerHTML = `
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                `;
                
                toastContainer.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
            
            function createToastContainer() {
                const container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
                return container;
            }
        });
    </script>
</body>
</html>
