<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zynapse - Secure Messaging</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="zynaps.png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>
</head>
<body>
    <div class="auth-page">
        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-content">
                <div class="spinner-large"></div>
                <p>Loading Zynapse...</p>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen">
            <img src="zynaps.png" class="logo-large" alt="Zynapse Logo">
            <h1>Zynapse</h1>
            <p class="tagline">Connect. Communicate. Collaborate.<br>Secure messaging for the modern world.</p>
            <p class="powered-by">Powered by Buffer Zone</p>
            <div class="welcome-actions">
                <button class="btn-primary" id="showSignupBtn">Create Account</button>
                <button class="btn-secondary" id="showLoginBtn">Log In</button>
            </div>
            <div class="welcome-footer">
                By continuing, you agree to our <a href="#" class="link">Terms</a> and <a href="#" class="link">Privacy Policy</a>
            </div>
        </div>

        <!-- Sign Up Form -->
        <div class="auth-form" id="signupForm" style="display: none;">
            <div class="auth-header">
                <button class="back-btn" id="backFromSignup">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <img src="zynaps.png" class="logo-small" alt="Zynapse">
                <h2>Create Account</h2>
                <p>Join Zynapse today</p>
            </div>
            
            <form id="signupFormActual">
                <div class="auth-form-content">
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" placeholder="Full Name" id="signupName" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-phone"></i>
                        <input type="tel" placeholder="Phone Number" id="signupPhone" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" placeholder="Email Address" id="signupEmail" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" placeholder="Password" id="signupPassword" required>
                        <i class="fas fa-eye toggle-password"></i>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" placeholder="Confirm Password" id="signupConfirmPassword" required>
                    </div>
                    
                    <div class="profile-upload-section">
                        <label class="upload-label">Profile Picture</label>
                        <div class="profile-upload-container">
                            <div class="upload-preview" id="profilePreview">
                                <div class="preview-placeholder">
                                    <i class="fas fa-user-circle"></i>
                                    <span>No image</span>
                                </div>
                            </div>
                            <div class="upload-buttons">
                                <button type="button" class="btn-upload" id="uploadProfileBtn">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <button type="button" class="btn-remove" id="removeProfileBtn" style="display: none;">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                        <input type="file" id="profileImage" accept="image/*" style="display: none;">
                        <p class="upload-hint">Upload a clear profile picture (max 5MB)</p>
                    </div>
                    
                    <div class="terms-agreement">
                        <input type="checkbox" id="termsAgree" required>
                        <label for="termsAgree">I agree to the Terms of Service and Privacy Policy</label>
                    </div>
                    
                    <button type="submit" class="btn-primary" id="signupBtn">
                        <span>Create Account</span>
                        <div class="spinner-small" style="display: none;"></div>
                    </button>
                    
                    <div class="auth-divider">
                        <span>Or</span>
                    </div>
                    
                    <button type="button" class="btn-google" id="googleSignupBtn">
                        <i class="fab fa-google"></i> Sign up with Google
                    </button>
                    
                    <div class="auth-switch">
                        Already have an account? <a href="#" class="link" id="switchToLogin">Log In</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Login Form -->
        <div class="auth-form" id="loginForm" style="display: none;">
            <div class="auth-header">
                <button class="back-btn" id="backFromLogin">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <img src="zynaps.png" class="logo-small" alt="Zynapse">
                <h2>Welcome Back</h2>
                <p>Sign in to your account</p>
            </div>
            
            <form id="loginFormActual">
                <div class="auth-form-content">
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" placeholder="Email Address" id="loginEmail" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" placeholder="Password" id="loginPassword" required>
                        <i class="fas fa-eye toggle-password"></i>
                    </div>
                    
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">Remember me</label>
                        <a href="#" class="forgot-password">Forgot Password?</a>
                    </div>
                    
                    <button type="submit" class="btn-primary" id="loginBtn">
                        <span>Sign In</span>
                        <div class="spinner-small" style="display: none;"></div>
                    </button>
                    
                    <div class="auth-divider">
                        <span>Or</span>
                    </div>
                    
                    <button type="button" class="btn-google" id="googleLoginBtn">
                        <i class="fab fa-google"></i> Sign in with Google
                    </button>
                    
                    <div class="auth-switch">
                        Don't have an account? <a href="#" class="link" id="switchToSignup">Sign Up</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <audio id="notificationSound" preload="auto">
        <source src="notification.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
            authDomain: "zynapse-68181.firebaseapp.com",
            databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
            projectId: "zynapse-68181",
            storageBucket: "zynapse-68181.firebasestorage.app",
            messagingSenderId: "841353050519",
            appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
            measurementId: "G-4764XLL6WS"
        };

        // Cloudinary Configuration
        const CLOUDINARY_CONFIG = {
            cloudName: 'dd3lcymrk',
            apiKey: '489857926297197',
            uploadPreset: 'h3eyhc2o',
            folder: 'zynapse/profiles'
        };

        // Global variables
        let currentUser = null;
        let profileImageFile = null;
        let profileImageUrl = null;

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                
                // Hide loading screen after 1 second
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 300);
                }, 1000);

                // Check authentication state
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        // User is signed in, redirect to home
                        window.location.href = 'home.html';
                    }
                });

                // Setup event listeners
                setupAuthEventListeners();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize app. Please refresh.', 'error');
            }
        });

        function setupAuthEventListeners() {
            // Welcome screen buttons
            document.getElementById('showSignupBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
            });

            document.getElementById('showLoginBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
            });

            // Back buttons
            document.getElementById('backFromSignup').addEventListener('click', () => {
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'block';
                resetSignupForm();
            });

            document.getElementById('backFromLogin').addEventListener('click', () => {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'block';
                resetLoginForm();
            });

            // Form switching
            document.getElementById('switchToLogin').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
            });

            document.getElementById('switchToSignup').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
            });

            // Password toggle
            document.querySelectorAll('.toggle-password').forEach(icon => {
                icon.addEventListener('click', function() {
                    const input = this.parentElement.querySelector('input');
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    this.classList.toggle('fa-eye');
                    this.classList.toggle('fa-eye-slash');
                });
            });

            // Profile image upload
            document.getElementById('uploadProfileBtn').addEventListener('click', () => {
                document.getElementById('profileImage').click();
            });

            document.getElementById('profileImage').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Validate file size (5MB max)
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('File size must be less than 5MB', 'error');
                        return;
                    }
                    
                    // Validate file type
                    if (!file.type.match('image.*')) {
                        showToast('Please select an image file', 'error');
                        return;
                    }
                    
                    profileImageFile = file;
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('profilePreview');
                        preview.innerHTML = '';
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        preview.appendChild(img);
                        document.getElementById('removeProfileBtn').style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('removeProfileBtn').addEventListener('click', () => {
                profileImageFile = null;
                const preview = document.getElementById('profilePreview');
                preview.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-user-circle"></i>
                        <span>No image</span>
                    </div>
                `;
                document.getElementById('removeProfileBtn').style.display = 'none';
                document.getElementById('profileImage').value = '';
            });

            // Sign up form submission
            document.getElementById('signupFormActual').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleSignup();
            });

            // Login form submission
            document.getElementById('loginFormActual').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleLogin();
            });

            // Google sign in
            document.getElementById('googleSignupBtn').addEventListener('click', handleGoogleSignIn);
            document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleSignIn);
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            
            // Validation
            if (!name || !phone || !email || !password || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (!document.getElementById('termsAgree').checked) {
                showToast('Please agree to the terms and conditions', 'error');
                return;
            }
            
            const btn = document.getElementById('signupBtn');
            const btnText = btn.querySelector('span');
            const spinner = btn.querySelector('.spinner-small');
            
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';
            
            try {
                // Create user in Firebase Auth
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Generate user ID
                const userId = generateUserId();
                
                // Upload profile image if exists
                let profileUrl = null;
                if (profileImageFile) {
                    profileUrl = await uploadToCloudinary(profileImageFile);
                }
                
                // Save user data to Realtime Database
                await firebase.database().ref(`users/${user.uid}`).set({
                    uid: user.uid,
                    userId: userId,
                    name: name,
                    phone: phone,
                    email: email,
                    profileUrl: profileUrl,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastActive: firebase.database.ServerValue.TIMESTAMP,
                    status: 'Hey there! I am using Zynapse'
                });
                
                // Create user's contacts node
                await firebase.database().ref(`contacts/${user.uid}`).set({});
                
                showToast('Account created successfully!', 'success');
                
                // Auto login and redirect
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1500);
                
            } catch (error) {
                console.error('Signup error:', error);
                let message = 'Failed to create account';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Email already in use';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Password is too weak';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address';
                }
                showToast(message, 'error');
                
                btn.disabled = false;
                btnText.style.display = 'block';
                spinner.style.display = 'none';
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }
            
            const btn = document.getElementById('loginBtn');
            const btnText = btn.querySelector('span');
            const spinner = btn.querySelector('.spinner-small');
            
            btn.disabled = true;
            btnText.style.display = 'none';
            spinner.style.display = 'block';
            
            try {
                await firebase.auth().signInWithEmailAndPassword(email, password);
                
                showToast('Logged in successfully!', 'success');
                
                // Update last active time
                const user = firebase.auth().currentUser;
                if (user) {
                    await firebase.database().ref(`users/${user.uid}/lastActive`).set(firebase.database.ServerValue.TIMESTAMP);
                }
                
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                let message = 'Login failed';
                if (error.code === 'auth/user-not-found') {
                    message = 'User not found';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Invalid email address';
                }
                showToast(message, 'error');
                
                btn.disabled = false;
                btnText.style.display = 'block';
                spinner.style.display = 'none';
            }
        }

        async function handleGoogleSignIn() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await firebase.auth().signInWithPopup(provider);
                const user = result.user;
                
                // Check if user exists in database
                const userRef = firebase.database().ref(`users/${user.uid}`);
                const snapshot = await userRef.once('value');
                
                if (!snapshot.exists()) {
                    // New user - create record
                    const userId = generateUserId();
                    await userRef.set({
                        uid: user.uid,
                        userId: userId,
                        name: user.displayName || 'User',
                        email: user.email,
                        profileUrl: user.photoURL,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastActive: firebase.database.ServerValue.TIMESTAMP,
                        status: 'Hey there! I am using Zynapse',
                        isGoogleUser: true
                    });
                    
                    // Create user's contacts node
                    await firebase.database().ref(`contacts/${user.uid}`).set({});
                } else {
                    // Update last active time for existing user
                    await userRef.child('lastActive').set(firebase.database.ServerValue.TIMESTAMP);
                }
                
                showToast('Signed in with Google!', 'success');
                setTimeout(() => {
                    window.location.href = 'home.html';
                }, 1000);
                
            } catch (error) {
                console.error('Google sign in error:', error);
                showToast('Failed to sign in with Google', 'error');
            }
        }

        function generateUserId() {
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `ZYN-${randomNum}`;
        }

        async function uploadToCloudinary(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                formData.append('folder', CLOUDINARY_CONFIG.folder);
                
                fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.secure_url) {
                        resolve(data.secure_url);
                    } else {
                        reject(new Error('Upload failed'));
                    }
                })
                .catch(error => {
                    reject(error);
                });
            });
        }

        function showToast(message, type = 'info') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function resetSignupForm() {
            document.getElementById('signupFormActual').reset();
            profileImageFile = null;
            const preview = document.getElementById('profilePreview');
            preview.innerHTML = `
                <div class="preview-placeholder">
                    <i class="fas fa-user-circle"></i>
                    <span>No image</span>
                </div>
            `;
            document.getElementById('removeProfileBtn').style.display = 'none';
        }

        function resetLoginForm() {
            document.getElementById('loginFormActual').reset();
        }

        // Add spinner CSS
        const style = document.createElement('style');
        style.textContent = `
            .spinner-small {
                width: 18px;
                height: 18px;
                border: 2px solid rgba(255,255,255,0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                display: none;
            }
            
            .remember-me {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin: 10px 0;
                font-size: 14px;
            }
            
            .remember-me label {
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
            }
            
            .remember-me input[type="checkbox"] {
                width: 16px;
                height: 16px;
                accent-color: var(--blue);
            }
            
            .forgot-password {
                color: var(--blue);
                text-decoration: none;
                font-weight: 600;
            }
            
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
