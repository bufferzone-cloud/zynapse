<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zynapse - Sign Up</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="zynaps.png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- ImageKit SDK -->
    <script src="https://unpkg.com/imagekit-javascript/dist/imagekit.min.js"></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <img src="zynaps.png" alt="Zynapse Logo">
                </div>
                <h1 class="auth-title">Zynapse</h1>
                <p class="auth-subtitle">
                    Secure, private messaging built for Zambia. Connect instantly with friends, family, and colleagues.
                </p>
                <div class="powered-by">Powered by Buffer Zone</div>
            </div>

            <div id="loginForm" class="auth-form">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                </div>
                
                <button onclick="login()" class="btn btn-primary" style="width: 100%;">
                    Sign In
                </button>
                
                <div class="text-center mt-3">
                    <p class="text-muted">Don't have an account? <a href="#" onclick="showSignup()" style="color: var(--primary-blue); text-decoration: none;">Sign Up</a></p>
                </div>
            </div>

            <div id="signupForm" class="auth-form hidden">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="signupName" class="form-input" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" id="signupPhone" class="form-input" placeholder="+260 00 000 0000" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="signupPassword" class="form-input" placeholder="Create a strong password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Profile Picture</label>
                    <div class="file-upload-container">
                        <label for="profilePicture" class="file-upload-label">
                            <img id="profilePreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23C7C7CC'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" 
                                 class="file-upload-preview" alt="Profile Preview">
                            <span class="text-muted">Tap to upload profile picture</span>
                        </label>
                        <input type="file" id="profilePicture" accept="image/*" class="hidden" onchange="previewProfile()">
                    </div>
                </div>
                
                <button onclick="signup()" class="btn btn-primary" style="width: 100%;">
                    Create Account
                </button>
                
                <div class="text-center mt-3">
                    <p class="text-muted">Already have an account? <a href="#" onclick="showLogin()" style="color: var(--primary-blue); text-decoration: none;">Sign In</a></p>
                </div>
            </div>

            <div id="loading" class="hidden text-center">
                <div class="loading-skeleton" style="width: 100%; height: 48px; border-radius: var(--radius-md); margin-bottom: 16px;"></div>
                <p class="text-muted">Please wait...</p>
            </div>

            <div id="errorMessage" class="hidden" style="background: rgba(255,59,48,0.1); color: var(--message-red); padding: 12px; border-radius: var(--radius-md); margin-top: 16px; text-align: center;">
                <!-- Error message will appear here -->
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="imagekit-config.js"></script>
    <script>
        // Show login form by default
        showLogin();

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function previewProfile() {
            const file = document.getElementById('profilePicture').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        function generateUserId() {
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `ZYN-${randomNum}`;
        }

        async function signup() {
            const name = document.getElementById('signupName').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const profileFile = document.getElementById('profilePicture').files[0];

            if (!name || !phone || !email || !password) {
                showError('Please fill in all required fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters long');
                return;
            }

            showLoading(true);

            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Generate unique user ID
                const userId = generateUserId();

                let profileUrl = '';
                if (profileFile) {
                    // Upload profile picture to ImageKit
                    const result = await uploadToImageKit(profileFile, `profile_${userId}.jpg`, ['profile']);
                    profileUrl = result.url;
                }

                // Save user data to Firebase Database
                await database.ref('users/' + userId).set({
                    name: name,
                    phone: phone,
                    email: email,
                    userId: userId,
                    profileUrl: profileUrl,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    status: 'online'
                });

                // Update user's auth profile
                await user.updateProfile({
                    displayName: name,
                    photoURL: profileUrl
                });

                // Redirect to home page
                window.location.href = 'home.html';

            } catch (error) {
                showLoading(false);
                showError(error.message);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }

            showLoading(true);

            try {
                await auth.signInWithEmailAndPassword(email, password);
                window.location.href = 'home.html';
            } catch (error) {
                showLoading(false);
                showError(error.message);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (show) {
                loginForm.classList.add('hidden');
                signupForm.classList.add('hidden');
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
                if (signupForm.classList.contains('hidden')) {
                    loginForm.classList.remove('hidden');
                } else {
                    signupForm.classList.remove('hidden');
                }
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user && window.location.pathname.endsWith('index.html')) {
                window.location.href = 'home.html';
            }
        });
    </script>
</body>
</html>
