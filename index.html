<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zynapse - Secure Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cloudinary-core@2.13.0/cloudinary-core-shrinkwrap.min.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        /* ===== BASE RESET & GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: none;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .screen {
            display: none;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: #ffffff;
        }

        .screen.active {
            display: block;
        }

        /* ===== SIGNUP/LOGIN SCREEN ===== */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-placeholder {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            border-radius: 24px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 122, 255, 0.2);
        }

        .logo-placeholder i {
            font-size: 48px;
            color: white;
        }

        .app-name {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 18px;
            color: #8E8E93;
            margin-bottom: 30px;
            text-align: center;
            max-width: 400px;
            line-height: 1.5;
        }

        .powered-by {
            font-size: 14px;
            color: #C7C7CC;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .powered-by .buffer-dot {
            width: 6px;
            height: 6px;
            background: #34C759;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid #F2F2F7;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-title {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 10px;
            text-align: center;
        }

        .form-subtitle {
            font-size: 14px;
            color: #8E8E93;
            margin-bottom: 25px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 16px;
            border: 2px solid #F2F2F7;
            border-radius: 12px;
            font-size: 16px;
            background: #F8F8F8;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .profile-upload-container {
            text-align: center;
            margin-bottom: 25px;
        }

        .profile-image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #F2F2F7;
            margin: 0 auto 15px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .profile-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #8E8E93;
        }

        .upload-placeholder i {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 12px;
            color: #007AFF;
            margin-top: 5px;
        }

        .user-id-display {
            background: #F8F8F8;
            border: 2px solid #F2F2F7;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
        }

        .user-id-label {
            font-size: 14px;
            color: #8E8E93;
            margin-bottom: 8px;
        }

        .user-id-value {
            font-size: 24px;
            font-weight: 700;
            color: #007AFF;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .copy-id-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-id-btn:hover {
            background: #0056CC;
        }

        .copy-id-btn.copied {
            background: #34C759;
        }

        .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 122, 255, 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            width: 100%;
            padding: 16px;
            background: transparent;
            color: #007AFF;
            border: 2px solid #F2F2F7;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-secondary:hover {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }

        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }

        .form-navigation button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-back {
            background: #F2F2F7;
            color: #8E8E93;
        }

        .btn-back:hover {
            background: #E5E5EA;
        }

        .btn-next {
            background: #007AFF;
            color: white;
        }

        .btn-next:hover {
            background: #0056CC;
        }

        .login-prompt {
            text-align: center;
            margin-top: 25px;
            color: #8E8E93;
            font-size: 14px;
        }

        .login-link {
            color: #007AFF;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .login-link:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #FF3B30;
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .success-message {
            background: #34C759;
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        /* ===== MAIN APP LAYOUT ===== */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid #F2F2F7;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo-small {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-logo-small i {
            color: white;
            font-size: 18px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
        }

        .user-id-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-id-header {
            font-size: 12px;
            color: #8E8E93;
            font-family: monospace;
        }

        .copy-btn-small {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: #F2F2F7;
            border: none;
            color: #007AFF;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .copy-btn-small:hover {
            background: #E5E5EA;
        }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: #F2F2F7;
            border: none;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background: #E5E5EA;
        }

        .app-main {
            position: absolute;
            top: 60px;
            bottom: 70px;
            left: 0;
            right: 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .app-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid #F2F2F7;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-width: 70px;
        }

        .nav-item:hover {
            background: rgba(0, 122, 255, 0.05);
        }

        .nav-item.active {
            color: #007AFF;
        }

        .nav-item.active .nav-icon {
            color: #007AFF;
        }

        .nav-icon {
            font-size: 22px;
            color: #8E8E93;
            transition: all 0.3s ease;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            color: #8E8E93;
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-label {
            color: #007AFF;
        }

        .nav-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #FF3B30;
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* ===== FLOATING CHAT BUTTON ===== */
        .floating-chat-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            border-radius: 30px;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 122, 255, 0.3);
            z-index: 999;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(0, 122, 255, 0.4);
        }

        .floating-chat-btn:active {
            transform: scale(0.95);
        }

        /* ===== HOME SCREEN (CHAT LIST) ===== */
        .home-screen {
            padding: 20px;
        }

        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: #F2F2F7;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #F2F2F7;
        }

        .chat-item:hover {
            background: #F8F8F8;
        }

        .chat-item.active {
            background: rgba(0, 122, 255, 0.05);
        }

        .chat-avatar {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            margin-right: 15px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 12px;
            color: #8E8E93;
        }

        .chat-preview {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-message {
            font-size: 14px;
            color: #8E8E93;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .chat-badge {
            background: #007AFF;
            color: white;
            font-size: 12px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            color: #F2F2F7;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: #8E8E93;
            margin-bottom: 10px;
        }

        .empty-subtitle {
            font-size: 14px;
            color: #C7C7CC;
            max-width: 300px;
            margin: 0 auto;
        }

        /* ===== START CHAT POPUP ===== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .popup-container {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .popup-header {
            padding: 25px 25px 15px;
            border-bottom: 1px solid #F2F2F7;
        }

        .popup-title {
            font-size: 20px;
            font-weight: 700;
            color: #000000;
            margin-bottom: 5px;
        }

        .popup-subtitle {
            font-size: 14px;
            color: #8E8E93;
        }

        .popup-content {
            padding: 25px;
        }

        .user-search-result {
            display: none;
            background: #F8F8F8;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.3s ease;
        }

        .user-result-header {
            font-size: 12px;
            color: #8E8E93;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-result-card {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .result-avatar {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .result-id {
            font-size: 12px;
            color: #8E8E93;
            font-family: monospace;
        }

        .popup-footer {
            padding: 20px 25px 25px;
            border-top: 1px solid #F2F2F7;
            display: flex;
            gap: 12px;
        }

        .popup-footer .btn-secondary {
            flex: 1;
            margin: 0;
        }

        .popup-footer .btn-primary {
            flex: 1;
            margin: 0;
        }

        /* ===== CHAT INTERFACE ===== */
        .chat-screen {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
        }

        .chat-header-bar {
            height: 60px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #F2F2F7;
            background: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .chat-back-btn {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: #F2F2F7;
            border: none;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            transition: all 0.2s ease;
        }

        .chat-back-btn:hover {
            background: #E5E5EA;
        }

        .chat-contact-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .chat-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .chat-contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-contact-details {
            flex: 1;
            min-width: 0;
        }

        .chat-contact-name {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-contact-status {
            font-size: 12px;
            color: #34C759;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: #F2F2F7;
            border: none;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .chat-action-btn:hover {
            background: #E5E5EA;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            display: none;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid #F2F2F7;
        }

        .dropdown-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #F2F2F7;
            color: #000000;
            text-decoration: none;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #F8F8F8;
        }

        .dropdown-item i {
            width: 20px;
            color: #8E8E93;
        }

        .dropdown-item.danger {
            color: #FF3B30;
        }

        .dropdown-item.danger i {
            color: #FF3B30;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: white;
        }

        .message-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .message-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 80%;
        }

        .message-row.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-row.received {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            overflow: hidden;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message-row.received:not(:first-child) .message-avatar {
            visibility: hidden;
        }

        .message-row.received .message-avatar {
            opacity: 1;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            max-width: 100%;
        }

        .message-row.sent .message-bubble {
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-row.received .message-bubble {
            background: #F2F2F7;
            color: #000000;
            border-bottom-left-radius: 4px;
        }

        .message-text {
            font-size: 16px;
            line-height: 1.4;
        }

        .message-media {
            margin: 8px -4px 0 -4px;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }

        .message-media img, .message-media video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 12px;
        }

        .message-file {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 8px;
        }

        .message-file i {
            font-size: 24px;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 12px;
            opacity: 0.8;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
            text-align: right;
        }

        .message-row.received .message-time {
            color: #8E8E93;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: #F2F2F7;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #8E8E93;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }

        .chat-input-container {
            padding: 12px 20px;
            background: white;
            border-top: 1px solid #F2F2F7;
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        .attachment-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #F2F2F7;
            border: none;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .attachment-btn:hover {
            background: #E5E5EA;
        }

        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 16px;
            border: 2px solid #F2F2F7;
            border-radius: 20px;
            font-size: 16px;
            line-height: 1.4;
            resize: none;
            background: #F8F8F8;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .message-input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #007AFF;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: #0056CC;
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #F2F2F7;
            color: #8E8E93;
            cursor: not-allowed;
            transform: none;
        }

        .attachment-menu {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background: white;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            padding: 12px;
            display: none;
            z-index: 1000;
            border: 1px solid #F2F2F7;
        }

        .attachment-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 180px;
        }

        .attachment-option:hover {
            background: #F8F8F8;
        }

        .attachment-option i {
            font-size: 20px;
            color: #007AFF;
            width: 24px;
        }

        /* ===== ZYNES SCREEN ===== */
        .zynes-screen {
            padding: 20px;
        }

        .create-zyne {
            background: white;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #F2F2F7;
        }

        .create-zyne-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .create-zyne-avatar {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .create-zyne-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .create-zyne-prompt {
            font-size: 16px;
            color: #8E8E93;
            cursor: pointer;
            flex: 1;
        }

        .zyne-form {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .zyne-text-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #F2F2F7;
            border-radius: 15px;
            font-size: 16px;
            margin-bottom: 15px;
            resize: vertical;
            background: #F8F8F8;
            transition: all 0.3s ease;
        }

        .zyne-text-input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
        }

        .zyne-media-preview {
            position: relative;
            margin-bottom: 15px;
            border-radius: 15px;
            overflow: hidden;
        }

        .zyne-media-preview img, .zyne-media-preview video {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 15px;
        }

        .remove-media-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 18px;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-media-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .zyne-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .media-upload-btns {
            display: flex;
            gap: 10px;
        }

        .media-upload-btn {
            width: 44px;
            height: 44px;
            border-radius: 22px;
            background: #F2F2F7;
            border: none;
            color: #007AFF;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .media-upload-btn:hover {
            background: #E5E5EA;
        }

        .zynes-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .zyne-card {
            background: white;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #F2F2F7;
            animation: fadeIn 0.5s ease;
        }

        .zyne-header {
            display: flex;
            align-items: center;
            padding: 15px;
            gap: 12px;
        }

        .zyne-avatar {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .zyne-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .zyne-user-info {
            flex: 1;
            min-width: 0;
        }

        .zyne-user-name {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .zyne-time {
            font-size: 12px;
            color: #8E8E93;
        }

        .zyne-menu-btn {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: #F2F2F7;
            border: none;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .zyne-menu-btn:hover {
            background: #E5E5EA;
        }

        .zyne-content {
            padding: 0 15px 15px;
        }

        .zyne-text {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 15px;
            color: #000000;
        }

        .zyne-media {
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .zyne-media img, .zyne-media video {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            display: block;
        }

        .zyne-stats {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 0 15px 15px;
            color: #8E8E93;
            font-size: 14px;
        }

        .zyne-likes, .zyne-comments {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .zyne-likes.active {
            color: #FF3B30;
        }

        .zyne-actions-bar {
            display: flex;
            border-top: 1px solid #F2F2F7;
        }

        .zyne-action-btn {
            flex: 1;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: none;
            border: none;
            color: #8E8E93;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .zyne-action-btn:hover {
            background: #F8F8F8;
        }

        .zyne-action-btn.active {
            color: #007AFF;
        }

        .zyne-comments-section {
            padding: 15px;
            border-top: 1px solid #F2F2F7;
            background: #F8F8F8;
            display: none;
        }

        .zyne-comment {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .zyne-comment:last-child {
            margin-bottom: 0;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 16px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-content {
            flex: 1;
            background: white;
            padding: 10px 15px;
            border-radius: 15px;
            border-top-left-radius: 4px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .comment-name {
            font-size: 14px;
            font-weight: 600;
            color: #000000;
        }

        .comment-time {
            font-size: 12px;
            color: #8E8E93;
        }

        .comment-text {
            font-size: 14px;
            color: #000000;
            line-height: 1.4;
        }

        .add-comment {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #F2F2F7;
            border-radius: 15px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
        }

        .comment-input:focus {
            outline: none;
            border-color: #007AFF;
        }

        .comment-btn {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .comment-btn:hover {
            background: #0056CC;
        }

        /* ===== GROUPS SCREEN ===== */
        .groups-screen {
            padding: 20px;
        }

        .create-group-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .create-group-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 122, 255, 0.2);
        }

        .groups-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .group-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #F2F2F7;
        }

        .group-item:hover {
            background: #F8F8F8;
            transform: translateX(5px);
        }

        .group-avatar {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            margin-right: 15px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }

        .group-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .group-avatar.multi::before {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: #F2F2F7;
            border-radius: 10px;
            border: 2px solid white;
        }

        .group-avatar.multi::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            background: #E5E5EA;
            border-radius: 10px;
            border: 2px solid white;
        }

        .group-info {
            flex: 1;
            min-width: 0;
        }

        .group-name {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .group-members {
            font-size: 14px;
            color: #8E8E93;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .group-last-message {
            font-size: 14px;
            color: #8E8E93;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .group-unread {
            background: #007AFF;
            color: white;
            font-size: 12px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            flex-shrink: 0;
        }

        /* ===== CREATE GROUP POPUP ===== */
        .create-group-form {
            display: none;
        }

        .group-members-select {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #F2F2F7;
            border-radius: 12px;
            margin-bottom: 20px;
            background: #F8F8F8;
        }

        .member-select-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #F2F2F7;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .member-select-item:hover {
            background: white;
        }

        .member-select-item.selected {
            background: rgba(0, 122, 255, 0.1);
        }

        .member-select-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #C7C7CC;
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .member-select-item.selected .member-select-checkbox {
            background: #007AFF;
            border-color: #007AFF;
        }

        .member-select-item.selected .member-select-checkbox::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }

        .selected-members-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            min-height: 40px;
            padding: 10px;
            border: 2px dashed #F2F2F7;
            border-radius: 12px;
        }

        .selected-member-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(0, 122, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
        }

        .remove-member-btn {
            width: 18px;
            height: 18px;
            border-radius: 9px;
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .remove-member-btn:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        /* ===== CHAT REQUESTS SCREEN ===== */
        .requests-screen {
            padding: 20px;
        }

        .requests-tabs {
            display: flex;
            background: #F2F2F7;
            border-radius: 15px;
            padding: 4px;
            margin-bottom: 25px;
        }

        .request-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: none;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #8E8E93;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .request-tab.active {
            background: white;
            color: #007AFF;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .requests-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .request-card {
            background: white;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #F2F2F7;
            animation: fadeIn 0.5s ease;
        }

        .request-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .request-avatar {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .request-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .request-info {
            flex: 1;
            min-width: 0;
        }

        .request-name {
            font-size: 18px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .request-id {
            font-size: 14px;
            color: #8E8E93;
            font-family: monospace;
        }

        .request-time {
            font-size: 12px;
            color: #C7C7CC;
            margin-top: 4px;
        }

        .request-actions {
            display: flex;
            gap: 12px;
        }

        .request-actions button {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .accept-btn {
            background: #34C759;
            color: white;
        }

        .accept-btn:hover {
            background: #2DA94F;
        }

        .reject-btn {
            background: #F2F2F7;
            color: #FF3B30;
        }

        .reject-btn:hover {
            background: #FFD1D1;
        }

        /* ===== CONTACTS SCREEN ===== */
        .contacts-screen {
            padding: 20px;
        }

        .contacts-search {
            position: relative;
            margin-bottom: 25px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8E8E93;
        }

        .contacts-search-input {
            width: 100%;
            padding: 16px 16px 16px 45px;
            border: 2px solid #F2F2F7;
            border-radius: 15px;
            font-size: 16px;
            background: #F8F8F8;
            transition: all 0.3s ease;
        }

        .contacts-search-input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .contacts-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: #F2F2F7;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #F2F2F7;
        }

        .contact-item:hover {
            background: #F8F8F8;
        }

        .contact-avatar {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            margin-right: 15px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .contact-status {
            font-size: 14px;
            color: #8E8E93;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #C7C7CC;
        }

        .status-dot.online {
            background: #34C759;
            animation: pulse 2s infinite;
        }

        .contact-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .contact-item:hover .contact-actions {
            opacity: 1;
        }

        .contact-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #F2F2F7;
            border: none;
            color: #007AFF;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .contact-action-btn:hover {
            background: #E5E5EA;
        }

        .contact-action-btn.remove {
            color: #FF3B30;
        }

        /* ===== PROFILE VIEW MODAL ===== */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 3000;
            display: none;
            flex-direction: column;
            animation: slideInRight 0.4s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .profile-header {
            padding: 60px 20px 20px;
            background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            color: white;
            position: relative;
        }

        .profile-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .profile-back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 60px;
            border: 4px solid white;
            overflow: hidden;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name-large {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
        }

        .profile-id-large {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            font-family: monospace;
            letter-spacing: 1px;
        }

        .profile-content {
            flex: 1;
            padding: 30px 20px;
            overflow-y: auto;
        }

        .profile-section {
            background: white;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #F2F2F7;
        }

        .profile-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #F2F2F7;
        }

        .profile-info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 14px;
            color: #8E8E93;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: #000000;
        }

        /* ===== NOTIFICATIONS ===== */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            border-radius: 14px;
            padding: 15px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 4000;
            transform: translateX(150%);
            transition: transform 0.4s ease;
            border-left: 4px solid #007AFF;
            min-width: 300px;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: rgba(0, 122, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #007AFF;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 13px;
            color: #8E8E93;
            line-height: 1.4;
        }

        .notification-close {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: #F2F2F7;
            border: none;
            color: #8E8E93;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .notification-close:hover {
            background: #E5E5EA;
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #F2F2F7;
            border-top-color: #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, #F2F2F7 25%, #E5E5EA 50%, #F2F2F7 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-avatar {
            width: 56px;
            height: 56px;
            border-radius: 28px;
        }

        .skeleton-text {
            height: 16px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .skeleton-text.short {
            width: 60%;
        }

        .skeleton-text.medium {
            width: 80%;
        }

        /* ===== RESPONSIVE ADJUSTMENTS ===== */
        @media (max-width: 480px) {
            .app-name {
                font-size: 36px;
            }
            
            .tagline {
                font-size: 16px;
            }
            
            .auth-form {
                padding: 25px 20px;
            }
            
            .popup-container {
                width: 95%;
            }
            
            .message-row {
                max-width: 85%;
            }
            
            .notification {
                left: 20px;
                right: 20px;
                min-width: auto;
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 768px;
                margin: 0 auto;
                box-shadow: 0 0 60px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .flex {
            display: flex !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .slide-up {
            animation: slideUp 0.3s ease;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .p-20 {
            padding: 20px;
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #F2F2F7;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #C7C7CC;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8E8E93;
        }

        /* ===== SELECTION STYLING ===== */
        ::selection {
            background: rgba(0, 122, 255, 0.2);
            color: #007AFF;
        }

        /* ===== FOCUS OUTLINES ===== */
        :focus-visible {
            outline: 2px solid #007AFF;
            outline-offset: 2px;
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .app-nav,
            .floating-chat-btn,
            .header-btn,
            .chat-input-container {
                display: none !important;
            }
            
            .app-main {
                position: static;
                height: auto;
                overflow: visible;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="screen active">
        <div class="auth-container">
            <div class="logo-section">
                <div class="logo-placeholder">
                    <i class="fas fa-bolt"></i>
                </div>
                <h1 class="app-name">Zynapse</h1>
                <p class="tagline">Secure, real-time messaging with end-to-end encryption. Connect instantly with anyone, anywhere.</p>
                <div class="powered-by">
                    <span class="buffer-dot"></span>
                    Powered by Buffer Zone
                </div>
            </div>

            <div class="auth-form">
                <!-- Step 1: Sign Up Info -->
                <div id="signupStep1" class="form-step active">
                    <h2 class="form-title">Create Account</h2>
                    <p class="form-subtitle">Enter your details to get started</p>
                    
                    <div id="authError" class="error-message"></div>
                    <div id="authSuccess" class="success-message"></div>
                    
                    <div class="input-group">
                        <label class="input-label">Full Name</label>
                        <input type="text" id="userName" class="input-field" placeholder="John Doe" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Phone Number</label>
                        <input type="tel" id="userPhone" class="input-field" placeholder="+1234567890" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Email Address</label>
                        <input type="email" id="userEmail" class="input-field" placeholder="john@example.com" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <input type="password" id="userPassword" class="input-field" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
                    </div>
                    
                    <button class="btn-primary" onclick="nextSignupStep()">Continue</button>
                    
                    <div class="login-prompt">
                        Already have an account? <a class="login-link" onclick="showLogin()">Sign In</a>
                    </div>
                </div>

                <!-- Step 2: Profile Picture -->
                <div id="signupStep2" class="form-step">
                    <h2 class="form-title">Profile Picture</h2>
                    <p class="form-subtitle">Upload a photo for your profile</p>
                    
                    <div class="profile-upload-container">
                        <div class="profile-image-preview" onclick="uploadProfilePicture()">
                            <div class="upload-placeholder">
                                <i class="fas fa-user"></i>
                                <span>Tap to upload</span>
                            </div>
                        </div>
                        <div class="upload-text">Max 5MB â€¢ JPG, PNG, GIF</div>
                    </div>
                    
                    <div class="form-navigation">
                        <button class="btn-back" onclick="prevSignupStep()">Back</button>
                        <button class="btn-next" onclick="nextSignupStep()">Continue</button>
                    </div>
                </div>

                <!-- Step 3: User ID Generated -->
                <div id="signupStep3" class="form-step">
                    <h2 class="form-title">Your Zynapse ID</h2>
                    <p class="form-subtitle">Your unique identifier for Zynapse</p>
                    
                    <div class="user-id-display">
                        <div class="user-id-label">Your User ID</div>
                        <div id="generatedUserId" class="user-id-value">ZYN-0000</div>
                        <button class="copy-id-btn" onclick="copyUserId()">
                            <i class="fas fa-copy"></i> Copy ID
                        </button>
                    </div>
                    
                    <div class="form-navigation">
                        <button class="btn-back" onclick="prevSignupStep()">Back</button>
                        <button class="btn-primary" onclick="completeRegistration()">Complete Registration</button>
                    </div>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="form-step">
                    <h2 class="form-title">Welcome Back</h2>
                    <p class="form-subtitle">Sign in to your Zynapse account</p>
                    
                    <div id="loginError" class="error-message"></div>
                    
                    <div class="input-group">
                        <label class="input-label">Email Address</label>
                        <input type="email" id="loginEmail" class="input-field" placeholder="john@example.com" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Password</label>
                        <input type="password" id="loginPassword" class="input-field" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                    </div>
                    
                    <button class="btn-primary" onclick="loginUser()">Sign In</button>
                    
                    <button class="btn-secondary" onclick="showSignup()">
                        Create New Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <div class="header-left">
                <div class="app-logo-small">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="headerUserName">Loading...</div>
                    <div class="user-id-container">
                        <span class="user-id-header" id="headerUserId">ZYN-0000</span>
                        <button class="copy-btn-small" onclick="copyUserIdHeader()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <button class="header-btn" onclick="showProfileModal()">
                    <i class="fas fa-user"></i>
                </button>
                <button class="header-btn" onclick="showSettings()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="app-main" id="appMain">
            <!-- Home Screen -->
            <div id="homeScreen" class="screen home-screen active">
                <div class="chat-list" id="chatList">
                    <!-- Chat items will be dynamically inserted here -->
                </div>
                
                <div class="empty-state" id="emptyChats">
                    <div class="empty-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3 class="empty-title">No Chats Yet</h3>
                    <p class="empty-subtitle">Start a conversation by tapping the chat button below</p>
                </div>
            </div>

            <!-- Zynes Screen -->
            <div id="zynesScreen" class="screen zynes-screen">
                <div class="create-zyne">
                    <div class="create-zyne-header" onclick="toggleZyneForm()">
                        <div class="create-zyne-avatar" id="createZyneAvatar">
                            <img src="" alt="Your Avatar">
                        </div>
                        <div class="create-zyne-prompt">What's on your mind?</div>
                    </div>
                    
                    <div class="zyne-form" id="zyneForm">
                        <textarea class="zyne-text-input" id="zyneText" placeholder="Share your thoughts..."></textarea>
                        
                        <div class="zyne-media-preview" id="zyneMediaPreview"></div>
                        
                        <div class="zyne-actions">
                            <div class="media-upload-btns">
                                <button class="media-upload-btn" onclick="uploadZynePhoto()">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="media-upload-btn" onclick="uploadZyneVideo()">
                                    <i class="fas fa-video"></i>
                                </button>
                            </div>
                            <button class="btn-primary" onclick="postZyne()">Post</button>
                        </div>
                    </div>
                </div>
                
                <div class="zynes-feed" id="zynesFeed">
                    <!-- Zyne posts will be dynamically inserted here -->
                </div>
            </div>

            <!-- Groups Screen -->
            <div id="groupsScreen" class="screen groups-screen">
                <button class="create-group-btn" onclick="showCreateGroupPopup()">
                    <i class="fas fa-plus"></i> Create New Group
                </button>
                
                <div class="groups-list" id="groupsList">
                    <!-- Group items will be dynamically inserted here -->
                </div>
                
                <div class="empty-state" id="emptyGroups">
                    <div class="empty-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="empty-title">No Groups Yet</h3>
                    <p class="empty-subtitle">Create a group to start chatting with multiple people</p>
                </div>
            </div>

            <!-- Chat Requests Screen -->
            <div id="requestsScreen" class="screen requests-screen">
                <div class="requests-tabs">
                    <button class="request-tab active" onclick="showIncomingRequests()">Incoming</button>
                    <button class="request-tab" onclick="showOutgoingRequests()">Outgoing</button>
                </div>
                
                <div class="requests-list" id="incomingRequests">
                    <!-- Incoming requests will be dynamically inserted here -->
                </div>
                
                <div class="requests-list" id="outgoingRequests" style="display: none;">
                    <!-- Outgoing requests will be dynamically inserted here -->
                </div>
                
                <div class="empty-state" id="emptyRequests">
                    <div class="empty-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h3 class="empty-title">No Requests</h3>
                    <p class="empty-subtitle">You don't have any chat requests at the moment</p>
                </div>
            </div>

            <!-- Contacts Screen -->
            <div id="contactsScreen" class="screen contacts-screen">
                <div class="contacts-search">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="contacts-search-input" id="contactsSearch" 
                           placeholder="Search contacts..." oninput="searchContacts()">
                </div>
                
                <div class="contacts-list" id="contactsList">
                    <!-- Contact items will be dynamically inserted here -->
                </div>
                
                <div class="empty-state" id="emptyContacts">
                    <div class="empty-icon">
                        <i class="fas fa-address-book"></i>
                    </div>
                    <h3 class="empty-title">No Contacts</h3>
                    <p class="empty-subtitle">Add contacts by sending them chat requests</p>
                </div>
            </div>

            <!-- Chat Screen -->
            <div id="chatScreen" class="screen chat-screen">
                <div class="chat-header-bar">
                    <button class="chat-back-btn" onclick="backToHome()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    
                    <div class="chat-contact-info">
                        <div class="chat-contact-avatar" id="chatContactAvatar">
                            <img src="" alt="Contact Avatar">
                        </div>
                        <div class="chat-contact-details">
                            <div class="chat-contact-name" id="chatContactName">Loading...</div>
                            <div class="chat-contact-status" id="chatContactStatus">
                                <span class="status-dot"></span>
                                <span id="statusText">Offline</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-header-actions">
                        <button class="chat-action-btn" onclick="toggleChatMenu()">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="dropdown-menu" id="chatMenu">
                            <a class="dropdown-item" onclick="addNickname()">
                                <i class="fas fa-tag"></i> Add Nickname
                            </a>
                            <a class="dropdown-item" onclick="viewChatProfile()">
                                <i class="fas fa-user"></i> View Profile
                            </a>
                            <a class="dropdown-item" onclick="addToFavorites()">
                                <i class="fas fa-star"></i> Add to Favorites
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item danger" onclick="blockUser()">
                                <i class="fas fa-ban"></i> Block User
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be dynamically inserted here -->
                </div>
                
                <div class="chat-input-container">
                    <button class="attachment-btn" onclick="toggleAttachmentMenu()">
                        <i class="fas fa-plus"></i>
                    </button>
                    
                    <div class="attachment-menu" id="attachmentMenu">
                        <div class="attachment-option" onclick="attachPhoto()">
                            <i class="fas fa-image"></i>
                            <span>Photo</span>
                        </div>
                        <div class="attachment-option" onclick="attachVideo()">
                            <i class="fas fa-video"></i>
                            <span>Video</span>
                        </div>
                        <div class="attachment-option" onclick="attachFile()">
                            <i class="fas fa-file"></i>
                            <span>File</span>
                        </div>
                    </div>
                    
                    <textarea class="message-input" id="messageInput" 
                             placeholder="iMessage" rows="1" 
                             oninput="autoResizeTextarea(this)"
                             onkeydown="handleMessageKeydown(event)"></textarea>
                    
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Chat Button -->
        <button class="floating-chat-btn" onclick="showStartChatPopup()">
            <i class="fas fa-comment-alt"></i>
        </button>

        <!-- App Navigation -->
        <div class="app-nav">
            <div class="nav-item active" onclick="showScreen('homeScreen')">
                <i class="fas fa-home nav-icon"></i>
                <span class="nav-label">HOME</span>
            </div>
            <div class="nav-item" onclick="showScreen('zynesScreen')">
                <i class="fas fa-bolt nav-icon"></i>
                <span class="nav-label">ZYNES</span>
                <span class="nav-badge" id="zynesBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showScreen('groupsScreen')">
                <i class="fas fa-users nav-icon"></i>
                <span class="nav-label">GROUPS</span>
                <span class="nav-badge" id="groupsBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showScreen('requestsScreen')">
                <i class="fas fa-user-plus nav-icon"></i>
                <span class="nav-label">REQUESTS</span>
                <span class="nav-badge" id="requestsBadge" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showScreen('contactsScreen')">
                <i class="fas fa-address-book nav-icon"></i>
                <span class="nav-label">CONTACTS</span>
            </div>
        </div>
    </div>

    <!-- Start Chat Popup -->
    <div class="popup-overlay" id="startChatPopup">
        <div class="popup-container">
            <div class="popup-header">
                <h3 class="popup-title">Start New Chat</h3>
                <p class="popup-subtitle">Enter a Zynapse ID to start chatting</p>
            </div>
            
            <div class="popup-content">
                <div class="input-group">
                    <label class="input-label">Zynapse ID</label>
                    <input type="text" id="searchUserId" class="input-field" 
                           placeholder="ZYN-XXXX" oninput="searchUser()">
                </div>
                
                <div class="user-search-result" id="userSearchResult">
                    <div class="user-result-header">User Found</div>
                    <div class="user-result-card">
                        <div class="result-avatar" id="resultAvatar">
                            <img src="" alt="User Avatar">
                        </div>
                        <div class="result-info">
                            <div class="result-name" id="resultName">Loading...</div>
                            <div class="result-id" id="resultId">ZYN-0000</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn-secondary" onclick="closeStartChatPopup()">Cancel</button>
                <button class="btn-primary" id="sendRequestBtn" onclick="sendChatRequest()" disabled>Send Request</button>
            </div>
        </div>
    </div>

    <!-- Create Group Popup -->
    <div class="popup-overlay" id="createGroupPopup">
        <div class="popup-container">
            <div class="popup-header">
                <h3 class="popup-title">Create New Group</h3>
                <p class="popup-subtitle">Add members and set up your group</p>
            </div>
            
            <div class="popup-content">
                <div class="input-group">
                    <label class="input-label">Group Name</label>
                    <input type="text" id="groupName" class="input-field" placeholder="Enter group name">
                </div>
                
                <div class="input-group">
                    <label class="input-label">Add Members</label>
                    <div class="selected-members-list" id="selectedMembersList"></div>
                    <div class="group-members-select" id="groupMembersSelect">
                        <!-- Members will be dynamically inserted here -->
                    </div>
                </div>
                
                <div class="profile-upload-container">
                    <div class="profile-image-preview" id="groupImagePreview" onclick="uploadGroupPicture()">
                        <div class="upload-placeholder">
                            <i class="fas fa-users"></i>
                            <span>Group Photo</span>
                        </div>
                    </div>
                    <div class="upload-text">Optional group photo</div>
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn-secondary" onclick="closeCreateGroupPopup()">Cancel</button>
                <button class="btn-primary" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-header">
            <button class="profile-back-btn" onclick="closeProfileModal()">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="profile-avatar-large" id="profileModalAvatar">
                <img src="" alt="Profile Picture">
            </div>
            
            <div class="profile-name-large" id="profileModalName">Loading...</div>
            <div class="profile-id-large" id="profileModalId">ZYN-0000</div>
        </div>
        
        <div class="profile-content">
            <div class="profile-section">
                <h4 class="profile-section-title">
                    <i class="fas fa-info-circle"></i> Account Information
                </h4>
                <div class="profile-info-item">
                    <span class="info-label">Name</span>
                    <span class="info-value" id="profileInfoName">Loading...</span>
                </div>
                <div class="profile-info-item">
                    <span class="info-label">Email</span>
                    <span class="info-value" id="profileInfoEmail">Loading...</span>
                </div>
                <div class="profile-info-item">
                    <span class="info-label">Phone</span>
                    <span class="info-value" id="profileInfoPhone">Loading...</span>
                </div>
                <div class="profile-info-item">
                    <span class="info-label">Member Since</span>
                    <span class="info-value" id="profileInfoDate">Loading...</span>
                </div>
            </div>
            
            <div class="profile-section">
                <h4 class="profile-section-title">
                    <i class="fas fa-chart-bar"></i> Statistics
                </h4>
                <div class="profile-info-item">
                    <span class="info-label">Total Contacts</span>
                    <span class="info-value" id="profileStatsContacts">0</span>
                </div>
                <div class="profile-info-item">
                    <span class="info-label">Total Chats</span>
                    <span class="info-value" id="profileStatsChats">0</span>
                </div>
                <div class="profile-info-item">
                    <span class="info-label">Zynes Posted</span>
                    <span class="info-value" id="profileStatsZynes">0</span>
                </div>
                <div class="profile-info-item">
                    <span class="info-label">Groups Joined</span>
                    <span class="info-value" id="profileStatsGroups">0</span>
                </div>
            </div>
            
            <div class="profile-section">
                <h4 class="profile-section-title">
                    <i class="fas fa-cog"></i> Settings
                </h4>
                <div class="dropdown-item" onclick="changeProfilePicture()">
                    <i class="fas fa-camera"></i>
                    <span>Change Profile Picture</span>
                </div>
                <div class="dropdown-item" onclick="editProfile()">
                    <i class="fas fa-edit"></i>
                    <span>Edit Profile</span>
                </div>
                <div class="dropdown-item" onclick="notificationSettings()">
                    <i class="fas fa-bell"></i>
                    <span>Notification Settings</span>
                </div>
                <div class="dropdown-item danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Audio for notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="notification.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
            authDomain: "zynapse-68181.firebaseapp.com",
            databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
            projectId: "zynapse-68181",
            storageBucket: "zynapse-68181.firebasestorage.app",
            messagingSenderId: "841353050519",
            appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
            measurementId: "G-4764XLL6WS"
        };

        // ===== CLOUDINARY CONFIGURATION =====
        const CLOUDINARY_CONFIG = {
            cloudName: 'dd3lcymrk',
            apiKey: '489857926297197',
            uploadPreset: 'h3eyhc2o',
            folder: 'zynapse'
        };

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let currentUserId = null;
        let currentChat = null;
        let currentScreen = 'homeScreen';
        let contacts = [];
        let chatRequests = [];
        let groups = [];
        let zynes = [];
        let notifications = [];
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let cloudinaryWidget = null;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            checkAuthState();
            setupEventListeners();
            initializeCloudinary();
        });

        function initializeFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseAuth = firebase.auth();
                firebaseDb = firebase.database();
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showError('Failed to initialize app. Please refresh the page.');
            }
        }

        function initializeCloudinary() {
            try {
                cloudinaryWidget = cloudinary.createUploadWidget(
                    {
                        cloudName: CLOUDINARY_CONFIG.cloudName,
                        uploadPreset: CLOUDINARY_CONFIG.uploadPreset,
                        sources: ['local', 'camera', 'url'],
                        multiple: false,
                        maxFileSize: 50000000, // 50MB
                        resourceType: 'auto',
                        folder: CLOUDINARY_CONFIG.folder,
                        clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'mp4', 'mov', 'avi', 'pdf', 'doc', 'docx', 'txt'],
                        showAdvancedOptions: false,
                        cropping: false,
                        showPoweredBy: false,
                        styles: {
                            palette: {
                                window: "#FFFFFF",
                                windowBorder: "#90A0B3",
                                tabIcon: "#007AFF",
                                menuIcons: "#5A616A",
                                textDark: "#000000",
                                textLight: "#FFFFFF",
                                link: "#007AFF",
                                action: "#FF620C",
                                inactiveTabIcon: "#8E8E93",
                                error: "#FF3B30",
                                inProgress: "#007AFF",
                                complete: "#34C759",
                                sourceBg: "#F2F2F7"
                            }
                        }
                    },
                    (error, result) => {
                        if (!error && result && result.event === "success") {
                            handleCloudinaryUpload(result);
                        }
                    }
                );
            } catch (error) {
                console.error('Cloudinary initialization error:', error);
            }
        }

        function checkAuthState() {
            firebaseAuth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    loadUserData(user.uid);
                } else {
                    // User is signed out
                    showAuthScreen();
                }
            });
        }

        function setupEventListeners() {
            // Navigation clicks
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Click outside to close dropdowns
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.chat-action-btn')) {
                    document.getElementById('chatMenu').style.display = 'none';
                }
                if (!event.target.closest('.attachment-btn')) {
                    document.getElementById('attachmentMenu').style.display = 'none';
                }
            });

            // Prevent scrolling when popup is open
            document.addEventListener('wheel', function(event) {
                if (document.querySelector('.popup-overlay:not([style*="display: none"])')) {
                    event.preventDefault();
                }
            }, { passive: false });
        }

        // ===== AUTHENTICATION FUNCTIONS =====
        let signupData = {
            name: '',
            phone: '',
            email: '',
            password: '',
            profilePic: '',
            userId: ''
        };

        function nextSignupStep() {
            const step1 = document.getElementById('signupStep1');
            const step2 = document.getElementById('signupStep2');
            const step3 = document.getElementById('signupStep3');
            
            if (step1.classList.contains('active')) {
                // Validate step 1
                signupData.name = document.getElementById('userName').value.trim();
                signupData.phone = document.getElementById('userPhone').value.trim();
                signupData.email = document.getElementById('userEmail').value.trim();
                signupData.password = document.getElementById('userPassword').value;
                
                if (!signupData.name || !signupData.phone || !signupData.email || !signupData.password) {
                    showAuthError('Please fill in all fields');
                    return;
                }
                
                if (signupData.password.length < 6) {
                    showAuthError('Password must be at least 6 characters');
                    return;
                }
                
                step1.classList.remove('active');
                step2.classList.add('active');
                showAuthSuccess('Profile details saved');
                
            } else if (step2.classList.contains('active')) {
                // Generate user ID
                signupData.userId = 'ZYN-' + Math.floor(1000 + Math.random() * 9000);
                document.getElementById('generatedUserId').textContent = signupData.userId;
                
                step2.classList.remove('active');
                step3.classList.add('active');
                
            } else if (step3.classList.contains('active')) {
                completeRegistration();
            }
        }

        function prevSignupStep() {
            const step1 = document.getElementById('signupStep1');
            const step2 = document.getElementById('signupStep2');
            const step3 = document.getElementById('signupStep3');
            
            if (step2.classList.contains('active')) {
                step2.classList.remove('active');
                step1.classList.add('active');
            } else if (step3.classList.contains('active')) {
                step3.classList.remove('active');
                step2.classList.add('active');
            }
        }

        function showLogin() {
            document.getElementById('signupStep1').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
            hideAuthMessages();
        }

        function showSignup() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('signupStep1').classList.add('active');
            hideAuthMessages();
        }

        function completeRegistration() {
            showLoading('Creating your account...');
            
            // Create user in Firebase Auth
            firebaseAuth.createUserWithEmailAndPassword(signupData.email, signupData.password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Prepare user data for database
                    const userData = {
                        name: signupData.name,
                        phone: signupData.phone,
                        email: signupData.email,
                        userId: signupData.userId,
                        profilePic: signupData.profilePic || '',
                        createdAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        status: 'online',
                        contacts: [],
                        chatRequests: [],
                        groups: [],
                        zynes: []
                    };
                    
                    // Save user data to database
                    return firebaseDb.ref('users/' + user.uid).set(userData);
                })
                .then(() => {
                    hideLoading();
                    showAuthSuccess('Account created successfully!');
                    // Auto login will happen via auth state change
                })
                .catch((error) => {
                    hideLoading();
                    showAuthError(error.message);
                });
        }

        function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showLoginError('Please enter email and password');
                return;
            }
            
            showLoading('Signing in...');
            
            firebaseAuth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    hideLoading();
                    // Auth state change will handle the rest
                })
                .catch((error) => {
                    hideLoading();
                    showLoginError(error.message);
                });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                firebaseAuth.signOut()
                    .then(() => {
                        closeProfileModal();
                        showAuthScreen();
                    })
                    .catch((error) => {
                        showNotification('Error', 'Failed to logout: ' + error.message, 'error');
                    });
            }
        }

        // ===== USER DATA MANAGEMENT =====
        function loadUserData(userId) {
            showLoading('Loading your data...');
            
            // Load user data from database
            firebaseDb.ref('users/' + userId).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        currentUserId = userId;
                        
                        // Update UI
                        document.getElementById('headerUserName').textContent = userData.name;
                        document.getElementById('headerUserId').textContent = userData.userId;
                        document.getElementById('profileModalName').textContent = userData.name;
                        document.getElementById('profileModalId').textContent = userData.userId;
                        document.getElementById('profileInfoName').textContent = userData.name;
                        document.getElementById('profileInfoEmail').textContent = userData.email;
                        document.getElementById('profileInfoPhone').textContent = userData.phone;
                        document.getElementById('profileInfoDate').textContent = new Date(userData.createdAt).toLocaleDateString();
                        
                        // Update profile pictures
                        if (userData.profilePic) {
                            document.querySelectorAll('.create-zyne-avatar img').forEach(img => {
                                img.src = userData.profilePic;
                                img.onerror = function() {
                                    this.src = '';
                                    this.parentElement.innerHTML = '<i class="fas fa-user"></i>';
                                };
                            });
                        }
                        
                        // Load user's data
                        loadContacts();
                        loadChatRequests();
                        loadGroups();
                        loadZynes();
                        loadChats();
                        
                        // Set up real-time listeners
                        setupRealtimeListeners();
                        
                        // Show app
                        hideLoading();
                        showApp();
                    } else {
                        throw new Error('User data not found');
                    }
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Error loading user data:', error);
                    showNotification('Error', 'Failed to load user data', 'error');
                    firebaseAuth.signOut();
                });
        }

        function setupRealtimeListeners() {
            // Listen for new messages
            firebaseDb.ref('chats').orderByChild('participants').equalTo(currentUserId).on('value', (snapshot) => {
                updateChatList(snapshot.val());
            });
            
            // Listen for chat requests
            firebaseDb.ref('chatRequests').orderByChild('toUserId').equalTo(currentUserId).on('value', (snapshot) => {
                updateChatRequests(snapshot.val());
            });
            
            // Listen for contacts updates
            firebaseDb.ref('users/' + currentUserId + '/contacts').on('value', (snapshot) => {
                updateContacts(snapshot.val());
            });
            
            // Listen for new zynes
            firebaseDb.ref('zynes').orderByChild('owner').equalTo(currentUserId).on('value', (snapshot) => {
                updateZynesFeed(snapshot.val());
            });
        }

        // ===== SCREEN MANAGEMENT =====
        function showAuthScreen() {
            document.getElementById('authScreen').classList.add('active');
            document.getElementById('appContainer').style.display = 'none';
            currentUser = null;
            currentUserId = null;
        }

        function showApp() {
            document.getElementById('authScreen').classList.remove('active');
            document.getElementById('appContainer').style.display = 'flex';
            showScreen('homeScreen');
        }

        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
            
            // Update floating button visibility
            const floatingBtn = document.querySelector('.floating-chat-btn');
            if (screenId === 'homeScreen' || screenId === 'contactsScreen') {
                floatingBtn.style.display = 'flex';
            } else {
                floatingBtn.style.display = 'none';
            }
        }

        function backToHome() {
            showScreen('homeScreen');
            currentChat = null;
        }

        // ===== CHAT FUNCTIONS =====
        function showStartChatPopup() {
            document.getElementById('startChatPopup').style.display = 'flex';
            document.getElementById('userSearchResult').style.display = 'none';
            document.getElementById('searchUserId').value = '';
            document.getElementById('sendRequestBtn').disabled = true;
        }

        function closeStartChatPopup() {
            document.getElementById('startChatPopup').style.display = 'none';
        }

        function searchUser() {
            const userId = document.getElementById('searchUserId').value.trim().toUpperCase();
            const sendRequestBtn = document.getElementById('sendRequestBtn');
            
            if (userId.length === 8 && userId.startsWith('ZYN-')) {
                // Search for user in database
                firebaseDb.ref('users').orderByChild('userId').equalTo(userId).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const userData = Object.values(snapshot.val())[0];
                            const userId = Object.keys(snapshot.val())[0];
                            
                            // Update search result UI
                            document.getElementById('resultName').textContent = userData.name;
                            document.getElementById('resultId').textContent = userData.userId;
                            if (userData.profilePic) {
                                document.getElementById('resultAvatar').innerHTML = `<img src="${userData.profilePic}" alt="${userData.name}">`;
                            }
                            
                            // Store the found user ID for later use
                            document.getElementById('userSearchResult').dataset.userId = userId;
                            
                            // Show result and enable send button
                            document.getElementById('userSearchResult').style.display = 'block';
                            sendRequestBtn.disabled = false;
                        } else {
                            document.getElementById('userSearchResult').style.display = 'none';
                            sendRequestBtn.disabled = true;
                        }
                    })
                    .catch((error) => {
                        console.error('Error searching user:', error);
                        sendRequestBtn.disabled = true;
                    });
            } else {
                document.getElementById('userSearchResult').style.display = 'none';
                sendRequestBtn.disabled = true;
            }
        }

        function sendChatRequest() {
            const targetUserId = document.getElementById('userSearchResult').dataset.userId;
            const currentUserRef = firebaseDb.ref('users/' + currentUserId);
            
            // Get current user data
            currentUserRef.once('value')
                .then((snapshot) => {
                    const currentUserData = snapshot.val();
                    
                    // Create chat request object
                    const requestId = firebaseDb.ref().child('chatRequests').push().key;
                    const chatRequest = {
                        id: requestId,
                        fromUserId: currentUserId,
                        fromUserName: currentUserData.name,
                        fromUserAvatar: currentUserData.profilePic || '',
                        fromUserZynId: currentUserData.userId,
                        toUserId: targetUserId,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    };
                    
                    // Save chat request
                    return firebaseDb.ref('chatRequests/' + requestId).set(chatRequest);
                })
                .then(() => {
                    showNotification('Success', 'Chat request sent successfully!', 'success');
                    closeStartChatPopup();
                    
                    // Play notification sound
                    playNotificationSound();
                })
                .catch((error) => {
                    console.error('Error sending chat request:', error);
                    showNotification('Error', 'Failed to send chat request', 'error');
                });
        }

        function loadChatRequests() {
            // Load incoming requests
            firebaseDb.ref('chatRequests')
                .orderByChild('toUserId')
                .equalTo(currentUserId)
                .once('value')
                .then((snapshot) => {
                    updateChatRequests(snapshot.val());
                });
            
            // Load outgoing requests
            firebaseDb.ref('chatRequests')
                .orderByChild('fromUserId')
                .equalTo(currentUserId)
                .once('value')
                .then((snapshot) => {
                    updateOutgoingRequests(snapshot.val());
                });
        }

        function updateChatRequests(requests) {
            const incomingRequestsContainer = document.getElementById('incomingRequests');
            const emptyRequests = document.getElementById('emptyRequests');
            const requestsBadge = document.getElementById('requestsBadge');
            
            if (!requests) {
                incomingRequestsContainer.innerHTML = '';
                emptyRequests.style.display = 'block';
                requestsBadge.style.display = 'none';
                return;
            }
            
            const pendingRequests = Object.values(requests).filter(req => req.status === 'pending');
            
            if (pendingRequests.length === 0) {
                incomingRequestsContainer.innerHTML = '';
                emptyRequests.style.display = 'block';
                requestsBadge.style.display = 'none';
                return;
            }
            
            // Update badge
            requestsBadge.textContent = pendingRequests.length;
            requestsBadge.style.display = 'inline-flex';
            
            // Clear container
            incomingRequestsContainer.innerHTML = '';
            emptyRequests.style.display = 'none';
            
            // Add request cards
            pendingRequests.forEach(request => {
                const requestCard = document.createElement('div');
                requestCard.className = 'request-card fade-in';
                requestCard.innerHTML = `
                    <div class="request-header">
                        <div class="request-avatar">
                            ${request.fromUserAvatar ? 
                                `<img src="${request.fromUserAvatar}" alt="${request.fromUserName}">` :
                                `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-user" style="color:white;font-size:24px;"></i>
                                </div>`
                            }
                        </div>
                        <div class="request-info">
                            <div class="request-name">${request.fromUserName}</div>
                            <div class="request-id">${request.fromUserZynId}</div>
                            <div class="request-time">${formatTime(request.timestamp)}</div>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button class="accept-btn" onclick="acceptChatRequest('${request.id}', '${request.fromUserId}')">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button class="reject-btn" onclick="rejectChatRequest('${request.id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                `;
                incomingRequestsContainer.appendChild(requestCard);
            });
        }

        function updateOutgoingRequests(requests) {
            const outgoingRequestsContainer = document.getElementById('outgoingRequests');
            
            if (!requests) {
                outgoingRequestsContainer.innerHTML = '<div class="empty-state"><p>No outgoing requests</p></div>';
                return;
            }
            
            outgoingRequestsContainer.innerHTML = '';
            
            Object.values(requests).forEach(request => {
                if (request.status === 'pending') {
                    const requestCard = document.createElement('div');
                    requestCard.className = 'request-card';
                    requestCard.innerHTML = `
                        <div class="request-header">
                            <div class="request-info">
                                <div class="request-name">Sent to ${request.toUserId}</div>
                                <div class="request-time">${formatTime(request.timestamp)}</div>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="reject-btn" onclick="cancelChatRequest('${request.id}')">
                                Cancel Request
                            </button>
                        </div>
                    `;
                    outgoingRequestsContainer.appendChild(requestCard);
                }
            });
        }

        function acceptChatRequest(requestId, fromUserId) {
            // Update request status
            firebaseDb.ref('chatRequests/' + requestId).update({
                status: 'accepted',
                acceptedAt: new Date().toISOString()
            })
            .then(() => {
                // Add each other to contacts
                const currentUserContactsRef = firebaseDb.ref('users/' + currentUserId + '/contacts');
                const otherUserContactsRef = firebaseDb.ref('users/' + fromUserId + '/contacts');
                
                // Get user data first
                return Promise.all([
                    firebaseDb.ref('users/' + currentUserId).once('value'),
                    firebaseDb.ref('users/' + fromUserId).once('value')
                ])
                .then(([currentUserSnapshot, otherUserSnapshot]) => {
                    const currentUser = currentUserSnapshot.val();
                    const otherUser = otherUserSnapshot.val();
                    
                    // Add other user to current user's contacts
                    const currentUserContact = {
                        userId: fromUserId,
                        zynId: otherUser.userId,
                        name: otherUser.name,
                        profilePic: otherUser.profilePic || '',
                        addedAt: new Date().toISOString()
                    };
                    
                    // Add current user to other user's contacts
                    const otherUserContact = {
                        userId: currentUserId,
                        zynId: currentUser.userId,
                        name: currentUser.name,
                        profilePic: currentUser.profilePic || '',
                        addedAt: new Date().toISOString()
                    };
                    
                    return Promise.all([
                        currentUserContactsRef.child(fromUserId).set(currentUserContact),
                        otherUserContactsRef.child(currentUserId).set(otherUserContact)
                    ]);
                });
            })
            .then(() => {
                showNotification('Success', 'Chat request accepted!', 'success');
                playNotificationSound();
                
                // Create a chat between users
                createChat(fromUserId);
            })
            .catch((error) => {
                console.error('Error accepting chat request:', error);
                showNotification('Error', 'Failed to accept request', 'error');
            });
        }

        function rejectChatRequest(requestId) {
            if (confirm('Are you sure you want to reject this chat request?')) {
                firebaseDb.ref('chatRequests/' + requestId).update({
                    status: 'rejected',
                    rejectedAt: new Date().toISOString()
                })
                .then(() => {
                    showNotification('Request Rejected', 'Chat request has been rejected', 'info');
                })
                .catch((error) => {
                    console.error('Error rejecting chat request:', error);
                    showNotification('Error', 'Failed to reject request', 'error');
                });
            }
        }

        function cancelChatRequest(requestId) {
            if (confirm('Are you sure you want to cancel this chat request?')) {
                firebaseDb.ref('chatRequests/' + requestId).remove()
                    .then(() => {
                        showNotification('Request Cancelled', 'Chat request has been cancelled', 'info');
                    })
                    .catch((error) => {
                        console.error('Error cancelling chat request:', error);
                        showNotification('Error', 'Failed to cancel request', 'error');
                    });
            }
        }

        function showIncomingRequests() {
            document.getElementById('incomingRequests').style.display = 'block';
            document.getElementById('outgoingRequests').style.display = 'none';
            document.querySelectorAll('.request-tab')[0].classList.add('active');
            document.querySelectorAll('.request-tab')[1].classList.remove('active');
        }

        function showOutgoingRequests() {
            document.getElementById('incomingRequests').style.display = 'none';
            document.getElementById('outgoingRequests').style.display = 'block';
            document.querySelectorAll('.request-tab')[0].classList.remove('active');
            document.querySelectorAll('.request-tab')[1].classList.add('active');
        }

        // ===== CONTACTS MANAGEMENT =====
        function loadContacts() {
            firebaseDb.ref('users/' + currentUserId + '/contacts')
                .once('value')
                .then((snapshot) => {
                    updateContacts(snapshot.val());
                });
        }

        function updateContacts(contactsData) {
            const contactsList = document.getElementById('contactsList');
            const emptyContacts = document.getElementById('emptyContacts');
            const profileStatsContacts = document.getElementById('profileStatsContacts');
            
            if (!contactsData) {
                contactsList.innerHTML = '';
                emptyContacts.style.display = 'block';
                profileStatsContacts.textContent = '0';
                return;
            }
            
            const contactsArray = Object.values(contactsData);
            
            if (contactsArray.length === 0) {
                contactsList.innerHTML = '';
                emptyContacts.style.display = 'block';
                profileStatsContacts.textContent = '0';
                return;
            }
            
            // Update stats
            profileStatsContacts.textContent = contactsArray.length;
            
            // Clear container
            contactsList.innerHTML = '';
            emptyContacts.style.display = 'none';
            
            // Add contact items
            contactsArray.forEach(contact => {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.onclick = () => openChat(contact.userId);
                contactItem.innerHTML = `
                    <div class="contact-avatar">
                        ${contact.profilePic ? 
                            `<img src="${contact.profilePic}" alt="${contact.name}">` :
                            `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                <i class="fas fa-user" style="color:white;font-size:24px;"></i>
                            </div>`
                        }
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status">
                            <span class="status-dot"></span>
                            <span>Last seen recently</span>
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="contact-action-btn" onclick="event.stopPropagation();viewContactProfile('${contact.userId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="contact-action-btn remove" onclick="event.stopPropagation();removeContact('${contact.userId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                contactsList.appendChild(contactItem);
            });
        }

        function searchContacts() {
            const searchTerm = document.getElementById('contactsSearch').value.toLowerCase();
            const contactItems = document.querySelectorAll('.contact-item');
            
            contactItems.forEach(item => {
                const contactName = item.querySelector('.contact-name').textContent.toLowerCase();
                if (contactName.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function removeContact(contactUserId) {
            if (confirm('Are you sure you want to remove this contact?')) {
                firebaseDb.ref('users/' + currentUserId + '/contacts/' + contactUserId).remove()
                    .then(() => {
                        showNotification('Contact Removed', 'Contact has been removed', 'info');
                    })
                    .catch((error) => {
                        console.error('Error removing contact:', error);
                        showNotification('Error', 'Failed to remove contact', 'error');
                    });
            }
        }

        // ===== CHAT FUNCTIONALITY =====
        function createChat(otherUserId) {
            const chatId = firebaseDb.ref().child('chats').push().key;
            
            // Get user data
            Promise.all([
                firebaseDb.ref('users/' + currentUserId).once('value'),
                firebaseDb.ref('users/' + otherUserId).once('value')
            ])
            .then(([currentUserSnapshot, otherUserSnapshot]) => {
                const currentUser = currentUserSnapshot.val();
                const otherUser = otherUserSnapshot.val();
                
                // Create chat object
                const chat = {
                    id: chatId,
                    participants: [currentUserId, otherUserId],
                    participantNames: {
                        [currentUserId]: currentUser.name,
                        [otherUserId]: otherUser.name
                    },
                    participantAvatars: {
                        [currentUserId]: currentUser.profilePic || '',
                        [otherUserId]: otherUser.profilePic || ''
                    },
                    participantZynIds: {
                        [currentUserId]: currentUser.userId,
                        [otherUserId]: otherUser.userId
                    },
                    lastMessage: '',
                    lastMessageTime: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    messages: {}
                };
                
                // Save chat
                return firebaseDb.ref('chats/' + chatId).set(chat);
            })
            .then(() => {
                // Open the chat
                openChat(otherUserId);
            })
            .catch((error) => {
                console.error('Error creating chat:', error);
                showNotification('Error', 'Failed to create chat', 'error');
            });
        }

        function loadChats() {
            firebaseDb.ref('chats')
                .orderByChild('participants')
                .equalTo(currentUserId)
                .once('value')
                .then((snapshot) => {
                    updateChatList(snapshot.val());
                });
        }

        function updateChatList(chats) {
            const chatList = document.getElementById('chatList');
            const emptyChats = document.getElementById('emptyChats');
            const profileStatsChats = document.getElementById('profileStatsChats');
            
            if (!chats) {
                chatList.innerHTML = '';
                emptyChats.style.display = 'block';
                profileStatsChats.textContent = '0';
                return;
            }
            
            const chatsArray = Object.values(chats).filter(chat => 
                chat.participants && chat.participants.includes(currentUserId)
            );
            
            if (chatsArray.length === 0) {
                chatList.innerHTML = '';
                emptyChats.style.display = 'block';
                profileStatsChats.textContent = '0';
                return;
            }
            
            // Update stats
            profileStatsChats.textContent = chatsArray.length;
            
            // Clear container
            chatList.innerHTML = '';
            emptyChats.style.display = 'none';
            
            // Sort chats by last message time
            chatsArray.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            
            // Add chat items
            chatsArray.forEach(chat => {
                const otherParticipantId = chat.participants.find(id => id !== currentUserId);
                const otherParticipantName = chat.participantNames[otherParticipantId] || 'Unknown User';
                const otherParticipantAvatar = chat.participantAvatars[otherParticipantId] || '';
                
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.onclick = () => openChat(otherParticipantId);
                chatItem.innerHTML = `
                    <div class="chat-avatar">
                        ${otherParticipantAvatar ? 
                            `<img src="${otherParticipantAvatar}" alt="${otherParticipantName}">` :
                            `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                <i class="fas fa-user" style="color:white;font-size:28px;"></i>
                            </div>`
                        }
                    </div>
                    <div class="chat-info">
                        <div class="chat-header">
                            <div class="chat-name">${otherParticipantName}</div>
                            <div class="chat-time">${formatTime(chat.lastMessageTime)}</div>
                        </div>
                        <div class="chat-preview">
                            <div class="chat-message">${chat.lastMessage || 'No messages yet'}</div>
                            <div class="chat-badge" style="display: none;">1</div>
                        </div>
                    </div>
                `;
                chatList.appendChild(chatItem);
            });
        }

        function openChat(otherUserId) {
            currentChat = otherUserId;
            
            // Find the chat with this participant
            firebaseDb.ref('chats')
                .orderByChild('participants')
                .equalTo(currentUserId)
                .once('value')
                .then((snapshot) => {
                    const chats = snapshot.val();
                    if (chats) {
                        const chat = Object.values(chats).find(c => 
                            c.participants.includes(otherUserId)
                        );
                        
                        if (chat) {
                            loadChatMessages(chat.id);
                            
                            // Get other user's data for header
                            firebaseDb.ref('users/' + otherUserId).once('value')
                                .then((userSnapshot) => {
                                    const userData = userSnapshot.val();
                                    if (userData) {
                                        document.getElementById('chatContactName').textContent = userData.name;
                                        document.getElementById('statusText').textContent = userData.status || 'Offline';
                                        
                                        const statusDot = document.querySelector('.chat-contact-status .status-dot');
                                        if (userData.status === 'online') {
                                            statusDot.classList.add('online');
                                        } else {
                                            statusDot.classList.remove('online');
                                        }
                                        
                                        if (userData.profilePic) {
                                            document.getElementById('chatContactAvatar').innerHTML = 
                                                `<img src="${userData.profilePic}" alt="${userData.name}">`;
                                        }
                                    }
                                });
                        } else {
                            // Create new chat
                            createChat(otherUserId);
                            return;
                        }
                    } else {
                        // Create new chat
                        createChat(otherUserId);
                        return;
                    }
                })
                .catch((error) => {
                    console.error('Error opening chat:', error);
                    showNotification('Error', 'Failed to open chat', 'error');
                });
            
            // Switch to chat screen
            showScreen('chatScreen');
        }

        function loadChatMessages(chatId) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '<div class="loading" style="margin: 20px auto;"></div>';
            
            firebaseDb.ref('chats/' + chatId + '/messages')
                .orderByChild('timestamp')
                .limitToLast(50)
                .once('value')
                .then((snapshot) => {
                    const messages = snapshot.val();
                    displayMessages(messages);
                    
                    // Set up real-time listener for new messages
                    firebaseDb.ref('chats/' + chatId + '/messages')
                        .orderByChild('timestamp')
                        .startAt(Date.now())
                        .on('child_added', (newMessage) => {
                            addNewMessage(newMessage.val());
                        });
                })
                .catch((error) => {
                    console.error('Error loading messages:', error);
                    messagesContainer.innerHTML = '<div class="empty-state"><p>Failed to load messages</p></div>';
                });
        }

        function displayMessages(messages) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            if (!messages) {
                messagesContainer.innerHTML = `
                    <div class="empty-state" style="margin-top: 50px;">
                        <i class="fas fa-comments empty-icon"></i>
                        <h3 class="empty-title">No Messages Yet</h3>
                        <p class="empty-subtitle">Send a message to start the conversation</p>
                    </div>
                `;
                return;
            }
            
            // Convert messages object to array and sort by timestamp
            const messagesArray = Object.values(messages).sort((a, b) => 
                new Date(a.timestamp) - new Date(b.timestamp)
            );
            
            // Group messages by date
            const groupedMessages = groupMessagesByDate(messagesArray);
            
            // Display grouped messages
            Object.keys(groupedMessages).forEach(date => {
                const dateHeader = document.createElement('div');
                dateHeader.className = 'message-date-header';
                dateHeader.style.textAlign = 'center';
                dateHeader.style.margin = '20px 0';
                dateHeader.style.color = '#8E8E93';
                dateHeader.style.fontSize = '12px';
                dateHeader.style.fontWeight = '600';
                dateHeader.textContent = formatDate(date);
                messagesContainer.appendChild(dateHeader);
                
                groupedMessages[date].forEach((message, index) => {
                    const isSent = message.senderId === currentUserId;
                    const prevMessage = groupedMessages[date][index - 1];
                    const showAvatar = !prevMessage || prevMessage.senderId !== message.senderId;
                    
                    const messageRow = document.createElement('div');
                    messageRow.className = `message-row ${isSent ? 'sent' : 'received'}`;
                    
                    if (!isSent && showAvatar) {
                        messageRow.innerHTML = `
                            <div class="message-avatar">
                                ${message.senderAvatar ? 
                                    `<img src="${message.senderAvatar}" alt="${message.senderName}">` :
                                    `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                        <i class="fas fa-user" style="color:white;font-size:16px;"></i>
                                    </div>`
                                }
                            </div>
                            <div class="message-bubble">
                                ${message.type === 'text' ? 
                                    `<div class="message-text">${escapeHtml(message.content)}</div>` :
                                message.type === 'image' ?
                                    `<div class="message-media">
                                        <img src="${message.content}" alt="Image" onclick="viewMedia('${message.content}')">
                                    </div>` :
                                message.type === 'video' ?
                                    `<div class="message-media">
                                        <video controls>
                                            <source src="${message.content}" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </div>` :
                                message.type === 'file' ?
                                    `<div class="message-file" onclick="downloadFile('${message.content}', '${message.fileName}')">
                                        <i class="fas fa-file"></i>
                                        <div class="file-info">
                                            <div class="file-name">${message.fileName}</div>
                                            <div class="file-size">${formatFileSize(message.fileSize)}</div>
                                        </div>
                                        <i class="fas fa-download"></i>
                                    </div>` :
                                    `<div class="message-text">${escapeHtml(message.content)}</div>`
                                }
                                <div class="message-time">${formatMessageTime(message.timestamp)}</div>
                            </div>
                        `;
                    } else {
                        messageRow.innerHTML = `
                            <div class="message-bubble">
                                ${message.type === 'text' ? 
                                    `<div class="message-text">${escapeHtml(message.content)}</div>` :
                                message.type === 'image' ?
                                    `<div class="message-media">
                                        <img src="${message.content}" alt="Image" onclick="viewMedia('${message.content}')">
                                    </div>` :
                                message.type === 'video' ?
                                    `<div class="message-media">
                                        <video controls>
                                            <source src="${message.content}" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    </div>` :
                                message.type === 'file' ?
                                    `<div class="message-file" onclick="downloadFile('${message.content}', '${message.fileName}')">
                                        <i class="fas fa-file"></i>
                                        <div class="file-info">
                                            <div class="file-name">${message.fileName}</div>
                                            <div class="file-size">${formatFileSize(message.fileSize)}</div>
                                        </div>
                                        <i class="fas fa-download"></i>
                                    </div>` :
                                    `<div class="message-text">${escapeHtml(message.content)}</div>`
                                }
                                <div class="message-time">${formatMessageTime(message.timestamp)}</div>
                            </div>
                            ${isSent && showAvatar ? `
                                <div class="message-avatar">
                                    ${message.senderAvatar ? 
                                        `<img src="${message.senderAvatar}" alt="${message.senderName}">` :
                                        `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                            <i class="fas fa-user" style="color:white;font-size:16px;"></i>
                                        </div>`
                                    }
                                </div>
                            ` : ''}
                        `;
                    }
                    
                    messagesContainer.appendChild(messageRow);
                });
            });
            
            // Scroll to bottom
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        function addNewMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const isSent = message.senderId === currentUserId;
            
            const messageRow = document.createElement('div');
            messageRow.className = `message-row ${isSent ? 'sent' : 'received'} fade-in`;
            
            if (!isSent) {
                messageRow.innerHTML = `
                    <div class="message-avatar">
                        ${message.senderAvatar ? 
                            `<img src="${message.senderAvatar}" alt="${message.senderName}">` :
                            `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                <i class="fas fa-user" style="color:white;font-size:16px;"></i>
                            </div>`
                        }
                    </div>
                    <div class="message-bubble">
                        ${message.type === 'text' ? 
                            `<div class="message-text">${escapeHtml(message.content)}</div>` :
                        message.type === 'image' ?
                            `<div class="message-media">
                                <img src="${message.content}" alt="Image" onclick="viewMedia('${message.content}')">
                            </div>` :
                        message.type === 'video' ?
                            `<div class="message-media">
                                <video controls>
                                    <source src="${message.content}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>` :
                        message.type === 'file' ?
                            `<div class="message-file" onclick="downloadFile('${message.content}', '${message.fileName}')">
                                <i class="fas fa-file"></i>
                                <div class="file-info">
                                    <div class="file-name">${message.fileName}</div>
                                    <div class="file-size">${formatFileSize(message.fileSize)}</div>
                                </div>
                                <i class="fas fa-download"></i>
                            </div>` :
                            `<div class="message-text">${escapeHtml(message.content)}</div>`
                        }
                        <div class="message-time">${formatMessageTime(message.timestamp)}</div>
                    </div>
                `;
            } else {
                messageRow.innerHTML = `
                    <div class="message-bubble">
                        ${message.type === 'text' ? 
                            `<div class="message-text">${escapeHtml(message.content)}</div>` :
                        message.type === 'image' ?
                            `<div class="message-media">
                                <img src="${message.content}" alt="Image" onclick="viewMedia('${message.content}')">
                            </div>` :
                        message.type === 'video' ?
                            `<div class="message-media">
                                <video controls>
                                    <source src="${message.content}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>` :
                        message.type === 'file' ?
                            `<div class="message-file" onclick="downloadFile('${message.content}', '${message.fileName}')">
                                <i class="fas fa-file"></i>
                                <div class="file-info">
                                    <div class="file-name">${message.fileName}</div>
                                    <div class="file-size">${formatFileSize(message.fileSize)}</div>
                                </div>
                                <i class="fas fa-download"></i>
                            </div>` :
                            `<div class="message-text">${escapeHtml(message.content)}</div>`
                        }
                        <div class="message-time">${formatMessageTime(message.timestamp)}</div>
                    </div>
                    <div class="message-avatar">
                        ${message.senderAvatar ? 
                            `<img src="${message.senderAvatar}" alt="${message.senderName}">` :
                            `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                <i class="fas fa-user" style="color:white;font-size:16px;"></i>
                            </div>`
                        }
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageRow);
            
            // Scroll to bottom
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
            
            // Play notification sound for received messages
            if (!isSent) {
                playNotificationSound();
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !currentChat) return;
            
            // Find the chat
            firebaseDb.ref('chats')
                .orderByChild('participants')
                .equalTo(currentUserId)
                .once('value')
                .then((snapshot) => {
                    const chats = snapshot.val();
                    if (chats) {
                        const chat = Object.entries(chats).find(([chatId, chatData]) => 
                            chatData.participants.includes(currentChat)
                        );
                        
                        if (chat) {
                            const [chatId, chatData] = chat;
                            
                            // Get current user data
                            return firebaseDb.ref('users/' + currentUserId).once('value')
                                .then((userSnapshot) => {
                                    const userData = userSnapshot.val();
                                    
                                    // Create message object
                                    const messageId = firebaseDb.ref().child('messages').push().key;
                                    const message = {
                                        id: messageId,
                                        chatId: chatId,
                                        senderId: currentUserId,
                                        senderName: userData.name,
                                        senderAvatar: userData.profilePic || '',
                                        content: content,
                                        type: 'text',
                                        timestamp: new Date().toISOString(),
                                        status: 'sent'
                                    };
                                    
                                    // Add message to chat
                                    return firebaseDb.ref('chats/' + chatId + '/messages/' + messageId).set(message)
                                        .then(() => {
                                            // Update chat's last message
                                            return firebaseDb.ref('chats/' + chatId).update({
                                                lastMessage: content,
                                                lastMessageTime: new Date().toISOString()
                                            });
                                        });
                                });
                        }
                    }
                    return Promise.reject('Chat not found');
                })
                .then(() => {
                    // Clear input
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    document.getElementById('sendBtn').disabled = true;
                })
                .catch((error) => {
                    console.error('Error sending message:', error);
                    showNotification('Error', 'Failed to send message', 'error');
                });
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Enable/disable send button
            document.getElementById('sendBtn').disabled = textarea.value.trim().length === 0;
        }

        function handleMessageKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (document.getElementById('messageInput').value.trim()) {
                    sendMessage();
                }
            }
        }

        function toggleAttachmentMenu() {
            const menu = document.getElementById('attachmentMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function attachPhoto() {
            cloudinaryWidget.open({
                resourceType: 'image',
                maxFileSize: 5000000, // 5MB
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif']
            });
            document.getElementById('attachmentMenu').style.display = 'none';
        }

        function attachVideo() {
            cloudinaryWidget.open({
                resourceType: 'video',
                maxFileSize: 50000000, // 50MB
                clientAllowedFormats: ['mp4', 'mov', 'avi']
            });
            document.getElementById('attachmentMenu').style.display = 'none';
        }

        function attachFile() {
            cloudinaryWidget.open({
                resourceType: 'auto',
                maxFileSize: 50000000, // 50MB
                clientAllowedFormats: ['pdf', 'doc', 'docx', 'txt']
            });
            document.getElementById('attachmentMenu').style.display = 'none';
        }

        function handleCloudinaryUpload(result) {
            if (!currentChat) {
                showNotification('Error', 'No active chat', 'error');
                return;
            }
            
            // Find the chat
            firebaseDb.ref('chats')
                .orderByChild('participants')
                .equalTo(currentUserId)
                .once('value')
                .then((snapshot) => {
                    const chats = snapshot.val();
                    if (chats) {
                        const chat = Object.entries(chats).find(([chatId, chatData]) => 
                            chatData.participants.includes(currentChat)
                        );
                        
                        if (chat) {
                            const [chatId, chatData] = chat;
                            
                            // Get current user data
                            return firebaseDb.ref('users/' + currentUserId).once('value')
                                .then((userSnapshot) => {
                                    const userData = userSnapshot.val();
                                    
                                    // Determine message type
                                    let type = 'file';
                                    if (result.info.resource_type === 'image') type = 'image';
                                    if (result.info.resource_type === 'video') type = 'video';
                                    
                                    // Create message object
                                    const messageId = firebaseDb.ref().child('messages').push().key;
                                    const message = {
                                        id: messageId,
                                        chatId: chatId,
                                        senderId: currentUserId,
                                        senderName: userData.name,
                                        senderAvatar: userData.profilePic || '',
                                        content: result.info.secure_url,
                                        type: type,
                                        fileName: result.info.original_filename || 'file',
                                        fileSize: result.info.bytes || 0,
                                        timestamp: new Date().toISOString(),
                                        status: 'sent'
                                    };
                                    
                                    // Add message to chat
                                    return firebaseDb.ref('chats/' + chatId + '/messages/' + messageId).set(message)
                                        .then(() => {
                                            // Update chat's last message
                                            const lastMessage = type === 'image' ? 'ðŸ“· Photo' : 
                                                               type === 'video' ? 'ðŸŽ¥ Video' : 'ðŸ“Ž File';
                                            return firebaseDb.ref('chats/' + chatId).update({
                                                lastMessage: lastMessage,
                                                lastMessageTime: new Date().toISOString()
                                            });
                                        });
                                });
                        }
                    }
                    return Promise.reject('Chat not found');
                })
                .then(() => {
                    showNotification('Success', 'File sent successfully', 'success');
                })
                .catch((error) => {
                    console.error('Error sending file:', error);
                    showNotification('Error', 'Failed to send file', 'error');
                });
        }

        function toggleChatMenu() {
            const menu = document.getElementById('chatMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function addNickname() {
            const nickname = prompt('Enter nickname for this contact:');
            if (nickname && nickname.trim()) {
                // Store nickname in user's contacts
                firebaseDb.ref('users/' + currentUserId + '/contacts/' + currentChat + '/nickname')
                    .set(nickname.trim())
                    .then(() => {
                        showNotification('Success', 'Nickname added', 'success');
                        document.getElementById('chatMenu').style.display = 'none';
                    })
                    .catch((error) => {
                        showNotification('Error', 'Failed to add nickname', 'error');
                    });
            }
        }

        function viewChatProfile() {
            viewContactProfile(currentChat);
            document.getElementById('chatMenu').style.display = 'none';
        }

        function addToFavorites() {
            firebaseDb.ref('users/' + currentUserId + '/contacts/' + currentChat + '/favorite')
                .set(true)
                .then(() => {
                    showNotification('Success', 'Added to favorites', 'success');
                    document.getElementById('chatMenu').style.display = 'none';
                })
                .catch((error) => {
                    showNotification('Error', 'Failed to add to favorites', 'error');
                });
        }

        function blockUser() {
            if (confirm('Are you sure you want to block this user?')) {
                firebaseDb.ref('users/' + currentUserId + '/blocked/' + currentChat)
                    .set(true)
                    .then(() => {
                        showNotification('User Blocked', 'This user has been blocked', 'info');
                        document.getElementById('chatMenu').style.display = 'none';
                        backToHome();
                    })
                    .catch((error) => {
                        showNotification('Error', 'Failed to block user', 'error');
                    });
            }
        }

        // ===== ZYNES FUNCTIONALITY =====
        function toggleZyneForm() {
            const form = document.getElementById('zyneForm');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }

        function uploadZynePhoto() {
            cloudinaryWidget.open({
                resourceType: 'image',
                maxFileSize: 10000000, // 10MB
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif'],
                cropping: true,
                croppingAspectRatio: 1
            });
        }

        function uploadZyneVideo() {
            cloudinaryWidget.open({
                resourceType: 'video',
                maxFileSize: 50000000, // 50MB
                clientAllowedFormats: ['mp4', 'mov', 'avi']
            });
        }

        function postZyne() {
            const text = document.getElementById('zyneText').value.trim();
            const mediaPreview = document.getElementById('zyneMediaPreview');
            const mediaUrl = mediaPreview.dataset.url;
            const mediaType = mediaPreview.dataset.type;
            
            if (!text && !mediaUrl) {
                showNotification('Error', 'Please add text or media to post', 'error');
                return;
            }
            
            // Get current user data
            firebaseDb.ref('users/' + currentUserId).once('value')
                .then((userSnapshot) => {
                    const userData = userSnapshot.val();
                    
                    // Create zyne object
                    const zyneId = firebaseDb.ref().child('zynes').push().key;
                    const zyne = {
                        id: zyneId,
                        owner: currentUserId,
                        ownerName: userData.name,
                        ownerAvatar: userData.profilePic || '',
                        ownerZynId: userData.userId,
                        text: text,
                        mediaUrl: mediaUrl || '',
                        mediaType: mediaType || '',
                        likes: 0,
                        comments: 0,
                        timestamp: new Date().toISOString(),
                        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 24 hours
                    };
                    
                    // Save zyne
                    return firebaseDb.ref('zynes/' + zyneId).set(zyne)
                        .then(() => {
                            // Add to user's zynes list
                            return firebaseDb.ref('users/' + currentUserId + '/zynes/' + zyneId).set(true);
                        });
                })
                .then(() => {
                    // Reset form
                    document.getElementById('zyneText').value = '';
                    mediaPreview.innerHTML = '';
                    delete mediaPreview.dataset.url;
                    delete mediaPreview.dataset.type;
                    document.getElementById('zyneForm').style.display = 'none';
                    
                    showNotification('Success', 'Zyne posted successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Error posting zyne:', error);
                    showNotification('Error', 'Failed to post zyne', 'error');
                });
        }

        function loadZynes() {
            // Load current user's zynes and zynes from contacts
            firebaseDb.ref('zynes')
                .orderByChild('timestamp')
                .limitToLast(50)
                .once('value')
                .then((snapshot) => {
                    updateZynesFeed(snapshot.val());
                });
        }

        function updateZynesFeed(zynesData) {
            const zynesFeed = document.getElementById('zynesFeed');
            const profileStatsZynes = document.getElementById('profileStatsZynes');
            
            if (!zynesData) {
                zynesFeed.innerHTML = '<div class="empty-state"><p>No Zynes yet</p></div>';
                profileStatsZynes.textContent = '0';
                return;
            }
            
            // Filter zynes: show user's zynes and zynes from contacts
            const currentUserContacts = contacts.map(c => c.userId);
            const filteredZynes = Object.values(zynesData).filter(zyne => 
                zyne.owner === currentUserId || currentUserContacts.includes(zyne.owner)
            );
            
            if (filteredZynes.length === 0) {
                zynesFeed.innerHTML = '<div class="empty-state"><p>No Zynes yet</p></div>';
                profileStatsZynes.textContent = '0';
                return;
            }
            
            // Update stats
            const userZynesCount = filteredZynes.filter(z => z.owner === currentUserId).length;
            profileStatsZynes.textContent = userZynesCount;
            
            // Sort by timestamp (newest first)
            filteredZynes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Clear and display zynes
            zynesFeed.innerHTML = '';
            filteredZynes.forEach(zyne => {
                const zyneCard = createZyneCard(zyne);
                zynesFeed.appendChild(zyneCard);
            });
        }

        function createZyneCard(zyne) {
            const card = document.createElement('div');
            card.className = 'zyne-card';
            card.dataset.zyneId = zyne.id;
            
            const isOwner = zyne.owner === currentUserId;
            
            let mediaHtml = '';
            if (zyne.mediaUrl) {
                if (zyne.mediaType === 'image') {
                    mediaHtml = `<div class="zyne-media"><img src="${zyne.mediaUrl}" alt="Zyne Image"></div>`;
                } else if (zyne.mediaType === 'video') {
                    mediaHtml = `<div class="zyne-media"><video controls><source src="${zyne.mediaUrl}" type="video/mp4"></video></div>`;
                }
            }
            
            card.innerHTML = `
                <div class="zyne-header">
                    <div class="zyne-avatar">
                        ${zyne.ownerAvatar ? 
                            `<img src="${zyne.ownerAvatar}" alt="${zyne.ownerName}">` :
                            `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                <i class="fas fa-user" style="color:white;font-size:24px;"></i>
                            </div>`
                        }
                    </div>
                    <div class="zyne-user-info">
                        <div class="zyne-user-name">${zyne.ownerName}</div>
                        <div class="zyne-time">${formatTime(zyne.timestamp)} â€¢ Expires in 24h</div>
                    </div>
                    ${isOwner ? `
                        <button class="zyne-menu-btn" onclick="deleteZyne('${zyne.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
                <div class="zyne-content">
                    ${zyne.text ? `<div class="zyne-text">${escapeHtml(zyne.text)}</div>` : ''}
                    ${mediaHtml}
                    <div class="zyne-stats">
                        <div class="zyne-likes" onclick="likeZyne('${zyne.id}')">
                            <i class="fas fa-heart"></i>
                            <span class="likes-count">${zyne.likes || 0}</span>
                        </div>
                        <div class="zyne-comments" onclick="toggleComments('${zyne.id}')">
                            <i class="fas fa-comment"></i>
                            <span class="comments-count">${zyne.comments || 0}</span>
                        </div>
                    </div>
                </div>
                <div class="zyne-actions-bar">
                    <button class="zyne-action-btn" onclick="likeZyne('${zyne.id}')">
                        <i class="fas fa-heart"></i> Like
                    </button>
                    <button class="zyne-action-btn" onclick="toggleComments('${zyne.id}')">
                        <i class="fas fa-comment"></i> Comment
                    </button>
                </div>
                <div class="zyne-comments-section" id="comments-${zyne.id}">
                    <!-- Comments will be loaded here -->
                </div>
            `;
            
            return card;
        }

        function likeZyne(zyneId) {
            // Toggle like
            const zyneRef = firebaseDb.ref('zynes/' + zyneId);
            
            zyneRef.transaction((zyne) => {
                if (zyne) {
                    zyne.likes = (zyne.likes || 0) + 1;
                }
                return zyne;
            });
        }

        function toggleComments(zyneId) {
            const commentsSection = document.getElementById('comments-' + zyneId);
            
            if (commentsSection.style.display === 'block') {
                commentsSection.style.display = 'none';
            } else {
                commentsSection.style.display = 'block';
                loadComments(zyneId);
            }
        }

        function loadComments(zyneId) {
            const commentsSection = document.getElementById('comments-' + zyneId);
            
            // Load comments for this zyne
            firebaseDb.ref('zyneComments/' + zyneId)
                .orderByChild('timestamp')
                .once('value')
                .then((snapshot) => {
                    const comments = snapshot.val();
                    displayComments(commentsSection, comments, zyneId);
                });
        }

        function displayComments(container, comments, zyneId) {
            if (!comments) {
                container.innerHTML = `
                    <div class="add-comment">
                        <input type="text" class="comment-input" id="comment-input-${zyneId}" placeholder="Add a comment...">
                        <button class="comment-btn" onclick="postComment('${zyneId}')">Post</button>
                    </div>
                `;
                return;
            }
            
            const commentsArray = Object.values(comments).sort((a, b) => 
                new Date(a.timestamp) - new Date(b.timestamp)
            );
            
            let commentsHtml = '';
            commentsArray.forEach(comment => {
                commentsHtml += `
                    <div class="zyne-comment">
                        <div class="comment-avatar">
                            ${comment.userAvatar ? 
                                `<img src="${comment.userAvatar}" alt="${comment.userName}">` :
                                `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-user" style="color:white;font-size:12px;"></i>
                                </div>`
                            }
                        </div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <div class="comment-name">${comment.userName}</div>
                                <div class="comment-time">${formatTime(comment.timestamp)}</div>
                            </div>
                            <div class="comment-text">${escapeHtml(comment.text)}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = commentsHtml + `
                <div class="add-comment">
                    <input type="text" class="comment-input" id="comment-input-${zyneId}" placeholder="Add a comment...">
                    <button class="comment-btn" onclick="postComment('${zyneId}')">Post</button>
                </div>
            `;
        }

        function postComment(zyneId) {
            const input = document.getElementById('comment-input-' + zyneId);
            const text = input.value.trim();
            
            if (!text) return;
            
            // Get current user data
            firebaseDb.ref('users/' + currentUserId).once('value')
                .then((userSnapshot) => {
                    const userData = userSnapshot.val();
                    
                    // Create comment object
                    const commentId = firebaseDb.ref().child('comments').push().key;
                    const comment = {
                        id: commentId,
                        zyneId: zyneId,
                        userId: currentUserId,
                        userName: userData.name,
                        userAvatar: userData.profilePic || '',
                        text: text,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Save comment
                    return firebaseDb.ref('zyneComments/' + zyneId + '/' + commentId).set(comment)
                        .then(() => {
                            // Update zyne comment count
                            return firebaseDb.ref('zynes/' + zyneId).transaction((zyne) => {
                                if (zyne) {
                                    zyne.comments = (zyne.comments || 0) + 1;
                                }
                                return zyne;
                            });
                        });
                })
                .then(() => {
                    input.value = '';
                    showNotification('Success', 'Comment posted', 'success');
                })
                .catch((error) => {
                    console.error('Error posting comment:', error);
                    showNotification('Error', 'Failed to post comment', 'error');
                });
        }

        function deleteZyne(zyneId) {
            if (confirm('Are you sure you want to delete this Zyne?')) {
                firebaseDb.ref('zynes/' + zyneId).remove()
                    .then(() => {
                        showNotification('Success', 'Zyne deleted', 'success');
                    })
                    .catch((error) => {
                        console.error('Error deleting zyne:', error);
                        showNotification('Error', 'Failed to delete zyne', 'error');
                    });
            }
        }

        // ===== GROUPS FUNCTIONALITY =====
        function showCreateGroupPopup() {
            document.getElementById('createGroupPopup').style.display = 'flex';
            loadContactsForGroup();
        }

        function closeCreateGroupPopup() {
            document.getElementById('createGroupPopup').style.display = 'none';
            document.getElementById('groupName').value = '';
            document.getElementById('selectedMembersList').innerHTML = '';
            document.getElementById('groupImagePreview').innerHTML = `
                <div class="upload-placeholder">
                    <i class="fas fa-users"></i>
                    <span>Group Photo</span>
                </div>
            `;
        }

        function loadContactsForGroup() {
            const membersSelect = document.getElementById('groupMembersSelect');
            
            firebaseDb.ref('users/' + currentUserId + '/contacts')
                .once('value')
                .then((snapshot) => {
                    const contacts = snapshot.val();
                    
                    if (!contacts) {
                        membersSelect.innerHTML = '<div class="empty-state"><p>No contacts to add</p></div>';
                        return;
                    }
                    
                    membersSelect.innerHTML = '';
                    
                    Object.entries(contacts).forEach(([contactId, contact]) => {
                        const memberItem = document.createElement('div');
                        memberItem.className = 'member-select-item';
                        memberItem.dataset.userId = contactId;
                        memberItem.onclick = () => toggleGroupMember(contactId, contact.name);
                        memberItem.innerHTML = `
                            <div class="member-select-checkbox"></div>
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="width:32px;height:32px;border-radius:16px;overflow:hidden;">
                                    ${contact.profilePic ? 
                                        `<img src="${contact.profilePic}" alt="${contact.name}" style="width:100%;height:100%;object-fit:cover;">` :
                                        `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                                            <i class="fas fa-user" style="color:white;font-size:14px;"></i>
                                        </div>`
                                    }
                                </div>
                                <div>
                                    <div style="font-weight:600;">${contact.name}</div>
                                    <div style="font-size:12px;color:#8E8E93;">${contact.zynId}</div>
                                </div>
                            </div>
                        `;
                        membersSelect.appendChild(memberItem);
                    });
                });
        }

        const selectedGroupMembers = new Set();

        function toggleGroupMember(userId, userName) {
            const memberItem = document.querySelector(`.member-select-item[data-user-id="${userId}"]`);
            
            if (selectedGroupMembers.has(userId)) {
                selectedGroupMembers.delete(userId);
                memberItem.classList.remove('selected');
                
                // Remove from selected list
                const tag = document.querySelector(`.selected-member-tag[data-user-id="${userId}"]`);
                if (tag) tag.remove();
            } else {
                selectedGroupMembers.add(userId);
                memberItem.classList.add('selected');
                
                // Add to selected list
                const selectedList = document.getElementById('selectedMembersList');
                const tag = document.createElement('div');
                tag.className = 'selected-member-tag';
                tag.dataset.userId = userId;
                tag.innerHTML = `
                    ${userName}
                    <button class="remove-member-btn" onclick="event.stopPropagation();toggleGroupMember('${userId}', '${userName}')">Ã—</button>
                `;
                selectedList.appendChild(tag);
            }
        }

        function uploadGroupPicture() {
            cloudinaryWidget.open({
                resourceType: 'image',
                maxFileSize: 5000000, // 5MB
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif'],
                cropping: true,
                croppingAspectRatio: 1
            });
        }

        function createGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            
            if (!groupName) {
                showNotification('Error', 'Please enter a group name', 'error');
                return;
            }
            
            if (selectedGroupMembers.size === 0) {
                showNotification('Error', 'Please add at least one member', 'error');
                return;
            }
            
            // Get current user data
            firebaseDb.ref('users/' + currentUserId).once('value')
                .then((userSnapshot) => {
                    const userData = userSnapshot.val();
                    
                    // Create group object
                    const groupId = firebaseDb.ref().child('groups').push().key;
                    const members = Array.from(selectedGroupMembers);
                    members.push(currentUserId); // Add creator as member
                    
                    const group = {
                        id: groupId,
                        name: groupName,
                        description: '',
                        admin: currentUserId,
                        members: members,
                        memberNames: {},
                        memberAvatars: {},
                        memberZynIds: {},
                        createdAt: new Date().toISOString(),
                        lastMessage: '',
                        lastMessageTime: new Date().toISOString()
                    };
                    
                    // Add member details
                    members.forEach(memberId => {
                        if (memberId === currentUserId) {
                            group.memberNames[memberId] = userData.name;
                            group.memberAvatars[memberId] = userData.profilePic || '';
                            group.memberZynIds[memberId] = userData.userId;
                        } else {
                            // Get member details from contacts
                            return firebaseDb.ref('users/' + currentUserId + '/contacts/' + memberId).once('value')
                                .then((contactSnapshot) => {
                                    const contactData = contactSnapshot.val();
                                    if (contactData) {
                                        group.memberNames[memberId] = contactData.name;
                                        group.memberAvatars[memberId] = contactData.profilePic || '';
                                        group.memberZynIds[memberId] = contactData.zynId;
                                    }
                                });
                        }
                    });
                    
                    // Save group
                    return firebaseDb.ref('groups/' + groupId).set(group);
                })
                .then(() => {
                    closeCreateGroupPopup();
                    showNotification('Success', 'Group created successfully!', 'success');
                    
                    // Add group to each member's groups list
                    const members = Array.from(selectedGroupMembers);
                    members.push(currentUserId);
                    
                    const updatePromises = members.map(memberId => 
                        firebaseDb.ref('users/' + memberId + '/groups/' + groupId).set(true)
                    );
                    
                    return Promise.all(updatePromises);
                })
                .then(() => {
                    // Open the group chat
                    openGroupChat(groupId);
                })
                .catch((error) => {
                    console.error('Error creating group:', error);
                    showNotification('Error', 'Failed to create group', 'error');
                });
        }

        function loadGroups() {
            firebaseDb.ref('users/' + currentUserId + '/groups')
                .once('value')
                .then((snapshot) => {
                    const userGroups = snapshot.val();
                    if (userGroups) {
                        const groupIds = Object.keys(userGroups);
                        loadGroupDetails(groupIds);
                    } else {
                        document.getElementById('groupsList').innerHTML = '';
                        document.getElementById('emptyGroups').style.display = 'block';
                    }
                });
        }

        function loadGroupDetails(groupIds) {
            const groupsList = document.getElementById('groupsList');
            const emptyGroups = document.getElementById('emptyGroups');
            const profileStatsGroups = document.getElementById('profileStatsGroups');
            
            if (groupIds.length === 0) {
                groupsList.innerHTML = '';
                emptyGroups.style.display = 'block';
                profileStatsGroups.textContent = '0';
                return;
            }
            
            // Update stats
            profileStatsGroups.textContent = groupIds.length;
            
            // Clear container
            groupsList.innerHTML = '';
            emptyGroups.style.display = 'none';
            
            // Load each group's details
            groupIds.forEach(groupId => {
                firebaseDb.ref('groups/' + groupId).once('value')
                    .then((snapshot) => {
                        const group = snapshot.val();
                        if (group) {
                            const groupItem = createGroupItem(group);
                            groupsList.appendChild(groupItem);
                        }
                    });
            });
        }

        function createGroupItem(group) {
            const item = document.createElement('div');
            item.className = 'group-item';
            item.onclick = () => openGroupChat(group.id);
            
            const membersCount = group.members ? group.members.length : 0;
            const isMultiAvatar = membersCount > 2;
            
            item.innerHTML = `
                <div class="group-avatar ${isMultiAvatar ? 'multi' : ''}">
                    ${!isMultiAvatar && group.memberAvatars && group.memberAvatars[group.admin] ? 
                        `<img src="${group.memberAvatars[group.admin]}" alt="${group.name}">` :
                        `<div style="width:100%;height:100%;background:linear-gradient(135deg,#007AFF 0%,#5856D6 100%);display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-users" style="color:white;font-size:28px;"></i>
                        </div>`
                    }
                </div>
                <div class="group-info">
                    <div class="group-name">${group.name}</div>
                    <div class="group-members">
                        <i class="fas fa-user-friends"></i>
                        <span>${membersCount} members</span>
                    </div>
                    <div class="group-last-message">${group.lastMessage || 'No messages yet'}</div>
                </div>
                <div class="group-unread" style="display: none;">1</div>
            `;
            
            return item;
        }

        function openGroupChat(groupId) {
            // Similar to openChat but for groups
            showNotification('Info', 'Group chat functionality coming soon', 'info');
        }

        // ===== PROFILE FUNCTIONS =====
        function showProfileModal() {
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function viewContactProfile(contactId) {
            firebaseDb.ref('users/' + contactId).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        // Create a profile view modal for the contact
                        alert(`Profile View\n\nName: ${userData.name}\nZynapse ID: ${userData.userId}\nEmail: ${userData.email}\nPhone: ${userData.phone}`);
                    }
                });
        }

        function changeProfilePicture() {
            cloudinaryWidget.open({
                resourceType: 'image',
                maxFileSize: 5000000, // 5MB
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif'],
                cropping: true,
                croppingAspectRatio: 1
            });
        }

        function editProfile() {
            showNotification('Info', 'Edit profile functionality coming soon', 'info');
        }

        function notificationSettings() {
            showNotification('Info', 'Notification settings coming soon', 'info');
        }

        // ===== UTILITY FUNCTIONS =====
        function showLoading(message) {
            // Create loading overlay
            let loading = document.getElementById('loadingOverlay');
            if (!loading) {
                loading = document.createElement('div');
                loading.id = 'loadingOverlay';
                loading.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255, 255, 255, 0.9);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    backdrop-filter: blur(10px);
                `;
                loading.innerHTML = `
                    <div class="loading" style="width: 40px; height: 40px; border-width: 3px;"></div>
                    <p style="margin-top: 20px; color: #8E8E93; font-weight: 600;">${message}</p>
                `;
                document.body.appendChild(loading);
            }
        }

        function hideLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) {
                loading.remove();
            }
        }

        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let icon = 'fas fa-info-circle';
            let color = '#007AFF';
            
            switch (type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    color = '#34C759';
                    break;
                case 'error':
                    icon = 'fas fa-exclamation-circle';
                    color = '#FF3B30';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    color = '#FF9500';
                    break;
            }
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notification.style.borderLeftColor = color;
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 400);
            }, 5000);
        }

        function playNotificationSound() {
            try {
                const audio = document.getElementById('notificationSound');
                audio.currentTime = 0;
                audio.play().catch(e => console.log('Audio play failed:', e));
            } catch (error) {
                console.log('Notification sound error:', error);
            }
        }

        function copyUserId() {
            const userId = document.getElementById('generatedUserId').textContent;
            navigator.clipboard.writeText(userId).then(() => {
                const btn = document.querySelector('.copy-id-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function copyUserIdHeader() {
            const userId = document.getElementById('headerUserId').textContent;
            navigator.clipboard.writeText(userId).then(() => {
                showNotification('Copied', 'User ID copied to clipboard', 'success');
            });
        }

        function uploadProfilePicture() {
            cloudinaryWidget.open({
                resourceType: 'image',
                maxFileSize: 5000000, // 5MB
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif'],
                cropping: true,
                croppingAspectRatio: 1
            });
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showAuthSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideAuthMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // Less than 1 minute
            if (diff < 60000) return 'Just now';
            
            // Less than 1 hour
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `${minutes}m ago`;
            }
            
            // Less than 1 day
            if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours}h ago`;
            }
            
            // Less than 1 week
            if (diff < 604800000) {
                const days = Math.floor(diff / 86400000);
                return `${days}d ago`;
            }
            
            // Return date
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            }
        }

        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function groupMessagesByDate(messages) {
            const groups = {};
            
            messages.forEach(message => {
                const date = new Date(message.timestamp).toDateString();
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(message);
            });
            
            return groups;
        }

        function viewMedia(url) {
            window.open(url, '_blank');
        }

        function downloadFile(url, fileName) {
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function showSettings() {
            showNotification('Info', 'Settings functionality coming soon', 'info');
        }

        // ===== CLOUDINARY UPLOAD HANDLER =====
        function handleCloudinaryUpload(result) {
            if (result.event === "success") {
                const url = result.info.secure_url;
                const resourceType = result.info.resource_type;
                
                // Handle based on context
                if (document.getElementById('signupStep2').classList.contains('active')) {
                    // Profile picture upload
                    signupData.profilePic = url;
                    const preview = document.querySelector('.profile-image-preview');
                    preview.innerHTML = `<img src="${url}" alt="Profile Preview">`;
                    showAuthSuccess('Profile picture uploaded');
                    
                } else if (document.getElementById('zyneForm').style.display === 'block') {
                    // Zyne media upload
                    const preview = document.getElementById('zyneMediaPreview');
                    if (resourceType === 'image') {
                        preview.innerHTML = `
                            <img src="${url}" alt="Zyne Media">
                            <button class="remove-media-btn" onclick="removeZyneMedia()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        preview.dataset.url = url;
                        preview.dataset.type = 'image';
                    } else if (resourceType === 'video') {
                        preview.innerHTML = `
                            <video controls>
                                <source src="${url}" type="video/mp4">
                            </video>
                            <button class="remove-media-btn" onclick="removeZyneMedia()">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        preview.dataset.url = url;
                        preview.dataset.type = 'video';
                    }
                    
                } else if (document.getElementById('createGroupPopup').style.display === 'flex') {
                    // Group picture upload
                    const preview = document.getElementById('groupImagePreview');
                    preview.innerHTML = `<img src="${url}" alt="Group Photo">`;
                    preview.dataset.url = url;
                    
                } else if (document.getElementById('profileModal').style.display === 'flex') {
                    // Profile picture change
                    firebaseDb.ref('users/' + currentUserId).update({
                        profilePic: url
                    })
                    .then(() => {
                        showNotification('Success', 'Profile picture updated', 'success');
                        
                        // Update all profile picture displays
                        document.querySelectorAll('.profile-image-preview img, .create-zyne-avatar img, .chat-contact-avatar img').forEach(img => {
                            img.src = url;
                        });
                    })
                    .catch((error) => {
                        showNotification('Error', 'Failed to update profile picture', 'error');
                    });
                }
            }
        }

        function removeZyneMedia() {
            const preview = document.getElementById('zyneMediaPreview');
            preview.innerHTML = '';
            delete preview.dataset.url;
            delete preview.dataset.type;
        }

        // ===== INITIAL CLOUDINARY WIDGET SETUP =====
        window.cloudinaryWidget = cloudinaryWidget;

        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            // Don't show error to user for minor issues
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // ===== SERVICE WORKER FOR PWA =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js').catch(function(error) {
                    console.log('ServiceWorker registration failed:', error);
                });
            });
        }

        // ===== OFFLINE DETECTION =====
        window.addEventListener('online', function() {
            showNotification('You\'re back online', 'Connection restored', 'success');
        });

        window.addEventListener('offline', function() {
            showNotification('You\'re offline', 'Connection lost. Some features may not work.', 'warning');
        });

        // ===== TOUCH EVENT HANDLERS FOR MOBILE =====
        let startX, startY;

        document.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        }, { passive: true });

        document.addEventListener('touchmove', function(e) {
            if (!startX || !startY) return;
            
            const diffX = startX - e.touches[0].clientX;
            const diffY = startY - e.touches[0].clientY;
            
            // Horizontal swipe detection for navigation
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    // Swipe left - next screen
                    const screens = ['homeScreen', 'zynesScreen', 'groupsScreen', 'requestsScreen', 'contactsScreen'];
                    const currentIndex = screens.indexOf(currentScreen);
                    if (currentIndex < screens.length - 1) {
                        showScreen(screens[currentIndex + 1]);
                        updateNavActive(screens[currentIndex + 1]);
                    }
                } else {
                    // Swipe right - previous screen
                    const screens = ['homeScreen', 'zynesScreen', 'groupsScreen', 'requestsScreen', 'contactsScreen'];
                    const currentIndex = screens.indexOf(currentScreen);
                    if (currentIndex > 0) {
                        showScreen(screens[currentIndex - 1]);
                        updateNavActive(screens[currentIndex - 1]);
                    }
                }
                startX = null;
                startY = null;
            }
        }, { passive: true });

        function updateNavActive(screenId) {
            const navItems = document.querySelectorAll('.nav-item');
            const screenToNav = {
                'homeScreen': 0,
                'zynesScreen': 1,
                'groupsScreen': 2,
                'requestsScreen': 3,
                'contactsScreen': 4
            };
            
            navItems.forEach((item, index) => {
                if (index === screenToNav[screenId]) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ===== PERFORMANCE OPTIMIZATIONS =====
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Handle responsive adjustments
                const floatingBtn = document.querySelector('.floating-chat-btn');
                if (window.innerWidth <= 480) {
                    floatingBtn.style.bottom = '80px';
                    floatingBtn.style.right = '15px';
                } else {
                    floatingBtn.style.bottom = '90px';
                    floatingBtn.style.right = '20px';
                }
            }, 250);
        });

        // ===== INITIAL RESIZE HANDLER =====
        window.dispatchEvent(new Event('resize'));

        // ===== EXPORT FUNCTIONS FOR GLOBAL ACCESS =====
        window.nextSignupStep = nextSignupStep;
        window.prevSignupStep = prevSignupStep;
        window.showLogin = showLogin;
        window.showSignup = showSignup;
        window.completeRegistration = completeRegistration;
        window.loginUser = loginUser;
        window.logout = logout;
        window.copyUserId = copyUserId;
        window.copyUserIdHeader = copyUserIdHeader;
        window.uploadProfilePicture = uploadProfilePicture;
        window.showScreen = showScreen;
        window.backToHome = backToHome;
        window.showStartChatPopup = showStartChatPopup;
        window.closeStartChatPopup = closeStartChatPopup;
        window.searchUser = searchUser;
        window.sendChatRequest = sendChatRequest;
        window.acceptChatRequest = acceptChatRequest;
        window.rejectChatRequest = rejectChatRequest;
        window.cancelChatRequest = cancelChatRequest;
        window.showIncomingRequests = showIncomingRequests;
        window.showOutgoingRequests = showOutgoingRequests;
        window.searchContacts = searchContacts;
        window.viewContactProfile = viewContactProfile;
        window.removeContact = removeContact;
        window.autoResizeTextarea = autoResizeTextarea;
        window.handleMessageKeydown = handleMessageKeydown;
        window.sendMessage = sendMessage;
        window.toggleAttachmentMenu = toggleAttachmentMenu;
        window.attachPhoto = attachPhoto;
        window.attachVideo = attachVideo;
        window.attachFile = attachFile;
        window.toggleChatMenu = toggleChatMenu;
        window.addNickname = addNickname;
        window.viewChatProfile = viewChatProfile;
        window.addToFavorites = addToFavorites;
        window.blockUser = blockUser;
        window.toggleZyneForm = toggleZyneForm;
        window.uploadZynePhoto = uploadZynePhoto;
        window.uploadZyneVideo = uploadZyneVideo;
        window.postZyne = postZyne;
        window.likeZyne = likeZyne;
        window.toggleComments = toggleComments;
        window.postComment = postComment;
        window.deleteZyne = deleteZyne;
        window.showCreateGroupPopup = showCreateGroupPopup;
        window.closeCreateGroupPopup = closeCreateGroupPopup;
        window.toggleGroupMember = toggleGroupMember;
        window.uploadGroupPicture = uploadGroupPicture;
        window.createGroup = createGroup;
        window.showProfileModal = showProfileModal;
        window.closeProfileModal = closeProfileModal;
        window.changeProfilePicture = changeProfilePicture;
        window.editProfile = editProfile;
        window.notificationSettings = notificationSettings;
        window.viewMedia = viewMedia;
        window.downloadFile = downloadFile;
        window.showSettings = showSettings;
        window.removeZyneMedia = removeZyneMedia;
    </script>
</body>
</html>
