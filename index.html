<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zynapse - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-blue: #007AFF;
            --primary-red: #FF3B30;
            --ios-gray: #8E8E93;
            --ios-light-gray: #C7C7CC;
            --ios-bg: #FFFFFF;
            --ios-bg-secondary: #F2F2F7;
            --ios-border: #C6C6C8;
            --message-blue: #007AFF;
            --message-gray: #E5E5EA;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.1);
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            color: #000;
            font-size: 17px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== APP CONTAINER ===== */
        #app-container {
            height: 100vh;
            width: 100vw;
            max-width: 100%;
            overflow: hidden;
            position: relative;
            background-color: var(--ios-bg);
        }

        /* ===== PAGE TRANSITIONS ===== */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background-color: var(--ios-bg);
            z-index: 10;
            overflow: hidden;
        }

        .page.active {
            transform: translateX(0);
            z-index: 20;
        }

        .page.previous {
            transform: translateX(-30%);
            z-index: 15;
        }

        /* ===== SIGNUP PAGE ===== */
        #signup-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            background: linear-gradient(to bottom, #FFFFFF 0%, #F8F8F8 100%);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
        }

        .app-title {
            font-size: 36px;
            font-weight: 700;
            color: #000;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .app-tagline {
            font-size: 18px;
            color: var(--ios-gray);
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.4;
            max-width: 300px;
        }

        .powered-by {
            font-size: 14px;
            color: var(--ios-light-gray);
            margin-bottom: 50px;
            letter-spacing: 0.5px;
        }

        .signup-form {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: 16px 15px;
            border: 1px solid var(--ios-border);
            border-radius: 10px;
            font-size: 17px;
            background-color: var(--ios-bg);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .file-upload-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-preview {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            object-fit: cover;
            border: 2px solid var(--ios-border);
        }

        .file-upload-label {
            flex: 1;
            padding: 16px 15px;
            border: 1px dashed var(--ios-border);
            border-radius: 10px;
            text-align: center;
            color: var(--ios-gray);
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-label:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 18px 24px;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056CC;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background-color: var(--ios-bg-secondary);
            color: #000;
            border: 1px solid var(--ios-border);
        }

        .btn-secondary:hover {
            background-color: #E5E5EA;
        }

        .form-footer {
            margin-top: 30px;
            text-align: center;
            color: var(--ios-gray);
            font-size: 14px;
        }

        .login-link {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 600;
        }

        .login-link:hover {
            text-decoration: underline;
        }

        /* ===== LOADING SPINNER ===== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== HEADER ===== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: var(--ios-bg);
            border-bottom: 1px solid var(--ios-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
            padding-top: var(--safe-area-inset-top, 0);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            height: 32px;
            width: auto;
            object-fit: contain;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 17px;
            font-weight: 600;
        }

        .user-id-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-id {
            font-size: 13px;
            color: var(--ios-gray);
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--primary-blue);
            font-size: 12px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .copy-btn:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary-blue);
            font-size: 18px;
            transition: background-color 0.2s;
        }

        .icon-btn:hover {
            background-color: var(--ios-bg-secondary);
        }

        /* ===== MAIN CONTENT AREA ===== */
        .main-content {
            height: calc(100% - 120px);
            margin-top: 60px;
            margin-bottom: 60px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
        }

        /* ===== FLOATING CHAT BUTTON ===== */
        .floating-chat-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background-color: var(--primary-blue);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-medium);
            z-index: 90;
            transition: all 0.3s;
            user-select: none;
            touch-action: none;
        }

        .floating-chat-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-medium);
        }

        .floating-chat-btn:active {
            transform: scale(0.95);
        }

        .floating-chat-btn-label {
            position: absolute;
            bottom: 70px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .floating-chat-btn:hover .floating-chat-btn-label {
            opacity: 1;
        }

        /* ===== NAVIGATION FOOTER ===== */
        .nav-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background-color: var(--ios-bg);
            border-top: 1px solid var(--ios-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: var(--safe-area-inset-bottom, 0);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--ios-gray);
            cursor: pointer;
            padding: 8px;
            flex: 1;
            height: 100%;
            transition: all 0.2s;
            position: relative;
        }

        .nav-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--primary-blue);
        }

        .nav-item:hover {
            background-color: var(--ios-bg-secondary);
        }

        .nav-badge {
            position: absolute;
            top: 4px;
            right: calc(50% - 20px);
            background-color: var(--primary-red);
            color: white;
            font-size: 11px;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* ===== HOME PAGE ===== */
        #home-page .main-content {
            padding: 0;
        }

        .chat-list {
            list-style: none;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--ios-border);
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        .chat-item:hover {
            background-color: var(--ios-bg-secondary);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            object-fit: cover;
            margin-right: 12px;
            border: 1px solid var(--ios-border);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-size: 17px;
            font-weight: 600;
            color: #000;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 13px;
            color: var(--ios-gray);
            white-space: nowrap;
        }

        .chat-preview {
            font-size: 15px;
            color: var(--ios-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background-color: var(--primary-blue);
            color: white;
            font-size: 12px;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            margin-left: 8px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
            color: var(--ios-gray);
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: var(--ios-light-gray);
        }

        .empty-state-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #000;
        }

        .empty-state-text {
            font-size: 16px;
            line-height: 1.4;
            max-width: 300px;
        }

        /* ===== CHAT PAGE ===== */
        #chat-page {
            display: flex;
            flex-direction: column;
        }

        .chat-header-bar {
            height: 60px;
            border-bottom: 1px solid var(--ios-border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            background-color: var(--ios-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--primary-blue);
            margin-right: 16px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .back-btn:hover {
            background-color: var(--ios-bg-secondary);
        }

        .chat-contact-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            object-fit: cover;
            border: 1px solid var(--ios-border);
        }

        .chat-contact-name {
            font-size: 17px;
            font-weight: 600;
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: var(--ios-bg);
        }

        .message-row {
            display: flex;
            margin-bottom: 4px;
        }

        .message-row.sent {
            justify-content: flex-end;
        }

        .message-row.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 17px;
        }

        .message-bubble.sent {
            background-color: var(--message-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-bubble.received {
            background-color: var(--message-gray);
            color: #000;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 12px;
            color: var(--ios-gray);
            margin-top: 4px;
            text-align: right;
        }

        .message-bubble.received .message-time {
            color: var(--ios-gray);
            text-align: left;
        }

        .message-bubble.sent .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-attachment {
            max-width: 200px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
        }

        .attachment-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .attachment-file {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            text-decoration: none;
            color: inherit;
            gap: 10px;
        }

        .attachment-file i {
            font-size: 24px;
            color: var(--primary-blue);
        }

        .attachment-info {
            flex: 1;
            min-width: 0;
        }

        .attachment-name {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .attachment-size {
            font-size: 13px;
            color: var(--ios-gray);
        }

        .chat-input-container {
            padding: 12px 16px;
            border-top: 1px solid var(--ios-border);
            background-color: var(--ios-bg);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-input-wrapper {
            flex: 1;
            background-color: var(--ios-bg-secondary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border: 1px solid var(--ios-border);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: none;
            font-size: 17px;
            padding: 8px 0;
            outline: none;
            color: #000;
        }

        .chat-input::placeholder {
            color: var(--ios-light-gray);
        }

        .attachment-btn {
            background: none;
            border: none;
            color: var(--ios-gray);
            font-size: 20px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .attachment-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-blue);
        }

        .send-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background-color: #0056CC;
        }

        .send-btn:disabled {
            background-color: var(--ios-light-gray);
            cursor: not-allowed;
        }

        .typing-indicator {
            font-size: 14px;
            color: var(--ios-gray);
            font-style: italic;
            padding-left: 16px;
            margin-bottom: 8px;
        }

        /* ===== MODALS & POPUPS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 20px;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background-color: var(--ios-bg);
            border-radius: 14px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--ios-border);
            text-align: center;
            position: relative;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #000;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--ios-gray);
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: var(--ios-bg-secondary);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--ios-border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #000;
        }

        .search-input-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 1px solid var(--ios-border);
            border-radius: 10px;
            font-size: 16px;
            background-color: var(--ios-bg);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ios-gray);
        }

        .user-result {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 8px;
        }

        .user-result:hover {
            background-color: var(--ios-bg-secondary);
        }

        .user-result-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            object-fit: cover;
            margin-right: 12px;
            border: 1px solid var(--ios-border);
        }

        .user-result-info {
            flex: 1;
        }

        .user-result-name {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-result-id {
            font-size: 14px;
            color: var(--ios-gray);
        }

        .request-card {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 1px solid var(--ios-border);
            border-radius: 12px;
            margin-bottom: 16px;
            background-color: var(--ios-bg);
        }

        .request-info {
            flex: 1;
            margin-left: 16px;
        }

        .request-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .request-id {
            font-size: 14px;
            color: var(--ios-gray);
        }

        .request-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 15px;
            border-radius: 8px;
        }

        .btn-accept {
            background-color: var(--primary-blue);
            color: white;
        }

        .btn-reject {
            background-color: var(--ios-bg-secondary);
            color: #000;
            border: 1px solid var(--ios-border);
        }

        /* ===== ZYNES PAGE ===== */
        .zynes-container {
            padding: 20px 16px;
        }

        .zynes-create {
            background-color: var(--ios-bg);
            border: 1px solid var(--ios-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
        }

        .zynes-textarea {
            width: 100%;
            border: none;
            background: none;
            font-size: 17px;
            resize: none;
            min-height: 80px;
            margin-bottom: 16px;
            outline: none;
            color: #000;
        }

        .zynes-textarea::placeholder {
            color: var(--ios-light-gray);
        }

        .zynes-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zynes-media-preview {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .media-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
        }

        .media-preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-media {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .zyne-post {
            background-color: var(--ios-bg);
            border: 1px solid var(--ios-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }

        .zyne-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .zyne-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            object-fit: cover;
            margin-right: 12px;
            border: 1px solid var(--ios-border);
        }

        .zyne-user-info {
            flex: 1;
        }

        .zyne-user-name {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .zyne-time {
            font-size: 14px;
            color: var(--ios-gray);
        }

        .zyne-content {
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .zyne-media {
            margin-bottom: 16px;
            border-radius: 8px;
            overflow: hidden;
        }

        .zyne-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
        }

        .zyne-video {
            width: 100%;
            border-radius: 8px;
        }

        .zyne-actions-bar {
            display: flex;
            justify-content: space-between;
            padding-top: 16px;
            border-top: 1px solid var(--ios-border);
        }

        .zyne-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--ios-gray);
            cursor: pointer;
            font-size: 15px;
            transition: color 0.2s;
        }

        .zyne-action-btn:hover {
            color: var(--primary-blue);
        }

        .zyne-action-btn.liked {
            color: var(--primary-red);
        }

        .zyne-comments {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--ios-border);
        }

        .comment-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid var(--ios-border);
            border-radius: 20px;
            font-size: 15px;
            background-color: var(--ios-bg-secondary);
        }

        .comment {
            display: flex;
            margin-bottom: 12px;
        }

        .comment-avatar {
            width: 36px;
            height: 36px;
            border-radius: 18px;
            object-fit: cover;
            margin-right: 12px;
        }

        .comment-content {
            flex: 1;
            background-color: var(--ios-bg-secondary);
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
        }

        .comment-author {
            font-weight: 600;
            margin-bottom: 4px;
        }

        /* ===== GROUPS PAGE ===== */
        .groups-container {
            padding: 20px 16px;
        }

        .groups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .groups-title {
            font-size: 28px;
            font-weight: 700;
            color: #000;
        }

        .group-list {
            list-style: none;
        }

        .group-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--ios-border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .group-item:hover {
            background-color: var(--ios-bg-secondary);
        }

        .group-avatar {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            object-fit: cover;
            margin-right: 16px;
            border: 1px solid var(--ios-border);
            background-color: var(--ios-bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--ios-gray);
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .group-members {
            font-size: 14px;
            color: var(--ios-gray);
        }

        .group-last-message {
            font-size: 15px;
            color: var(--ios-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        /* ===== CONTACTS PAGE ===== */
        .contacts-container {
            padding: 20px 16px;
        }

        .contacts-list {
            list-style: none;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--ios-border);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .contact-item:hover {
            background-color: var(--ios-bg-secondary);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            object-fit: cover;
            margin-right: 16px;
            border: 1px solid var(--ios-border);
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-status {
            font-size: 14px;
            color: var(--ios-gray);
        }

        .contact-status.online {
            color: var(--primary-blue);
        }

        .contact-actions {
            display: flex;
            gap: 8px;
        }

        /* ===== CHAT REQUESTS PAGE ===== */
        .requests-container {
            padding: 20px 16px;
        }

        /* ===== PROFILE DROPDOWN ===== */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--ios-bg);
            border: 1px solid var(--ios-border);
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .dropdown-menu.active {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            text-decoration: none;
            color: #000;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--ios-border);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--ios-bg-secondary);
        }

        .dropdown-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            color: var(--ios-gray);
        }

        /* ===== UPLOAD PROGRESS ===== */
        .upload-progress {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            box-shadow: var(--shadow-medium);
            max-width: 300px;
            width: 90%;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-blue);
            width: 0%;
            transition: width 0.3s;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }

        /* ===== NOTIFICATION SOUND ===== */
        #notification-sound {
            display: none;
        }

        /* ===== RESPONSIVE ADJUSTMENTS ===== */
        @media (max-width: 768px) {
            .modal {
                max-width: 90%;
            }
            
            .message-bubble {
                max-width: 85%;
            }
            
            .app-title {
                font-size: 32px;
            }
            
            .zynes-create {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 12px;
            }
            
            .nav-item span {
                font-size: 10px;
            }
            
            .nav-item i {
                font-size: 20px;
            }
            
            .chat-input-container {
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Signup/Login Page -->
        <div id="signup-page" class="page active">
            <div class="logo-container">
                <!-- Logo placeholder - replace with actual zynaps.png -->
                <div class="logo-img" style="background-color: #007AFF; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 36px;">Z</div>
                <h1 class="app-title">Zynapse</h1>
                <p class="app-tagline">Secure, private messaging with end-to-end encryption and ephemeral status updates.</p>
                <p class="powered-by">Powered by Buffer Zone</p>
            </div>
            
            <form id="signup-form" class="signup-form">
                <div class="form-group">
                    <input type="text" id="signup-name" class="form-input" placeholder="Full Name" required>
                </div>
                
                <div class="form-group">
                    <input type="tel" id="signup-phone" class="form-input" placeholder="Phone Number" required>
                </div>
                
                <div class="form-group">
                    <input type="email" id="signup-email" class="form-input" placeholder="Email Address" required>
                </div>
                
                <div class="form-group">
                    <input type="password" id="signup-password" class="form-input" placeholder="Password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <div class="file-upload-container">
                        <img id="profile-preview" class="profile-preview" src="" alt="Profile Preview" style="display: none;">
                        <label for="profile-image" class="file-upload-label">
                            <i class="fas fa-camera"></i> Upload Profile Picture
                        </label>
                        <input type="file" id="profile-image" class="file-input" accept="image/*">
                    </div>
                </div>
                
                <button type="submit" id="signup-btn" class="btn btn-primary">
                    <span id="signup-btn-text">Create Account</span>
                    <div id="signup-spinner" class="loading-spinner" style="display: none;"></div>
                </button>
            </form>
            
            <div class="form-footer">
                <p>Already have an account? <a href="#" id="login-link" class="login-link">Log In</a></p>
            </div>
        </div>
        
        <!-- Main App Pages -->
        <div id="home-page" class="page">
            <div class="header">
                <div class="header-left">
                    <!-- Logo placeholder -->
                    <div class="header-logo" style="background-color: #007AFF; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">Z</div>
                    <div class="user-info">
                        <div class="user-name" id="header-user-name">User Name</div>
                        <div class="user-id-container">
                            <span class="user-id" id="header-user-id">ZYN-0000</span>
                            <button class="copy-btn" id="copy-user-id">Copy</button>
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="icon-btn" id="profile-menu-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
                
                <!-- Profile Dropdown -->
                <div class="dropdown-menu" id="profile-dropdown">
                    <div class="dropdown-item" id="view-profile-btn">
                        <i class="fas fa-user"></i> View Profile
                    </div>
                    <div class="dropdown-item" id="settings-btn">
                        <i class="fas fa-cog"></i> Settings
                    </div>
                    <div class="dropdown-item" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Log Out
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <ul class="chat-list" id="chat-list">
                    <!-- Chat items will be dynamically added here -->
                </ul>
                
                <div id="empty-chat-state" class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <h2 class="empty-state-title">No Chats Yet</h2>
                    <p class="empty-state-text">Start a new chat by tapping the + button below</p>
                </div>
            </div>
            
            <!-- Floating Chat Button -->
            <button class="floating-chat-btn" id="start-chat-btn">
                <i class="fas fa-plus"></i>
                <span class="floating-chat-btn-label">Start Chat</span>
            </button>
            
            <!-- Navigation Footer -->
            <div class="nav-footer">
                <button class="nav-item active" data-page="home">
                    <i class="fas fa-home"></i>
                    <span>HOME</span>
                </button>
                <button class="nav-item" data-page="zynes">
                    <i class="fas fa-fire"></i>
                    <span>ZYNES</span>
                    <span class="nav-badge" id="zynes-badge" style="display: none;">0</span>
                </button>
                <button class="nav-item" data-page="groups">
                    <i class="fas fa-users"></i>
                    <span>GROUPS</span>
                </button>
                <button class="nav-item" data-page="requests">
                    <i class="fas fa-user-plus"></i>
                    <span>REQUESTS</span>
                    <span class="nav-badge" id="requests-badge" style="display: none;">0</span>
                </button>
                <button class="nav-item" data-page="contacts">
                    <i class="fas fa-address-book"></i>
                    <span>CONTACTS</span>
                </button>
            </div>
        </div>
        
        <!-- Chat Page -->
        <div id="chat-page" class="page">
            <div class="chat-header-bar">
                <button class="back-btn" id="chat-back-btn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                
                <div class="chat-contact-info">
                    <img id="chat-contact-avatar" class="chat-contact-avatar" src="" alt="Contact Avatar">
                    <div>
                        <div class="chat-contact-name" id="chat-contact-name">Contact Name</div>
                        <div class="chat-contact-status" id="chat-contact-status" style="font-size: 13px; color: var(--ios-gray);">Online</div>
                    </div>
                </div>
                
                <div class="chat-header-actions">
                    <button class="icon-btn" id="chat-menu-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
                
                <!-- Chat Dropdown -->
                <div class="dropdown-menu" id="chat-dropdown">
                    <div class="dropdown-item" id="view-chat-profile-btn">
                        <i class="fas fa-user"></i> View Profile
                    </div>
                    <div class="dropdown-item" id="add-nickname-btn">
                        <i class="fas fa-tag"></i> Add Nickname
                    </div>
                    <div class="dropdown-item" id="add-to-favorites-btn">
                        <i class="fas fa-star"></i> Add to Favorites
                    </div>
                    <div class="dropdown-item" id="block-user-btn">
                        <i class="fas fa-ban"></i> Block User
                    </div>
                </div>
            </div>
            
            <div class="chat-messages-container" id="chat-messages-container">
                <!-- Messages will be dynamically added here -->
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chat-input" placeholder="iMessage">
                    <button class="attachment-btn" id="attachment-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <button class="send-btn" id="send-btn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <!-- Attachment Menu -->
            <div class="dropdown-menu" id="attachment-menu" style="position: absolute; bottom: 70px; left: 20px; width: 200px;">
                <div class="dropdown-item" id="attach-image-btn">
                    <i class="fas fa-image"></i> Photo
                </div>
                <div class="dropdown-item" id="attach-video-btn">
                    <i class="fas fa-video"></i> Video
                </div>
                <div class="dropdown-item" id="attach-file-btn">
                    <i class="fas fa-file"></i> File
                </div>
            </div>
        </div>
        
        <!-- Zynes Page -->
        <div id="zynes-page" class="page">
            <div class="header">
                <div class="header-left">
                    <button class="back-btn" id="zynes-back-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="user-info">
                        <div class="user-name">Zynes</div>
                        <div class="user-id">Status Updates</div>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="zynes-container">
                    <div class="zynes-create">
                        <textarea class="zynes-textarea" id="zyne-text" placeholder="What's on your mind?"></textarea>
                        
                        <div class="zynes-media-preview" id="zyne-media-preview">
                            <!-- Media previews will be added here -->
                        </div>
                        
                        <div class="zynes-actions">
                            <div>
                                <button class="icon-btn" id="add-zyne-photo">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button class="icon-btn" id="add-zyne-video">
                                    <i class="fas fa-video"></i>
                                </button>
                            </div>
                            <button class="btn btn-primary" id="post-zyne-btn">Post</button>
                        </div>
                    </div>
                    
                    <div id="zynes-feed">
                        <!-- Zyne posts will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Groups Page -->
        <div id="groups-page" class="page">
            <div class="header">
                <div class="header-left">
                    <button class="back-btn" id="groups-back-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="user-info">
                        <div class="user-name">Groups</div>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="icon-btn" id="create-group-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="main-content">
                <div class="groups-container">
                    <div class="groups-header">
                        <h1 class="groups-title">Your Groups</h1>
                    </div>
                    
                    <ul class="group-list" id="group-list">
                        <!-- Group items will be dynamically added here -->
                    </ul>
                    
                    <div id="empty-groups-state" class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h2 class="empty-state-title">No Groups Yet</h2>
                        <p class="empty-state-text">Create a new group to start chatting with multiple people</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contacts Page -->
        <div id="contacts-page" class="page">
            <div class="header">
                <div class="header-left">
                    <button class="back-btn" id="contacts-back-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="user-info">
                        <div class="user-name">Contacts</div>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="icon-btn" id="add-contact-btn">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="main-content">
                <div class="contacts-container">
                    <ul class="contacts-list" id="contacts-list">
                        <!-- Contact items will be dynamically added here -->
                    </ul>
                    
                    <div id="empty-contacts-state" class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-address-book"></i>
                        </div>
                        <h2 class="empty-state-title">No Contacts Yet</h2>
                        <p class="empty-state-text">Add contacts to start chatting with them</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Requests Page -->
        <div id="requests-page" class="page">
            <div class="header">
                <div class="header-left">
                    <button class="back-btn" id="requests-back-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="user-info">
                        <div class="user-name">Chat Requests</div>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="requests-container" id="requests-container">
                    <!-- Request cards will be dynamically added here -->
                </div>
                
                <div id="empty-requests-state" class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h2 class="empty-state-title">No Pending Requests</h2>
                    <p class="empty-state-text">You don't have any pending chat requests</p>
                </div>
            </div>
        </div>
        
        <!-- MODALS -->
        
        <!-- Start Chat Modal -->
        <div class="modal-overlay" id="start-chat-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Start New Chat</h2>
                    <button class="modal-close" id="start-chat-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="search-input-container">
                        <input type="text" class="search-input" id="search-user-id" placeholder="Enter User ID (ZYN-XXXX)">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div id="user-search-result">
                        <!-- User search result will appear here -->
                    </div>
                    
                    <div id="search-instruction" class="text-center" style="color: var(--ios-gray); padding: 40px 20px;">
                        <i class="fas fa-user-friends" style="font-size: 48px; margin-bottom: 16px; color: var(--ios-light-gray);"></i>
                        <p>Enter a User ID to search for a user</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Create Group Modal -->
        <div class="modal-overlay" id="create-group-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Create New Group</h2>
                    <button class="modal-close" id="create-group-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Group Name</label>
                        <input type="text" id="group-name" class="form-input" placeholder="Enter group name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Group Photo (Optional)</label>
                        <div class="file-upload-container">
                            <img id="group-photo-preview" class="profile-preview" src="" alt="Group Photo Preview" style="display: none;">
                            <label for="group-photo" class="file-upload-label">
                                <i class="fas fa-camera"></i> Upload Group Photo
                            </label>
                            <input type="file" id="group-photo" class="file-input" accept="image/*">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Add Members by User ID</label>
                        <div class="search-input-container">
                            <input type="text" class="search-input" id="group-member-search" placeholder="Enter User ID">
                            <button class="btn btn-primary btn-sm" id="add-group-member-btn" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%);">Add</button>
                        </div>
                    </div>
                    
                    <div id="group-members-list">
                        <p class="form-label">Group Members</p>
                        <!-- Group members will be added here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-group-btn">Cancel</button>
                    <button class="btn btn-primary" id="create-group-confirm-btn">Create Group</button>
                </div>
            </div>
        </div>
        
        <!-- Add Contact Modal -->
        <div class="modal-overlay" id="add-contact-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Add Contact</h2>
                    <button class="modal-close" id="add-contact-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="search-input-container">
                        <input type="text" class="search-input" id="contact-user-id" placeholder="Enter User ID (ZYN-XXXX)">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    
                    <div id="contact-search-result">
                        <!-- Contact search result will appear here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-contact-btn">Cancel</button>
                    <button class="btn btn-primary" id="send-contact-request-btn">Send Request</button>
                </div>
            </div>
        </div>
        
        <!-- Profile View Modal -->
        <div class="modal-overlay" id="profile-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">Your Profile</h2>
                    <button class="modal-close" id="profile-modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 24px;">
                        <img id="modal-profile-pic" class="profile-preview" src="" alt="Profile Picture" style="width: 100px; height: 100px; border-radius: 50px; margin-bottom: 16px;">
                        <h3 id="modal-user-name" style="font-size: 22px; margin-bottom: 8px;"></h3>
                        <p id="modal-user-id" style="color: var(--ios-gray);"></p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="edit-user-name" class="form-input" placeholder="Your Name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="edit-user-email" class="form-input" placeholder="Your Email">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="edit-user-phone" class="form-input" placeholder="Your Phone">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Profile Picture</label>
                        <div class="file-upload-container">
                            <label for="edit-profile-image" class="file-upload-label">
                                <i class="fas fa-camera"></i> Change Profile Picture
                            </label>
                            <input type="file" id="edit-profile-image" class="file-input" accept="image/*">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-edit-btn">Cancel</button>
                    <button class="btn btn-primary" id="save-profile-btn">Save Changes</button>
                </div>
            </div>
        </div>
        
        <!-- Upload Progress Indicator -->
        <div id="upload-progress" class="upload-progress" style="display: none;">
            <i class="fas fa-cloud-upload-alt"></i>
            <div class="progress-info">
                <div>Uploading...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>
        
        <!-- Notification Sound -->
        <audio id="notification-sound" preload="auto">
            <!-- notification.mp3 will be loaded here -->
            <source src="https://assets.mixkit.co/active_storage/sfx/286/286-preview.mp3" type="audio/mpeg">
        </audio>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
            authDomain: "zynapse-68181.firebaseapp.com",
            databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
            projectId: "zynapse-68181",
            storageBucket: "zynapse-68181.firebasestorage.app",
            messagingSenderId: "841353050519",
            appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
            measurementId: "G-4764XLL6WS"
        };

        // ===== CLOUDINARY CONFIGURATION =====
        const CLOUDINARY_CONFIG = {
            cloudName: 'dd3lcymrk',
            apiKey: '489857926297197',
            uploadPreset: 'h3eyhc2o',
            folder: 'zynapse'
        };
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/upload`;

        // ===== APP STATE =====
        let currentUser = null;
        let currentChat = null;
        let currentPage = 'signup';
        let contacts = [];
        let chatRequests = [];
        let groups = [];
        let zynes = [];
        let chats = [];
        let allUsers = {};
        let notificationsEnabled = true;

        // ===== DOM ELEMENTS =====
        const appContainer = document.getElementById('app-container');
        const pages = {
            signup: document.getElementById('signup-page'),
            home: document.getElementById('home-page'),
            chat: document.getElementById('chat-page'),
            zynes: document.getElementById('zynes-page'),
            groups: document.getElementById('groups-page'),
            contacts: document.getElementById('contacts-page'),
            requests: document.getElementById('requests-page')
        };

        // Signup page elements
        const signupForm = document.getElementById('signup-form');
        const signupBtn = document.getElementById('signup-btn');
        const signupBtnText = document.getElementById('signup-btn-text');
        const signupSpinner = document.getElementById('signup-spinner');
        const profileImageInput = document.getElementById('profile-image');
        const profilePreview = document.getElementById('profile-preview');
        const loginLink = document.getElementById('login-link');

        // Home page elements
        const headerUserName = document.getElementById('header-user-name');
        const headerUserId = document.getElementById('header-user-id');
        const copyUserIdBtn = document.getElementById('copy-user-id');
        const startChatBtn = document.getElementById('start-chat-btn');
        const startChatModal = document.getElementById('start-chat-modal');
        const startChatClose = document.getElementById('start-chat-close');
        const searchUserIdInput = document.getElementById('search-user-id');
        const userSearchResult = document.getElementById('user-search-result');
        const searchInstruction = document.getElementById('search-instruction');
        const chatList = document.getElementById('chat-list');
        const emptyChatState = document.getElementById('empty-chat-state');
        const navItems = document.querySelectorAll('.nav-item');
        const zynesBadge = document.getElementById('zynes-badge');
        const requestsBadge = document.getElementById('requests-badge');
        const profileMenuBtn = document.getElementById('profile-menu-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const viewProfileBtn = document.getElementById('view-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // Chat page elements
        const chatBackBtn = document.getElementById('chat-back-btn');
        const chatContactAvatar = document.getElementById('chat-contact-avatar');
        const chatContactName = document.getElementById('chat-contact-name');
        const chatContactStatus = document.getElementById('chat-contact-status');
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const attachmentBtn = document.getElementById('attachment-btn');
        const attachmentMenu = document.getElementById('attachment-menu');
        const attachImageBtn = document.getElementById('attach-image-btn');
        const attachVideoBtn = document.getElementById('attach-video-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const chatMenuBtn = document.getElementById('chat-menu-btn');
        const chatDropdown = document.getElementById('chat-dropdown');

        // Zynes page elements
        const zynesBackBtn = document.getElementById('zynes-back-btn');
        const zyneText = document.getElementById('zyne-text');
        const zyneMediaPreview = document.getElementById('zyne-media-preview');
        const addZynePhotoBtn = document.getElementById('add-zyne-photo');
        const addZyneVideoBtn = document.getElementById('add-zyne-video');
        const postZyneBtn = document.getElementById('post-zyne-btn');
        const zynesFeed = document.getElementById('zynes-feed');

        // Groups page elements
        const groupsBackBtn = document.getElementById('groups-back-btn');
        const createGroupBtn = document.getElementById('create-group-btn');
        const createGroupModal = document.getElementById('create-group-modal');
        const createGroupClose = document.getElementById('create-group-close');
        const groupList = document.getElementById('group-list');
        const emptyGroupsState = document.getElementById('empty-groups-state');

        // Contacts page elements
        const contactsBackBtn = document.getElementById('contacts-back-btn');
        const addContactBtn = document.getElementById('add-contact-btn');
        const addContactModal = document.getElementById('add-contact-modal');
        const addContactClose = document.getElementById('add-contact-close');
        const contactsList = document.getElementById('contacts-list');
        const emptyContactsState = document.getElementById('empty-contacts-state');

        // Requests page elements
        const requestsBackBtn = document.getElementById('requests-back-btn');
        const requestsContainer = document.getElementById('requests-container');
        const emptyRequestsState = document.getElementById('empty-requests-state');

        // Modals
        const profileModal = document.getElementById('profile-modal');
        const profileModalClose = document.getElementById('profile-modal-close');
        const modalProfilePic = document.getElementById('modal-profile-pic');
        const modalUserName = document.getElementById('modal-user-name');
        const modalUserId = document.getElementById('modal-user-id');
        const editUserName = document.getElementById('edit-user-name');
        const editUserEmail = document.getElementById('edit-user-email');
        const editUserPhone = document.getElementById('edit-user-phone');
        const editProfileImage = document.getElementById('edit-profile-image');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        // Upload progress
        const uploadProgress = document.getElementById('upload-progress');
        const progressFill = document.getElementById('progress-fill');

        // Notification sound
        const notificationSound = document.getElementById('notification-sound');

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded');
                return;
            }
            
            firebase.initializeApp(firebaseConfig);
            
            // Check if user is already logged in
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    loadUserData(user.uid);
                } else {
                    // User is signed out
                    showPage('signup');
                }
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize empty states
            updateEmptyStates();
        });

        // ===== EVENT LISTENERS SETUP =====
        function setupEventListeners() {
            // Signup form
            signupForm.addEventListener('submit', handleSignup);
            loginLink.addEventListener('click', (e) => {
                e.preventDefault();
                // For demo purposes, we'll just show an alert
                // In a real app, this would switch to a login form
                alert('Login functionality would be implemented here. For demo, please sign up.');
            });
            
            // Profile image upload
            profileImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        profilePreview.src = event.target.result;
                        profilePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Copy user ID
            copyUserIdBtn.addEventListener('click', copyUserId);
            
            // Start chat button
            startChatBtn.addEventListener('click', () => {
                showModal(startChatModal);
            });
            
            // Close start chat modal
            startChatClose.addEventListener('click', () => {
                hideModal(startChatModal);
            });
            
            // Search user by ID
            searchUserIdInput.addEventListener('input', searchUserById);
            
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.getAttribute('data-page');
                    if (page === 'home') {
                        showPage('home');
                    } else {
                        // For demo purposes, show the page
                        showPage(page);
                    }
                    
                    // Update active nav item
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });
            
            // Profile menu
            profileMenuBtn.addEventListener('click', toggleProfileDropdown);
            viewProfileBtn.addEventListener('click', showProfileModal);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Chat page
            chatBackBtn.addEventListener('click', () => {
                showPage('home');
            });
            
            // Chat input
            chatInput.addEventListener('input', () => {
                sendBtn.disabled = chatInput.value.trim() === '';
            });
            
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Send message
            sendBtn.addEventListener('click', sendMessage);
            
            // Attachment menu
            attachmentBtn.addEventListener('click', toggleAttachmentMenu);
            attachImageBtn.addEventListener('click', () => {
                triggerFileUpload('image/*', handleImageUpload);
                hideAttachmentMenu();
            });
            attachVideoBtn.addEventListener('click', () => {
                triggerFileUpload('video/*', handleVideoUpload);
                hideAttachmentMenu();
            });
            attachFileBtn.addEventListener('click', () => {
                triggerFileUpload('*', handleFileUpload);
                hideAttachmentMenu();
            });
            
            // Chat menu
            chatMenuBtn.addEventListener('click', toggleChatDropdown);
            
            // Zynes page
            zynesBackBtn.addEventListener('click', () => {
                showPage('home');
            });
            
            addZynePhotoBtn.addEventListener('click', () => {
                triggerFileUpload('image/*', handleZyneImageUpload);
            });
            
            addZyneVideoBtn.addEventListener('click', () => {
                triggerFileUpload('video/*', handleZyneVideoUpload);
            });
            
            postZyneBtn.addEventListener('click', postZyne);
            
            // Groups page
            groupsBackBtn.addEventListener('click', () => {
                showPage('home');
            });
            
            createGroupBtn.addEventListener('click', () => {
                showModal(createGroupModal);
            });
            
            createGroupClose.addEventListener('click', () => {
                hideModal(createGroupModal);
            });
            
            // Contacts page
            contactsBackBtn.addEventListener('click', () => {
                showPage('home');
            });
            
            addContactBtn.addEventListener('click', () => {
                showModal(addContactModal);
            });
            
            addContactClose.addEventListener('click', () => {
                hideModal(addContactModal);
            });
            
            // Requests page
            requestsBackBtn.addEventListener('click', () => {
                showPage('home');
            });
            
            // Profile modal
            profileModalClose.addEventListener('click', () => {
                hideModal(profileModal);
            });
            
            cancelEditBtn.addEventListener('click', () => {
                hideModal(profileModal);
            });
            
            saveProfileBtn.addEventListener('click', saveProfile);
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!profileMenuBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('active');
                }
                
                if (!chatMenuBtn.contains(e.target) && !chatDropdown.contains(e.target)) {
                    chatDropdown.classList.remove('active');
                }
                
                if (!attachmentBtn.contains(e.target) && !attachmentMenu.contains(e.target)) {
                    hideAttachmentMenu();
                }
            });
            
            // Close modals when clicking on overlay
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal(modal);
                    }
                });
            });
        }

        // ===== PAGE MANAGEMENT =====
        function showPage(pageName) {
            // Hide all pages
            Object.values(pages).forEach(page => {
                page.classList.remove('active', 'previous');
            });
            
            // If we're navigating from one page to another (not from signup)
            if (currentPage !== 'signup' && pageName !== 'signup') {
                const currentPageElement = pages[currentPage];
                currentPageElement.classList.add('previous');
            }
            
            // Show the requested page
            pages[pageName].classList.add('active');
            currentPage = pageName;
            
            // Update the navigation active state
            navItems.forEach(item => {
                if (item.getAttribute('data-page') === pageName) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Load page-specific data
            switch (pageName) {
                case 'home':
                    loadChats();
                    break;
                case 'zynes':
                    loadZynes();
                    break;
                case 'groups':
                    loadGroups();
                    break;
                case 'contacts':
                    loadContacts();
                    break;
                case 'requests':
                    loadChatRequests();
                    break;
            }
        }

        // ===== MODAL MANAGEMENT =====
        function showModal(modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ===== DROPDOWN MANAGEMENT =====
        function toggleProfileDropdown() {
            profileDropdown.classList.toggle('active');
        }

        function toggleChatDropdown() {
            chatDropdown.classList.toggle('active');
        }

        function toggleAttachmentMenu() {
            if (attachmentMenu.style.display === 'block') {
                hideAttachmentMenu();
            } else {
                attachmentMenu.style.display = 'block';
            }
        }

        function hideAttachmentMenu() {
            attachmentMenu.style.display = 'none';
        }

        // ===== AUTHENTICATION & USER MANAGEMENT =====
        async function handleSignup(e) {
            e.preventDefault();
            
            // Get form values
            const name = document.getElementById('signup-name').value.trim();
            const phone = document.getElementById('signup-phone').value.trim();
            const email = document.getElementById('signup-email').value.trim().toLowerCase();
            const password = document.getElementById('signup-password').value;
            const profileImage = profileImageInput.files[0];
            
            // Validate form
            if (!name || !phone || !email || !password) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            // Show loading state
            signupBtnText.textContent = 'Creating account...';
            signupSpinner.style.display = 'inline-block';
            signupBtn.disabled = true;
            
            try {
                // 1. Create user in Firebase Auth
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // 2. Generate user ID
                const userId = generateUserId();
                
                // 3. Upload profile image if provided
                let profileImageUrl = '';
                if (profileImage) {
                    profileImageUrl = await uploadToCloudinary(profileImage, 'profile');
                }
                
                // 4. Create user data object
                const userData = {
                    name,
                    phone,
                    email,
                    userId,
                    profileImage: profileImageUrl,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    status: 'online',
                    contacts: {},
                    chats: {},
                    groups: {}
                };
                
                // 5. Save user data to Firebase Realtime Database
                await firebase.database().ref('users/' + user.uid).set(userData);
                
                // 6. Also store by userId for easy lookup
                await firebase.database().ref('userIds/' + userId).set({
                    uid: user.uid,
                    name,
                    profileImage: profileImageUrl
                });
                
                // 7. Update current user and show home page
                currentUser = {
                    uid: user.uid,
                    ...userData
                };
                
                // Update UI
                updateUserHeader();
                showPage('home');
                
                // Initialize user data
                initializeUserData();
                
            } catch (error) {
                console.error('Signup error:', error);
                alert(`Signup failed: ${error.message}`);
            } finally {
                // Reset loading state
                signupBtnText.textContent = 'Create Account';
                signupSpinner.style.display = 'none';
                signupBtn.disabled = false;
            }
        }

        function generateUserId() {
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `ZYN-${randomNum}`;
        }

        async function loadUserData(uid) {
            try {
                const userRef = firebase.database().ref('users/' + uid);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    currentUser = {
                        uid,
                        ...snapshot.val()
                    };
                    
                    // Update UI
                    updateUserHeader();
                    showPage('home');
                    
                    // Initialize user data
                    initializeUserData();
                    
                    // Set up real-time listeners
                    setupRealtimeListeners();
                } else {
                    // User data doesn't exist, sign out
                    await firebase.auth().signOut();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function updateUserHeader() {
            if (currentUser) {
                headerUserName.textContent = currentUser.name;
                headerUserId.textContent = currentUser.userId;
                
                // Update profile modal if open
                if (profileModal.classList.contains('active')) {
                    modalUserName.textContent = currentUser.name;
                    modalUserId.textContent = currentUser.userId;
                    editUserName.value = currentUser.name;
                    editUserEmail.value = currentUser.email;
                    editUserPhone.value = currentUser.phone;
                    
                    if (currentUser.profileImage) {
                        modalProfilePic.src = currentUser.profileImage;
                        modalProfilePic.style.display = 'block';
                    }
                }
            }
        }

        function copyUserId() {
            if (currentUser && currentUser.userId) {
                navigator.clipboard.writeText(currentUser.userId)
                    .then(() => {
                        // Show feedback
                        const originalText = copyUserIdBtn.textContent;
                        copyUserIdBtn.textContent = 'Copied!';
                        setTimeout(() => {
                            copyUserIdBtn.textContent = originalText;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                    });
            }
        }

        async function handleLogout() {
            try {
                await firebase.auth().signOut();
                currentUser = null;
                showPage('signup');
                profileDropdown.classList.remove('active');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showProfileModal() {
            if (currentUser) {
                modalUserName.textContent = currentUser.name;
                modalUserId.textContent = currentUser.userId;
                editUserName.value = currentUser.name;
                editUserEmail.value = currentUser.email;
                editUserPhone.value = currentUser.phone;
                
                if (currentUser.profileImage) {
                    modalProfilePic.src = currentUser.profileImage;
                    modalProfilePic.style.display = 'block';
                } else {
                    modalProfilePic.style.display = 'none';
                }
                
                showModal(profileModal);
                profileDropdown.classList.remove('active');
            }
        }

        async function saveProfile() {
            if (!currentUser) return;
            
            const name = editUserName.value.trim();
            const email = editUserEmail.value.trim();
            const phone = editUserPhone.value.trim();
            const profileImage = editProfileImage.files[0];
            
            if (!name || !email || !phone) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                let profileImageUrl = currentUser.profileImage;
                
                // Upload new profile image if provided
                if (profileImage) {
                    profileImageUrl = await uploadToCloudinary(profileImage, 'profile');
                }
                
                // Update user data in Firebase
                const updates = {
                    name,
                    email,
                    phone,
                    profileImage: profileImageUrl
                };
                
                await firebase.database().ref('users/' + currentUser.uid).update(updates);
                
                // Update currentUser object
                currentUser.name = name;
                currentUser.email = email;
                currentUser.phone = phone;
                currentUser.profileImage = profileImageUrl;
                
                // Update userIds reference
                await firebase.database().ref('userIds/' + currentUser.userId).update({
                    name,
                    profileImage: profileImageUrl
                });
                
                // Update UI
                updateUserHeader();
                
                // Close modal
                hideModal(profileModal);
                
                alert('Profile updated successfully!');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile. Please try again.');
            }
        }

        // ===== FILE UPLOAD FUNCTIONS =====
        function triggerFileUpload(accept, callback) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = accept;
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    callback(file);
                }
            };
            input.click();
        }

        async function uploadToCloudinary(file, type = 'file') {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                formData.append('folder', CLOUDINARY_CONFIG.folder);
                
                // Show upload progress
                uploadProgress.style.display = 'flex';
                progressFill.style.width = '0%';
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', CLOUDINARY_URL);
                
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        progressFill.style.width = percentComplete + '%';
                    }
                };
                
                xhr.onload = () => {
                    uploadProgress.style.display = 'none';
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response.secure_url);
                    } else {
                        reject(new Error('Upload failed'));
                    }
                };
                
                xhr.onerror = () => {
                    uploadProgress.style.display = 'none';
                    reject(new Error('Upload failed'));
                };
                
                xhr.send(formData);
            });
        }

        // ===== CHAT FUNCTIONS =====
        async function searchUserById() {
            const userId = searchUserIdInput.value.trim().toUpperCase();
            
            if (!userId || !userId.startsWith('ZYN-') || userId.length !== 8) {
                userSearchResult.innerHTML = '';
                searchInstruction.style.display = 'block';
                return;
            }
            
            try {
                const snapshot = await firebase.database().ref('userIds/' + userId).once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    
                    // Check if this is the current user
                    if (currentUser && userId === currentUser.userId) {
                        userSearchResult.innerHTML = `
                            <div class="user-result">
                                <div style="text-align: center; width: 100%; padding: 20px; color: var(--ios-gray);">
                                    <i class="fas fa-user" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <p>You cannot start a chat with yourself</p>
                                </div>
                            </div>
                        `;
                        searchInstruction.style.display = 'none';
                        return;
                    }
                    
                    // Check if already in contacts
                    let isContact = false;
                    if (currentUser && currentUser.contacts) {
                        isContact = Object.values(currentUser.contacts).some(contact => contact.userId === userId);
                    }
                    
                    userSearchResult.innerHTML = `
                        <div class="user-result" id="user-result-${userId}">
                            <img src="${userData.profileImage || ''}" class="user-result-avatar" alt="${userData.name}">
                            <div class="user-result-info">
                                <div class="user-result-name">${userData.name}</div>
                                <div class="user-result-id">${userId}</div>
                                ${isContact ? '<div style="color: var(--ios-gray); font-size: 14px;">Already in your contacts</div>' : ''}
                            </div>
                        </div>
                    `;
                    
                    searchInstruction.style.display = 'none';
                    
                    // Add click event to start chat
                    document.getElementById(`user-result-${userId}`).addEventListener('click', () => {
                        if (!isContact) {
                            sendChatRequest(userId, userData);
                        } else {
                            // Start chat directly if already in contacts
                            startChatWithUser(userId, userData);
                        }
                    });
                    
                } else {
                    userSearchResult.innerHTML = `
                        <div class="user-result">
                            <div style="text-align: center; width: 100%; padding: 20px; color: var(--ios-gray);">
                                <i class="fas fa-user-slash" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <p>User not found</p>
                            </div>
                        </div>
                    `;
                    searchInstruction.style.display = 'none';
                }
            } catch (error) {
                console.error('Error searching user:', error);
                userSearchResult.innerHTML = `
                    <div class="user-result">
                        <div style="text-align: center; width: 100%; padding: 20px; color: var(--ios-gray);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <p>Error searching for user</p>
                        </div>
                    </div>
                `;
                searchInstruction.style.display = 'none';
            }
        }

        async function sendChatRequest(recipientId, recipientData) {
            if (!currentUser) return;
            
            try {
                // Get recipient's UID
                const recipientSnapshot = await firebase.database().ref('userIds/' + recipientId).once('value');
                if (!recipientSnapshot.exists()) {
                    alert('User not found');
                    return;
                }
                
                const recipientUid = recipientSnapshot.val().uid;
                
                // Create request ID
                const requestId = `req_${Date.now()}_${currentUser.uid}`;
                
                // Create request data
                const requestData = {
                    id: requestId,
                    fromUserId: currentUser.userId,
                    fromUid: currentUser.uid,
                    fromName: currentUser.name,
                    fromProfileImage: currentUser.profileImage || '',
                    toUserId: recipientId,
                    toUid: recipientUid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending'
                };
                
                // Save request to Firebase
                await firebase.database().ref(`chatRequests/${recipientUid}/${requestId}`).set(requestData);
                
                // Hide modal and show success message
                hideModal(startChatModal);
                searchUserIdInput.value = '';
                userSearchResult.innerHTML = '';
                searchInstruction.style.display = 'block';
                
                alert(`Chat request sent to ${recipientData.name}`);
                
            } catch (error) {
                console.error('Error sending chat request:', error);
                alert('Failed to send chat request. Please try again.');
            }
        }

        async function startChatWithUser(userId, userData) {
            if (!currentUser) return;
            
            try {
                // Get recipient's Uid
                const recipientSnapshot = await firebase.database().ref('userIds/' + userId).once('value');
                if (!recipientSnapshot.exists()) {
                    alert('User not found');
                    return;
                }
                
                const recipientUid = recipientSnapshot.val().uid;
                
                // Create or get chat ID
                const chatId = generateChatId(currentUser.uid, recipientUid);
                
                // Set current chat
                currentChat = {
                    id: chatId,
                    userId: userId,
                    userUid: recipientUid,
                    name: userData.name,
                    profileImage: userData.profileImage || '',
                    isGroup: false
                };
                
                // Update UI
                chatContactName.textContent = userData.name;
                chatContactAvatar.src = userData.profileImage || '';
                chatContactStatus.textContent = 'Online';
                
                // Load chat messages
                loadChatMessages(chatId);
                
                // Show chat page
                showPage('chat');
                hideModal(startChatModal);
                searchUserIdInput.value = '';
                userSearchResult.innerHTML = '';
                searchInstruction.style.display = 'block';
                
            } catch (error) {
                console.error('Error starting chat:', error);
                alert('Failed to start chat. Please try again.');
            }
        }

        function generateChatId(uid1, uid2) {
            // Sort UIDs to ensure consistent chat ID regardless of who initiated
            const sortedUids = [uid1, uid2].sort();
            return `chat_${sortedUids[0]}_${sortedUids[1]}`;
        }

        async function loadChatMessages(chatId) {
            if (!currentUser) return;
            
            try {
                const messagesRef = firebase.database().ref(`chats/${chatId}/messages`);
                messagesRef.off(); // Remove previous listeners
                
                messagesRef.limitToLast(50).on('value', (snapshot) => {
                    chatMessagesContainer.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        // No messages yet
                        return;
                    }
                    
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Sort messages by timestamp
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    
                    // Render messages
                    messages.forEach(message => {
                        const messageElement = createMessageElement(message);
                        chatMessagesContainer.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom
                    scrollToBottom();
                });
                
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        function createMessageElement(message) {
            const isSent = message.senderId === currentUser.uid;
            const messageRow = document.createElement('div');
            messageRow.className = `message-row ${isSent ? 'sent' : 'received'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
            
            let messageContent = '';
            
            if (message.type === 'text') {
                messageContent = `<div>${escapeHtml(message.content)}</div>`;
            } else if (message.type === 'image') {
                messageContent = `
                    <div>${escapeHtml(message.text || '')}</div>
                    <div class="message-attachment">
                        <img src="${message.content}" class="attachment-image" alt="Image">
                    </div>
                `;
            } else if (message.type === 'video') {
                messageContent = `
                    <div>${escapeHtml(message.text || '')}</div>
                    <div class="message-attachment">
                        <video src="${message.content}" class="attachment-video" controls style="width: 100%;"></video>
                    </div>
                `;
            } else if (message.type === 'file') {
                const fileName = message.fileName || 'File';
                const fileSize = message.fileSize ? formatFileSize(message.fileSize) : '';
                
                messageContent = `
                    <div>${escapeHtml(message.text || '')}</div>
                    <a href="${message.content}" target="_blank" class="attachment-file">
                        <i class="fas fa-file-download"></i>
                        <div class="attachment-info">
                            <div class="attachment-name">${fileName}</div>
                            <div class="attachment-size">${fileSize}</div>
                        </div>
                    </a>
                `;
            }
            
            const timeString = formatTime(message.timestamp);
            
            messageBubble.innerHTML = `
                ${messageContent}
                <div class="message-time">${timeString}</div>
            `;
            
            messageRow.appendChild(messageBubble);
            return messageRow;
        }

        async function sendMessage() {
            if (!currentUser || !currentChat || !chatInput.value.trim()) return;
            
            const messageText = chatInput.value.trim();
            const messageId = `msg_${Date.now()}_${currentUser.uid}`;
            
            const messageData = {
                id: messageId,
                senderId: currentUser.uid,
                senderName: currentUser.name,
                type: 'text',
                content: messageText,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'sent'
            };
            
            try {
                // Save message to Firebase
                await firebase.database().ref(`chats/${currentChat.id}/messages/${messageId}`).set(messageData);
                
                // Update chat last message
                await firebase.database().ref(`chats/${currentChat.id}/lastMessage`).set({
                    text: messageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    senderId: currentUser.uid
                });
                
                // Update user's chats
                await firebase.database().ref(`users/${currentUser.uid}/chats/${currentChat.id}`).set({
                    chatId: currentChat.id,
                    lastActivity: firebase.database.ServerValue.TIMESTAMP,
                    withUserId: currentChat.userId,
                    withUserName: currentChat.name,
                    isGroup: false
                });
                
                // Update recipient's chats if it's a direct chat
                if (!currentChat.isGroup) {
                    await firebase.database().ref(`users/${currentChat.userUid}/chats/${currentChat.id}`).set({
                        chatId: currentChat.id,
                        lastActivity: firebase.database.ServerValue.TIMESTAMP,
                        withUserId: currentUser.userId,
                        withUserName: currentUser.name,
                        isGroup: false
                    });
                }
                
                // Clear input
                chatInput.value = '';
                sendBtn.disabled = true;
                
                // Play notification sound for recipient
                playNotificationSound();
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        async function handleImageUpload(file) {
            if (!currentUser || !currentChat || !file) return;
            
            try {
                // Upload image to Cloudinary
                const imageUrl = await uploadToCloudinary(file, 'image');
                
                // Send image message
                await sendMediaMessage('image', imageUrl, file.name, file.size);
                
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Failed to upload image. Please try again.');
            }
        }

        async function handleVideoUpload(file) {
            if (!currentUser || !currentChat || !file) return;
            
            // Check file size (50MB limit)
            if (file.size > 50 * 1024 * 1024) {
                alert('Video file size must be less than 50MB');
                return;
            }
            
            try {
                // Upload video to Cloudinary
                const videoUrl = await uploadToCloudinary(file, 'video');
                
                // Send video message
                await sendMediaMessage('video', videoUrl, file.name, file.size);
                
            } catch (error) {
                console.error('Error uploading video:', error);
                alert('Failed to upload video. Please try again.');
            }
        }

        async function handleFileUpload(file) {
            if (!currentUser || !currentChat || !file) return;
            
            // Check file size (50MB limit)
            if (file.size > 50 * 1024 * 1024) {
                alert('File size must be less than 50MB');
                return;
            }
            
            try {
                // Upload file to Cloudinary
                const fileUrl = await uploadToCloudinary(file, 'raw');
                
                // Send file message
                await sendMediaMessage('file', fileUrl, file.name, file.size);
                
            } catch (error) {
                console.error('Error uploading file:', error);
                alert('Failed to upload file. Please try again.');
            }
        }

        async function sendMediaMessage(type, url, fileName, fileSize) {
            if (!currentUser || !currentChat) return;
            
            const messageId = `msg_${Date.now()}_${currentUser.uid}`;
            
            const messageData = {
                id: messageId,
                senderId: currentUser.uid,
                senderName: currentUser.name,
                type: type,
                content: url,
                fileName: fileName,
                fileSize: fileSize,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'sent'
            };
            
            try {
                // Save message to Firebase
                await firebase.database().ref(`chats/${currentChat.id}/messages/${messageId}`).set(messageData);
                
                // Update chat last message
                const lastMessageText = type === 'image' ? ' Image' : 
                                      type === 'video' ? ' Video' : 
                                      type === 'file' ? ' File' : 'Media';
                
                await firebase.database().ref(`chats/${currentChat.id}/lastMessage`).set({
                    text: lastMessageText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    senderId: currentUser.uid
                });
                
                // Play notification sound for recipient
                playNotificationSound();
                
            } catch (error) {
                console.error('Error sending media message:', error);
                alert('Failed to send media. Please try again.');
            }
        }

        // ===== ZYNES FUNCTIONS =====
        function handleZyneImageUpload(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const mediaId = `media_${Date.now()}`;
                zyneMediaPreview.innerHTML += `
                    <div class="media-preview-item" id="${mediaId}">
                        <img src="${e.target.result}" class="media-preview-image" alt="Preview">
                        <button class="remove-media" onclick="removeZyneMedia('${mediaId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function handleZyneVideoUpload(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const mediaId = `media_${Date.now()}`;
                zyneMediaPreview.innerHTML += `
                    <div class="media-preview-item" id="${mediaId}">
                        <video src="${e.target.result}" class="media-preview-image" controls style="width: 100%; height: 100%; object-fit: cover;"></video>
                        <button class="remove-media" onclick="removeZyneMedia('${mediaId}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        function removeZyneMedia(mediaId) {
            const mediaElement = document.getElementById(mediaId);
            if (mediaElement) {
                mediaElement.remove();
            }
        }

        async function postZyne() {
            if (!currentUser) return;
            
            const text = zyneText.value.trim();
            const mediaItems = zyneMediaPreview.querySelectorAll('.media-preview-item');
            
            if (!text && mediaItems.length === 0) {
                alert('Please add text or media to post');
                return;
            }
            
            try {
                // Upload media files if any
                const mediaUrls = [];
                // Note: In a real app, we would upload each media file to Cloudinary
                // For this demo, we'll just use placeholder URLs
                
                // Create zyne data
                const zyneId = `zyne_${Date.now()}_${currentUser.uid}`;
                const zyneData = {
                    id: zyneId,
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    userProfileImage: currentUser.profileImage || '',
                    text: text,
                    media: mediaUrls,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    likes: {},
                    comments: {},
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000) // Expires in 24 hours
                };
                
                // Save to Firebase
                await firebase.database().ref(`zynes/${zyneId}`).set(zyneData);
                
                // Add to user's zynes
                await firebase.database().ref(`users/${currentUser.uid}/zynes/${zyneId}`).set(true);
                
                // Clear form
                zyneText.value = '';
                zyneMediaPreview.innerHTML = '';
                
                // Reload zynes
                loadZynes();
                
                alert('Zyne posted successfully!');
                
            } catch (error) {
                console.error('Error posting zyne:', error);
                alert('Failed to post zyne. Please try again.');
            }
        }

        async function loadZynes() {
            if (!currentUser) return;
            
            try {
                // For demo purposes, we'll create some sample zynes
                // In a real app, we would fetch from Firebase
                
                const sampleZynes = [
                    {
                        id: 'zyne_1',
                        userId: currentUser.uid,
                        userName: currentUser.name,
                        userProfileImage: currentUser.profileImage || '',
                        text: 'Just launched Zynapse! What do you think?',
                        media: [],
                        timestamp: Date.now() - 3600000, // 1 hour ago
                        likes: {},
                        comments: {},
                        expiresAt: Date.now() + (23 * 60 * 60 * 1000)
                    },
                    {
                        id: 'zyne_2',
                        userId: 'sample_user_1',
                        userName: 'Alex Johnson',
                        userProfileImage: '',
                        text: 'Beautiful sunset today! ',
                        media: ['https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'],
                        timestamp: Date.now() - 7200000, // 2 hours ago
                        likes: { [currentUser.uid]: true },
                        comments: {},
                        expiresAt: Date.now() + (22 * 60 * 60 * 1000)
                    }
                ];
                
                zynes = sampleZynes;
                renderZynes();
                
            } catch (error) {
                console.error('Error loading zynes:', error);
            }
        }

        function renderZynes() {
            zynesFeed.innerHTML = '';
            
            if (zynes.length === 0) {
                zynesFeed.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <h2 class="empty-state-title">No Zynes Yet</h2>
                        <p class="empty-state-text">Be the first to post a Zyne!</p>
                    </div>
                `;
                return;
            }
            
            // Sort zynes by timestamp (newest first)
            zynes.sort((a, b) => b.timestamp - a.timestamp);
            
            zynes.forEach(zyne => {
                const zyneElement = createZyneElement(zyne);
                zynesFeed.appendChild(zyneElement);
            });
        }

        function createZyneElement(zyne) {
            const isOwnZyne = zyne.userId === currentUser.uid;
            const isLiked = zyne.likes && zyne.likes[currentUser.uid];
            const likeCount = zyne.likes ? Object.keys(zyne.likes).length : 0;
            const commentCount = zyne.comments ? Object.keys(zyne.comments).length : 0;
            const timeAgo = formatTimeAgo(zyne.timestamp);
            
            const zyneElement = document.createElement('div');
            zyneElement.className = 'zyne-post';
            zyneElement.id = `zyne-${zyne.id}`;
            
            let mediaContent = '';
            if (zyne.media && zyne.media.length > 0) {
                if (zyne.media[0].includes('video')) {
                    mediaContent = `
                        <div class="zyne-media">
                            <video src="${zyne.media[0]}" class="zyne-video" controls></video>
                        </div>
                    `;
                } else {
                    mediaContent = `
                        <div class="zyne-media">
                            <img src="${zyne.media[0]}" class="zyne-image" alt="Zyne media">
                        </div>
                    `;
                }
            }
            
            zyneElement.innerHTML = `
                <div class="zyne-header">
                    <img src="${zyne.userProfileImage || ''}" class="zyne-avatar" alt="${zyne.userName}">
                    <div class="zyne-user-info">
                        <div class="zyne-user-name">${zyne.userName}</div>
                        <div class="zyne-time">${timeAgo}</div>
                    </div>
                    ${isOwnZyne ? `
                        <button class="icon-btn" onclick="deleteZyne('${zyne.id}')" style="margin-left: auto;">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
                
                ${zyne.text ? `<div class="zyne-content">${escapeHtml(zyne.text)}</div>` : ''}
                
                ${mediaContent}
                
                <div class="zyne-actions-bar">
                    <button class="zyne-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleZyneLike('${zyne.id}')">
                        <i class="fas fa-heart"></i>
                        <span>${likeCount}</span>
                    </button>
                    <button class="zyne-action-btn" onclick="toggleZyneComments('${zyne.id}')">
                        <i class="fas fa-comment"></i>
                        <span>${commentCount}</span>
                    </button>
                </div>
                
                <div class="zyne-comments" id="comments-${zyne.id}" style="display: none;">
                    <div class="comment-input-container">
                        <input type="text" class="comment-input" id="comment-input-${zyne.id}" placeholder="Add a comment...">
                        <button class="btn btn-primary btn-sm" onclick="postComment('${zyne.id}')">Post</button>
                    </div>
                    <div id="comments-list-${zyne.id}">
                        <!-- Comments will be loaded here -->
                    </div>
                </div>
            `;
            
            return zyneElement;
        }

        // ===== GROUP FUNCTIONS =====
        async function loadGroups() {
            if (!currentUser) return;
            
            try {
                // For demo purposes, we'll create some sample groups
                // In a real app, we would fetch from Firebase
                
                const sampleGroups = [
                    {
                        id: 'group_1',
                        name: 'Zynapse Team',
                        description: 'Core development team',
                        members: {
                            [currentUser.uid]: true,
                            'sample_user_1': true,
                            'sample_user_2': true
                        },
                        memberCount: 3,
                        lastMessage: {
                            text: 'Let\'s schedule a meeting for tomorrow',
                            timestamp: Date.now() - 3600000,
                            senderId: 'sample_user_1'
                        },
                        createdBy: currentUser.uid,
                        createdAt: Date.now() - 86400000 // 1 day ago
                    },
                    {
                        id: 'group_2',
                        name: 'Friday Hangout',
                        description: 'Weekend plans group',
                        members: {
                            [currentUser.uid]: true,
                            'sample_user_3': true,
                            'sample_user_4': true,
                            'sample_user_5': true
                        },
                        memberCount: 4,
                        lastMessage: {
                            text: 'Who\'s coming to the party?',
                            timestamp: Date.now() - 7200000,
                            senderId: 'sample_user_3'
                        },
                        createdBy: 'sample_user_3',
                        createdAt: Date.now() - 172800000 // 2 days ago
                    }
                ];
                
                groups = sampleGroups;
                renderGroups();
                
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        function renderGroups() {
            groupList.innerHTML = '';
            
            if (groups.length === 0) {
                emptyGroupsState.style.display = 'flex';
                return;
            }
            
            emptyGroupsState.style.display = 'none';
            
            groups.forEach(group => {
                const groupElement = document.createElement('li');
                groupElement.className = 'group-item';
                groupElement.innerHTML = `
                    <div class="group-avatar">
                        ${group.name.charAt(0)}
                    </div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-members">${group.memberCount} members</div>
                        ${group.lastMessage ? `<div class="group-last-message">${group.lastMessage.text}</div>` : ''}
                    </div>
                `;
                
                groupElement.addEventListener('click', () => {
                    openGroupChat(group);
                });
                
                groupList.appendChild(groupElement);
            });
        }

        function openGroupChat(group) {
            currentChat = {
                id: group.id,
                name: group.name,
                isGroup: true,
                memberCount: group.memberCount
            };
            
            // Update UI
            chatContactName.textContent = group.name;
            chatContactAvatar.src = '';
            chatContactStatus.textContent = `${group.memberCount} members`;
            
            // For demo, we'll just show a message
            chatMessagesContainer.innerHTML = `
                <div class="empty-state" style="height: 100%;">
                    <div class="empty-state-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h2 class="empty-state-title">${group.name}</h2>
                    <p class="empty-state-text">Group chat with ${group.memberCount} members</p>
                </div>
            `;
            
            showPage('chat');
        }

        // ===== CONTACTS FUNCTIONS =====
        async function loadContacts() {
            if (!currentUser) return;
            
            try {
                // For demo purposes, we'll create some sample contacts
                // In a real app, we would fetch from Firebase
                
                const sampleContacts = [
                    {
                        userId: 'ZYN-1234',
                        name: 'Alex Johnson',
                        profileImage: '',
                        status: 'online',
                        lastSeen: Date.now() - 300000 // 5 minutes ago
                    },
                    {
                        userId: 'ZYN-5678',
                        name: 'Sam Wilson',
                        profileImage: '',
                        status: 'offline',
                        lastSeen: Date.now() - 3600000 // 1 hour ago
                    },
                    {
                        userId: 'ZYN-9012',
                        name: 'Taylor Swift',
                        profileImage: '',
                        status: 'online',
                        lastSeen: Date.now() - 60000 // 1 minute ago
                    }
                ];
                
                contacts = sampleContacts;
                renderContacts();
                
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        function renderContacts() {
            contactsList.innerHTML = '';
            
            if (contacts.length === 0) {
                emptyContactsState.style.display = 'flex';
                return;
            }
            
            emptyContactsState.style.display = 'none';
            
            contacts.forEach(contact => {
                const contactElement = document.createElement('li');
                contactElement.className = 'contact-item';
                contactElement.innerHTML = `
                    <img src="${contact.profileImage || ''}" class="contact-avatar" alt="${contact.name}">
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status ${contact.status === 'online' ? 'online' : ''}">
                            ${contact.status === 'online' ? 'Online' : `Last seen ${formatTimeAgo(contact.lastSeen)}`}
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="icon-btn" onclick="startChatWithContact('${contact.userId}')">
                            <i class="fas fa-comment"></i>
                        </button>
                    </div>
                `;
                
                contactsList.appendChild(contactElement);
            });
        }

        // ===== CHAT REQUESTS FUNCTIONS =====
        async function loadChatRequests() {
            if (!currentUser) return;
            
            try {
                // For demo purposes, we'll create some sample requests
                // In a real app, we would fetch from Firebase
                
                const sampleRequests = [
                    {
                        id: 'req_1',
                        fromUserId: 'ZYN-3456',
                        fromName: 'Jordan Lee',
                        fromProfileImage: '',
                        timestamp: Date.now() - 1800000, // 30 minutes ago
                        status: 'pending'
                    },
                    {
                        id: 'req_2',
                        fromUserId: 'ZYN-7890',
                        fromName: 'Casey Smith',
                        fromProfileImage: '',
                        timestamp: Date.now() - 86400000, // 1 day ago
                        status: 'pending'
                    }
                ];
                
                chatRequests = sampleRequests;
                renderChatRequests();
                
            } catch (error) {
                console.error('Error loading chat requests:', error);
            }
        }

        function renderChatRequests() {
            requestsContainer.innerHTML = '';
            
            if (chatRequests.length === 0) {
                emptyRequestsState.style.display = 'flex';
                requestsBadge.style.display = 'none';
                return;
            }
            
            emptyRequestsState.style.display = 'none';
            
            // Update badge
            requestsBadge.textContent = chatRequests.length;
            requestsBadge.style.display = 'flex';
            
            chatRequests.forEach(request => {
                const requestElement = document.createElement('div');
                requestElement.className = 'request-card';
                requestElement.id = `request-${request.id}`;
                
                const timeAgo = formatTimeAgo(request.timestamp);
                
                requestElement.innerHTML = `
                    <img src="${request.fromProfileImage || ''}" class="profile-preview" alt="${request.fromName}">
                    <div class="request-info">
                        <div class="request-name">${request.fromName}</div>
                        <div class="request-id">${request.fromUserId}  ${timeAgo}</div>
                    </div>
                    <div class="request-actions">
                        <button class="btn btn-accept btn-sm" onclick="acceptChatRequest('${request.id}')">Accept</button>
                        <button class="btn btn-reject btn-sm" onclick="rejectChatRequest('${request.id}')">Reject</button>
                    </div>
                `;
                
                requestsContainer.appendChild(requestElement);
            });
        }

        function acceptChatRequest(requestId) {
            // In a real app, this would update the request status in Firebase
            // and add the user to contacts
            
            // For demo, just remove the request
            const requestElement = document.getElementById(`request-${requestId}`);
            if (requestElement) {
                requestElement.remove();
                
                // Update chatRequests array
                chatRequests = chatRequests.filter(req => req.id !== requestId);
                
                // Update badge
                if (chatRequests.length === 0) {
                    emptyRequestsState.style.display = 'flex';
                    requestsBadge.style.display = 'none';
                } else {
                    requestsBadge.textContent = chatRequests.length;
                }
                
                alert('Chat request accepted! User added to your contacts.');
            }
        }

        function rejectChatRequest(requestId) {
            // In a real app, this would update the request status in Firebase
            
            // For demo, just remove the request
            const requestElement = document.getElementById(`request-${requestId}`);
            if (requestElement) {
                requestElement.remove();
                
                // Update chatRequests array
                chatRequests = chatRequests.filter(req => req.id !== requestId);
                
                // Update badge
                if (chatRequests.length === 0) {
                    emptyRequestsState.style.display = 'flex';
                    requestsBadge.style.display = 'none';
                } else {
                    requestsBadge.textContent = chatRequests.length;
                }
                
                alert('Chat request rejected.');
            }
        }

        // ===== CHAT FUNCTIONS =====
        async function loadChats() {
            if (!currentUser) return;
            
            try {
                // For demo purposes, we'll create some sample chats
                // In a real app, we would fetch from Firebase
                
                const sampleChats = [
                    {
                        id: 'chat_1',
                        withUserId: 'ZYN-1234',
                        withUserName: 'Alex Johnson',
                        withUserProfileImage: '',
                        lastMessage: {
                            text: 'See you tomorrow!',
                            timestamp: Date.now() - 300000, // 5 minutes ago
                            senderId: 'sample_user_1'
                        },
                        unreadCount: 2,
                        isGroup: false
                    },
                    {
                        id: 'chat_2',
                        withUserId: 'ZYN-5678',
                        withUserName: 'Sam Wilson',
                        withUserProfileImage: '',
                        lastMessage: {
                            text: 'Thanks for your help!',
                            timestamp: Date.now() - 1800000, // 30 minutes ago
                            senderId: currentUser.uid
                        },
                        unreadCount: 0,
                        isGroup: false
                    },
                    {
                        id: 'group_1',
                        groupName: 'Zynapse Team',
                        lastMessage: {
                            text: 'Let\'s schedule a meeting',
                            timestamp: Date.now() - 3600000, // 1 hour ago
                            senderId: 'sample_user_1'
                        },
                        unreadCount: 5,
                        isGroup: true
                    }
                ];
                
                chats = sampleChats;
                renderChats();
                
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        function renderChats() {
            chatList.innerHTML = '';
            
            if (chats.length === 0) {
                emptyChatState.style.display = 'flex';
                return;
            }
            
            emptyChatState.style.display = 'none';
            
            // Sort chats by last message timestamp (newest first)
            chats.sort((a, b) => b.lastMessage.timestamp - a.lastMessage.timestamp);
            
            chats.forEach(chat => {
                const chatElement = document.createElement('li');
                chatElement.className = 'chat-item';
                
                const chatName = chat.isGroup ? chat.groupName : chat.withUserName;
                const lastMessageTime = formatTime(chat.lastMessage.timestamp);
                const isLastMessageFromMe = chat.lastMessage.senderId === currentUser.uid;
                const lastMessagePreview = isLastMessageFromMe ? `You: ${chat.lastMessage.text}` : chat.lastMessage.text;
                
                chatElement.innerHTML = `
                    <img src="${chat.withUserProfileImage || ''}" class="chat-avatar" alt="${chatName}">
                    <div class="chat-info">
                        <div class="chat-header">
                            <div class="chat-name">${chatName}</div>
                            <div class="chat-time">${lastMessageTime}</div>
                        </div>
                        <div class="chat-preview">${lastMessagePreview}</div>
                    </div>
                    ${chat.unreadCount > 0 ? `<div class="unread-badge">${chat.unreadCount}</div>` : ''}
                `;
                
                chatElement.addEventListener('click', () => {
                    openChat(chat);
                });
                
                chatList.appendChild(chatElement);
            });
        }

        function openChat(chat) {
            if (chat.isGroup) {
                currentChat = {
                    id: chat.id,
                    name: chat.groupName,
                    isGroup: true
                };
                
                // Update UI
                chatContactName.textContent = chat.groupName;
                chatContactAvatar.src = '';
                chatContactStatus.textContent = 'Group';
                
            } else {
                currentChat = {
                    id: chat.id,
                    userId: chat.withUserId,
                    name: chat.withUserName,
                    profileImage: chat.withUserProfileImage || '',
                    isGroup: false
                };
                
                // Update UI
                chatContactName.textContent = chat.withUserName;
                chatContactAvatar.src = chat.withUserProfileImage || '';
                chatContactStatus.textContent = 'Online';
            }
            
            // For demo, we'll just show a message
            chatMessagesContainer.innerHTML = `
                <div class="empty-state" style="height: 100%;">
                    <div class="empty-state-icon">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <h2 class="empty-state-title">${currentChat.name}</h2>
                    <p class="empty-state-text">Start a conversation with ${currentChat.name}</p>
                </div>
            `;
            
            showPage('chat');
        }

        // ===== UTILITY FUNCTIONS =====
        function initializeUserData() {
            // Initialize empty states
            updateEmptyStates();
            
            // Load initial data
            loadChats();
            loadContacts();
            loadChatRequests();
            loadZynes();
            loadGroups();
        }

        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            // Listen for new chat requests
            firebase.database().ref(`chatRequests/${currentUser.uid}`).on('value', (snapshot) => {
                // In a real app, we would update chatRequests array and UI
                // For demo, we'll just update the badge
                if (snapshot.exists()) {
                    const requests = snapshot.val();
                    const requestCount = Object.keys(requests).length;
                    
                    requestsBadge.textContent = requestCount;
                    requestsBadge.style.display = requestCount > 0 ? 'flex' : 'none';
                } else {
                    requestsBadge.style.display = 'none';
                }
            });
            
            // Listen for new messages in user's chats
            if (currentUser.chats) {
                Object.keys(currentUser.chats).forEach(chatId => {
                    firebase.database().ref(`chats/${chatId}/messages`).limitToLast(1).on('child_added', (snapshot) => {
                        // Play notification sound for new messages
                        if (notificationsEnabled) {
                            playNotificationSound();
                        }
                    });
                });
            }
        }

        function updateEmptyStates() {
            // Show/hide empty states based on data
            if (chats.length === 0) {
                emptyChatState.style.display = 'flex';
            } else {
                emptyChatState.style.display = 'none';
            }
            
            if (contacts.length === 0) {
                emptyContactsState.style.display = 'flex';
            } else {
                emptyContactsState.style.display = 'none';
            }
            
            if (chatRequests.length === 0) {
                emptyRequestsState.style.display = 'flex';
            } else {
                emptyRequestsState.style.display = 'none';
            }
        }

        function scrollToBottom() {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function playNotificationSound() {
            if (notificationsEnabled) {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(e => {
                    console.log('Could not play notification sound:', e);
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else if (diffDays < 7) {
                return `${diffDays}d ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        function formatTimeAgo(timestamp) {
            return formatTime(timestamp);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ===== DEMO-ONLY FUNCTIONS =====
        // These functions are for demo purposes only
        // In a real app, they would interact with Firebase
        window.startChatWithContact = function(userId) {
            // Find contact
            const contact = contacts.find(c => c.userId === userId);
            if (contact) {
                startChatWithUser(userId, contact);
            }
        };

        window.toggleZyneLike = function(zyneId) {
            const zyne = zynes.find(z => z.id === zyneId);
            if (!zyne) return;
            
            const isLiked = zyne.likes && zyne.likes[currentUser.uid];
            const likeBtn = document.querySelector(`#zyne-${zyneId} .zyne-action-btn`);
            const likeCountSpan = likeBtn.querySelector('span');
            
            if (isLiked) {
                // Unlike
                delete zyne.likes[currentUser.uid];
                likeBtn.classList.remove('liked');
            } else {
                // Like
                if (!zyne.likes) zyne.likes = {};
                zyne.likes[currentUser.uid] = true;
                likeBtn.classList.add('liked');
            }
            
            // Update like count
            const likeCount = zyne.likes ? Object.keys(zyne.likes).length : 0;
            likeCountSpan.textContent = likeCount;
        };

        window.toggleZyneComments = function(zyneId) {
            const commentsSection = document.getElementById(`comments-${zyneId}`);
            if (commentsSection.style.display === 'none') {
                commentsSection.style.display = 'block';
            } else {
                commentsSection.style.display = 'none';
            }
        };

        window.postComment = function(zyneId) {
            const commentInput = document.getElementById(`comment-input-${zyneId}`);
            const commentText = commentInput.value.trim();
            
            if (!commentText) return;
            
            const zyne = zynes.find(z => z.id === zyneId);
            if (!zyne) return;
            
            // Add comment
            if (!zyne.comments) zyne.comments = {};
            const commentId = `comment_${Date.now()}`;
            zyne.comments[commentId] = {
                id: commentId,
                userId: currentUser.uid,
                userName: currentUser.name,
                text: commentText,
                timestamp: Date.now()
            };
            
            // Update UI
            const commentsList = document.getElementById(`comments-list-${zyneId}`);
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.innerHTML = `
                <img src="${currentUser.profileImage || ''}" class="comment-avatar" alt="${currentUser.name}">
                <div class="comment-content">
                    <div class="comment-author">${currentUser.name}</div>
                    <div>${escapeHtml(commentText)}</div>
                </div>
            `;
            commentsList.appendChild(commentElement);
            
            // Clear input
            commentInput.value = '';
            
            // Update comment count
            const commentBtn = document.querySelector(`#zyne-${zyneId} .zyne-action-btn:nth-child(2)`);
            const commentCountSpan = commentBtn.querySelector('span');
            const commentCount = Object.keys(zyne.comments).length;
            commentCountSpan.textContent = commentCount;
        };

        window.deleteZyne = function(zyneId) {
            if (confirm('Are you sure you want to delete this Zyne?')) {
                // Remove from array
                zynes = zynes.filter(z => z.id !== zyneId);
                
                // Remove from UI
                const zyneElement = document.getElementById(`zyne-${zyneId}`);
                if (zyneElement) {
                    zyneElement.remove();
                }
                
                // Update empty state if needed
                if (zynes.length === 0) {
                    renderZynes();
                }
            }
        };
    </script>
</body>
</html>
