<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zynapse - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="icon" href="https://img.icons8.com/color/96/000000/chat.png">
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-blue: #007AFF;
            --primary-red: #FF3B30;
            --primary-green: #34C759;
            --primary-orange: #FF9500;
            --light-gray: #F2F2F7;
            --medium-gray: #C7C7CC;
            --dark-gray: #8E8E93;
            --text-dark: #000000;
            --text-light: #FFFFFF;
            --bubble-sent: #007AFF;
            --bubble-received: #E5E5EA;
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.05);
            --ios-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 10px;
            --border-radius-small: 6px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #FFFFFF;
            color: var(--text-dark);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
            max-width: 100vw;
            min-height: 100vh;
        }

        button, input, textarea {
            font-family: inherit;
            font-size: inherit;
        }

        button {
            cursor: pointer;
            background: none;
            border: none;
            outline: none;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        ul, ol {
            list-style: none;
        }

        /* ===== SCREEN CONTAINERS ===== */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #FFFFFF;
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 1;
        }

        .screen.active {
            display: flex;
        }

        /* ===== SIGNUP SCREEN ===== */
        #signupScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #FFFFFF 0%, #F8F9FF 100%);
        }

        .signup-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }

        .logo-large {
            width: 180px;
            height: 180px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #5AC8FA 100%);
            border-radius: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
        }

        .logo-large i {
            font-size: 80px;
            color: white;
        }

        .app-name {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #5AC8FA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .tagline {
            font-size: 16px;
            color: var(--dark-gray);
            text-align: center;
            max-width: 320px;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .powered-by {
            font-size: 14px;
            color: var(--medium-gray);
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .powered-by span {
            font-weight: 600;
            color: var(--primary-blue);
        }

        .signup-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            width: 100%;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--dark-gray);
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--ios-transition);
            background-color: white;
        }

        .form-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .profile-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin: 10px 0;
        }

        .profile-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: var(--shadow-medium);
            display: none;
        }

        .profile-preview.active {
            display: block;
        }

        .upload-btn {
            padding: 12px 24px;
            background-color: var(--light-gray);
            border-radius: 20px;
            font-weight: 500;
            color: var(--primary-blue);
            transition: var(--ios-transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background-color: #E5E5EA;
        }

        .signup-btn {
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #5AC8FA 100%);
            color: white;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: 600;
            margin-top: 10px;
            transition: var(--ios-transition);
            box-shadow: var(--shadow-medium);
        }

        .signup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.2);
        }

        .signup-btn:active {
            transform: translateY(0);
        }

        .login-link {
            text-align: center;
            margin-top: 20px;
            color: var(--dark-gray);
            font-size: 15px;
        }

        .login-link a {
            color: var(--primary-blue);
            font-weight: 600;
        }

        /* ===== HEADER STYLES ===== */
        .header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background-color: #FFFFFF;
            border-bottom: 1px solid var(--light-gray);
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #5AC8FA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
        }

        .user-id-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-id {
            font-size: 13px;
            color: var(--dark-gray);
            font-family: 'SF Mono', monospace;
        }

        .copy-btn {
            background-color: var(--light-gray);
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: var(--ios-transition);
        }

        .copy-btn:hover {
            background-color: #E5E5EA;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--dark-gray);
            transition: var(--ios-transition);
        }

        .header-icon-btn:hover {
            background-color: var(--light-gray);
        }

        /* ===== MAIN CONTENT AREA ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background-color: #FFFFFF;
            position: relative;
            padding-bottom: 60px;
        }

        /* ===== FLOATING ACTION BUTTON ===== */
        .floating-action-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #5AC8FA 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
            z-index: 100;
            cursor: move;
            transition: var(--ios-transition);
        }

        .floating-action-btn:hover {
            transform: scale(1.05);
        }

        /* ===== NAVIGATION FOOTER ===== */
        .nav-footer {
            height: 60px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #FFFFFF;
            border-top: 1px solid var(--light-gray);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            padding-bottom: var(--safe-area-bottom);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
            border-radius: 10px;
            transition: var(--ios-transition);
            flex: 1;
            max-width: 80px;
        }

        .nav-btn i {
            font-size: 22px;
            color: var(--dark-gray);
            transition: var(--ios-transition);
        }

        .nav-btn span {
            font-size: 11px;
            font-weight: 500;
            color: var(--dark-gray);
            transition: var(--ios-transition);
        }

        .nav-btn.active {
            background-color: rgba(0, 122, 255, 0.1);
        }

        .nav-btn.active i,
        .nav-btn.active span {
            color: var(--primary-blue);
        }

        .nav-btn:hover:not(.active) {
            background-color: var(--light-gray);
        }

        /* ===== HOME SCREEN ===== */
        .home-container {
            padding: 20px 16px;
        }

        .welcome-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #5AC8FA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--dark-gray);
            max-width: 300px;
            margin: 0 auto;
        }

        .chats-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            background-color: #FFFFFF;
            border: 1px solid var(--light-gray);
            transition: var(--ios-transition);
            cursor: pointer;
        }

        .chat-item:hover {
            background-color: var(--light-gray);
            transform: translateY(-2px);
            box-shadow: var(--shadow-subtle);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 16px;
            border: 2px solid white;
            box-shadow: var(--shadow-subtle);
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chat-last-message {
            font-size: 14px;
            color: var(--dark-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .chat-time {
            font-size: 12px;
            color: var(--medium-gray);
        }

        .no-chats {
            text-align: center;
            padding: 60px 20px;
            color: var(--dark-gray);
        }

        .no-chats i {
            font-size: 48px;
            color: var(--medium-gray);
            margin-bottom: 16px;
        }

        /* ===== MODALS & POPUPS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: #FFFFFF;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--dark-gray);
            transition: var(--ios-transition);
        }

        .modal-close:hover {
            background-color: var(--light-gray);
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            margin-bottom: 16px;
        }

        .user-preview {
            display: flex;
            align-items: center;
            padding: 16px;
            border-radius: var(--border-radius);
            background-color: var(--light-gray);
            margin-bottom: 20px;
        }

        .user-preview-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 16px;
        }

        .user-preview-info {
            flex: 1;
        }

        .user-preview-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-preview-id {
            font-size: 14px;
            color: var(--dark-gray);
            font-family: 'SF Mono', monospace;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: var(--ios-transition);
        }

        .btn-primary {
            background-color: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056CC;
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background-color: #E5E5EA;
        }

        .btn-success {
            background-color: var(--primary-green);
            color: white;
        }

        .btn-danger {
            background-color: var(--primary-red);
            color: white;
        }

        /* ===== CHAT INTERFACE ===== */
        .chat-header {
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            background-color: #FFFFFF;
            border-bottom: 1px solid var(--light-gray);
            position: relative;
            z-index: 10;
        }

        .chat-back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--primary-blue);
            margin-right: 12px;
            transition: var(--ios-transition);
        }

        .chat-back-btn:hover {
            background-color: var(--light-gray);
        }

        .chat-contact-info {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .chat-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
        }

        .chat-contact-name {
            font-weight: 600;
            font-size: 17px;
        }

        .chat-menu-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--dark-gray);
            transition: var(--ios-transition);
        }

        .chat-menu-btn:hover {
            background-color: var(--light-gray);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            background-color: #FFFFFF;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            max-width: 80%;
            animation: messageAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            box-shadow: var(--shadow-subtle);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.sent .message-bubble {
            background-color: var(--bubble-sent);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background-color: var(--bubble-received);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            margin-top: 4px;
            text-align: right;
            color: rgba(255, 255, 255, 0.8);
        }

        .message.received .message-time {
            color: var(--medium-gray);
        }

        .message-input-container {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background-color: #FFFFFF;
            border-top: 1px solid var(--light-gray);
            gap: 12px;
        }

        .message-input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid var(--medium-gray);
            border-radius: 20px;
            font-size: 16px;
            resize: none;
            max-height: 120px;
            background-color: var(--light-gray);
            transition: var(--ios-transition);
        }

        .message-input:focus {
            border-color: var(--primary-blue);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .attach-btn, .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--dark-gray);
            transition: var(--ios-transition);
        }

        .attach-btn:hover {
            background-color: var(--light-gray);
        }

        .send-btn {
            background-color: var(--primary-blue);
            color: white;
        }

        .send-btn:hover {
            background-color: #0056CC;
        }

        /* ===== ZYNES SCREEN ===== */
        .zynes-container {
            padding: 20px 16px;
        }

        .zyne-create {
            background-color: var(--light-gray);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 24px;
        }

        .zyne-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius-small);
            font-size: 16px;
            margin-bottom: 12px;
            resize: vertical;
        }

        .zyne-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .zyne-media-preview {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .media-preview-item {
            width: 80px;
            height: 80px;
            border-radius: var(--border-radius-small);
            object-fit: cover;
            position: relative;
        }

        .remove-media {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--primary-red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .zynes-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .zyne-item {
            background-color: #FFFFFF;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
            overflow: hidden;
            box-shadow: var(--shadow-subtle);
        }

        .zyne-header {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--light-gray);
        }

        .zyne-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
        }

        .zyne-user-info {
            flex: 1;
        }

        .zyne-user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .zyne-timestamp {
            font-size: 13px;
            color: var(--dark-gray);
        }

        .zyne-delete {
            color: var(--primary-red);
            font-size: 18px;
            cursor: pointer;
        }

        .zyne-content {
            padding: 16px;
        }

        .zyne-text {
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .zyne-media {
            border-radius: var(--border-radius-small);
            max-width: 100%;
            margin-bottom: 12px;
        }

        .zyne-stats {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            border-top: 1px solid var(--light-gray);
            font-size: 14px;
            color: var(--dark-gray);
        }

        .zyne-actions-bar {
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid var(--light-gray);
        }

        .zyne-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--dark-gray);
            font-weight: 500;
            transition: var(--ios-transition);
            padding: 8px 16px;
            border-radius: 6px;
        }

        .zyne-action-btn:hover {
            background-color: var(--light-gray);
        }

        .zyne-action-btn.liked {
            color: var(--primary-red);
        }

        /* ===== GROUPS SCREEN ===== */
        .groups-container {
            padding: 20px 16px;
        }

        .groups-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .group-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-radius: var(--border-radius);
            background-color: #FFFFFF;
            border: 1px solid var(--light-gray);
            transition: var(--ios-transition);
            cursor: pointer;
        }

        .group-item:hover {
            background-color: var(--light-gray);
            transform: translateY(-2px);
            box-shadow: var(--shadow-subtle);
        }

        .group-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 16px;
            border: 2px solid white;
            box-shadow: var(--shadow-subtle);
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .group-members {
            font-size: 14px;
            color: var(--dark-gray);
        }

        .group-last-message {
            font-size: 14px;
            color: var(--dark-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .create-group-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: linear-gradient(135deg, var(--primary-green) 0%, #4CD964 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(52, 199, 89, 0.3);
            z-index: 100;
            transition: var(--ios-transition);
        }

        .create-group-btn:hover {
            transform: scale(1.05);
        }

        /* ===== CHAT REQUESTS SCREEN ===== */
        .requests-container {
            padding: 20px 16px;
        }

        .requests-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .request-item {
            background-color: #FFFFFF;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
            overflow: hidden;
            box-shadow: var(--shadow-subtle);
        }

        .request-header {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--light-gray);
        }

        .request-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 16px;
        }

        .request-info {
            flex: 1;
        }

        .request-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .request-id {
            font-size: 14px;
            color: var(--dark-gray);
            font-family: 'SF Mono', monospace;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            padding: 16px;
        }

        /* ===== CONTACTS SCREEN ===== */
        .contacts-container {
            padding: 20px 16px;
        }

        .contacts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-radius: var(--border-radius);
            background-color: #FFFFFF;
            border: 1px solid var(--light-gray);
            transition: var(--ios-transition);
        }

        .contact-item:hover {
            background-color: var(--light-gray);
            transform: translateY(-2px);
            box-shadow: var(--shadow-subtle);
        }

        .contact-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 16px;
            border: 2px solid white;
            box-shadow: var(--shadow-subtle);
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .contact-status {
            font-size: 14px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .contact-status.online {
            color: var(--primary-green);
        }

        .contact-actions {
            display: flex;
            gap: 10px;
        }

        .contact-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            transition: var(--ios-transition);
        }

        .contact-action-btn:hover {
            background-color: #E5E5EA;
        }

        .contact-action-btn.chat {
            color: var(--primary-blue);
        }

        .contact-action-btn.remove {
            color: var(--primary-red);
        }

        /* ===== DROPDOWN MENUS ===== */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #FFFFFF;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
            display: none;
            border: 1px solid var(--light-gray);
            overflow: hidden;
        }

        .dropdown-menu.active {
            display: block;
            animation: dropdownAppear 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes dropdownAppear {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--ios-transition);
            border-bottom: 1px solid var(--light-gray);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--light-gray);
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
            color: var(--dark-gray);
        }

        .dropdown-item.danger {
            color: var(--primary-red);
        }

        .dropdown-item.danger i {
            color: var(--primary-red);
        }

        /* ===== LOADING & EMPTY STATES ===== */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-gray);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--dark-gray);
        }

        .empty-state i {
            font-size: 48px;
            color: var(--medium-gray);
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 16px;
            max-width: 300px;
            margin: 0 auto 20px;
        }

        /* ===== UTILITIES ===== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .w-100 { width: 100%; }

        /* ===== RESPONSIVE ADJUSTMENTS ===== */
        @media (max-width: 768px) {
            .app-name {
                font-size: 36px;
            }
            
            .logo-large {
                width: 150px;
                height: 150px;
            }
            
            .logo-large i {
                font-size: 70px;
            }
            
            .modal {
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            .header-logo {
                font-size: 20px;
            }
            
            .user-name {
                font-size: 15px;
            }
            
            .nav-btn span {
                font-size: 10px;
            }
            
            .message {
                max-width: 90%;
            }
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-gray);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            z-index: 10000;
            font-size: 14px;
            display: none;
            animation: toastAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes toastAppear {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ===== FILE UPLOAD STYLES ===== */
        .file-upload-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-upload-container input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* ===== MEDIA MESSAGES ===== */
        .message-media {
            max-width: 250px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            transition: var(--ios-transition);
        }

        .message-media:hover {
            transform: scale(1.02);
        }

        /* ===== TYPING INDICATOR ===== */
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            font-size: 14px;
            color: var(--dark-gray);
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            margin-left: 8px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--dark-gray);
            margin: 0 2px;
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-4px);
            }
        }

        /* ===== PROFILE VIEW MODAL ===== */
        .profile-modal .modal-body {
            text-align: center;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 20px;
            border: 4px solid white;
            box-shadow: var(--shadow-medium);
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .profile-id {
            font-size: 16px;
            color: var(--dark-gray);
            font-family: 'SF Mono', monospace;
            margin-bottom: 20px;
            background-color: var(--light-gray);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }

        .profile-details {
            text-align: left;
            margin-top: 20px;
            background-color: var(--light-gray);
            padding: 16px;
            border-radius: var(--border-radius);
        }

        .profile-detail {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .profile-detail:last-child {
            border-bottom: none;
        }

        .profile-detail-label {
            font-weight: 500;
            color: var(--dark-gray);
        }

        .profile-detail-value {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Signup Screen -->
    <div id="signupScreen" class="screen active">
        <div class="signup-container">
            <div class="logo-large">
                <i class="fas fa-comment-dots"></i>
            </div>
            <h1 class="app-name">Zynapse</h1>
            <p class="tagline">Secure, private messaging with end-to-end encryption. Connect instantly with friends and colleagues.</p>
            <div class="powered-by">
                <i class="fas fa-shield-alt"></i>
                <span>Powered by Buffer Zone</span>
            </div>
            
            <form id="signupForm" class="signup-form">
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" class="form-input" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="phoneNumber">Phone Number</label>
                    <input type="tel" id="phoneNumber" class="form-input" placeholder="Enter your phone number" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" class="form-input" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="Create a password" required minlength="6">
                </div>
                
                <div class="profile-upload-container">
                    <img id="profilePreview" class="profile-preview" alt="Profile Preview">
                    <div class="file-upload-container">
                        <button type="button" class="upload-btn" id="uploadProfileBtn">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Upload Profile Picture
                        </button>
                        <input type="file" id="profilePicture" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <button type="submit" class="signup-btn" id="registerBtn">
                    <i class="fas fa-user-plus"></i>
                    Register
                </button>
            </form>
            
            <div class="login-link">
                Already have an account? <a href="#" id="loginLink">Log In</a>
            </div>
        </div>
    </div>

    <!-- Home Screen -->
    <div id="homeScreen" class="screen">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">Zynapse</div>
                <div class="user-info">
                    <div class="user-name" id="headerUserName">User Name</div>
                    <div class="user-id-container">
                        <span class="user-id" id="headerUserID">ZYN-0000</span>
                        <button class="copy-btn" id="copyUserIdBtn" title="Copy User ID">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-icon-btn" id="notificationsBtn" title="Notifications">
                    <i class="far fa-bell"></i>
                </button>
                <div class="dropdown">
                    <button class="header-icon-btn" id="menuBtn" title="Menu">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-menu" id="mainMenuDropdown">
                        <a href="#" class="dropdown-item" id="profileMenuBtn">
                            <i class="fas fa-user"></i>
                            My Profile
                        </a>
                        <a href="#" class="dropdown-item" id="settingsMenuBtn">
                            <i class="fas fa-cog"></i>
                            Settings
                        </a>
                        <a href="#" class="dropdown-item" id="logoutMenuBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            Log Out
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="home-container">
                <div class="welcome-section">
                    <h1 class="welcome-title" id="welcomeUser">Welcome!</h1>
                    <p class="welcome-subtitle">Start a conversation by tapping the chat button below</p>
                </div>
                
                <div class="chats-list" id="chatsList">
                    <!-- Chat items will be dynamically added here -->
                </div>
                
                <div class="no-chats" id="noChatsMessage">
                    <i class="fas fa-comments"></i>
                    <h3>No conversations yet</h3>
                    <p>Tap the chat button below to start your first conversation</p>
                </div>
            </div>
        </div>
        
        <div class="floating-action-btn" id="startChatBtn" title="Start New Chat">
            <i class="fas fa-plus"></i>
        </div>
        
        <div class="nav-footer">
            <button class="nav-btn active" data-screen="homeScreen">
                <i class="fas fa-home"></i>
                <span>HOME</span>
            </button>
            <button class="nav-btn" data-screen="zynesScreen">
                <i class="fas fa-bolt"></i>
                <span>ZYNES</span>
            </button>
            <button class="nav-btn" data-screen="groupsScreen">
                <i class="fas fa-users"></i>
                <span>GROUPS</span>
            </button>
            <button class="nav-btn" data-screen="requestsScreen">
                <i class="fas fa-user-plus"></i>
                <span>REQUESTS</span>
            </button>
            <button class="nav-btn" data-screen="contactsScreen">
                <i class="fas fa-address-book"></i>
                <span>CONTACTS</span>
            </button>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chatScreen" class="screen">
        <div class="chat-header">
            <button class="chat-back-btn" id="chatBackBtn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-contact-info">
                <img class="chat-contact-avatar" id="chatContactAvatar" src="https://via.placeholder.com/40" alt="Contact">
                <div class="chat-contact-name" id="chatContactName">Contact Name</div>
            </div>
            <div class="dropdown">
                <button class="chat-menu-btn" id="chatMenuBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-menu" id="chatDropdown">
                    <a href="#" class="dropdown-item" id="addNicknameBtn">
                        <i class="fas fa-tag"></i>
                        Add Nickname
                    </a>
                    <a href="#" class="dropdown-item" id="viewProfileBtn">
                        <i class="fas fa-user"></i>
                        View Profile
                    </a>
                    <a href="#" class="dropdown-item" id="blockUserBtn">
                        <i class="fas fa-ban"></i>
                        Block User
                    </a>
                    <a href="#" class="dropdown-item" id="addToFavoritesBtn">
                        <i class="fas fa-star"></i>
                        Add to Favorites
                    </a>
                    <a href="#" class="dropdown-item danger" id="deleteChatBtn">
                        <i class="fas fa-trash"></i>
                        Delete Chat
                    </a>
                </div>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be dynamically added here -->
            </div>
            
            <div class="message-input-container">
                <div class="dropdown">
                    <button class="attach-btn" id="attachBtn" title="Attach file">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <div class="dropdown-menu" id="attachDropdown">
                        <a href="#" class="dropdown-item" data-attach-type="image">
                            <i class="fas fa-image"></i>
                            Photo
                        </a>
                        <a href="#" class="dropdown-item" data-attach-type="video">
                            <i class="fas fa-video"></i>
                            Video
                        </a>
                        <a href="#" class="dropdown-item" data-attach-type="file">
                            <i class="fas fa-file"></i>
                            File
                        </a>
                    </div>
                </div>
                
                <textarea class="message-input" id="messageInput" placeholder="iMessage" rows="1"></textarea>
                
                <button class="send-btn" id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Zynes Screen -->
    <div id="zynesScreen" class="screen">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">Zynapse</div>
                <div class="user-info">
                    <div class="user-name">Zynes</div>
                    <div class="user-id-container">
                        <span class="user-id">Your Status</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-icon-btn" id="refreshZynesBtn" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="zynes-container">
                <div class="zyne-create">
                    <textarea class="zyne-textarea" id="zyneText" placeholder="What's on your mind?"></textarea>
                    <div class="zyne-media-preview" id="zyneMediaPreview"></div>
                    <div class="zyne-actions">
                        <div class="file-upload-container">
                            <button type="button" class="btn btn-secondary" id="addZyneMediaBtn">
                                <i class="fas fa-camera"></i>
                                Add Media
                            </button>
                            <input type="file" id="zyneMediaUpload" accept="image/*,video/*" multiple style="display: none;">
                        </div>
                        <button class="btn btn-primary" id="postZyneBtn">
                            <i class="fas fa-paper-plane"></i>
                            Post
                        </button>
                    </div>
                </div>
                
                <div class="zynes-list" id="zynesList">
                    <!-- Zynes will be dynamically added here -->
                </div>
                
                <div class="empty-state" id="noZynesMessage">
                    <i class="fas fa-bolt"></i>
                    <h3>No Zynes yet</h3>
                    <p>Share your first status update above</p>
                </div>
            </div>
        </div>
        
        <div class="nav-footer">
            <button class="nav-btn" data-screen="homeScreen">
                <i class="fas fa-home"></i>
                <span>HOME</span>
            </button>
            <button class="nav-btn active" data-screen="zynesScreen">
                <i class="fas fa-bolt"></i>
                <span>ZYNES</span>
            </button>
            <button class="nav-btn" data-screen="groupsScreen">
                <i class="fas fa-users"></i>
                <span>GROUPS</span>
            </button>
            <button class="nav-btn" data-screen="requestsScreen">
                <i class="fas fa-user-plus"></i>
                <span>REQUESTS</span>
            </button>
            <button class="nav-btn" data-screen="contactsScreen">
                <i class="fas fa-address-book"></i>
                <span>CONTACTS</span>
            </button>
        </div>
    </div>

    <!-- Groups Screen -->
    <div id="groupsScreen" class="screen">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">Zynapse</div>
                <div class="user-info">
                    <div class="user-name">Groups</div>
                    <div class="user-id-container">
                        <span class="user-id">Connect with multiple users</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-icon-btn" id="refreshGroupsBtn" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="groups-container">
                <div class="groups-list" id="groupsList">
                    <!-- Groups will be dynamically added here -->
                </div>
                
                <div class="empty-state" id="noGroupsMessage">
                    <i class="fas fa-users"></i>
                    <h3>No groups yet</h3>
                    <p>Create your first group to start chatting with multiple people</p>
                </div>
            </div>
        </div>
        
        <div class="create-group-btn" id="createGroupBtn" title="Create New Group">
            <i class="fas fa-plus"></i>
        </div>
        
        <div class="nav-footer">
            <button class="nav-btn" data-screen="homeScreen">
                <i class="fas fa-home"></i>
                <span>HOME</span>
            </button>
            <button class="nav-btn" data-screen="zynesScreen">
                <i class="fas fa-bolt"></i>
                <span>ZYNES</span>
            </button>
            <button class="nav-btn active" data-screen="groupsScreen">
                <i class="fas fa-users"></i>
                <span>GROUPS</span>
            </button>
            <button class="nav-btn" data-screen="requestsScreen">
                <i class="fas fa-user-plus"></i>
                <span>REQUESTS</span>
            </button>
            <button class="nav-btn" data-screen="contactsScreen">
                <i class="fas fa-address-book"></i>
                <span>CONTACTS</span>
            </button>
        </div>
    </div>

    <!-- Chat Requests Screen -->
    <div id="requestsScreen" class="screen">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">Zynapse</div>
                <div class="user-info">
                    <div class="user-name">Chat Requests</div>
                    <div class="user-id-container">
                        <span class="user-id">Pending invitations</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-icon-btn" id="refreshRequestsBtn" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="requests-container">
                <div class="requests-list" id="requestsList">
                    <!-- Requests will be dynamically added here -->
                </div>
                
                <div class="empty-state" id="noRequestsMessage">
                    <i class="fas fa-user-plus"></i>
                    <h3>No pending requests</h3>
                    <p>You'll see chat requests here when someone sends you one</p>
                </div>
            </div>
        </div>
        
        <div class="nav-footer">
            <button class="nav-btn" data-screen="homeScreen">
                <i class="fas fa-home"></i>
                <span>HOME</span>
            </button>
            <button class="nav-btn" data-screen="zynesScreen">
                <i class="fas fa-bolt"></i>
                <span>ZYNES</span>
            </button>
            <button class="nav-btn" data-screen="groupsScreen">
                <i class="fas fa-users"></i>
                <span>GROUPS</span>
            </button>
            <button class="nav-btn active" data-screen="requestsScreen">
                <i class="fas fa-user-plus"></i>
                <span>REQUESTS</span>
            </button>
            <button class="nav-btn" data-screen="contactsScreen">
                <i class="fas fa-address-book"></i>
                <span>CONTACTS</span>
            </button>
        </div>
    </div>

    <!-- Contacts Screen -->
    <div id="contactsScreen" class="screen">
        <div class="header">
            <div class="header-left">
                <div class="header-logo">Zynapse</div>
                <div class="user-info">
                    <div class="user-name">Contacts</div>
                    <div class="user-id-container">
                        <span class="user-id">Your connections</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-icon-btn" id="refreshContactsBtn" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="contacts-container">
                <div class="contacts-list" id="contactsList">
                    <!-- Contacts will be dynamically added here -->
                </div>
                
                <div class="empty-state" id="noContactsMessage">
                    <i class="fas fa-address-book"></i>
                    <h3>No contacts yet</h3>
                    <p>Accept chat requests to add users to your contacts</p>
                </div>
            </div>
        </div>
        
        <div class="nav-footer">
            <button class="nav-btn" data-screen="homeScreen">
                <i class="fas fa-home"></i>
                <span>HOME</span>
            </button>
            <button class="nav-btn" data-screen="zynesScreen">
                <i class="fas fa-bolt"></i>
                <span>ZYNES</span>
            </button>
            <button class="nav-btn" data-screen="groupsScreen">
                <i class="fas fa-users"></i>
                <span>GROUPS</span>
            </button>
            <button class="nav-btn" data-screen="requestsScreen">
                <i class="fas fa-user-plus"></i>
                <span>REQUESTS</span>
            </button>
            <button class="nav-btn active" data-screen="contactsScreen">
                <i class="fas fa-address-book"></i>
                <span>CONTACTS</span>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="startChatModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Start New Chat</h3>
                <button class="modal-close" id="closeStartChatModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Enter the User ID of the person you want to chat with:</p>
                <input type="text" class="modal-input" id="recipientUserIdInput" placeholder="ZYN-XXXX">
                <div class="user-preview" id="recipientPreview" style="display: none;">
                    <img class="user-preview-avatar" id="recipientAvatarPreview" src="https://via.placeholder.com/60" alt="User">
                    <div class="user-preview-info">
                        <div class="user-preview-name" id="recipientNamePreview">User Name</div>
                        <div class="user-preview-id" id="recipientIdPreview">ZYN-0000</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelStartChatBtn">Cancel</button>
                <button class="btn btn-primary" id="sendRequestBtn">Send Chat Request</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createGroupModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Group</h3>
                <button class="modal-close" id="closeCreateGroupModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="groupNameInput">Group Name</label>
                    <input type="text" class="modal-input" id="groupNameInput" placeholder="Enter group name">
                </div>
                <div class="form-group">
                    <label for="groupDescriptionInput">Group Description (Optional)</label>
                    <input type="text" class="modal-input" id="groupDescriptionInput" placeholder="Enter group description">
                </div>
                <div class="form-group">
                    <label>Add Members by User ID</label>
                    <div class="mb-1" style="display: flex; gap: 8px;">
                        <input type="text" class="modal-input" id="addMemberInput" placeholder="ZYN-XXXX" style="flex: 1;">
                        <button class="btn btn-secondary" id="addMemberBtn">Add</button>
                    </div>
                    <div id="groupMembersList" class="mt-2">
                        <!-- Members will be added here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCreateGroupBtn">Cancel</button>
                <button class="btn btn-primary" id="createGroupModalBtn">Create Group</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay profile-modal" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">User Profile</h3>
                <button class="modal-close" id="closeProfileModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <img class="profile-avatar-large" id="profileModalAvatar" src="https://via.placeholder.com/120" alt="Profile">
                <div class="profile-name" id="profileModalName">User Name</div>
                <div class="profile-id" id="profileModalUserId">ZYN-0000</div>
                <div class="profile-details">
                    <div class="profile-detail">
                        <span class="profile-detail-label">Status:</span>
                        <span class="profile-detail-value" id="profileModalStatus">Online</span>
                    </div>
                    <div class="profile-detail">
                        <span class="profile-detail-label">Last Seen:</span>
                        <span class="profile-detail-value" id="profileModalLastSeen">Just now</span>
                    </div>
                    <div class="profile-detail">
                        <span class="profile-detail-label">Member Since:</span>
                        <span class="profile-detail-value" id="profileModalMemberSince">2023</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100" id="closeProfileModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toastNotification"></div>

    <!-- Audio for notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
            authDomain: "zynapse-68181.firebaseapp.com",
            databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
            projectId: "zynapse-68181",
            storageBucket: "zynapse-68181.firebasestorage.app",
            messagingSenderId: "841353050519",
            appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
            measurementId: "G-4764XLL6WS"
        };

        // ===== CLOUDINARY CONFIGURATION =====
        const CLOUDINARY_CONFIG = {
            cloudName: 'dd3lcymrk',
            apiKey: '489857926297197',
            uploadPreset: 'h3eyhc2o',
            folder: 'zynapse',
            maxFileSize: 50 * 1024 * 1024 // 50MB in bytes
        };

        // ===== APPLICATION STATE =====
        let currentUser = null;
        let currentChat = null;
        let currentContact = null;
        let contacts = [];
        let chatRequests = [];
        let chats = [];
        let groups = [];
        let zynes = [];
        let allUsers = {};
        let firebaseInitialized = false;
        let cloudinaryInitialized = false;

        // ===== DOM ELEMENTS =====
        const screens = {
            signup: document.getElementById('signupScreen'),
            home: document.getElementById('homeScreen'),
            chat: document.getElementById('chatScreen'),
            zynes: document.getElementById('zynesScreen'),
            groups: document.getElementById('groupsScreen'),
            requests: document.getElementById('requestsScreen'),
            contacts: document.getElementById('contactsScreen')
        };

        const modals = {
            startChat: document.getElementById('startChatModal'),
            createGroup: document.getElementById('createGroupModal'),
            profile: document.getElementById('profileModal')
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase
                await initializeFirebase();
                
                // Check if user is already logged in
                const authToken = localStorage.getItem('zynapse_auth_token');
                const userData = localStorage.getItem('zynapse_user_data');
                
                if (authToken && userData) {
                    currentUser = JSON.parse(userData);
                    await loadUserData();
                    showScreen('home');
                    updateUI();
                    showToast('Welcome back to Zynapse!');
                } else {
                    showScreen('signup');
                }
                
                // Set up event listeners
                setupEventListeners();
                
                // Initialize drag and drop for floating button
                initDraggableButton();
                
                console.log('Zynapse application initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Error initializing application. Please refresh the page.');
            }
        });

        // ===== FIREBASE FUNCTIONS =====
        async function initializeFirebase() {
            try {
                // Check if Firebase is already loaded
                if (typeof firebase === 'undefined') {
                    await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js');
                    await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js');
                    await loadScript('https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js');
                }
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                firebaseInitialized = true;
                
                // Set up auth state listener
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        console.log('User authenticated:', user.uid);
                    } else {
                        console.log('User signed out');
                    }
                });
                
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                throw error;
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ===== AUTHENTICATION FUNCTIONS =====
        async function registerUser(userData) {
            try {
                showLoading(true);
                
                // Generate unique user ID
                const userId = generateUserId();
                
                // Create user in Firebase Auth
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(
                    userData.email,
                    userData.password
                );
                
                // Update user profile
                await userCredential.user.updateProfile({
                    displayName: userData.name
                });
                
                // Prepare user data for database
                const userRecord = {
                    userId: userId,
                    name: userData.name,
                    phone: userData.phone,
                    email: userData.email,
                    profilePic: userData.profilePic || 'https://via.placeholder.com/150',
                    createdAt: Date.now(),
                    lastSeen: Date.now(),
                    status: 'online',
                    contacts: [],
                    chatRequests: [],
                    blockedUsers: []
                };
                
                // Save user data to Firebase Database
                await firebase.database().ref('users/' + userId).set(userRecord);
                
                // Set current user
                currentUser = {
                    ...userRecord,
                    uid: userCredential.user.uid
                };
                
                // Save to localStorage
                localStorage.setItem('zynapse_auth_token', userCredential.user.uid);
                localStorage.setItem('zynapse_user_data', JSON.stringify(currentUser));
                
                showLoading(false);
                showToast('Registration successful! Welcome to Zynapse.');
                
                // Load user data and show home screen
                await loadUserData();
                showScreen('home');
                updateUI();
                
                return userRecord;
            } catch (error) {
                showLoading(false);
                console.error('Registration error:', error);
                
                let errorMessage = 'Registration failed. ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += 'Email already in use.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'Password is too weak.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage);
                throw error;
            }
        }

        async function loginUser(email, password) {
            try {
                showLoading(true);
                
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                
                // Get user data from database
                const userId = await findUserIdByEmail(email);
                if (!userId) {
                    throw new Error('User data not found');
                }
                
                const userSnapshot = await firebase.database().ref('users/' + userId).once('value');
                const userData = userSnapshot.val();
                
                if (!userData) {
                    throw new Error('User data not found');
                }
                
                // Set current user
                currentUser = {
                    ...userData,
                    uid: userCredential.user.uid
                };
                
                // Save to localStorage
                localStorage.setItem('zynapse_auth_token', userCredential.user.uid);
                localStorage.setItem('zynapse_user_data', JSON.stringify(currentUser));
                
                // Update last seen
                await firebase.database().ref('users/' + userId + '/lastSeen').set(Date.now());
                await firebase.database().ref('users/' + userId + '/status').set('online');
                
                showLoading(false);
                showToast('Login successful!');
                
                // Load user data and show home screen
                await loadUserData();
                showScreen('home');
                updateUI();
                
                return currentUser;
            } catch (error) {
                showLoading(false);
                console.error('Login error:', error);
                
                let errorMessage = 'Login failed. ';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage += 'Invalid email or password.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage);
                throw error;
            }
        }

        async function logoutUser() {
            try {
                // Update status to offline
                if (currentUser && currentUser.userId) {
                    await firebase.database().ref('users/' + currentUser.userId + '/status').set('offline');
                }
                
                // Sign out from Firebase
                await firebase.auth().signOut();
                
                // Clear localStorage
                localStorage.removeItem('zynapse_auth_token');
                localStorage.removeItem('zynapse_user_data');
                
                // Reset state
                currentUser = null;
                contacts = [];
                chatRequests = [];
                chats = [];
                groups = [];
                zynes = [];
                allUsers = {};
                
                // Show signup screen
                showScreen('signup');
                showToast('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error during logout');
            }
        }

        // ===== USER DATA FUNCTIONS =====
        async function loadUserData() {
            if (!currentUser || !currentUser.userId) return;
            
            try {
                showLoading(true);
                
                // Load contacts
                await loadContacts();
                
                // Load chat requests
                await loadChatRequests();
                
                // Load chats
                await loadChats();
                
                // Load groups
                await loadGroups();
                
                // Load zynes
                await loadZynes();
                
                // Load all users data (for quick lookups)
                await loadAllUsers();
                
                // Set up real-time listeners
                setupRealtimeListeners();
                
                showLoading(false);
            } catch (error) {
                showLoading(false);
                console.error('Error loading user data:', error);
                showToast('Error loading user data');
            }
        }

        async function loadContacts() {
            if (!currentUser) return;
            
            try {
                const contactsRef = firebase.database().ref('users/' + currentUser.userId + '/contacts');
                const snapshot = await contactsRef.once('value');
                
                contacts = [];
                const contactIds = snapshot.val() || [];
                
                for (const contactId of contactIds) {
                    const userSnapshot = await firebase.database().ref('users/' + contactId).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData) {
                        contacts.push({
                            userId: contactId,
                            ...userData
                        });
                    }
                }
                
                updateContactsUI();
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        async function loadChatRequests() {
            if (!currentUser) return;
            
            try {
                const requestsRef = firebase.database().ref('chatRequests');
                const snapshot = await requestsRef.once('value');
                
                chatRequests = [];
                const requestsData = snapshot.val() || {};
                
                for (const requestId in requestsData) {
                    const request = requestsData[requestId];
                    
                    if (request.to === currentUser.userId && request.status === 'pending') {
                        // Get sender info
                        const senderSnapshot = await firebase.database().ref('users/' + request.from).once('value');
                        const senderData = senderSnapshot.val();
                        
                        if (senderData) {
                            chatRequests.push({
                                id: requestId,
                                ...request,
                                sender: senderData
                            });
                        }
                    }
                }
                
                updateRequestsUI();
            } catch (error) {
                console.error('Error loading chat requests:', error);
            }
        }

        async function loadChats() {
            if (!currentUser) return;
            
            try {
                const chatsRef = firebase.database().ref('chats');
                const snapshot = await chatsRef.once('value');
                
                chats = [];
                const chatsData = snapshot.val() || {};
                
                for (const chatId in chatsData) {
                    const chat = chatsData[chatId];
                    
                    if (chat.participants && chat.participants.includes(currentUser.userId)) {
                        // Get the other participant
                        const otherParticipantId = chat.participants.find(id => id !== currentUser.userId);
                        
                        if (otherParticipantId) {
                            const userSnapshot = await firebase.database().ref('users/' + otherParticipantId).once('value');
                            const userData = userSnapshot.val();
                            
                            if (userData) {
                                // Get last message
                                const messages = chat.messages || {};
                                const lastMessageKey = Object.keys(messages).pop();
                                const lastMessage = lastMessageKey ? messages[lastMessageKey] : null;
                                
                                chats.push({
                                    id: chatId,
                                    participantId: otherParticipantId,
                                    participant: userData,
                                    lastMessage: lastMessage,
                                    unreadCount: chat.unreadCount || 0,
                                    updatedAt: chat.updatedAt || Date.now()
                                });
                            }
                        }
                    }
                }
                
                // Sort by updatedAt (most recent first)
                chats.sort((a, b) => b.updatedAt - a.updatedAt);
                
                updateChatsUI();
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        async function loadGroups() {
            if (!currentUser) return;
            
            try {
                const groupsRef = firebase.database().ref('groups');
                const snapshot = await groupsRef.once('value');
                
                groups = [];
                const groupsData = snapshot.val() || {};
                
                for (const groupId in groupsData) {
                    const group = groupsData[groupId];
                    
                    if (group.members && group.members.includes(currentUser.userId)) {
                        // Get last message
                        const messages = group.messages || {};
                        const lastMessageKey = Object.keys(messages).pop();
                        const lastMessage = lastMessageKey ? messages[lastMessageKey] : null;
                        
                        groups.push({
                            id: groupId,
                            ...group,
                            lastMessage: lastMessage
                        });
                    }
                }
                
                updateGroupsUI();
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        async function loadZynes() {
            if (!currentUser) return;
            
            try {
                const zynesRef = firebase.database().ref('zynes');
                const snapshot = await zynesRef.once('value');
                
                zynes = [];
                const zynesData = snapshot.val() || {};
                const currentTime = Date.now();
                
                for (const zyneId in zynesData) {
                    const zyne = zynesData[zyneId];
                    
                    // Check if zyne has expired (24 hours)
                    const zyneAge = currentTime - zyne.timestamp;
                    const hoursOld = zyneAge / (1000 * 60 * 60);
                    
                    if (hoursOld < 24) {
                        // Get user info
                        const userSnapshot = await firebase.database().ref('users/' + zyne.userId).once('value');
                        const userData = userSnapshot.val();
                        
                        if (userData && (zyne.userId === currentUser.userId || contacts.some(c => c.userId === zyne.userId))) {
                            zynes.push({
                                id: zyneId,
                                ...zyne,
                                user: userData
                            });
                        }
                    } else {
                        // Remove expired zyne
                        await firebase.database().ref('zynes/' + zyneId).remove();
                    }
                }
                
                // Sort by timestamp (most recent first)
                zynes.sort((a, b) => b.timestamp - a.timestamp);
                
                updateZynesUI();
            } catch (error) {
                console.error('Error loading zynes:', error);
            }
        }

        async function loadAllUsers() {
            try {
                const usersRef = firebase.database().ref('users');
                const snapshot = await usersRef.once('value');
                
                allUsers = snapshot.val() || {};
            } catch (error) {
                console.error('Error loading all users:', error);
            }
        }

        // ===== CHAT FUNCTIONS =====
        async function sendChatRequest(recipientId) {
            if (!currentUser || !recipientId) return;
            
            try {
                // Check if recipient exists
                const recipientSnapshot = await firebase.database().ref('users/' + recipientId).once('value');
                if (!recipientSnapshot.exists()) {
                    showToast('User not found');
                    return;
                }
                
                // Check if already in contacts
                if (currentUser.contacts && currentUser.contacts.includes(recipientId)) {
                    showToast('User is already in your contacts');
                    return;
                }
                
                // Check if request already exists
                const requestsRef = firebase.database().ref('chatRequests');
                const snapshot = await requestsRef.orderByChild('from').equalTo(currentUser.userId).once('value');
                
                let existingRequest = false;
                snapshot.forEach((childSnapshot) => {
                    const request = childSnapshot.val();
                    if (request.to === recipientId && request.status === 'pending') {
                        existingRequest = true;
                    }
                });
                
                if (existingRequest) {
                    showToast('Chat request already sent');
                    return;
                }
                
                // Create new request
                const newRequestRef = requestsRef.push();
                const requestData = {
                    id: newRequestRef.key,
                    from: currentUser.userId,
                    to: recipientId,
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                await newRequestRef.set(requestData);
                
                // Add to sender's sent requests
                await firebase.database().ref('users/' + currentUser.userId + '/sentRequests/' + newRequestRef.key).set(recipientId);
                
                showToast('Chat request sent successfully');
                closeModal('startChat');
                
                // Play notification sound
                playNotificationSound();
            } catch (error) {
                console.error('Error sending chat request:', error);
                showToast('Error sending chat request');
            }
        }

        async function acceptChatRequest(requestId) {
            if (!currentUser || !requestId) return;
            
            try {
                const requestRef = firebase.database().ref('chatRequests/' + requestId);
                const snapshot = await requestRef.once('value');
                const request = snapshot.val();
                
                if (!request) {
                    showToast('Request not found');
                    return;
                }
                
                // Update request status
                await requestRef.update({ status: 'accepted' });
                
                // Add to contacts for both users
                const senderId = request.from;
                
                // Add sender to current user's contacts
                const currentUserContactsRef = firebase.database().ref('users/' + currentUser.userId + '/contacts');
                const currentUserSnapshot = await currentUserContactsRef.once('value');
                const currentUserContacts = currentUserSnapshot.val() || [];
                
                if (!currentUserContacts.includes(senderId)) {
                    await currentUserContactsRef.set([...currentUserContacts, senderId]);
                }
                
                // Add current user to sender's contacts
                const senderContactsRef = firebase.database().ref('users/' + senderId + '/contacts');
                const senderSnapshot = await senderContactsRef.once('value');
                const senderContacts = senderSnapshot.val() || [];
                
                if (!senderContacts.includes(currentUser.userId)) {
                    await senderContactsRef.set([...senderContacts, currentUser.userId]);
                }
                
                // Create a chat between users
                await createChat(currentUser.userId, senderId);
                
                // Remove the request from the list
                chatRequests = chatRequests.filter(req => req.id !== requestId);
                updateRequestsUI();
                
                showToast('Chat request accepted');
                playNotificationSound();
                
                // Refresh contacts and chats
                await loadContacts();
                await loadChats();
            } catch (error) {
                console.error('Error accepting chat request:', error);
                showToast('Error accepting chat request');
            }
        }

        async function rejectChatRequest(requestId) {
            try {
                await firebase.database().ref('chatRequests/' + requestId).update({ status: 'rejected' });
                
                // Remove from local array
                chatRequests = chatRequests.filter(req => req.id !== requestId);
                updateRequestsUI();
                
                showToast('Chat request rejected');
            } catch (error) {
                console.error('Error rejecting chat request:', error);
                showToast('Error rejecting chat request');
            }
        }

        async function createChat(userId1, userId2) {
            try {
                // Check if chat already exists
                const chatsRef = firebase.database().ref('chats');
                const snapshot = await chatsRef.orderByChild('participants').equalTo([userId1, userId2].sort().join(',')).once('value');
                
                if (snapshot.exists()) {
                    return Object.keys(snapshot.val())[0];
                }
                
                // Create new chat
                const newChatRef = chatsRef.push();
                const chatData = {
                    id: newChatRef.key,
                    participants: [userId1, userId2].sort(),
                    messages: {},
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                
                await newChatRef.set(chatData);
                
                return newChatRef.key;
            } catch (error) {
                console.error('Error creating chat:', error);
                throw error;
            }
        }

        async function sendMessage(chatId, messageText, mediaUrl = null, mediaType = null) {
            if (!currentUser || !chatId || (!messageText && !mediaUrl)) return;
            
            try {
                const messageRef = firebase.database().ref(`chats/${chatId}/messages`).push();
                const messageData = {
                    id: messageRef.key,
                    from: currentUser.userId,
                    text: messageText || '',
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                    timestamp: Date.now(),
                    read: false
                };
                
                await messageRef.set(messageData);
                
                // Update chat's updatedAt
                await firebase.database().ref(`chats/${chatId}/updatedAt`).set(Date.now());
                
                // Play notification sound
                playNotificationSound();
                
                return messageData;
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Error sending message');
                throw error;
            }
        }

        async function createGroup(groupName, description, members) {
            if (!currentUser || !groupName) return;
            
            try {
                // Add current user to members if not already included
                if (!members.includes(currentUser.userId)) {
                    members.push(currentUser.userId);
                }
                
                // Create group
                const groupsRef = firebase.database().ref('groups');
                const newGroupRef = groupsRef.push();
                
                const groupData = {
                    id: newGroupRef.key,
                    name: groupName,
                    description: description || '',
                    admin: currentUser.userId,
                    members: members,
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    messages: {}
                };
                
                await newGroupRef.set(groupData);
                
                showToast('Group created successfully');
                closeModal('createGroup');
                
                // Refresh groups list
                await loadGroups();
                
                return newGroupRef.key;
            } catch (error) {
                console.error('Error creating group:', error);
                showToast('Error creating group');
                throw error;
            }
        }

        async function postZyne(content, mediaUrls = []) {
            if (!currentUser || (!content && mediaUrls.length === 0)) return;
            
            try {
                const zynesRef = firebase.database().ref('zynes');
                const newZyneRef = zynesRef.push();
                
                const zyneData = {
                    id: newZyneRef.key,
                    userId: currentUser.userId,
                    content: content || '',
                    mediaUrls: mediaUrls,
                    likes: [],
                    comments: {},
                    timestamp: Date.now(),
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 hours from now
                };
                
                await newZyneRef.set(zyneData);
                
                showToast('Zyne posted successfully');
                
                // Clear form
                document.getElementById('zyneText').value = '';
                document.getElementById('zyneMediaPreview').innerHTML = '';
                
                // Refresh zynes list
                await loadZynes();
                
                return newZyneRef.key;
            } catch (error) {
                console.error('Error posting zyne:', error);
                showToast('Error posting zyne');
                throw error;
            }
        }

        // ===== UI FUNCTIONS =====
        function showScreen(screenName) {
            // Hide all screens
            Object.values(screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show requested screen
            if (screens[screenName]) {
                screens[screenName].classList.add('active');
            }
            
            // Update nav buttons
            updateNavButtons(screenName);
        }

        function updateNavButtons(activeScreen) {
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(button => {
                const screen = button.getAttribute('data-screen');
                if (screen === activeScreen) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function showModal(modalName) {
            if (modals[modalName]) {
                modals[modalName].classList.add('active');
            }
        }

        function closeModal(modalName) {
            if (modals[modalName]) {
                modals[modalName].classList.remove('active');
            }
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toastNotification');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        function showLoading(show) {
            // Implement loading indicator if needed
            if (show) {
                // Show loading overlay
            } else {
                // Hide loading overlay
            }
        }

        function updateUI() {
            if (!currentUser) return;
            
            // Update header
            document.getElementById('headerUserName').textContent = currentUser.name;
            document.getElementById('headerUserID').textContent = currentUser.userId;
            
            // Update welcome message
            document.getElementById('welcomeUser').textContent = `Welcome, ${currentUser.name.split(' ')[0]}!`;
            
            // Update profile preview if exists
            const profilePreview = document.getElementById('profilePreview');
            if (currentUser.profilePic && currentUser.profilePic !== 'https://via.placeholder.com/150') {
                profilePreview.src = currentUser.profilePic;
                profilePreview.classList.add('active');
            }
        }

        function updateChatsUI() {
            const chatsList = document.getElementById('chatsList');
            const noChatsMessage = document.getElementById('noChatsMessage');
            
            if (chats.length === 0) {
                chatsList.innerHTML = '';
                noChatsMessage.style.display = 'block';
                return;
            }
            
            noChatsMessage.style.display = 'none';
            chatsList.innerHTML = '';
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.chatId = chat.id;
                chatItem.dataset.userId = chat.participantId;
                
                const lastMessage = chat.lastMessage ? 
                    (chat.lastMessage.mediaUrl ? 'Media' : chat.lastMessage.text) : 
                    'No messages yet';
                
                const timeAgo = chat.lastMessage ? 
                    formatTimeAgo(chat.lastMessage.timestamp) : 
                    '';
                
                chatItem.innerHTML = `
                    <img class="chat-avatar" src="${chat.participant.profilePic || 'https://via.placeholder.com/50'}" alt="${chat.participant.name}">
                    <div class="chat-info">
                        <div class="chat-name">${chat.participant.name}</div>
                        <div class="chat-last-message">${lastMessage}</div>
                    </div>
                    <div class="chat-time">${timeAgo}</div>
                `;
                
                chatItem.addEventListener('click', () => openChat(chat.id, chat.participantId));
                chatsList.appendChild(chatItem);
            });
        }

        function updateContactsUI() {
            const contactsList = document.getElementById('contactsList');
            const noContactsMessage = document.getElementById('noContactsMessage');
            
            if (contacts.length === 0) {
                contactsList.innerHTML = '';
                noContactsMessage.style.display = 'block';
                return;
            }
            
            noContactsMessage.style.display = 'none';
            contactsList.innerHTML = '';
            
            contacts.forEach(contact => {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                
                const statusClass = contact.status === 'online' ? 'online' : '';
                
                contactItem.innerHTML = `
                    <img class="contact-avatar" src="${contact.profilePic || 'https://via.placeholder.com/60'}" alt="${contact.name}">
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-status ${statusClass}">
                            <i class="fas fa-circle"></i>
                            ${contact.status === 'online' ? 'Online' : formatTimeAgo(contact.lastSeen)}
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="contact-action-btn chat" title="Start Chat" data-user-id="${contact.userId}">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="contact-action-btn remove" title="Remove Contact" data-user-id="${contact.userId}">
                            <i class="fas fa-user-times"></i>
                        </button>
                    </div>
                `;
                
                contactsList.appendChild(contactItem);
            });
            
            // Add event listeners for contact actions
            document.querySelectorAll('.contact-action-btn.chat').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const userId = btn.getAttribute('data-user-id');
                    openChatWithUser(userId);
                });
            });
            
            document.querySelectorAll('.contact-action-btn.remove').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const userId = btn.getAttribute('data-user-id');
                    if (confirm('Are you sure you want to remove this contact?')) {
                        await removeContact(userId);
                    }
                });
            });
        }

        function updateRequestsUI() {
            const requestsList = document.getElementById('requestsList');
            const noRequestsMessage = document.getElementById('noRequestsMessage');
            
            if (chatRequests.length === 0) {
                requestsList.innerHTML = '';
                noRequestsMessage.style.display = 'block';
                return;
            }
            
            noRequestsMessage.style.display = 'none';
            requestsList.innerHTML = '';
            
            chatRequests.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = 'request-item';
                
                requestItem.innerHTML = `
                    <div class="request-header">
                        <img class="request-avatar" src="${request.sender.profilePic || 'https://via.placeholder.com/60'}" alt="${request.sender.name}">
                        <div class="request-info">
                            <div class="request-name">${request.sender.name}</div>
                            <div class="request-id">${request.sender.userId}</div>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button class="btn btn-success w-100" data-request-id="${request.id}" id="acceptRequestBtn">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button class="btn btn-danger w-100" data-request-id="${request.id}" id="rejectRequestBtn">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                `;
                
                requestsList.appendChild(requestItem);
            });
            
            // Add event listeners for accept/reject buttons
            document.querySelectorAll('#acceptRequestBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const requestId = btn.getAttribute('data-request-id');
                    await acceptChatRequest(requestId);
                });
            });
            
            document.querySelectorAll('#rejectRequestBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const requestId = btn.getAttribute('data-request-id');
                    await rejectChatRequest(requestId);
                });
            });
        }

        function updateGroupsUI() {
            const groupsList = document.getElementById('groupsList');
            const noGroupsMessage = document.getElementById('noGroupsMessage');
            
            if (groups.length === 0) {
                groupsList.innerHTML = '';
                noGroupsMessage.style.display = 'block';
                return;
            }
            
            noGroupsMessage.style.display = 'none';
            groupsList.innerHTML = '';
            
            groups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.dataset.groupId = group.id;
                
                const lastMessage = group.lastMessage ? 
                    (group.lastMessage.mediaUrl ? 'Media' : group.lastMessage.text) : 
                    'No messages yet';
                
                groupItem.innerHTML = `
                    <img class="group-avatar" src="https://via.placeholder.com/60" alt="${group.name}">
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-members">${group.members ? group.members.length : 0} members</div>
                        <div class="group-last-message">${lastMessage}</div>
                    </div>
                `;
                
                groupItem.addEventListener('click', () => openGroupChat(group.id));
                groupsList.appendChild(groupItem);
            });
        }

        function updateZynesUI() {
            const zynesList = document.getElementById('zynesList');
            const noZynesMessage = document.getElementById('noZynesMessage');
            
            if (zynes.length === 0) {
                zynesList.innerHTML = '';
                noZynesMessage.style.display = 'block';
                return;
            }
            
            noZynesMessage.style.display = 'none';
            zynesList.innerHTML = '';
            
            zynes.forEach(zyne => {
                const zyneItem = document.createElement('div');
                zyneItem.className = 'zyne-item';
                zyneItem.dataset.zyneId = zyne.id;
                
                const mediaContent = zyne.mediaUrls && zyne.mediaUrls.length > 0 ?
                    zyne.mediaUrls.map(url => {
                        if (url.includes('.mp4') || url.includes('.mov') || url.includes('.avi')) {
                            return `<video class="zyne-media" controls><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video>`;
                        } else {
                            return `<img class="zyne-media" src="${url}" alt="Zyne media">`;
                        }
                    }).join('') : '';
                
                const isOwnZyne = zyne.userId === currentUser.userId;
                const likeCount = zyne.likes ? zyne.likes.length : 0;
                const commentCount = zyne.comments ? Object.keys(zyne.comments).length : 0;
                const isLiked = zyne.likes && zyne.likes.includes(currentUser.userId);
                
                zyneItem.innerHTML = `
                    <div class="zyne-header">
                        <img class="zyne-avatar" src="${zyne.user.profilePic || 'https://via.placeholder.com/50'}" alt="${zyne.user.name}">
                        <div class="zyne-user-info">
                            <div class="zyne-user-name">${zyne.user.name}</div>
                            <div class="zyne-timestamp">${formatTimeAgo(zyne.timestamp)}</div>
                        </div>
                        ${isOwnZyne ? `<div class="zyne-delete" title="Delete Zyne"><i class="fas fa-trash"></i></div>` : ''}
                    </div>
                    <div class="zyne-content">
                        ${zyne.content ? `<div class="zyne-text">${zyne.content}</div>` : ''}
                        ${mediaContent}
                    </div>
                    <div class="zyne-stats">
                        <span>${likeCount} like${likeCount !== 1 ? 's' : ''}</span>
                        <span>${commentCount} comment${commentCount !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="zyne-actions-bar">
                        <button class="zyne-action-btn like ${isLiked ? 'liked' : ''}" data-zyne-id="${zyne.id}">
                            <i class="fas fa-thumbs-up"></i> Like
                        </button>
                        <button class="zyne-action-btn" data-zyne-id="${zyne.id}">
                            <i class="fas fa-comment"></i> Comment
                        </button>
                        <button class="zyne-action-btn" data-zyne-id="${zyne.id}">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                `;
                
                zynesList.appendChild(zyneItem);
            });
            
            // Add event listeners for zyne actions
            document.querySelectorAll('.zyne-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const zyneId = btn.closest('.zyne-item').dataset.zyneId;
                    if (confirm('Are you sure you want to delete this zyne?')) {
                        await deleteZyne(zyneId);
                    }
                });
            });
            
            document.querySelectorAll('.zyne-action-btn.like').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const zyneId = btn.getAttribute('data-zyne-id');
                    await toggleLikeZyne(zyneId);
                });
            });
        }

        async function openChat(chatId, participantId) {
            try {
                // Get chat data
                const chatRef = firebase.database().ref(`chats/${chatId}`);
                const snapshot = await chatRef.once('value');
                const chatData = snapshot.val();
                
                if (!chatData) {
                    showToast('Chat not found');
                    return;
                }
                
                // Get participant data
                const participantSnapshot = await firebase.database().ref(`users/${participantId}`).once('value');
                const participantData = participantSnapshot.val();
                
                if (!participantData) {
                    showToast('User not found');
                    return;
                }
                
                // Set current chat
                currentChat = {
                    id: chatId,
                    ...chatData
                };
                
                currentContact = {
                    userId: participantId,
                    ...participantData
                };
                
                // Update chat UI
                document.getElementById('chatContactName').textContent = participantData.name;
                document.getElementById('chatContactAvatar').src = participantData.profilePic || 'https://via.placeholder.com/40';
                
                // Load messages
                await loadChatMessages(chatId);
                
                // Show chat screen
                showScreen('chat');
                
                // Mark messages as read
                await markMessagesAsRead(chatId);
            } catch (error) {
                console.error('Error opening chat:', error);
                showToast('Error opening chat');
            }
        }

        async function openChatWithUser(userId) {
            try {
                // Check if chat already exists
                let chatId = null;
                
                for (const chat of chats) {
                    if (chat.participantId === userId) {
                        chatId = chat.id;
                        break;
                    }
                }
                
                if (!chatId) {
                    // Create new chat
                    chatId = await createChat(currentUser.userId, userId);
                }
                
                // Open the chat
                await openChat(chatId, userId);
            } catch (error) {
                console.error('Error opening chat with user:', error);
                showToast('Error opening chat');
            }
        }

        async function openGroupChat(groupId) {
            // Implement group chat functionality
            showToast('Group chat functionality coming soon');
        }

        async function loadChatMessages(chatId) {
            try {
                const messagesRef = firebase.database().ref(`chats/${chatId}/messages`);
                const snapshot = await messagesRef.once('value');
                const messagesData = snapshot.val() || {};
                
                // Convert to array and sort by timestamp
                const messages = Object.values(messagesData).sort((a, b) => a.timestamp - b.timestamp);
                
                // Display messages
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                
                messages.forEach(message => {
                    const messageElement = createMessageElement(message);
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Set up real-time listener for new messages
                messagesRef.on('child_added', (snapshot) => {
                    const newMessage = snapshot.val();
                    if (!document.querySelector(`[data-message-id="${newMessage.id}"]`)) {
                        const messageElement = createMessageElement(newMessage);
                        messagesContainer.appendChild(messageElement);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        // Play notification sound if message is from other user
                        if (newMessage.from !== currentUser.userId) {
                            playNotificationSound();
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chat messages:', error);
            }
        }

        function createMessageElement(message) {
            const isSent = message.from === currentUser.userId;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = message.id;
            
            let mediaContent = '';
            if (message.mediaUrl) {
                if (message.mediaType === 'image') {
                    mediaContent = `<img class="message-media" src="${message.mediaUrl}" alt="Attached image">`;
                } else if (message.mediaType === 'video') {
                    mediaContent = `<video class="message-media" controls><source src="${message.mediaUrl}" type="video/mp4">Your browser does not support the video tag.</video>`;
                } else {
                    mediaContent = `<div class="message-media"><a href="${message.mediaUrl}" target="_blank">Download file</a></div>`;
                }
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${message.text ? `<div>${message.text}</div>` : ''}
                    ${mediaContent}
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                </div>
            `;
            
            return messageDiv;
        }

        async function markMessagesAsRead(chatId) {
            try {
                const messagesRef = firebase.database().ref(`chats/${chatId}/messages`);
                const snapshot = await messagesRef.once('value');
                
                const updates = {};
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    if (message.from !== currentUser.userId && !message.read) {
                        updates[`${childSnapshot.key}/read`] = true;
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    await messagesRef.update(updates);
                }
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function generateUserId() {
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            return `ZYN-${randomNum}`;
        }

        async function findUserIdByEmail(email) {
            try {
                const usersRef = firebase.database().ref('users');
                const snapshot = await usersRef.orderByChild('email').equalTo(email).once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    return Object.keys(userData)[0];
                }
                
                return null;
            } catch (error) {
                console.error('Error finding user by email:', error);
                return null;
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) { // Less than 1 minute
                return 'Just now';
            } else if (diff < 3600000) { // Less than 1 hour
                const minutes = Math.floor(diff / 60000);
                return `${minutes}m ago`;
            } else if (diff < 86400000) { // Less than 1 day
                const hours = Math.floor(diff / 3600000);
                return `${hours}h ago`;
            } else if (diff < 604800000) { // Less than 1 week
                const days = Math.floor(diff / 86400000);
                return `${days}d ago`;
            } else {
                const date = new Date(timestamp);
                return date.toLocaleDateString();
            }
        }

        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Audio play failed:', e));
        }

        async function uploadToCloudinary(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                formData.append('folder', CLOUDINARY_CONFIG.folder);
                
                // Check file size
                if (file.size > CLOUDINARY_CONFIG.maxFileSize) {
                    reject(new Error('File size exceeds 50MB limit'));
                    return;
                }
                
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/upload`);
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response.secure_url);
                    } else {
                        reject(new Error('Upload failed'));
                    }
                };
                
                xhr.onerror = function() {
                    reject(new Error('Upload failed'));
                };
                
                xhr.send(formData);
            });
        }

        function initDraggableButton() {
            const fab = document.getElementById('startChatBtn');
            let isDragging = false;
            let offsetX, offsetY;
            
            fab.addEventListener('mousedown', startDrag);
            fab.addEventListener('touchstart', startDragTouch);
            
            function startDrag(e) {
                isDragging = true;
                offsetX = e.clientX - fab.offsetLeft;
                offsetY = e.clientY - fab.offsetTop;
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                e.preventDefault();
            }
            
            function startDragTouch(e) {
                isDragging = true;
                const touch = e.touches[0];
                offsetX = touch.clientX - fab.offsetLeft;
                offsetY = touch.clientY - fab.offsetTop;
                
                document.addEventListener('touchmove', dragTouch);
                document.addEventListener('touchend', stopDrag);
                e.preventDefault();
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                const x = e.clientX - offsetX;
                const y = e.clientY - offsetY;
                
                // Constrain to viewport
                const maxX = window.innerWidth - fab.offsetWidth;
                const maxY = window.innerHeight - fab.offsetHeight;
                
                fab.style.left = Math.min(Math.max(0, x), maxX) + 'px';
                fab.style.bottom = 'auto';
                fab.style.top = Math.min(Math.max(0, y), maxY) + 'px';
            }
            
            function dragTouch(e) {
                if (!isDragging) return;
                
                const touch = e.touches[0];
                const x = touch.clientX - offsetX;
                const y = touch.clientY - offsetY;
                
                // Constrain to viewport
                const maxX = window.innerWidth - fab.offsetWidth;
                const maxY = window.innerHeight - fab.offsetHeight;
                
                fab.style.left = Math.min(Math.max(0, x), maxX) + 'px';
                fab.style.bottom = 'auto';
                fab.style.top = Math.min(Math.max(0, y), maxY) + 'px';
            }
            
            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', dragTouch);
                document.removeEventListener('touchend', stopDrag);
            }
        }

        // ===== EVENT LISTENERS SETUP =====
        function setupEventListeners() {
            // Signup form
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('fullName').value.trim();
                const phone = document.getElementById('phoneNumber').value.trim();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const profilePic = document.getElementById('profilePreview').src;
                
                if (!name || !phone || !email || !password) {
                    showToast('Please fill in all required fields');
                    return;
                }
                
                try {
                    await registerUser({
                        name,
                        phone,
                        email,
                        password,
                        profilePic: profilePic.includes('placeholder.com') ? null : profilePic
                    });
                } catch (error) {
                    console.error('Registration failed:', error);
                }
            });
            
            // Login link
            document.getElementById('loginLink').addEventListener('click', (e) => {
                e.preventDefault();
                // For now, just show a message. In a real app, you would show a login form
                showToast('Login functionality coming soon. For now, please register.');
            });
            
            // Profile picture upload
            document.getElementById('uploadProfileBtn').addEventListener('click', () => {
                document.getElementById('profilePicture').click();
            });
            
            document.getElementById('profilePicture').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showToast('Please select an image file');
                    return;
                }
                
                try {
                    // In a real app, upload to Cloudinary here
                    // For now, create a local URL
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('profilePreview').src = event.target.result;
                        document.getElementById('profilePreview').classList.add('active');
                    };
                    reader.readAsDataURL(file);
                    
                    showToast('Profile picture selected');
                } catch (error) {
                    console.error('Error uploading profile picture:', error);
                    showToast('Error uploading profile picture');
                }
            });
            
            // Copy user ID button
            document.getElementById('copyUserIdBtn').addEventListener('click', () => {
                const userId = document.getElementById('headerUserID').textContent;
                navigator.clipboard.writeText(userId).then(() => {
                    showToast('User ID copied to clipboard');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('Failed to copy User ID');
                });
            });
            
            // Start chat button
            document.getElementById('startChatBtn').addEventListener('click', () => {
                showModal('startChat');
            });
            
            // Close start chat modal
            document.getElementById('closeStartChatModal').addEventListener('click', () => {
                closeModal('startChat');
            });
            
            document.getElementById('cancelStartChatBtn').addEventListener('click', () => {
                closeModal('startChat');
            });
            
            // Send chat request
            document.getElementById('sendRequestBtn').addEventListener('click', async () => {
                const recipientId = document.getElementById('recipientUserIdInput').value.trim().toUpperCase();
                
                if (!recipientId || !recipientId.startsWith('ZYN-') || recipientId.length !== 8) {
                    showToast('Please enter a valid User ID (format: ZYN-XXXX)');
                    return;
                }
                
                if (recipientId === currentUser.userId) {
                    showToast('You cannot send a chat request to yourself');
                    return;
                }
                
                await sendChatRequest(recipientId);
            });
            
            // Check recipient ID as user types
            document.getElementById('recipientUserIdInput').addEventListener('input', async (e) => {
                const recipientId = e.target.value.trim().toUpperCase();
                const preview = document.getElementById('recipientPreview');
                
                if (recipientId.length === 8 && recipientId.startsWith('ZYN-')) {
                    // Look up user
                    const userSnapshot = await firebase.database().ref('users/' + recipientId).once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData) {
                        document.getElementById('recipientNamePreview').textContent = userData.name;
                        document.getElementById('recipientIdPreview').textContent = recipientId;
                        document.getElementById('recipientAvatarPreview').src = userData.profilePic || 'https://via.placeholder.com/60';
                        preview.style.display = 'flex';
                    } else {
                        preview.style.display = 'none';
                    }
                } else {
                    preview.style.display = 'none';
                }
            });
            
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const screen = button.getAttribute('data-screen');
                    showScreen(screen);
                });
            });
            
            // Chat back button
            document.getElementById('chatBackBtn').addEventListener('click', () => {
                showScreen('home');
            });
            
            // Send message
            document.getElementById('sendMessageBtn').addEventListener('click', async () => {
                const messageInput = document.getElementById('messageInput');
                const messageText = messageInput.value.trim();
                
                if (!messageText && !currentChat) return;
                
                try {
                    await sendMessage(currentChat.id, messageText);
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            });
            
            // Message input enter key
            document.getElementById('messageInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('sendMessageBtn').click();
                }
            });
            
            // Auto-resize textarea
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Menu dropdowns
            document.getElementById('menuBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('mainMenuDropdown').classList.toggle('active');
            });
            
            document.getElementById('chatMenuBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('chatDropdown').classList.toggle('active');
            });
            
            document.getElementById('attachBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('attachDropdown').classList.toggle('active');
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('active');
                });
            });
            
            // Profile menu button
            document.getElementById('profileMenuBtn').addEventListener('click', (e) => {
                e.preventDefault();
                showUserProfile(currentUser);
            });
            
            // Logout menu button
            document.getElementById('logoutMenuBtn').addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to log out?')) {
                    logoutUser();
                }
            });
            
            // Create group button
            document.getElementById('createGroupBtn').addEventListener('click', () => {
                showModal('createGroup');
            });
            
            // Close create group modal
            document.getElementById('closeCreateGroupModal').addEventListener('click', () => {
                closeModal('createGroup');
            });
            
            document.getElementById('cancelCreateGroupBtn').addEventListener('click', () => {
                closeModal('createGroup');
            });
            
            // Add member to group
            document.getElementById('addMemberBtn').addEventListener('click', () => {
                const memberId = document.getElementById('addMemberInput').value.trim().toUpperCase();
                
                if (!memberId || !memberId.startsWith('ZYN-') || memberId.length !== 8) {
                    showToast('Please enter a valid User ID');
                    return;
                }
                
                // Check if user exists
                if (!allUsers[memberId]) {
                    showToast('User not found');
                    return;
                }
                
                // Add to members list
                const membersList = document.getElementById('groupMembersList');
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `
                    <span>${allUsers[memberId].name} (${memberId})</span>
                    <button class="remove-member" data-user-id="${memberId}"></button>
                `;
                
                membersList.appendChild(memberItem);
                document.getElementById('addMemberInput').value = '';
                
                // Add remove event listener
                memberItem.querySelector('.remove-member').addEventListener('click', function() {
                    this.parentElement.remove();
                });
            });
            
            // Create group modal button
            document.getElementById('createGroupModalBtn').addEventListener('click', async () => {
                const groupName = document.getElementById('groupNameInput').value.trim();
                const description = document.getElementById('groupDescriptionInput').value.trim();
                
                if (!groupName) {
                    showToast('Please enter a group name');
                    return;
                }
                
                // Get member IDs from the list
                const memberItems = document.querySelectorAll('.member-item');
                const members = Array.from(memberItems).map(item => item.querySelector('button').getAttribute('data-user-id'));
                
                await createGroup(groupName, description, members);
            });
            
            // Post zyne button
            document.getElementById('postZyneBtn').addEventListener('click', async () => {
                const content = document.getElementById('zyneText').value.trim();
                const mediaPreviews = document.querySelectorAll('.media-preview-item');
                const mediaUrls = Array.from(mediaPreviews).map(preview => preview.dataset.url);
                
                if (!content && mediaUrls.length === 0) {
                    showToast('Please add content or media to your zyne');
                    return;
                }
                
                await postZyne(content, mediaUrls);
            });
            
            // Add zyne media button
            document.getElementById('addZyneMediaBtn').addEventListener('click', () => {
                document.getElementById('zyneMediaUpload').click();
            });
            
            document.getElementById('zyneMediaUpload').addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                const previewContainer = document.getElementById('zyneMediaPreview');
                
                for (const file of files) {
                    // Check file size
                    if (file.size > CLOUDINARY_CONFIG.maxFileSize) {
                        showToast(`File "${file.name}" exceeds 50MB limit`);
                        continue;
                    }
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'media-preview-item';
                        previewItem.style.backgroundImage = `url(${event.target.result})`;
                        previewItem.style.backgroundSize = 'cover';
                        previewItem.style.backgroundPosition = 'center';
                        previewItem.dataset.url = event.target.result; // In real app, this would be Cloudinary URL
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-media';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.addEventListener('click', () => {
                            previewItem.remove();
                        });
                        
                        previewItem.appendChild(removeBtn);
                        previewContainer.appendChild(previewItem);
                    };
                    
                    reader.readAsDataURL(file);
                }
                
                // Reset file input
                e.target.value = '';
            });
            
            // Refresh buttons
            document.getElementById('refreshZynesBtn').addEventListener('click', async () => {
                await loadZynes();
                showToast('Zynes refreshed');
            });
            
            document.getElementById('refreshGroupsBtn').addEventListener('click', async () => {
                await loadGroups();
                showToast('Groups refreshed');
            });
            
            document.getElementById('refreshRequestsBtn').addEventListener('click', async () => {
                await loadChatRequests();
                showToast('Requests refreshed');
            });
            
            document.getElementById('refreshContactsBtn').addEventListener('click', async () => {
                await loadContacts();
                showToast('Contacts refreshed');
            });
        }

        // ===== HELPER FUNCTIONS =====
        function showUserProfile(user) {
            document.getElementById('profileModalName').textContent = user.name;
            document.getElementById('profileModalUserId').textContent = user.userId;
            document.getElementById('profileModalAvatar').src = user.profilePic || 'https://via.placeholder.com/120';
            document.getElementById('profileModalStatus').textContent = user.status || 'Online';
            document.getElementById('profileModalLastSeen').textContent = formatTimeAgo(user.lastSeen || Date.now());
            document.getElementById('profileModalMemberSince').textContent = new Date(user.createdAt || Date.now()).getFullYear();
            
            showModal('profile');
        }

        async function removeContact(userId) {
            try {
                // Remove from current user's contacts
                const updatedContacts = currentUser.contacts.filter(id => id !== userId);
                await firebase.database().ref('users/' + currentUser.userId + '/contacts').set(updatedContacts);
                
                // Update local state
                currentUser.contacts = updatedContacts;
                contacts = contacts.filter(contact => contact.userId !== userId);
                
                // Update UI
                updateContactsUI();
                showToast('Contact removed');
            } catch (error) {
                console.error('Error removing contact:', error);
                showToast('Error removing contact');
            }
        }

        async function deleteZyne(zyneId) {
            try {
                await firebase.database().ref('zynes/' + zyneId).remove();
                
                // Update local state
                zynes = zynes.filter(zyne => zyne.id !== zyneId);
                
                // Update UI
                updateZynesUI();
                showToast('Zyne deleted');
            } catch (error) {
                console.error('Error deleting zyne:', error);
                showToast('Error deleting zyne');
            }
        }

        async function toggleLikeZyne(zyneId) {
            try {
                const zyneRef = firebase.database().ref('zynes/' + zyneId + '/likes');
                const snapshot = await zyneRef.once('value');
                let likes = snapshot.val() || [];
                
                if (likes.includes(currentUser.userId)) {
                    // Unlike
                    likes = likes.filter(id => id !== currentUser.userId);
                } else {
                    // Like
                    likes.push(currentUser.userId);
                }
                
                await zyneRef.set(likes);
                
                // Update local state
                const zyneIndex = zynes.findIndex(z => z.id === zyneId);
                if (zyneIndex !== -1) {
                    zynes[zyneIndex].likes = likes;
                }
                
                // Update UI
                updateZynesUI();
            } catch (error) {
                console.error('Error toggling like:', error);
                showToast('Error updating like');
            }
        }

        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            // Listen for new chat requests
            const requestsRef = firebase.database().ref('chatRequests');
            requestsRef.orderByChild('to').equalTo(currentUser.userId).on('child_added', async (snapshot) => {
                const request = snapshot.val();
                if (request.status === 'pending') {
                    // Get sender info
                    const senderSnapshot = await firebase.database().ref('users/' + request.from).once('value');
                    const senderData = senderSnapshot.val();
                    
                    if (senderData) {
                        // Check if already in array
                        if (!chatRequests.some(req => req.id === snapshot.key)) {
                            chatRequests.push({
                                id: snapshot.key,
                                ...request,
                                sender: senderData
                            });
                            updateRequestsUI();
                            playNotificationSound();
                            showToast(`New chat request from ${senderData.name}`);
                        }
                    }
                }
            });
            
            // Listen for chat request updates
            requestsRef.on('child_changed', (snapshot) => {
                const request = snapshot.val();
                if (request.status !== 'pending') {
                    // Remove from array
                    chatRequests = chatRequests.filter(req => req.id !== snapshot.key);
                    updateRequestsUI();
                }
            });
            
            // Listen for new messages in chats
            const chatsRef = firebase.database().ref('chats');
            chatsRef.orderByChild('participants').on('child_changed', async (snapshot) => {
                const chat = snapshot.val();
                
                // Check if this chat involves current user
                if (chat.participants && chat.participants.includes(currentUser.userId)) {
                    // Update chats list
                    await loadChats();
                }
            });
        }

        // Close profile modal
        document.getElementById('closeProfileModalBtn').addEventListener('click', () => {
            closeModal('profile');
        });
        
        document.getElementById('closeProfileModal').addEventListener('click', () => {
            closeModal('profile');
        });
    </script>
</body>
</html>
