<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zynapse - Messages</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles specific to home.html */
        .chat-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-circle);
            object-fit: cover;
            margin-right: 12px;
            flex-shrink: 0;
            border: 2px solid var(--white);
            box-shadow: var(--shadow-subtle);
        }

        .chat-item {
            position: relative;
            transition: all var(--transition-normal);
        }

        .chat-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 72px;
            right: 0;
            height: 1px;
            background: var(--gray-100);
        }

        .chat-item:last-child::after {
            display: none;
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .chat-time {
            font-size: 11px;
            color: var(--gray-500);
            white-space: nowrap;
        }

        .unread-badge {
            background: var(--blue);
            color: var(--white);
            font-size: 11px;
            font-weight: 700;
            width: 20px;
            height: 20px;
            border-radius: var(--radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: badgePulse 2s infinite;
        }

        .typing-indicator {
            font-size: 12px;
            color: var(--blue);
            font-style: italic;
        }

        /* Message bubbles */
        .message-bubble {
            position: relative;
            padding: 10px 14px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 15px;
            animation: messageSlide 0.3s ease;
        }

        .message.sent .message-bubble {
            background: var(--blue);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background: var(--gray-100);
            color: var(--black);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 4px;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .read-receipt {
            font-size: 10px;
            color: var(--blue);
            margin-left: 4px;
        }

        /* Media messages */
        .media-message {
            max-width: 240px;
        }

        .chat-media {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .media-info {
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 4px;
        }

        /* Voice message */
        .voice-message-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--gray-100);
            border-radius: 20px;
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--blue);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .voice-waveform {
            flex: 1;
            height: 20px;
            background: linear-gradient(90deg, var(--blue) 30%, rgba(0, 122, 255, 0.2) 70%);
            border-radius: 10px;
        }

        .voice-duration {
            font-size: 12px;
            color: var(--gray-600);
        }

        /* Location message */
        .location-message-container {
            padding: 12px;
            background: var(--gray-100);
            border-radius: 12px;
            max-width: 240px;
        }

        .location-map-preview {
            width: 100%;
            height: 120px;
            background: var(--gray-200);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            color: var(--gray-600);
        }

        .location-details {
            font-size: 12px;
            color: var(--gray-700);
        }

        /* Document message */
        .document-message-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--gray-100);
            border-radius: 12px;
            max-width: 240px;
        }

        .document-icon {
            width: 36px;
            height: 36px;
            background: var(--blue);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .document-info {
            flex: 1;
        }

        .document-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .document-size {
            font-size: 11px;
            color: var(--gray-600);
        }

        /* View once message */
        .view-once-message {
            cursor: pointer;
            position: relative;
        }

        .view-once-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            border-radius: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            gap: 8px;
        }

        /* Group chat */
        .group-avatar {
            position: relative;
        }

        .group-member-count {
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: var(--blue);
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--white);
        }

        /* Status indicators */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--white);
            position: absolute;
            bottom: 0;
            right: 0;
        }

        .status-online {
            background: var(--green);
        }

        .status-offline {
            background: var(--gray-400);
        }

        .status-away {
            background: var(--orange);
        }

        /* Typing animation */
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--gray-500);
            border-radius: 50%;
            animation: typing 1.4s infinite;
            display: inline-block;
            margin: 0 1px;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        /* Message slide animation */
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Badge pulse animation */
        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Attachment upload progress */
        .upload-progress {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: inherit;
        }

        .progress-circle {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Audio recording */
        .audio-recording {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--red-light);
            border-radius: 20px;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: recordingPulse 1s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Message reactions */
        .message-reaction {
            position: absolute;
            bottom: -8px;
            right: -8px;
            background: var(--white);
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .reaction-emoji {
            font-size: 14px;
        }

        .reaction-count {
            font-weight: 600;
        }

        /* Message menu */
        .message-menu {
            position: absolute;
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            min-width: 120px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .message-menu-item {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background var(--transition-fast);
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
        }

        .message-menu-item:last-child {
            border-bottom: none;
        }

        .message-menu-item:hover {
            background: var(--gray-50);
        }

        /* Date separator */
        .date-separator {
            text-align: center;
            margin: 16px 0;
            position: relative;
        }

        .date-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gray-200);
            z-index: 1;
        }

        .date-label {
            display: inline-block;
            background: var(--white);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            color: var(--gray-600);
            position: relative;
            z-index: 2;
            border: 1px solid var(--gray-200);
        }

        /* Message status */
        .message-status {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 2px;
            justify-content: flex-end;
        }

        .status-icon {
            font-size: 12px;
            color: var(--gray-500);
        }

        .status-icon.delivered {
            color: var(--blue);
        }

        .status-icon.read {
            color: var(--blue);
        }

        /* Forwarded message */
        .forwarded-label {
            font-size: 11px;
            color: var(--gray-600);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Reply preview */
        .reply-preview {
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--blue);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .reply-sender {
            font-weight: 600;
            color: var(--blue);
            margin-bottom: 2px;
        }

        .reply-text {
            color: var(--gray-700);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Message selection */
        .message.selected .message-bubble {
            background: rgba(0, 122, 255, 0.2);
            border: 2px solid var(--blue);
        }

        /* New message indicator */
        .new-messages-indicator {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--blue);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: var(--shadow-medium);
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Scroll to bottom button */
        .scroll-bottom-btn {
            position: absolute;
            bottom: 70px;
            right: 16px;
            background: var(--white);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
            cursor: pointer;
            z-index: 100;
            color: var(--blue);
            border: 1px solid var(--gray-200);
        }

        /* Voice message recording */
        .voice-recorder {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white);
            border-radius: 24px;
            padding: 16px;
            box-shadow: var(--shadow-heavy);
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            border: 1px solid var(--gray-200);
        }

        .voice-recorder.active {
            display: flex;
        }

        .recording-time {
            font-size: 14px;
            font-weight: 600;
            color: var(--red);
            min-width: 60px;
        }

        .recording-wave {
            width: 100px;
            height: 30px;
            background: linear-gradient(90deg, 
                var(--red) 0%, 
                var(--red) 30%, 
                rgba(255, 59, 48, 0.3) 30%, 
                rgba(255, 59, 48, 0.3) 100%);
            border-radius: 15px;
            animation: waveMove 2s linear infinite;
        }

        @keyframes waveMove {
            0% { background-position: 0 0; }
            100% { background-position: 100px 0; }
        }

        .cancel-recording {
            color: var(--red);
            cursor: pointer;
        }

        /* Emoji picker */
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 60px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-heavy);
            padding: 12px;
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            z-index: 1000;
            border: 1px solid var(--gray-200);
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-picker.active {
            display: grid;
        }

        .emoji-item {
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-sm);
            text-align: center;
            transition: background var(--transition-fast);
        }

        .emoji-item:hover {
            background: var(--gray-100);
        }

        /* Message context menu */
        .context-menu {
            position: fixed;
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            min-width: 150px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
            animation: fadeInUp 0.2s ease;
        }

        .context-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background var(--transition-fast);
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: var(--gray-50);
        }

        .context-menu-item.danger {
            color: var(--red);
        }

        /* Loading messages */
        .loading-messages {
            text-align: center;
            padding: 20px;
            color: var(--gray-500);
        }

        .loading-messages .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--blue);
            border-radius: 50%;
            margin: 0 auto 10px;
            animation: spin 1s linear infinite;
        }

        /* No messages */
        .no-messages {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-500);
        }

        .no-messages i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .no-messages h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-700);
        }

        /* Message search */
        .message-search {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-150);
            background: var(--white);
        }

        .search-input-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1.5px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: var(--gray-50);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--blue);
            background: var(--white);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-heavy);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            border: 1px solid var(--gray-200);
            margin-top: 4px;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
        }

        .search-result-item:hover {
            background: var(--gray-50);
        }

        .search-result-text {
            font-size: 14px;
            color: var(--gray-700);
        }

        .search-result-context {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        /* Message info modal */
        .message-info {
            font-size: 13px;
            color: var(--gray-600);
            margin-top: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .info-label {
            color: var(--gray-500);
        }

        .info-value {
            font-weight: 500;
        }

        /* Edit message */
        .edit-message-input {
            width: 100%;
            padding: 8px;
            border: 1.5px solid var(--blue);
            border-radius: var(--radius-md);
            font-size: 15px;
            margin-bottom: 8px;
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Pin message */
        .pinned-message {
            background: var(--blue-light);
            border-left: 3px solid var(--blue);
            padding: 12px;
            margin-bottom: 12px;
            border-radius: var(--radius-md);
        }

        .pinned-label {
            font-size: 11px;
            color: var(--blue);
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Starred messages */
        .starred-message {
            border-left: 3px solid var(--yellow);
        }

        .star-icon {
            color: var(--yellow);
        }

        /* Deleted message */
        .deleted-message {
            font-style: italic;
            color: var(--gray-500);
            background: var(--gray-100);
        }

        /* System message */
        .system-message {
            text-align: center;
            font-size: 13px;
            color: var(--gray-500);
            margin: 12px 0;
        }

        /* Temporary styles for development */
        .dev-notice {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--red);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 9999;
        }

        /* Print styles */
        @media print {
            .app-nav, .floating-btn, .message-input-area, .chat-actions {
                display: none !important;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .message-bubble {
                border: 2px solid currentColor;
            }
        }

        /* Dark mode override (disabled as per requirements) */
        @media (prefers-color-scheme: dark) {
            body {
                background: var(--white) !important;
                color: var(--black) !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <img src="zynaps.png" alt="Zynapse Logo" class="loading-logo">
            <div class="spinner-large"></div>
            <p>Loading Zynapse...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container hidden" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <img src="zynaps.png" alt="Zynapse Logo" class="header-logo">
                <div class="user-info">
                    <h2 id="userName">Loading...</h2>
                    <div class="user-id-container">
                        <span class="user-id" id="userId">ZYN-XXXX</span>
                        <button class="copy-btn" onclick="copyUserId()" title="Copy User ID">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <button class="profile-btn" id="profileBtn">
                <img src="" alt="Profile" class="profile-pic-small" id="profilePic">
                <i class="fas fa-chevron-down"></i>
            </button>

            <!-- Profile Dropdown -->
            <div class="dropdown-content" id="profileDropdown">
                <button class="dropdown-item" onclick="viewProfile()">
                    <i class="fas fa-user"></i> View Profile
                </button>
                <button class="dropdown-item" onclick="editProfile()">
                    <i class="fas fa-edit"></i> Edit Profile
                </button>
                <button class="dropdown-item" onclick="showSettings()">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="app-nav">
            <a href="#home" class="nav-item active" data-page="home" onclick="switchPage('home')">
                <i class="fas fa-home"></i>
                <span>HOME</span>
                <div class="badge hidden" id="homeBadge">0</div>
            </a>
            <a href="#zynes" class="nav-item" data-page="zynes" onclick="switchPage('zynes')">
                <i class="fas fa-fire"></i>
                <span>ZYNES</span>
                <div class="badge hidden" id="zyneBadge">0</div>
            </a>
            <a href="#groups" class="nav-item" data-page="groups" onclick="switchPage('groups')">
                <i class="fas fa-users"></i>
                <span>GROUPS</span>
                <div class="badge hidden" id="groupBadge">0</div>
            </a>
            <a href="#requests" class="nav-item" data-page="requests" onclick="switchPage('requests')">
                <i class="fas fa-user-plus"></i>
                <span>REQUESTS</span>
                <div class="badge hidden" id="requestBadge">0</div>
            </a>
            <a href="#contacts" class="nav-item" data-page="contacts" onclick="switchPage('contacts')">
                <i class="fas fa-address-book"></i>
                <span>CONTACTS</span>
                <div class="badge hidden" id="contactBadge">0</div>
            </a>
        </nav>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Home Page (Chats) -->
            <div class="page active" id="homePage">
                <div class="chats-header">
                    <h2>Chats</h2>
                </div>
                <div class="chats-list" id="chatsList">
                    <!-- Chats will be loaded here -->
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h3>No Chats Yet</h3>
                        <p>Start a conversation by tapping the chat button below</p>
                    </div>
                </div>
            </div>

            <!-- Zynes Page -->
            <div class="page" id="zynesPage">
                <div class="zynes-header">
                    <h2>Zynes</h2>
                </div>
                <div class="create-zyne">
                    <textarea class="create-input" id="zyneText" placeholder="What's on your mind?"></textarea>
                    <div class="media-preview" id="zyneMediaPreview"></div>
                    <div class="create-actions">
                        <div class="attachment-buttons">
                            <button class="icon-btn" onclick="addZynePhoto()">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="icon-btn" onclick="addZyneVideo()">
                                <i class="fas fa-video"></i>
                            </button>
                        </div>
                        <button class="btn-primary" onclick="postZyne()">
                            <i class="fas fa-plus"></i> Post
                        </button>
                    </div>
                </div>
                <div class="zynes-list" id="zynesList">
                    <!-- Zynes will be loaded here -->
                </div>
            </div>

            <!-- Groups Page -->
            <div class="page" id="groupsPage">
                <div class="groups-header">
                    <h2>Groups</h2>
                    <button class="create-group-btn" onclick="showCreateGroupModal()">
                        <i class="fas fa-plus"></i> New Group
                    </button>
                </div>
                <div class="groups-list" id="groupsList">
                    <!-- Groups will be loaded here -->
                </div>
            </div>

            <!-- Chat Requests Page -->
            <div class="page" id="requestsPage">
                <div class="requests-header">
                    <h2>Chat Requests</h2>
                </div>
                <div class="requests-list" id="requestsList">
                    <!-- Requests will be loaded here -->
                </div>
            </div>

            <!-- Contacts Page -->
            <div class="page" id="contactsPage">
                <div class="contacts-header">
                    <h2>Contacts</h2>
                </div>
                <div class="contacts-list" id="contactsList">
                    <!-- Contacts will be loaded here -->
                </div>
            </div>
        </main>

        <!-- Floating Chat Button -->
        <button class="floating-btn" id="floatingBtn" onclick="showStartChatModal()">
            <i class="fas fa-comment"></i>
            <span>Chat</span>
        </button>

        <!-- Active Chat Interface (Initially Hidden) -->
        <div class="chat-page hidden" id="chatPage">
            <div class="chat-header">
                <button class="back-btn" onclick="closeChat()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="chat-user-info">
                    <img src="" alt="User" class="chat-user-avatar" id="chatUserAvatar">
                    <div class="chat-user-details">
                        <h3 id="chatUserName">User Name</h3>
                        <div class="chat-status">
                            <div class="status-dot" id="chatUserStatus"></div>
                            <span id="chatUserStatusText">Online</span>
                        </div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="icon-btn" onclick="toggleChatInfo()">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="icon-btn" onclick="showChatMenu()">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
            </div>

            <div class="message-input-area">
                <button class="attach-btn" id="attachBtn" onclick="toggleAttachmentOptions()">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="message-input-container">
                    <textarea class="message-input" id="messageInput" placeholder="iMessage" rows="1"></textarea>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <!-- Attachment Options -->
            <div class="attachment-options" id="attachmentOptions">
                <button class="attachment-btn" onclick="attachPhoto()">
                    <i class="fas fa-image"></i>
                    <span>Photo</span>
                </button>
                <button class="attachment-btn" onclick="attachVideo()">
                    <i class="fas fa-video"></i>
                    <span>Video</span>
                </button>
                <button class="attachment-btn" onclick="attachDocument()">
                    <i class="fas fa-file"></i>
                    <span>Document</span>
                </button>
                <button class="attachment-btn" onclick="attachLocation()">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Location</span>
                </button>
                <button class="attachment-btn" onclick="startVoiceRecording()">
                    <i class="fas fa-microphone"></i>
                    <span>Voice</span>
                </button>
                <button class="attachment-btn" onclick="attachViewOnce()">
                    <i class="fas fa-eye"></i>
                    <span>View Once</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Start Chat Modal -->
    <div class="modal-overlay" id="startChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Chat</h3>
                <button class="close-modal" onclick="hideStartChatModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="search-input-group">
                    <input type="text" id="searchUserId" placeholder="Enter User ID (e.g., ZYN-1234)" autocomplete="off">
                </div>
                <div class="search-result" id="userSearchResult">
                    <!-- User found result will appear here -->
                </div>
                <div class="modal-actions">
                    <button class="action-btn btn-secondary" onclick="hideStartChatModal()">Cancel</button>
                    <button class="action-btn btn-primary" id="sendRequestBtn" onclick="sendChatRequest()" disabled>Send Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal-overlay" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Group</h3>
                <button class="close-modal" onclick="hideCreateGroupModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <input type="text" id="groupName" placeholder="Group Name" required>
                </div>
                <div class="profile-upload-section">
                    <label class="upload-label">Group Photo</label>
                    <div class="profile-upload-container">
                        <div class="upload-preview" id="groupPhotoPreview">
                            <div class="preview-placeholder">
                                <i class="fas fa-users"></i>
                                <span>No image</span>
                            </div>
                        </div>
                        <div class="upload-buttons">
                            <button class="btn-upload" onclick="document.getElementById('groupPhotoUpload').click()">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                        </div>
                    </div>
                    <input type="file" id="groupPhotoUpload" accept="image/*" style="display: none;">
                </div>
                <div class="member-search">
                    <input type="text" id="searchMembers" placeholder="Search contacts to add..." class="search-input">
                </div>
                <div class="members-list" id="groupMembersList">
                    <!-- Members will be listed here -->
                </div>
                <div class="modal-actions">
                    <button class="action-btn btn-secondary" onclick="hideCreateGroupModal()">Cancel</button>
                    <button class="action-btn btn-primary" onclick="createGroup()">Create Group</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Profile</h3>
                <button class="close-modal" onclick="hideProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="profile-view">
                    <div class="profile-header">
                        <img src="" alt="Profile" class="profile-large" id="profileLarge">
                        <h2 id="profileFullName">User Name</h2>
                        <p class="user-id" id="profileUserId">ZYN-XXXX</p>
                    </div>
                    <div class="profile-info">
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span class="info-value" id="profileStatus">Hey there! I am using Zynapse</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone:</span>
                            <span class="info-value" id="profilePhone">+1234567890</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value" id="profileEmail">user@example.com</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Joined:</span>
                            <span class="info-value" id="profileJoined">January 2024</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-modal" onclick="hideSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>Notifications</h4>
                    <div class="setting-item">
                        <span>Message Notifications</span>
                        <label class="switch">
                            <input type="checkbox" id="messageNotifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>Sound</span>
                        <label class="switch">
                            <input type="checkbox" id="notificationSound" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>Privacy</h4>
                    <div class="setting-item">
                        <span>Last Seen</span>
                        <select id="lastSeenPrivacy">
                            <option value="everyone">Everyone</option>
                            <option value="contacts">Contacts Only</option>
                            <option value="nobody">Nobody</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <span>Profile Photo</span>
                        <select id="profilePhotoPrivacy">
                            <option value="everyone">Everyone</option>
                            <option value="contacts">Contacts Only</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>Account</h4>
                    <button class="btn-secondary" onclick="changePassword()">Change Password</button>
                    <button class="btn-danger" onclick="deleteAccount()">Delete Account</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Notification Sound -->
    <audio id="notificationSound" src="notification.mp3" preload="auto"></audio>

    <script src="app.js"></script>
    <script>
        // Main Application JavaScript
        class ZynapseApp {
            constructor() {
                this.currentUser = null;
                this.currentChat = null;
                this.currentPage = 'home';
                this.contacts = [];
                this.chats = [];
                this.requests = [];
                this.zynes = [];
                this.groups = [];
                this.isTyping = false;
                this.typingTimeout = null;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.isRecording = false;
                this.recordingTimeout = null;
                
                // Firebase Configuration
                this.firebaseConfig = {
                    apiKey: "AIzaSyBrVtSAOckpj8_fRA3-0kI7vAzOpXDUqxs",
                    authDomain: "zynapse-68181.firebaseapp.com",
                    databaseURL: "https://zynapse-68181-default-rtdb.firebaseio.com",
                    projectId: "zynapse-68181",
                    storageBucket: "zynapse-68181.firebasestorage.app",
                    messagingSenderId: "841353050519",
                    appId: "1:841353050519:web:3b16d95d8f4cd3b9506cd2",
                    measurementId: "G-4764XLL6WS"
                };

                // Cloudinary Configuration
                this.cloudinaryConfig = {
                    cloudName: 'dd3lcymrk',
                    apiKey: '489857926297197',
                    uploadPreset: 'h3eyhc2o',
                    folder: 'zynapse'
                };

                this.init();
            }

            async init() {
                try {
                    // Check if user is logged in
                    const urlParams = new URLSearchParams(window.location.search);
                    const userId = urlParams.get('userId');
                    
                    if (!userId) {
                        window.location.href = 'index.html';
                        return;
                    }

                    // Load user data
                    await this.loadUserData(userId);
                    
                    // Initialize Firebase
                    await this.initializeFirebase();
                    
                    // Load all data
                    await this.loadAllData();
                    
                    // Set up real-time listeners
                    this.setupListeners();
                    
                    // Show app
                    this.showApp();
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to load app. Please try again.');
                }
            }

            async loadUserData(userId) {
                // In production, this would fetch from Firebase
                // For now, we'll use localStorage
                const userData = localStorage.getItem(`user_${userId}`);
                
                if (userData) {
                    this.currentUser = JSON.parse(userData);
                    this.updateUI();
                } else {
                    // Create dummy user for demo
                    this.currentUser = {
                        userId: userId,
                        name: 'John Doe',
                        email: 'john@example.com',
                        phone: '+1234567890',
                        profileImage: '',
                        status: 'Hey there! I am using Zynapse',
                        createdAt: new Date().toISOString(),
                        isOnline: true,
                        lastSeen: new Date().toISOString()
                    };
                    localStorage.setItem(`user_${userId}`, JSON.stringify(this.currentUser));
                }
            }

            async initializeFirebase() {
                // Initialize Firebase app
                if (!firebase.apps.length) {
                    firebase.initializeApp(this.firebaseConfig);
                }
                
                // Initialize Firebase services
                this.auth = firebase.auth();
                this.database = firebase.database();
                this.storage = firebase.storage();
                
                // Set up authentication state listener
                this.auth.onAuthStateChanged((user) => {
                    if (user) {
                        console.log('User authenticated:', user.uid);
                    } else {
                        console.log('No user signed in');
                    }
                });
            }

            async loadAllData() {
                // Load contacts
                await this.loadContacts();
                
                // Load chats
                await this.loadChats();
                
                // Load requests
                await this.loadRequests();
                
                // Load zynes
                await this.loadZynes();
                
                // Load groups
                await this.loadGroups();
                
                // Update badges
                this.updateBadges();
            }

            async loadContacts() {
                // Load contacts from localStorage (would be Firebase in production)
                const contacts = localStorage.getItem(`contacts_${this.currentUser.userId}`);
                this.contacts = contacts ? JSON.parse(contacts) : [];
                this.renderContacts();
            }

            async loadChats() {
                // Load chats from localStorage
                const chats = localStorage.getItem(`chats_${this.currentUser.userId}`);
                this.chats = chats ? JSON.parse(chats) : [];
                this.renderChats();
            }

            async loadRequests() {
                // Load requests from localStorage
                const requests = localStorage.getItem(`requests_${this.currentUser.userId}`);
                this.requests = requests ? JSON.parse(requests) : [];
                this.renderRequests();
            }

            async loadZynes() {
                // Load zynes from localStorage
                const zynes = localStorage.getItem(`zynes_${this.currentUser.userId}`);
                this.zynes = zynes ? JSON.parse(zynes) : [];
                this.renderZynes();
            }

            async loadGroups() {
                // Load groups from localStorage
                const groups = localStorage.getItem(`groups_${this.currentUser.userId}`);
                this.groups = groups ? JSON.parse(groups) : [];
                this.renderGroups();
            }

            setupListeners() {
                // Set up message input listener
                const messageInput = document.getElementById('messageInput');
                if (messageInput) {
                    messageInput.addEventListener('input', this.handleMessageInput.bind(this));
                    messageInput.addEventListener('keypress', this.handleMessageKeypress.bind(this));
                }

                // Set up profile button listener
                const profileBtn = document.getElementById('profileBtn');
                if (profileBtn) {
                    profileBtn.addEventListener('click', this.toggleProfileDropdown.bind(this));
                }

                // Set up attach button listener
                const attachBtn = document.getElementById('attachBtn');
                if (attachBtn) {
                    attachBtn.addEventListener('click', this.toggleAttachmentOptions.bind(this));
                }

                // Close dropdowns when clicking outside
                document.addEventListener('click', this.handleOutsideClick.bind(this));

                // Set up search listener
                const searchInput = document.getElementById('searchUserId');
                if (searchInput) {
                    searchInput.addEventListener('input', this.handleUserSearch.bind(this));
                }
            }

            updateUI() {
                // Update user info in header
                document.getElementById('userName').textContent = this.currentUser.name;
                document.getElementById('userId').textContent = this.currentUser.userId;
                
                // Update profile picture
                const profilePic = document.getElementById('profilePic');
                if (this.currentUser.profileImage) {
                    profilePic.src = this.currentUser.profileImage;
                } else {
                    profilePic.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="40" r="20" fill="%23ccc"/><circle cx="50" cy="100" r="30" fill="%23ccc"/></svg>';
                }
            }

            showApp() {
                // Hide loading screen
                document.getElementById('loadingScreen').classList.add('hidden');
                
                // Show app container
                document.getElementById('appContainer').classList.remove('hidden');
                
                // Play welcome sound
                this.playNotificationSound();
                
                // Show welcome toast
                this.showToast(`Welcome back, ${this.currentUser.name}!`, 'success');
            }

            // Page Navigation
            switchPage(page) {
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');

                // Hide all pages
                document.querySelectorAll('.page').forEach(pageEl => {
                    pageEl.classList.remove('active');
                });

                // Show selected page
                document.getElementById(`${page}Page`).classList.add('active');
                
                // Hide chat page if open
                if (page !== 'chat') {
                    document.getElementById('chatPage').classList.add('hidden');
                    document.getElementById('floatingBtn').classList.remove('hidden');
                }

                this.currentPage = page;
            }

            // Chat Functions
            async startChat(userId) {
                try {
                    // Find user in contacts
                    const contact = this.contacts.find(c => c.userId === userId);
                    
                    if (!contact) {
                        this.showError('User not found in contacts');
                        return;
                    }

                    this.currentChat = {
                        userId: contact.userId,
                        name: contact.name,
                        profileImage: contact.profileImage,
                        isGroup: false
                    };

                    // Open chat interface
                    this.openChat();
                    
                    // Load chat messages
                    await this.loadChatMessages();
                    
                } catch (error) {
                    console.error('Error starting chat:', error);
                    this.showError('Failed to start chat');
                }
            }

            openChat() {
                // Update chat header
                document.getElementById('chatUserName').textContent = this.currentChat.name;
                
                const avatar = document.getElementById('chatUserAvatar');
                if (this.currentChat.profileImage) {
                    avatar.src = this.currentChat.profileImage;
                } else {
                    avatar.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="40" r="20" fill="%23ccc"/><circle cx="50" cy="100" r="30" fill="%23ccc"/></svg>';
                }

                // Hide main pages and show chat
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById('chatPage').classList.remove('hidden');
                document.getElementById('floatingBtn').classList.add('hidden');

                // Focus message input
                setTimeout(() => {
                    document.getElementById('messageInput').focus();
                }, 100);
            }

            closeChat() {
                document.getElementById('chatPage').classList.add('hidden');
                document.getElementById('floatingBtn').classList.remove('hidden');
                this.switchPage(this.currentPage);
                this.currentChat = null;
            }

            async loadChatMessages() {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';

                // Load messages from localStorage
                const chatKey = `chat_${this.currentUser.userId}_${this.currentChat.userId}`;
                const messages = localStorage.getItem(chatKey);
                const messageList = messages ? JSON.parse(messages) : [];

                if (messageList.length === 0) {
                    messagesContainer.innerHTML = `
                        <div class="no-messages">
                            <i class="fas fa-comment-slash"></i>
                            <h3>No Messages Yet</h3>
                            <p>Send a message to start the conversation</p>
                        </div>
                    `;
                    return;
                }

                // Group messages by date
                const groupedMessages = this.groupMessagesByDate(messageList);

                // Render messages
                Object.keys(groupedMessages).forEach(date => {
                    // Add date separator
                    const dateElement = document.createElement('div');
                    dateElement.className = 'date-separator';
                    dateElement.innerHTML = `<span class="date-label">${this.formatDate(date)}</span>`;
                    messagesContainer.appendChild(dateElement);

                    // Add messages for this date
                    groupedMessages[date].forEach(message => {
                        const messageElement = this.createMessageElement(message);
                        messagesContainer.appendChild(messageElement);
                    });
                });

                // Scroll to bottom
                this.scrollToBottom();
            }

            groupMessagesByDate(messages) {
                const grouped = {};
                
                messages.forEach(message => {
                    const date = new Date(message.timestamp).toDateString();
                    
                    if (!grouped[date]) {
                        grouped[date] = [];
                    }
                    
                    grouped[date].push(message);
                });

                return grouped;
            }

            createMessageElement(message) {
                const isSent = message.senderId === this.currentUser.userId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;

                let messageContent = '';
                
                switch (message.type) {
                    case 'text':
                        messageContent = `
                            <div class="message-bubble">
                                <div class="message-text">${this.escapeHtml(message.content)}</div>
                                <div class="message-time">${this.formatTime(message.timestamp)}</div>
                            </div>
                        `;
                        break;
                        
                    case 'image':
                        messageContent = `
                            <div class="message-bubble media-message">
                                <img src="${message.content}" alt="Image" class="chat-media" onclick="viewMedia('${message.content}', 'image')">
                                <div class="media-info">
                                    <i class="fas fa-image"></i> Photo
                                </div>
                                <div class="message-time">${this.formatTime(message.timestamp)}</div>
                            </div>
                        `;
                        break;
                        
                    case 'video':
                        messageContent = `
                            <div class="message-bubble media-message">
                                <video src="${message.content}" class="chat-media" controls onclick="viewMedia('${message.content}', 'video')"></video>
                                <div class="media-info">
                                    <i class="fas fa-video"></i> Video
                                </div>
                                <div class="message-time">${this.formatTime(message.timestamp)}</div>
                            </div>
                        `;
                        break;
                        
                    case 'document':
                        messageContent = `
                            <div class="message-bubble">
                                <div class="document-message-container">
                                    <div class="document-icon">
                                        <i class="fas fa-file"></i>
                                    </div>
                                    <div class="document-info">
                                        <div class="document-name">${message.fileName}</div>
                                        <div class="document-size">${this.formatFileSize(message.fileSize)}</div>
                                    </div>
                                    <a href="${message.content}" download class="download-btn">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                                <div class="message-time">${this.formatTime(message.timestamp)}</div>
                            </div>
                        `;
                        break;
                        
                    case 'location':
                        const location = JSON.parse(message.content);
                        messageContent = `
                            <div class="message-bubble">
                                <div class="location-message-container">
                                    <div class="location-map-preview">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="location-details">
                                        <div>${location.address}</div>
                                        <div class="text-sm text-gray-500">${location.city}, ${location.area}</div>
                                    </div>
                                </div>
                                <div class="message-time">${this.formatTime(message.timestamp)}</div>
                            </div>
                        `;
                        break;
                        
                    case 'voice':
                        messageContent = `
                            <div class="message-bubble">
                                <div class="voice-message-container">
                                    <button class="voice-play-btn" onclick="playVoiceMessage('${message.content}')">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <div class="voice-waveform"></div>
                                    <div class="voice-duration">${message.duration}s</div>
                                </div>
                                <div class="message-time">${this.formatTime(message.timestamp)}</div>
                            </div>
                        `;
                        break;
                        
                    case 'view_once':
                        messageContent = `
                            <div class="message-bubble media-message view-once-message" onclick="viewOnceMessage(this, '${message.content}')">
                                <div class="view-once-overlay">
                                    <i class="fas fa-eye"></i>
                                    <span>View Once</span>
                                </div>
                                <div class="message-time">${this.formatTime(message.timestamp)}</div>
                            </div>
                        `;
                        break;
                }

                messageDiv.innerHTML = messageContent;
                return messageDiv;
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message && !this.attachedMedia) return;

                // Disable send button
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = true;

                try {
                    const newMessage = {
                        id: Date.now().toString(),
                        senderId: this.currentUser.userId,
                        receiverId: this.currentChat.userId,
                        type: this.attachedMedia ? this.attachedMedia.type : 'text',
                        content: this.attachedMedia ? this.attachedMedia.url : message,
                        timestamp: new Date().toISOString(),
                        status: 'sent',
                        fileName: this.attachedMedia?.fileName,
                        fileSize: this.attachedMedia?.fileSize,
                        duration: this.attachedMedia?.duration
                    };

                    // Save message to localStorage
                    const chatKey = `chat_${this.currentUser.userId}_${this.currentChat.userId}`;
                    const existingMessages = localStorage.getItem(chatKey);
                    const messages = existingMessages ? JSON.parse(existingMessages) : [];
                    messages.push(newMessage);
                    localStorage.setItem(chatKey, JSON.stringify(messages));

                    // Also save to receiver's chat
                    const receiverChatKey = `chat_${this.currentChat.userId}_${this.currentUser.userId}`;
                    const receiverMessages = localStorage.getItem(receiverChatKey) || '[]';
                    const receiverMessageList = JSON.parse(receiverMessages);
                    receiverMessageList.push(newMessage);
                    localStorage.setItem(receiverChatKey, JSON.stringify(receiverMessageList));

                    // Update chat list
                    await this.updateChatList(newMessage);

                    // Add message to UI
                    this.addMessageToUI(newMessage);

                    // Clear input and attachment
                    input.value = '';
                    this.clearAttachment();

                    // Scroll to bottom
                    this.scrollToBottom();

                    // Play sent sound
                    this.playSentSound();

                    // Update last message in chat list
                    this.updateChatLastMessage(newMessage);

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showError('Failed to send message');
                } finally {
                    sendBtn.disabled = false;
                    input.focus();
                }
            }

            addMessageToUI(message) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageElement = this.createMessageElement(message);
                messagesContainer.appendChild(messageElement);
            }

            async updateChatList(message) {
                // Find or create chat in list
                let chat = this.chats.find(c => c.userId === this.currentChat.userId);
                
                if (!chat) {
                    chat = {
                        userId: this.currentChat.userId,
                        name: this.currentChat.name,
                        profileImage: this.currentChat.profileImage,
                        lastMessage: message.content,
                        timestamp: message.timestamp,
                        unreadCount: 0,
                        isGroup: false
                    };
                    this.chats.unshift(chat);
                } else {
                    chat.lastMessage = message.content;
                    chat.timestamp = message.timestamp;
                    
                    // Move to top
                    this.chats = this.chats.filter(c => c.userId !== this.currentChat.userId);
                    this.chats.unshift(chat);
                }

                // Save to localStorage
                localStorage.setItem(`chats_${this.currentUser.userId}`, JSON.stringify(this.chats));
                
                // Re-render chats
                this.renderChats();
            }

            updateChatLastMessage(message) {
                // Update the chat's last message in the list
                const chatItems = document.querySelectorAll('.chat-item');
                chatItems.forEach(item => {
                    if (item.dataset.userId === this.currentChat.userId) {
                        const preview = item.querySelector('.chat-preview');
                        if (preview) {
                            preview.textContent = message.type === 'text' ? message.content : `Sent ${message.type}`;
                        }
                        
                        const time = item.querySelector('.chat-time');
                        if (time) {
                            time.textContent = this.formatTimeShort(message.timestamp);
                        }
                    }
                });
            }

            // Attachment Functions
            async attachPhoto() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Show loading
                        this.showLoading('Uploading photo...');
                        
                        try {
                            // Upload to Cloudinary
                            const url = await this.uploadToCloudinary(file);
                            
                            this.attachedMedia = {
                                type: 'image',
                                url: url,
                                fileName: file.name,
                                fileSize: file.size
                            };
                            
                            this.showToast('Photo attached', 'success');
                            this.hideAttachmentOptions();
                            
                        } catch (error) {
                            console.error('Error uploading photo:', error);
                            this.showError('Failed to upload photo');
                        } finally {
                            this.hideLoading();
                        }
                    }
                };
                input.click();
            }

            async attachVideo() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'video/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file size (50MB max)
                        if (file.size > 50 * 1024 * 1024) {
                            this.showError('Video must be less than 50MB');
                            return;
                        }

                        this.showLoading('Uploading video...');
                        
                        try {
                            const url = await this.uploadToCloudinary(file, 'video');
                            
                            this.attachedMedia = {
                                type: 'video',
                                url: url,
                                fileName: file.name,
                                fileSize: file.size
                            };
                            
                            this.showToast('Video attached', 'success');
                            this.hideAttachmentOptions();
                            
                        } catch (error) {
                            console.error('Error uploading video:', error);
                            this.showError('Failed to upload video');
                        } finally {
                            this.hideLoading();
                        }
                    }
                };
                input.click();
            }

            async attachDocument() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf,.doc,.docx,.txt,.xls,.xlsx';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file size (50MB max)
                        if (file.size > 50 * 1024 * 1024) {
                            this.showError('Document must be less than 50MB');
                            return;
                        }

                        this.showLoading('Uploading document...');
                        
                        try {
                            const url = await this.uploadToCloudinary(file, 'raw');
                            
                            this.attachedMedia = {
                                type: 'document',
                                url: url,
                                fileName: file.name,
                                fileSize: file.size
                            };
                            
                            this.showToast('Document attached', 'success');
                            this.hideAttachmentOptions();
                            
                        } catch (error) {
                            console.error('Error uploading document:', error);
                            this.showError('Failed to upload document');
                        } finally {
                            this.hideLoading();
                        }
                    }
                };
                input.click();
            }

            async attachLocation() {
                if (!navigator.geolocation) {
                    this.showError('Geolocation is not supported by your browser');
                    return;
                }

                this.showLoading('Getting your location...');

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            // Reverse geocode to get address
                            const address = await this.reverseGeocode(
                                position.coords.latitude,
                                position.coords.longitude
                            );

                            this.attachedMedia = {
                                type: 'location',
                                url: JSON.stringify({
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude,
                                    address: address.street,
                                    area: address.area,
                                    city: address.city,
                                    country: address.country
                                })
                            };

                            this.showToast('Location attached', 'success');
                            this.hideAttachmentOptions();

                        } catch (error) {
                            console.error('Error getting location:', error);
                            this.showError('Failed to get location');
                        } finally {
                            this.hideLoading();
                        }
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        this.showError('Unable to retrieve your location');
                        this.hideLoading();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }

            async attachViewOnce() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*,video/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.showLoading('Uploading view once media...');
                        
                        try {
                            const url = await this.uploadToCloudinary(file);
                            
                            this.attachedMedia = {
                                type: 'view_once',
                                url: url,
                                fileName: file.name,
                                fileSize: file.size
                            };
                            
                            this.showToast('View once media attached', 'success');
                            this.hideAttachmentOptions();
                            
                        } catch (error) {
                            console.error('Error uploading media:', error);
                            this.showError('Failed to upload media');
                        } finally {
                            this.hideLoading();
                        }
                    }
                };
                input.click();
            }

            async startVoiceRecording() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showError('Voice recording not supported');
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];

                    this.mediaRecorder.ondataavailable = (event) => {
                        this.audioChunks.push(event.data);
                    };

                    this.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        
                        // Create audio URL for preview
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        // Get duration
                        const audio = new Audio(audioUrl);
                        audio.onloadedmetadata = async () => {
                            const duration = Math.round(audio.duration);
                            
                            // Upload to Cloudinary
                            this.showLoading('Uploading voice message...');
                            
                            try {
                                const file = new File([audioBlob], 'voice-message.webm', { type: 'audio/webm' });
                                const url = await this.uploadToCloudinary(file, 'video'); // Using video preset for audio
                                
                                this.attachedMedia = {
                                    type: 'voice',
                                    url: url,
                                    duration: duration
                                };
                                
                                this.showToast('Voice message ready', 'success');
                                
                            } catch (error) {
                                console.error('Error uploading voice:', error);
                                this.showError('Failed to upload voice message');
                            } finally {
                                this.hideLoading();
                                this.hideAttachmentOptions();
                            }
                        };
                    };

                    // Start recording
                    this.mediaRecorder.start();
                    this.isRecording = true;
                    
                    // Show recording UI
                    this.showRecordingUI();
                    
                    // Stop after 2 minutes max
                    this.recordingTimeout = setTimeout(() => {
                        this.stopVoiceRecording();
                    }, 120000);

                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.showError('Failed to start recording');
                }
            }

            stopVoiceRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    
                    // Stop all tracks
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    
                    // Hide recording UI
                    this.hideRecordingUI();
                    
                    // Clear timeout
                    if (this.recordingTimeout) {
                        clearTimeout(this.recordingTimeout);
                        this.recordingTimeout = null;
                    }
                }
            }

            showRecordingUI() {
                // Create recording UI
                const recordingUI = document.createElement('div');
                recordingUI.className = 'voice-recorder active';
                recordingUI.id = 'voiceRecorder';
                recordingUI.innerHTML = `
                    <div class="recording-dot"></div>
                    <div class="recording-time" id="recordingTime">0:00</div>
                    <div class="recording-wave"></div>
                    <button class="cancel-recording" onclick="app.cancelRecording()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                document.body.appendChild(recordingUI);

                // Start timer
                let seconds = 0;
                this.recordingTimer = setInterval(() => {
                    seconds++;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    document.getElementById('recordingTime').textContent = 
                        `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            hideRecordingUI() {
                const recorder = document.getElementById('voiceRecorder');
                if (recorder) {
                    recorder.remove();
                }
                
                if (this.recordingTimer) {
                    clearInterval(this.recordingTimer);
                    this.recordingTimer = null;
                }
            }

            cancelRecording() {
                this.stopVoiceRecording();
                this.showToast('Recording cancelled', 'info');
            }

            clearAttachment() {
                this.attachedMedia = null;
                const messageInput = document.getElementById('messageInput');
                messageInput.placeholder = 'iMessage';
            }

            // Chat Request Functions
            async sendChatRequest(userId) {
                try {
                    // Check if user exists
                    const userExists = await this.checkUserExists(userId);
                    
                    if (!userExists) {
                        this.showError('User not found');
                        return;
                    }

                    // Check if already in contacts
                    const existingContact = this.contacts.find(c => c.userId === userId);
                    if (existingContact) {
                        this.showError('User is already in your contacts');
                        return;
                    }

                    // Check if request already sent
                    const existingRequest = this.requests.find(r => r.fromUserId === userId);
                    if (existingRequest) {
                        this.showError('Request already sent');
                        return;
                    }

                    // Create request
                    const request = {
                        id: Date.now().toString(),
                        fromUserId: this.currentUser.userId,
                        fromUserName: this.currentUser.name,
                        fromUserProfile: this.currentUser.profileImage,
                        toUserId: userId,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    };

                    // Save request
                    this.requests.push(request);
                    localStorage.setItem(`requests_${this.currentUser.userId}`, JSON.stringify(this.requests));

                    // Also save to receiver's requests
                    const receiverRequests = localStorage.getItem(`requests_${userId}`) || '[]';
                    const receiverRequestList = JSON.parse(receiverRequests);
                    receiverRequestList.push(request);
                    localStorage.setItem(`requests_${userId}`, JSON.stringify(receiverRequestList));

                    this.showToast('Chat request sent', 'success');
                    this.hideStartChatModal();

                } catch (error) {
                    console.error('Error sending request:', error);
                    this.showError('Failed to send request');
                }
            }

            async acceptChatRequest(requestId) {
                const request = this.requests.find(r => r.id === requestId);
                if (!request) return;

                try {
                    // Get user info
                    const userInfo = await this.getUserInfo(request.fromUserId);
                    
                    if (!userInfo) {
                        this.showError('User not found');
                        return;
                    }

                    // Add to contacts
                    const newContact = {
                        userId: userInfo.userId,
                        name: userInfo.name,
                        profileImage: userInfo.profileImage,
                        status: userInfo.status,
                        lastSeen: userInfo.lastSeen,
                        isOnline: userInfo.isOnline
                    };

                    this.contacts.push(newContact);
                    localStorage.setItem(`contacts_${this.currentUser.userId}`, JSON.stringify(this.contacts));

                    // Remove request
                    this.requests = this.requests.filter(r => r.id !== requestId);
                    localStorage.setItem(`requests_${this.currentUser.userId}`, JSON.stringify(this.requests));

                    // Also remove from sender's sent requests
                    const senderRequests = localStorage.getItem(`sent_requests_${request.fromUserId}`) || '[]';
                    const senderRequestList = JSON.parse(senderRequests);
                    const updatedSenderRequests = senderRequestList.filter(r => r.id !== requestId);
                    localStorage.setItem(`sent_requests_${request.fromUserId}`, JSON.stringify(updatedSenderRequests));

                    // Add sender to receiver's contacts
                    const senderContacts = localStorage.getItem(`contacts_${request.fromUserId}`) || '[]';
                    const senderContactList = JSON.parse(senderContacts);
                    
                    const receiverContact = {
                        userId: this.currentUser.userId,
                        name: this.currentUser.name,
                        profileImage: this.currentUser.profileImage,
                        status: this.currentUser.status,
                        lastSeen: this.currentUser.lastSeen,
                        isOnline: this.currentUser.isOnline
                    };

                    senderContactList.push(receiverContact);
                    localStorage.setItem(`contacts_${request.fromUserId}`, JSON.stringify(senderContactList));

                    this.showToast('Contact added', 'success');
                    this.renderContacts();
                    this.renderRequests();

                    // Start chat with new contact
                    this.startChat(request.fromUserId);

                } catch (error) {
                    console.error('Error accepting request:', error);
                    this.showError('Failed to accept request');
                }
            }

            rejectChatRequest(requestId) {
                this.requests = this.requests.filter(r => r.id !== requestId);
                localStorage.setItem(`requests_${this.currentUser.userId}`, JSON.stringify(this.requests));
                
                this.showToast('Request rejected', 'info');
                this.renderRequests();
            }

            // Zyne Functions
            async postZyne() {
                const textInput = document.getElementById('zyneText');
                const text = textInput.value.trim();
                
                if (!text && !this.zyneMedia) return;

                try {
                    const zyne = {
                        id: Date.now().toString(),
                        userId: this.currentUser.userId,
                        userName: this.currentUser.name,
                        userProfile: this.currentUser.profileImage,
                        text: text,
                        media: this.zyneMedia,
                        timestamp: new Date().toISOString(),
                        likes: 0,
                        comments: [],
                        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 24 hours
                    };

                    this.zynes.unshift(zyne);
                    localStorage.setItem(`zynes_${this.currentUser.userId}`, JSON.stringify(this.zynes));

                    // Also save to followers' feeds
                    this.contacts.forEach(contact => {
                        const followerZynes = localStorage.getItem(`feed_${contact.userId}`) || '[]';
                        const followerZyneList = JSON.parse(followerZynes);
                        followerZyneList.unshift(zyne);
                        localStorage.setItem(`feed_${contact.userId}`, JSON.stringify(followerZyneList));
                    });

                    textInput.value = '';
                    this.zyneMedia = null;
                    document.getElementById('zyneMediaPreview').innerHTML = '';

                    this.showToast('Zyne posted', 'success');
                    this.renderZynes();

                } catch (error) {
                    console.error('Error posting zyne:', error);
                    this.showError('Failed to post zyne');
                }
            }

            async likeZyne(zyneId) {
                const zyne = this.zynes.find(z => z.id === zyneId);
                if (!zyne) return;

                zyne.likes += 1;
                localStorage.setItem(`zynes_${this.currentUser.userId}`, JSON.stringify(this.zynes));
                
                // Update UI
                this.renderZynes();
            }

            async addZyneComment(zyneId, comment) {
                const zyne = this.zynes.find(z => z.id === zyneId);
                if (!zyne) return;

                const newComment = {
                    id: Date.now().toString(),
                    userId: this.currentUser.userId,
                    userName: this.currentUser.name,
                    userProfile: this.currentUser.profileImage,
                    text: comment,
                    timestamp: new Date().toISOString()
                };

                zyne.comments.push(newComment);
                localStorage.setItem(`zynes_${this.currentUser.userId}`, JSON.stringify(this.zynes));
                
                this.renderZynes();
            }

            // Group Functions
            async createGroup() {
                const nameInput = document.getElementById('groupName');
                const name = nameInput.value.trim();
                
                if (!name) {
                    this.showError('Group name is required');
                    return;
                }

                // Get selected members
                const selectedMembers = Array.from(document.querySelectorAll('.member-checkbox.checked'))
                    .map(cb => cb.dataset.userId);

                if (selectedMembers.length < 2) {
                    this.showError('Select at least 2 members');
                    return;
                }

                try {
                    const group = {
                        id: Date.now().toString(),
                        name: name,
                        creatorId: this.currentUser.userId,
                        creatorName: this.currentUser.name,
                        profileImage: this.groupPhotoUrl || '',
                        members: [this.currentUser.userId, ...selectedMembers],
                        createdAt: new Date().toISOString(),
                        lastActivity: new Date().toISOString()
                    };

                    this.groups.unshift(group);
                    localStorage.setItem(`groups_${this.currentUser.userId}`, JSON.stringify(this.groups));

                    // Add group to each member's list
                    selectedMembers.forEach(memberId => {
                        const memberGroups = localStorage.getItem(`groups_${memberId}`) || '[]';
                        const memberGroupList = JSON.parse(memberGroups);
                        memberGroupList.push(group);
                        localStorage.setItem(`groups_${memberId}`, JSON.stringify(memberGroupList));
                    });

                    nameInput.value = '';
                    this.groupPhotoUrl = null;
                    document.getElementById('groupPhotoPreview').innerHTML = `
                        <div class="preview-placeholder">
                            <i class="fas fa-users"></i>
                            <span>No image</span>
                        </div>
                    `;

                    this.showToast('Group created', 'success');
                    this.hideCreateGroupModal();
                    this.renderGroups();

                } catch (error) {
                    console.error('Error creating group:', error);
                    this.showError('Failed to create group');
                }
            }

            // Utility Functions
            async uploadToCloudinary(file, resourceType = 'image') {
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', this.cloudinaryConfig.uploadPreset);
                    formData.append('folder', this.cloudinaryConfig.folder);

                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', `https://api.cloudinary.com/v1_1/${this.cloudinaryConfig.cloudName}/${resourceType}/upload`);
                    
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            resolve(response.secure_url);
                        } else {
                            reject(new Error('Upload failed'));
                        }
                    };
                    
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.send(formData);
                });
            }

            async reverseGeocode(lat, lng) {
                // Using Nominatim OpenStreetMap for reverse geocoding
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                
                return {
                    street: data.address.road || data.address.street || 'Unknown street',
                    area: data.address.suburb || data.address.neighbourhood || '',
                    city: data.address.city || data.address.town || data.address.village || 'Unknown city',
                    country: data.address.country || 'Unknown country'
                };
            }

            async checkUserExists(userId) {
                // Check if user exists in localStorage
                const userData = localStorage.getItem(`user_${userId}`);
                return !!userData;
            }

            async getUserInfo(userId) {
                const userData = localStorage.getItem(`user_${userId}`);
                return userData ? JSON.parse(userData) : null;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                if (date.toDateString() === today.toDateString()) {
                    return 'Today';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return 'Yesterday';
                } else {
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }

            formatTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }

            formatTimeShort(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m`;
                if (diffHours < 24) return `${diffHours}h`;
                if (diffDays < 7) return `${diffDays}d`;
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            scrollToBottom() {
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            updateBadges() {
                // Update home badge (unread chats)
                const unreadChats = this.chats.filter(chat => chat.unreadCount > 0).length;
                this.updateBadge('homeBadge', unreadChats);

                // Update request badge
                this.updateBadge('requestBadge', this.requests.length);

                // Update other badges as needed
            }

            updateBadge(badgeId, count) {
                const badge = document.getElementById(badgeId);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }

            // UI Rendering Functions
            renderChats() {
                const chatsList = document.getElementById('chatsList');
                
                if (this.chats.length === 0) {
                    chatsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No Chats Yet</h3>
                            <p>Start a conversation by tapping the chat button below</p>
                        </div>
                    `;
                    return;
                }

                chatsList.innerHTML = this.chats.map(chat => `
                    <div class="chat-item" data-user-id="${chat.userId}" onclick="app.startChat('${chat.userId}')">
                        <img src="${chat.profileImage || 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"40\" r=\"20\" fill=\"%23ccc\"/><circle cx=\"50\" cy=\"100\" r=\"30\" fill=\"%23ccc\"/></svg>'}" 
                             alt="${chat.name}" class="chat-avatar">
                        <div class="chat-info">
                            <h3>${this.escapeHtml(chat.name)}</h3>
                            <div class="chat-preview">${this.escapeHtml(chat.lastMessage || 'No messages yet')}</div>
                        </div>
                        <div class="chat-meta">
                            <div class="chat-time">${this.formatTimeShort(chat.timestamp)}</div>
                            ${chat.unreadCount > 0 ? `<div class="unread-badge">${chat.unreadCount}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            }

            renderContacts() {
                const contactsList = document.getElementById('contactsList');
                
                if (this.contacts.length === 0) {
                    contactsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-address-book"></i>
                            <h3>No Contacts</h3>
                            <p>Add contacts to start chatting</p>
                        </div>
                    `;
                    return;
                }

                contactsList.innerHTML = this.contacts.map(contact => `
                    <div class="contact-card" data-user-id="${contact.userId}">
                        <div class="contact-avatar-container">
                            <img src="${contact.profileImage || 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"40\" r=\"20\" fill=\"%23ccc\"/><circle cx=\"50\" cy=\"100\" r=\"30\" fill=\"%23ccc\"/></svg>'}" 
                                 alt="${contact.name}" class="contact-avatar">
                            <div class="status-indicator ${contact.isOnline ? 'status-online' : 'status-offline'}"></div>
                        </div>
                        <div class="contact-info">
                            <h3>${this.escapeHtml(contact.name)}</h3>
                            <div class="contact-status">
                                <span>${contact.status || 'Hey there! I am using Zynapse'}</span>
                            </div>
                        </div>
                        <div class="contact-actions">
                            <button class="icon-btn" onclick="app.startChat('${contact.userId}')" title="Start Chat">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="icon-btn" onclick="app.viewContactProfile('${contact.userId}')" title="View Profile">
                                <i class="fas fa-user"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderRequests() {
                const requestsList = document.getElementById('requestsList');
                
                if (this.requests.length === 0) {
                    requestsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-plus"></i>
                            <h3>No Requests</h3>
                            <p>You don't have any pending chat requests</p>
                        </div>
                    `;
                    return;
                }

                requestsList.innerHTML = this.requests.map(request => `
                    <div class="request-card">
                        <div class="request-header">
                            <img src="${request.fromUserProfile || 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"40\" r=\"20\" fill=\"%23ccc\"/><circle cx=\"50\" cy=\"100\" r=\"30\" fill=\"%23ccc\"/></svg>'}" 
                                 alt="${request.fromUserName}" class="request-avatar">
                            <div class="request-info">
                                <h4>${this.escapeHtml(request.fromUserName)}</h4>
                                <div class="request-user-id">${request.fromUserId}</div>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="action-btn accept-btn" onclick="app.acceptChatRequest('${request.id}')">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="action-btn reject-btn" onclick="app.rejectChatRequest('${request.id}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderZynes() {
                const zynesList = document.getElementById('zynesList');
                
                if (this.zynes.length === 0) {
                    zynesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-fire"></i>
                            <h3>No Zynes Yet</h3>
                            <p>Share your first Zyne with your contacts</p>
                        </div>
                    `;
                    return;
                }

                zynesList.innerHTML = this.zynes.map(zyne => `
                    <div class="zyne-card">
                        <div class="zyne-header">
                            <img src="${zyne.userProfile || 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"40\" r=\"20\" fill=\"%23ccc\"/><circle cx=\"50\" cy=\"100\" r=\"30\" fill=\"%23ccc\"/></svg>'}" 
                                 alt="${zyne.userName}" class="zyne-avatar">
                            <div class="zyne-user-info">
                                <h4>${this.escapeHtml(zyne.userName)}</h4>
                                <div class="zyne-time">${this.formatTimeShort(zyne.timestamp)}</div>
                            </div>
                        </div>
                        <div class="zyne-content">
                            ${zyne.text ? `<div class="zyne-text">${this.escapeHtml(zyne.text)}</div>` : ''}
                            ${zyne.media ? `
                                ${zyne.media.type === 'image' ? `
                                    <img src="${zyne.media.url}" alt="Zyne Media" class="zyne-media">
                                ` : zyne.media.type === 'video' ? `
                                    <video src="${zyne.media.url}" controls class="zyne-media"></video>
                                ` : ''}
                            ` : ''}
                        </div>
                        <div class="zyne-stats">
                            <span>${zyne.likes} likes</span>
                            <span>${zyne.comments.length} comments</span>
                        </div>
                        <div class="zyne-actions">
                            <button class="zyne-action-btn ${zyne.liked ? 'liked' : ''}" onclick="app.likeZyne('${zyne.id}')">
                                <i class="fas fa-heart"></i> Like
                            </button>
                            <button class="zyne-action-btn" onclick="app.showZyneComments('${zyne.id}')">
                                <i class="fas fa-comment"></i> Comment
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            renderGroups() {
                const groupsList = document.getElementById('groupsList');
                
                if (this.groups.length === 0) {
                    groupsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Groups</h3>
                            <p>Create a group to chat with multiple people</p>
                        </div>
                    `;
                    return;
                }

                groupsList.innerHTML = this.groups.map(group => `
                    <div class="group-card" onclick="app.openGroupChat('${group.id}')">
                        <div class="group-avatar">
                            <img src="${group.profileImage || 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"50\" r=\"45\" fill=\"%23ccc\"/></svg>'}" 
                                 alt="${group.name}" class="group-avatar-img">
                            <div class="group-member-count">${group.members.length}</div>
                        </div>
                        <div class="group-info">
                            <h3>${this.escapeHtml(group.name)}</h3>
                            <p>${group.members.length} members</p>
                            <div class="group-members">
                                <i class="fas fa-user"></i> ${group.creatorName}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Event Handlers
            handleMessageInput(event) {
                const input = event.target;
                const sendBtn = document.getElementById('sendBtn');
                
                // Auto-resize textarea
                input.style.height = 'auto';
                input.style.height = (input.scrollHeight) + 'px';
                
                // Enable/disable send button
                sendBtn.disabled = !input.value.trim() && !this.attachedMedia;
                
                // Handle typing indicator
                if (this.currentChat && !this.isTyping) {
                    this.isTyping = true;
                    this.sendTypingIndicator(true);
                    
                    // Clear previous timeout
                    if (this.typingTimeout) {
                        clearTimeout(this.typingTimeout);
                    }
                    
                    // Set timeout to stop typing indicator
                    this.typingTimeout = setTimeout(() => {
                        this.isTyping = false;
                        this.sendTypingIndicator(false);
                    }, 1000);
                }
            }

            handleMessageKeypress(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    this.sendMessage();
                }
            }

            handleUserSearch(event) {
                const searchTerm = event.target.value.trim();
                const sendRequestBtn = document.getElementById('sendRequestBtn');
                
                if (searchTerm.match(/^ZYN-\d{4}$/)) {
                    // Valid User ID format
                    sendRequestBtn.disabled = false;
                    
                    // Show user info if found
                    this.searchUser(searchTerm);
                } else {
                    sendRequestBtn.disabled = true;
                    document.getElementById('userSearchResult').innerHTML = '';
                }
            }

            async searchUser(userId) {
                try {
                    const userInfo = await this.getUserInfo(userId);
                    
                    if (userInfo) {
                        document.getElementById('userSearchResult').innerHTML = `
                            <div class="user-found">
                                <img src="${userInfo.profileImage || 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"40\" r=\"20\" fill=\"%23ccc\"/><circle cx=\"50\" cy=\"100\" r=\"30\" fill=\"%23ccc\"/></svg>'}" 
                                     alt="${userInfo.name}" class="user-found-avatar">
                                <div class="user-found-info">
                                    <h4>${this.escapeHtml(userInfo.name)}</h4>
                                    <p>${userId}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('userSearchResult').innerHTML = `
                            <div class="user-not-found">
                                <i class="fas fa-user-slash"></i>
                                <p>User not found</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error searching user:', error);
                }
            }

            handleOutsideClick(event) {
                // Close profile dropdown if clicking outside
                const profileDropdown = document.getElementById('profileDropdown');
                const profileBtn = document.getElementById('profileBtn');
                
                if (profileDropdown && profileBtn && 
                    !profileDropdown.contains(event.target) && 
                    !profileBtn.contains(event.target)) {
                    profileDropdown.classList.remove('show');
                }

                // Close attachment options if clicking outside
                const attachmentOptions = document.getElementById('attachmentOptions');
                const attachBtn = document.getElementById('attachBtn');
                
                if (attachmentOptions && attachBtn &&
                    !attachmentOptions.contains(event.target) &&
                    !attachBtn.contains(event.target)) {
                    attachmentOptions.classList.remove('show');
                }
            }

            // Modal Functions
            showStartChatModal() {
                document.getElementById('startChatModal').classList.add('active');
                document.getElementById('searchUserId').focus();
            }

            hideStartChatModal() {
                document.getElementById('startChatModal').classList.remove('active');
                document.getElementById('searchUserId').value = '';
                document.getElementById('userSearchResult').innerHTML = '';
                document.getElementById('sendRequestBtn').disabled = true;
            }

            showCreateGroupModal() {
                document.getElementById('createGroupModal').classList.add('active');
                document.getElementById('groupName').focus();
                
                // Load contacts for member selection
                this.renderGroupMemberList();
            }

            hideCreateGroupModal() {
                document.getElementById('createGroupModal').classList.remove('active');
                document.getElementById('groupName').value = '';
                document.getElementById('groupMembersList').innerHTML = '';
            }

            showProfileModal() {
                document.getElementById('profileModal').classList.add('active');
                
                // Update profile info
                document.getElementById('profileFullName').textContent = this.currentUser.name;
                document.getElementById('profileUserId').textContent = this.currentUser.userId;
                document.getElementById('profileStatus').textContent = this.currentUser.status;
                document.getElementById('profilePhone').textContent = this.currentUser.phone;
                document.getElementById('profileEmail').textContent = this.currentUser.email;
                document.getElementById('profileJoined').textContent = new Date(this.currentUser.createdAt).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long' 
                });
                
                const profileLarge = document.getElementById('profileLarge');
                if (this.currentUser.profileImage) {
                    profileLarge.src = this.currentUser.profileImage;
                } else {
                    profileLarge.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="40" r="20" fill="%23ccc"/><circle cx="50" cy="100" r="30" fill="%23ccc"/></svg>';
                }
            }

            hideProfileModal() {
                document.getElementById('profileModal').classList.remove('active');
            }

            showSettingsModal() {
                document.getElementById('settingsModal').classList.add('active');
            }

            hideSettingsModal() {
                document.getElementById('settingsModal').classList.remove('active');
            }

            // UI Helper Functions
            toggleProfileDropdown() {
                const dropdown = document.getElementById('profileDropdown');
                dropdown.classList.toggle('show');
            }

            toggleAttachmentOptions() {
                const options = document.getElementById('attachmentOptions');
                options.classList.toggle('show');
            }

            hideAttachmentOptions() {
                const options = document.getElementById('attachmentOptions');
                options.classList.remove('show');
            }

            renderGroupMemberList() {
                const membersList = document.getElementById('groupMembersList');
                
                membersList.innerHTML = this.contacts.map(contact => `
                    <div class="member-item">
                        <div class="member-info">
                            <img src="${contact.profileImage || 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"40\" r=\"20\" fill=\"%23ccc\"/><circle cx=\"50\" cy=\"100\" r=\"30\" fill=\"%23ccc\"/></svg>'}" 
                                 alt="${contact.name}" class="member-avatar">
                            <div class="member-name">${this.escapeHtml(contact.name)}</div>
                        </div>
                        <div class="member-checkbox" data-user-id="${contact.userId}" 
                             onclick="this.classList.toggle('checked')"></div>
                    </div>
                `).join('');
            }

            // Notification Functions
            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${this.getToastIcon(type)}"></i>
                    <span>${message}</span>
                `;
                
                toastContainer.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            getToastIcon(type) {
                switch (type) {
                    case 'success': return 'check-circle';
                    case 'error': return 'exclamation-circle';
                    case 'warning': return 'exclamation-triangle';
                    default: return 'info-circle';
                }
            }

            showError(message) {
                this.showToast(message, 'error');
            }

            showLoading(message) {
                // Create loading overlay
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                loadingOverlay.id = 'loadingOverlay';
                loadingOverlay.innerHTML = `
                    <div class="loading-content">
                        <div class="spinner-large"></div>
                        <p>${message}</p>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.remove();
                }
            }

            playNotificationSound() {
                const sound = document.getElementById('notificationSound');
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.log('Sound play failed:', e));
                }
            }

            playSentSound() {
                // Simple sent sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            }

            sendTypingIndicator(isTyping) {
                if (!this.currentChat) return;
                
                // In production, this would send to Firebase
                console.log(`${isTyping ? 'Started' : 'Stopped'} typing to ${this.currentChat.userId}`);
            }

            // Public methods for HTML onclick handlers
            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }
            }

            copyUserId() {
                const userId = this.currentUser.userId;
                navigator.clipboard.writeText(userId)
                    .then(() => this.showToast('User ID copied to clipboard', 'success'))
                    .catch(() => this.showError('Failed to copy User ID'));
            }

            viewProfile() {
                this.showProfileModal();
                document.getElementById('profileDropdown').classList.remove('show');
            }

            editProfile() {
                // Implement edit profile functionality
                this.showToast('Edit profile feature coming soon', 'info');
                document.getElementById('profileDropdown').classList.remove('show');
            }

            showSettings() {
                this.showSettingsModal();
                document.getElementById('profileDropdown').classList.remove('show');
            }

            toggleChatInfo() {
                // Implement chat info toggle
                this.showToast('Chat info feature coming soon', 'info');
            }

            showChatMenu() {
                // Implement chat menu
                this.showToast('Chat menu feature coming soon', 'info');
            }
        }

        // Initialize app when page loads
        let app;
        window.addEventListener('load', () => {
            app = new ZynapseApp();
            
            // Make app available globally for onclick handlers
            window.app = app;
            
            // Set up message input auto-resize
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
        });

        // Global functions for HTML onclick handlers
        function switchPage(page) {
            if (app) app.switchPage(page);
        }

        function showStartChatModal() {
            if (app) app.showStartChatModal();
        }

        function hideStartChatModal() {
            if (app) app.hideStartChatModal();
        }

        function sendChatRequest() {
            const userId = document.getElementById('searchUserId').value.trim();
            if (userId && app) {
                app.sendChatRequest(userId);
            }
        }

        function showCreateGroupModal() {
            if (app) app.showCreateGroupModal();
        }

        function hideCreateGroupModal() {
            if (app) app.hideCreateGroupModal();
        }

        function createGroup() {
            if (app) app.createGroup();
        }

        function closeChat() {
            if (app) app.closeChat();
        }

        function sendMessage() {
            if (app) app.sendMessage();
        }

        function toggleAttachmentOptions() {
            if (app) app.toggleAttachmentOptions();
        }

        function attachPhoto() {
            if (app) app.attachPhoto();
        }

        function attachVideo() {
            if (app) app.attachVideo();
        }

        function attachDocument() {
            if (app) app.attachDocument();
        }

        function attachLocation() {
            if (app) app.attachLocation();
        }

        function startVoiceRecording() {
            if (app) app.startVoiceRecording();
        }

        function attachViewOnce() {
            if (app) app.attachViewOnce();
        }

        function postZyne() {
            if (app) app.postZyne();
        }

        function addZynePhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('zyneMediaPreview');
                        preview.innerHTML = `
                            <div class="preview-item">
                                <img src="${e.target.result}" alt="Preview">
                                <button class="remove-preview" onclick="removeZyneMedia()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        if (app) app.zyneMedia = { type: 'image', url: e.target.result };
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function addZyneVideo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'video/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    const preview = document.getElementById('zyneMediaPreview');
                    preview.innerHTML = `
                        <div class="preview-item">
                            <video src="${url}" controls></video>
                            <button class="remove-preview" onclick="removeZyneMedia()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    if (app) app.zyneMedia = { type: 'video', url: url };
                }
            };
            input.click();
        }

        function removeZyneMedia() {
            document.getElementById('zyneMediaPreview').innerHTML = '';
            if (app) app.zyneMedia = null;
        }

        function viewMedia(url, type) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.style.zIndex = '9999';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                    <div class="modal-header">
                        <button class="close-modal" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 0; display: flex; align-items: center; justify-content: center;">
                        ${type === 'image' ? 
                            `<img src="${url}" style="max-width: 100%; max-height: 80vh; object-fit: contain;">` :
                            `<video src="${url}" controls style="max-width: 100%; max-height: 80vh;"></video>`
                        }
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function viewOnceMessage(element, url) {
            // Show media once
            const overlay = element.querySelector('.view-once-overlay');
            if (overlay) {
                overlay.style.display = 'none';
                
                // Determine media type from URL
                const isImage = url.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                const isVideo = url.match(/\.(mp4|webm|ogg)$/i);
                
                if (isImage) {
                    element.innerHTML = `
                        <img src="${url}" style="width: 100%; border-radius: inherit;">
                        <div class="message-time">${element.querySelector('.message-time')?.textContent || ''}</div>
                    `;
                } else if (isVideo) {
                    element.innerHTML = `
                        <video src="${url}" controls style="width: 100%; border-radius: inherit;"></video>
                        <div class="message-time">${element.querySelector('.message-time')?.textContent || ''}</div>
                    `;
                }
                
                // Mark as viewed (in production, would update in database)
                setTimeout(() => {
                    element.style.opacity = '0.5';
                    element.style.pointerEvents = 'none';
                }, 5000);
            }
        }

        function playVoiceMessage(url) {
            const audio = new Audio(url);
            audio.play().catch(e => console.log('Audio play failed:', e));
        }
    </script>
</body>
</html>
