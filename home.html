<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Zynapse</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="zynaps.png" type="image/png">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <!-- Cloudinary Upload Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
</head>
<body>
    <div class="app-container">
        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-content">
                <img src="zynaps.png" alt="Zynapse Logo" class="loading-logo">
                <div class="spinner-large"></div>
                <p>Loading Zynapse...</p>
            </div>
        </div>

        <!-- Main App (hidden initially) -->
        <div class="app-home hidden" id="appHome">
            <!-- Header -->
            <div class="app-header">
                <div class="header-left">
                    <img src="zynaps.png" alt="Zynapse Logo" class="header-logo">
                    <div class="user-info">
                        <h2 id="userName">Loading...</h2>
                        <div class="user-id-container">
                            <span class="user-id" id="userId">ZYN-0000</span>
                            <button class="copy-btn" onclick="copyUserId()" title="Copy User ID">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="dropdown">
                    <button class="profile-btn" id="profileBtn">
                        <img src="" alt="Profile" class="profile-pic-small" id="profilePic">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-content" id="profileDropdown">
                        <button class="dropdown-item" onclick="viewMyProfile()">
                            <i class="fas fa-user"></i> My Profile
                        </button>
                        <button class="dropdown-item" onclick="openSettings()">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                        <button class="dropdown-item" onclick="openAppOptions()">
                            <i class="fas fa-palette"></i> App Options
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="app-nav">
                <a href="#" class="nav-item active" data-page="home">
                    <i class="fas fa-home"></i>
                    <span>HOME</span>
                    <span class="badge hidden" id="homeBadge">0</span>
                </a>
                <a href="#" class="nav-item" data-page="zynes">
                    <i class="fas fa-fire"></i>
                    <span>ZYNES</span>
                    <span class="badge hidden" id="zyneBadge">0</span>
                </a>
                <a href="#" class="nav-item" data-page="groups">
                    <i class="fas fa-users"></i>
                    <span>GROUPS</span>
                    <span class="badge hidden" id="groupBadge">0</span>
                </a>
                <a href="#" class="nav-item" data-page="requests">
                    <i class="fas fa-user-plus"></i>
                    <span>REQUESTS</span>
                    <span class="badge hidden" id="requestBadge">0</span>
                </a>
                <a href="#" class="nav-item" data-page="contacts">
                    <i class="fas fa-address-book"></i>
                    <span>CONTACTS</span>
                </a>
            </nav>

            <!-- Main Content Area -->
            <main class="app-main" id="appMain">
                <!-- Home Page (Chats) -->
                <div class="page active" id="homePage">
                    <div class="chats-header">
                        <h2>Chats</h2>
                    </div>
                    <div class="chats-list" id="chatsList">
                        <!-- Chat items will be loaded here -->
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <h3>No Chats Yet</h3>
                            <p>Start a chat by clicking the + button below</p>
                        </div>
                    </div>
                </div>

                <!-- Zynes Page -->
                <div class="page" id="zynesPage">
                    <div class="zynes-header">
                        <h2>Zynes</h2>
                    </div>
                    <div class="create-zyne">
                        <textarea class="create-input" id="zyneText" placeholder="What's happening?"></textarea>
                        <div class="media-preview" id="zyneMediaPreview"></div>
                        <div class="create-actions">
                            <div class="attachment-options">
                                <button class="attachment-btn" onclick="attachZyneMedia('photo')">
                                    <i class="fas fa-image"></i>
                                    <span>Photo</span>
                                </button>
                                <button class="attachment-btn" onclick="attachZyneMedia('video')">
                                    <i class="fas fa-video"></i>
                                    <span>Video</span>
                                </button>
                            </div>
                            <button class="btn-primary" onclick="postZyne()">
                                <i class="fas fa-paper-plane"></i> Post
                            </button>
                        </div>
                    </div>
                    <div class="zynes-list" id="zynesList">
                        <!-- Zynes will be loaded here -->
                        <div class="empty-state">
                            <i class="fas fa-fire"></i>
                            <h3>No Zynes Yet</h3>
                            <p>Share your first Zyne above</p>
                        </div>
                    </div>
                </div>

                <!-- Groups Page -->
                <div class="page" id="groupsPage">
                    <div class="groups-header">
                        <h2>Groups</h2>
                        <button class="create-group-btn" onclick="showCreateGroupModal()">
                            <i class="fas fa-plus"></i> New Group
                        </button>
                    </div>
                    <div class="groups-list" id="groupsList">
                        <!-- Groups will be loaded here -->
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Groups Yet</h3>
                            <p>Create a group or wait for an invitation</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Requests Page -->
                <div class="page" id="requestsPage">
                    <div class="requests-header">
                        <h2>Chat Requests</h2>
                    </div>
                    <div class="requests-list" id="requestsList">
                        <!-- Requests will be loaded here -->
                        <div class="empty-state">
                            <i class="fas fa-user-plus"></i>
                            <h3>No Requests</h3>
                            <p>When someone sends you a request, it will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Contacts Page -->
                <div class="page" id="contactsPage">
                    <div class="contacts-header">
                        <h2>Contacts</h2>
                    </div>
                    <div class="contacts-list" id="contactsList">
                        <!-- Contacts will be loaded here -->
                        <div class="empty-state">
                            <i class="fas fa-address-book"></i>
                            <h3>No Contacts Yet</h3>
                            <p>Add contacts by accepting chat requests</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface (Hidden by default) -->
                <div class="chat-page hidden" id="chatPage">
                    <div class="chat-header">
                        <button class="back-btn" onclick="closeChat()">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="chat-user-info" id="chatHeaderInfo">
                            <!-- Chat header content loaded dynamically -->
                        </div>
                        <div class="chat-actions">
                            <div class="dropdown">
                                <button class="icon-btn" id="chatMenuBtn">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-content" id="chatMenu">
                                    <button class="dropdown-item" onclick="addChatNickname()">
                                        <i class="fas fa-tag"></i> Add Nickname
                                    </button>
                                    <button class="dropdown-item" onclick="viewChatProfile()">
                                        <i class="fas fa-user"></i> View Profile
                                    </button>
                                    <button class="dropdown-item" onclick="addToFavorites()">
                                        <i class="fas fa-star"></i> Add to Favorites
                                    </button>
                                    <button class="dropdown-item" onclick="blockUser()">
                                        <i class="fas fa-ban"></i> Block User
                                    </button>
                                    <button class="dropdown-item danger" onclick="deleteChat()">
                                        <i class="fas fa-trash"></i> Delete Chat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages loaded here -->
                    </div>
                    
                    <div class="message-input-area">
                        <div class="dropdown">
                            <button class="attach-btn" id="attachBtn">
                                <i class="fas fa-plus"></i>
                            </button>
                            <div class="attachment-options" id="attachmentOptions">
                                <button class="attachment-btn" onclick="attachMedia('photo')">
                                    <i class="fas fa-image"></i>
                                    <span>Photo</span>
                                </button>
                                <button class="attachment-btn" onclick="attachMedia('video')">
                                    <i class="fas fa-video"></i>
                                    <span>Video</span>
                                </button>
                                <button class="attachment-btn" onclick="attachMedia('document')">
                                    <i class="fas fa-file"></i>
                                    <span>Document</span>
                                </button>
                                <button class="attachment-btn" onclick="attachLocation()">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Location</span>
                                </button>
                                <button class="attachment-btn" onclick="startVoiceRecording()">
                                    <i class="fas fa-microphone"></i>
                                    <span>Voice</span>
                                </button>
                                <button class="attachment-btn" onclick="sendViewOnce()">
                                    <i class="fas fa-eye"></i>
                                    <span>View Once</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="message-input-container">
                            <textarea class="message-input" id="messageInput" 
                                      placeholder="Message" 
                                      rows="1"></textarea>
                        </div>
                        
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="typing-bubble">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span class="typing-text">typing</span>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Floating Start Chat Button -->
            <button class="floating-btn" onclick="showStartChatModal()">
                <i class="fas fa-comment"></i>
                <span>CHAT</span>
            </button>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <!-- Modals -->
    <!-- Start Chat Modal -->
    <div class="modal-overlay" id="startChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Start New Chat</h3>
                <button class="close-modal" onclick="closeModal('startChatModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="search-input-group">
                    <input type="text" id="searchUserId" placeholder="Enter User ID (ZYN-XXXX)" maxlength="8">
                </div>
                <div class="search-result" id="searchResult">
                    <!-- Search results appear here -->
                </div>
                <div class="modal-actions">
                    <button class="action-btn btn-secondary" onclick="closeModal('startChatModal')">
                        Cancel
                    </button>
                    <button class="action-btn btn-primary" id="sendRequestBtn" onclick="sendChatRequest()" disabled>
                        <i class="fas fa-paper-plane"></i> Send Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal-overlay" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Group</h3>
                <button class="close-modal" onclick="closeModal('createGroupModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-4">
                    <input type="text" id="groupName" placeholder="Group Name" required>
                </div>
                <div class="profile-upload-section">
                    <label class="upload-label">Group Photo</label>
                    <div class="profile-upload-container">
                        <div class="upload-preview" id="groupPhotoPreview">
                            <div class="preview-placeholder">
                                <i class="fas fa-users"></i>
                                <span>Upload</span>
                            </div>
                        </div>
                        <div class="upload-buttons">
                            <button class="btn-upload" onclick="uploadGroupPhoto()">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                            <button class="btn-remove" onclick="removeGroupPhoto()" disabled>
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                    <input type="hidden" id="groupPhotoUrl">
                </div>
                <div class="member-search-input">
                    <input type="text" id="searchMember" placeholder="Search contacts to add...">
                </div>
                <div class="members-list" id="membersList">
                    <!-- Members list appears here -->
                </div>
                <div class="modal-actions">
                    <button class="action-btn btn-secondary" onclick="closeModal('createGroupModal')">
                        Cancel
                    </button>
                    <button class="action-btn btn-primary" onclick="createGroup()">
                        <i class="fas fa-plus"></i> Create Group
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile View Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Profile</h3>
                <button class="close-modal" onclick="closeModal('profileModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Profile content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-modal" onclick="closeModal('settingsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>Notifications</h4>
                    <div class="setting-item">
                        <span>Message Notifications</span>
                        <label class="switch">
                            <input type="checkbox" id="msgNotifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>Request Notifications</span>
                        <label class="switch">
                            <input type="checkbox" id="requestNotifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>Zyne Notifications</span>
                        <label class="switch">
                            <input type="checkbox" id="zyneNotifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>Privacy</h4>
                    <div class="setting-item">
                        <span>Last Seen</span>
                        <select id="lastSeenPrivacy">
                            <option value="everyone">Everyone</option>
                            <option value="contacts">Contacts Only</option>
                            <option value="nobody">Nobody</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <span>Profile Photo</span>
                        <select id="profilePhotoPrivacy">
                            <option value="everyone">Everyone</option>
                            <option value="contacts">Contacts Only</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <span>Zynes Visibility</span>
                        <select id="zynePrivacy">
                            <option value="contacts">Contacts Only</option>
                            <option value="nobody">Nobody</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <h4>Account</h4>
                    <button class="action-btn btn-secondary" onclick="changePassword()">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                    <button class="action-btn btn-secondary" onclick="updateProfile()">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button class="action-btn btn-danger" onclick="deleteAccount()">
                        <i class="fas fa-trash"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Zyne Detail Modal -->
    <div class="modal-overlay" id="zyneDetailModal">
        <div class="modal-content">
            <!-- Zyne detail content loaded dynamically -->
        </div>
    </div>

    <!-- Group Chat Modal -->
    <div class="modal-overlay" id="groupChatModal">
        <div class="modal-content">
            <!-- Group chat loaded dynamically -->
        </div>
    </div>

    <!-- Audio Recorder -->
    <div class="modal-overlay" id="audioRecorderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Record Voice Message</h3>
                <button class="close-modal" onclick="stopRecording()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="audio-recorder">
                    <div class="recording-visualizer" id="recordingVisualizer">
                        <!-- Visualizer bars -->
                    </div>
                    <div class="recording-time" id="recordingTime">00:00</div>
                    <div class="recording-controls">
                        <button class="action-btn btn-danger" onclick="stopRecording()" id="stopBtn">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                        <button class="action-btn btn-primary" onclick="sendRecording()" id="sendRecordingBtn" disabled>
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Picker -->
    <div class="modal-overlay" id="locationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Send Location</h3>
                <button class="close-modal" onclick="closeModal('locationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="location-map" id="locationMap">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Loading map...</span>
                </div>
                <div class="location-info" id="locationInfo">
                    <!-- Location info appears here -->
                </div>
                <div class="modal-actions">
                    <button class="action-btn btn-secondary" onclick="closeModal('locationModal')">
                        Cancel
                    </button>
                    <button class="action-btn btn-primary" onclick="sendLocation()">
                        <i class="fas fa-paper-plane"></i> Send Location
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Home page specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    switchPage(page);
                });
            });

            // Initialize profile dropdown
            document.getElementById('profileBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('profileDropdown').classList.toggle('show');
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                document.getElementById('profileDropdown').classList.remove('show');
                document.getElementById('chatMenu').classList.remove('show');
                document.getElementById('attachmentOptions').classList.remove('show');
            });

            // Initialize attach button
            document.getElementById('attachBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('attachmentOptions').classList.toggle('show');
            });

            // Initialize chat menu
            document.getElementById('chatMenuBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('chatMenu').classList.toggle('show');
            });

            // Auto-resize message input
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Send message on Enter (without Shift)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Search user as typing
            const searchInput = document.getElementById('searchUserId');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const userId = this.value.trim().toUpperCase();
                    if (userId.startsWith('ZYN-') && userId.length === 8) {
                        searchUser(userId);
                    } else {
                        clearSearchResult();
                    }
                });
            }

            // Load user data
            loadUserData();
        });

        function switchPage(page) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-page="${page}"]`).classList.add('active');

            // Show selected page
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            document.getElementById(`${page}Page`).classList.add('active');

            // Load page-specific data
            switch(page) {
                case 'home':
                    loadChats();
                    break;
                case 'zynes':
                    loadZynes();
                    break;
                case 'groups':
                    loadGroups();
                    break;
                case 'requests':
                    loadChatRequests();
                    break;
                case 'contacts':
                    loadContacts();
                    break;
            }
        }

        function copyUserId() {
            const userId = document.getElementById('userId').textContent;
            navigator.clipboard.writeText(userId).then(() => {
                showToast('User ID copied to clipboard', 'success');
            });
        }

        function closeChat() {
            document.getElementById('chatPage').classList.add('hidden');
            document.getElementById('appMain').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showStartChatModal() {
            document.getElementById('startChatModal').classList.add('active');
            document.getElementById('searchUserId').focus();
        }

        function showCreateGroupModal() {
            document.getElementById('createGroupModal').classList.add('active');
            loadContactsForGroup();
        }

        // Additional home page functions will be in app.js
    </script>
</body>
</html>
